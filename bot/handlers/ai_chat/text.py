"""
–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è AI —á–∞—Ç–∞.
"""

from aiogram import F, Router
from aiogram.fsm.context import FSMContext
from aiogram.types import Message
from loguru import logger

from bot.database import get_db
from bot.monitoring import log_user_activity, monitor_performance
from bot.services import ChatHistoryService, ContentModerationService, UserService
from bot.services.ai_service_solid import get_ai_service

from .helpers import extract_user_name_from_message


def register_handlers(router: Router) -> None:
    """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç handlers –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π."""
    router.message.register(start_ai_chat, F.text & (F.text == "üí¨ –û–±—â–µ–Ω–∏–µ —Å AI"))
    router.message.register(handle_ai_message, F.text)


@monitor_performance
async def start_ai_chat(message: Message, state: FSMContext):  # noqa: ARG001
    """
    –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –æ–±—â–µ–Ω–∏—è —Å AI

    Args:
        message: –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        state: FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    """
    await message.answer(
        text="üêº <b>–†–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è —Å AI –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!</b>\n\n"
        "–¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –ø–∏—à–∏ –º–Ω–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî —è –æ—Ç–≤–µ—á—É! üí°",
        parse_mode="HTML",
    )


@monitor_performance
async def handle_ai_message(message: Message, state: FSMContext):  # noqa: ARG001
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è AI

    –í–ê–ñ–ù–û: –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —è–≤–ª—è–µ—Ç—Å—è —è–¥—Ä–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
    –í–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–Ω—É—é —Ü–µ–ø–æ—á–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ –∏—Å—Ç–æ—Ä–∏–µ–π —á–∞—Ç–∞.
    –ò–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤.

    –ê–ª–≥–æ—Ä–∏—Ç–º:
    1. –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
    2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π (–∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI)
    3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–º–æ–¥–µ—Ä–∞—Ü–∏—è)
    4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ AI —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
    5. –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç
    6. –ü—Ä–æ–º–æ–¥–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç AI
    7. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    8. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

    Args:
        message: –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        state: FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    """
    telegram_id = message.from_user.id
    user_message = message.text

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..."
    await message.bot.send_chat_action(message.chat.id, "typing")

    try:
        # –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
        moderation_service = ContentModerationService()

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Ç–µ–º–∞—Ö
        if moderation_service.is_provocative_question(user_message):
            logger.warning(f"üö´ –ü—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å –æ—Ç {telegram_id}: {user_message[:50]}...")
            log_user_activity(
                telegram_id, "provocative_question", False, "question_about_forbidden_topics"
            )

            # –í–µ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —É—á–µ–±—É
            safe_response = (
                "–Ø –ø–æ–º–æ–≥–∞—é —Å —É—á–µ–±–æ–π –∏ —à–∫–æ–ª—å–Ω—ã–º–∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏! üìö\n\n"
                "–ú–æ–≥—É –ø–æ–º–æ—á—å —Å:\n"
                "‚Ä¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π (–∑–∞–¥–∞—á–∏, –ø—Ä–∏–º–µ—Ä—ã, —Ñ–æ—Ä–º—É–ª—ã)\n"
                "‚Ä¢ –†—É—Å—Å–∫–∏–º —è–∑—ã–∫–æ–º (–ø—Ä–∞–≤–∏–ª–∞, –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è, –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞)\n"
                "‚Ä¢ –ò—Å—Ç–æ—Ä–∏–µ–π (–¥–∞—Ç—ã, —Å–æ–±—ã—Ç–∏—è, —ç–ø–æ—Ö–∏)\n"
                "‚Ä¢ –ì–µ–æ–≥—Ä–∞—Ñ–∏–µ–π (—Å—Ç—Ä–∞–Ω—ã, –∫–∞—Ä—Ç—ã, –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ –∑–æ–Ω—ã)\n"
                "‚Ä¢ –§–∏–∑–∏–∫–æ–π, —Ö–∏–º–∏–µ–π, –±–∏–æ–ª–æ–≥–∏–µ–π\n"
                "‚Ä¢ –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–æ–π –∏ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–º–∏ —è–∑—ã–∫–∞–º–∏\n\n"
                "–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –ø–æ –ª—é–±–æ–º—É —à–∫–æ–ª—å–Ω–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É! üêº"
            )
            await message.answer(text=safe_response)
            return

        # –°–Ω–∞—á–∞–ª–∞ –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        is_safe, reason = moderation_service.is_safe_content(user_message)

        if not is_safe:
            logger.warning(f"üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç {telegram_id}: {reason}")
            moderation_service.log_blocked_content(telegram_id, user_message, reason)
            log_user_activity(telegram_id, "blocked_content", False, reason)

            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–±–∞–∑–æ–≤–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
            try:
                with get_db() as db:
                    user_service = UserService(db)
                    user = user_service.get_user_by_telegram_id(telegram_id)
                    if user and user.user_type == "child":
                        from bot.services.analytics_service import AnalyticsService

                        analytics_service = AnalyticsService(db)
                        analytics_service.record_safety_metric(
                            metric_name="blocked_messages",
                            value=1.0,
                            user_telegram_id=telegram_id,
                            category="basic_moderation",
                        )
            except Exception as e:
                logger.debug(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –º–µ—Ç—Ä–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {e}")

            safe_response = moderation_service.get_safe_response_alternative("blocked_content")
            await message.answer(text=safe_response)
            return

        # –ó–∞—Ç–µ–º –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è
        user_context = {
            "telegram_id": telegram_id,
            "username": message.from_user.username,
            "first_name": message.from_user.first_name,
        }

        try:
            advanced_result = await moderation_service.advanced_moderate_content(
                user_message, user_context
            )

            # –ï—Å–ª–∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –∫–æ–Ω—Ç–µ–Ω—Ç
            if not advanced_result.is_safe:
                logger.warning(
                    f"üö´ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç {telegram_id}: "
                    f"{advanced_result.reason} (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {advanced_result.confidence:.2f})"
                )

                # –õ–æ–≥–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
                log_user_activity(
                    telegram_id,
                    "advanced_blocked_content",
                    False,
                    f"{advanced_result.category.value if advanced_result.category else 'unknown'}: {advanced_result.reason}",
                )

                # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                try:
                    with get_db() as db:
                        from bot.services.analytics_service import AnalyticsService

                        analytics_service = AnalyticsService(db)
                        analytics_service.record_safety_metric(
                            metric_name="blocked_messages",
                            value=1.0,
                            user_telegram_id=telegram_id,
                            category=(
                                advanced_result.category.value
                                if advanced_result.category
                                else "unknown"
                            ),
                        )
                except Exception as e:
                    logger.debug(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –º–µ—Ç—Ä–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {e}")

                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –º–æ–¥–µ—Ä–∞—Ü–∏–∏
                response_text = (
                    advanced_result.alternative_response
                    or moderation_service.get_safe_response_alternative("blocked_content")
                )
                await message.answer(text=response_text)
                return

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –º–æ–¥–µ—Ä–∞—Ü–∏–∏: {e}")
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –±–∞–∑–æ–≤–æ–π –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏

        # –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
        with get_db() as db:
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã
            user_service = UserService(db)
            history_service = ChatHistoryService(db)

            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user = user_service.get_or_create_user(
                telegram_id=telegram_id,
                username=message.from_user.username,
                first_name=message.from_user.first_name,
                last_name=message.from_user.last_name,
            )

            # –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ Premium –¥–ª—è –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            from bot.services.premium_features_service import PremiumFeaturesService

            premium_service = PremiumFeaturesService(db)
            can_request, limit_reason = premium_service.can_make_ai_request(
                telegram_id, username=message.from_user.username
            )

            if not can_request:
                logger.warning(f"üö´ AI –∑–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥–ª—è user={telegram_id}: {limit_reason}")
                from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup

                keyboard = InlineKeyboardMarkup(
                    inline_keyboard=[
                        [
                            InlineKeyboardButton(
                                text="üíé –£–∑–Ω–∞—Ç—å –æ Premium", callback_data="premium:info"
                            )
                        ]
                    ]
                )

                await message.answer(limit_reason, reply_markup=keyboard, parse_mode="HTML")
                return

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–µ–Ω–∏–≤–æ—Å—Ç–∏ –ø–∞–Ω–¥—ã (–ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞)
            from bot.services.panda_lazy_service import PandaLazyService

            lazy_service = PandaLazyService(db)
            is_lazy, lazy_message = lazy_service.check_and_update_lazy_state(telegram_id)
            if is_lazy and lazy_message:
                logger.info(f"üò¥ –ü–∞–Ω–¥–∞ '–ª–µ–Ω–∏–≤–∞' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                await message.answer(text=lazy_message)
                return

            # –î–ª—è premium - –±–æ–ª—å—à–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            history_limit = 50 if premium_service.is_premium_active(telegram_id) else 10

            # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            history = history_service.get_formatted_history_for_ai(telegram_id, limit=history_limit)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–∏—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞—è)
            is_history_cleared = len(history) == 0

            # #region agent log
            with open(
                r"c:\Users\Vyacheslav\PandaPal\.cursor\debug.log", "a", encoding="utf-8"
            ) as f:
                import json

                f.write(
                    json.dumps(
                        {
                            "sessionId": "debug-session",
                            "runId": "run1",
                            "hypothesisId": "B",
                            "location": "text.py:handle_ai_message",
                            "message": "History check",
                            "data": {
                                "is_history_cleared": is_history_cleared,
                                "history_length": len(history),
                                "user_message": user_message[:50],
                                "user_first_name": user.first_name,
                            },
                            "timestamp": int(__import__("time").time() * 1000),
                        }
                    )
                    + "\n"
                )
            # #endregion

            # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏
            # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ (–∏—â–µ–º –≤ –æ—Ç–≤–µ—Ç–∞—Ö AI)
            user_message_count = 0
            if user.first_name:
                # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ –≤ –æ—Ç–≤–µ—Ç–∞—Ö AI (–∏—â–µ–º –∏–º—è –≤ —Ç–µ–∫—Å—Ç–µ)
                last_name_mention_index = -1
                for i, msg in enumerate(history):
                    if (
                        msg.get("role") == "assistant"
                        and user.first_name.lower() in msg.get("text", "").lower()
                    ):
                        last_name_mention_index = i
                        break

                # –°—á–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ü–û–°–õ–ï –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏
                if last_name_mention_index >= 0:
                    # –ï—Å—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ - —Å—á–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –Ω–µ–≥–æ
                    user_message_count = sum(
                        1
                        for msg in history[last_name_mention_index + 1 :]
                        if msg.get("role") == "user"
                    )
                else:
                    # –ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏ - —Å—á–∏—Ç–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    user_message_count = sum(1 for msg in history if msg.get("role") == "user")
            else:
                # –ù–µ—Ç –∏–º–µ–Ω–∏ - —Å—á–∏—Ç–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                user_message_count = sum(1 for msg in history if msg.get("role") == "user")

            logger.info(
                f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {telegram_id} ({user.first_name}): "
                f"{user_message[:50]}... | –ò—Å—Ç–æ—Ä–∏—è: {len(history)} —Å–æ–æ–±—â–µ–Ω–∏–π | "
                f"–°–æ–æ–±—â–µ–Ω–∏–π —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è: {user_message_count}"
            )

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–ü–∞–Ω–¥–∞ –ø–µ—á–∞—Ç–∞–µ—Ç..."
            await message.bot.send_chat_action(chat_id=message.chat.id, action="typing")

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞ –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –µ—Å–ª–∏ –Ω–µ —Ä—É—Å—Å–∫–∏–π
            from bot.services.translate_service import get_translate_service

            translate_service = get_translate_service()
            detected_lang = await translate_service.detect_language(user_message)

            # –ï—Å–ª–∏ —è–∑—ã–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∏ —ç—Ç–æ –Ω–µ —Ä—É—Å—Å–∫–∏–π, –Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —è–∑—ã–∫
            if (
                detected_lang
                and detected_lang != "ru"
                and detected_lang in translate_service.SUPPORTED_LANGUAGES
            ):
                logger.info(f"üåç –û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫: {detected_lang}")
                # –ü–µ—Ä–µ–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç
                translated_text = await translate_service.translate_text(
                    user_message, target_language="ru", source_language=detected_lang
                )
                if translated_text:
                    lang_name = translate_service.get_language_name(detected_lang)
                    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
                    user_message = (
                        f"üåç –í–∏–∂—É, —á—Ç–æ —Ç—ã –Ω–∞–ø–∏—Å–∞–ª –Ω–∞ {lang_name}!\n\n"
                        f"üìù –û—Ä–∏–≥–∏–Ω–∞–ª: {user_message}\n"
                        f"üá∑üá∫ –ü–µ—Ä–µ–≤–æ–¥: {translated_text}\n\n"
                        f"–û–±—ä—è—Å–Ω–∏ —ç—Ç–æ—Ç –ø–µ—Ä–µ–≤–æ–¥ –∏ –ø–æ–º–æ–≥–∏ –ø–æ–Ω—è—Ç—å –≥—Ä–∞–º–º–∞—Ç–∏–∫—É –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞."
                    )
                    logger.info(f"‚úÖ –¢–µ–∫—Å—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω: {detected_lang} ‚Üí ru")

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º Premium —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            is_premium = premium_service.is_premium_active(telegram_id)

            # –ü–æ–ª—É—á–∞–µ–º AI —Å–µ—Ä–≤–∏—Å (SOLID —Ñ–∞—Å–∞–¥)
            ai_service = get_ai_service()

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–æ–ø—Ä–æ—Å –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º
            educational_keywords = [
                # –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞
                "–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞",
                "–∞–ª–≥–µ–±—Ä–∞",
                "–≥–µ–æ–º–µ—Ç—Ä–∏—è",
                "–∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞",
                "—Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è",
                "—É—Ä–∞–≤–Ω–µ–Ω–∏–µ",
                "—Ñ—É–Ω–∫—Ü–∏—è",
                "–∏–Ω—Ç–µ–≥—Ä–∞–ª",
                "–ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è",
                "–ª–æ–≥–∞—Ä–∏—Ñ–º",
                "–º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑",
                "—Ç–µ–æ—Ä–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π",
                "–≥—Ä–∞—Ñ–∏–∫",
                "–¥–∏–∞–≥—Ä–∞–º–º–∞",
                "—Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è",
                "—É–º–Ω–æ–∂–µ–Ω–∏–µ",
                "–¥–µ–ª–µ–Ω–∏–µ",
                "—Å–ª–æ–∂–µ–Ω–∏–µ",
                "–≤—ã—á–∏—Ç–∞–Ω–∏–µ",
                "–¥—Ä–æ–±—å",
                "–ø—Ä–æ—Ü–µ–Ω—Ç",
                "–ø—Ä–æ–ø–æ—Ä—Ü–∏—è",
                "—Å–∏—Å—Ç–µ–º–∞ —É—Ä–∞–≤–Ω–µ–Ω–∏–π",
                "–Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ",
                "–∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ",
                "–ª–∏–Ω–µ–π–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ",
                "–º–Ω–æ–≥–æ—á–ª–µ–Ω",
                "—Å—Ç–µ–ø–µ–Ω—å",
                "–∫–æ—Ä–µ–Ω—å",
                "—Å–∏–Ω—É—Å",
                "–∫–æ—Å–∏–Ω—É—Å",
                "—Ç–∞–Ω–≥–µ–Ω—Å",
                "–ø–∞—Ä–∞–±–æ–ª–∞",
                "—Å–∏–Ω—É—Å–æ–∏–¥–∞",
                # –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
                "—Ä—É—Å—Å–∫–∏–π",
                "–≥—Ä–∞–º–º–∞—Ç–∏–∫–∞",
                "–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è",
                "–ø—É–Ω–∫—Ç—É–∞—Ü–∏—è",
                "–º–æ—Ä—Ñ–æ–ª–æ–≥–∏—è",
                "—Å–∏–Ω—Ç–∞–∫—Å–∏—Å",
                "—Ñ–æ–Ω–µ—Ç–∏–∫–∞",
                "–ª–µ–∫—Å–∏–∫–∞",
                "—Å–ª–æ–≤–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ",
                "—Å–æ—á–∏–Ω–µ–Ω–∏–µ",
                "–¥–∏–∫—Ç–∞–Ω—Ç",
                "–∏–∑–ª–æ–∂–µ–Ω–∏–µ",
                "–ø–µ—Ä–µ—Å–∫–∞–∑",
                "–æ—Ä—Ñ–æ–≥—Ä–∞–º–º–∞",
                "–ø—Ä–∞–≤–∏–ª–æ",
                "–ø—Ä–∏—Å—Ç–∞–≤–∫–∞",
                "—Å—É—Ñ—Ñ–∏–∫—Å",
                "–æ–∫–æ–Ω—á–∞–Ω–∏–µ",
                "–∫–æ—Ä–µ–Ω—å —Å–ª–æ–≤–∞",
                "—á–∞—Å—Ç–∏ —Ä–µ—á–∏",
                "—Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ",
                "–ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ",
                "–≥–ª–∞–≥–æ–ª",
                "–Ω–∞—Ä–µ—á–∏–µ",
                "–ø—Ä–µ–¥–ª–æ–≥",
                "—Å–æ—é–∑",
                "—á–∞—Å—Ç–∏—Ü–∞",
                "–º–µ—Å—Ç–æ–∏–º–µ–Ω–∏–µ",
                "–ø–æ–¥–ª–µ–∂–∞—â–µ–µ",
                "—Å–∫–∞–∑—É–µ–º–æ–µ",
                # –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞
                "–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞",
                "–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ",
                "–∞–≤—Ç–æ—Ä",
                "–ø–∏—Å–∞—Ç–µ–ª—å",
                "–ø–æ—ç—Ç",
                "—Ä–æ–º–∞–Ω",
                "–ø–æ–≤–µ—Å—Ç—å",
                "—Ä–∞—Å—Å–∫–∞–∑",
                "—Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ",
                "–ø–æ—ç–º–∞",
                "–¥—Ä–∞–º–∞",
                "—Ç—Ä–∞–≥–µ–¥–∏—è",
                "–∫–æ–º–µ–¥–∏—è",
                "—Å–æ–Ω–µ—Ç",
                "—ç–ø–æ—Å",
                "–ª–∏—Ä–∏–∫–∞",
                "–∂–∞–Ω—Ä",
                "—Å—é–∂–µ—Ç",
                "–∫–æ–º–ø–æ–∑–∏—Ü–∏—è",
                "–≥–µ—Ä–æ–π",
                "–ø–µ—Ä—Å–æ–Ω–∞–∂",
                "–∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞",
                "—Ç–µ–º–∞",
                "–∏–¥–µ—è",
                "–ø—Ä–æ–±–ª–µ–º–∞",
                "—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞",
                # –ò—Å—Ç–æ—Ä–∏—è
                "–∏—Å—Ç–æ—Ä–∏—è",
                "–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π",
                "—Ä–µ–≤–æ–ª—é—Ü–∏—è",
                "–≤–æ–π–Ω–∞",
                "—Å—Ä–∞–∂–µ–Ω–∏–µ",
                "–∏–º–ø–µ—Ä–∏—è",
                "—Ü–∞—Ä—å",
                "–∏–º–ø–µ—Ä–∞—Ç–æ—Ä",
                "—Å—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—å–µ",
                "—Ä–µ–Ω–µ—Å—Å–∞–Ω—Å",
                "–≤–µ–ª–∏–∫–∞—è –æ—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –≤–æ–π–Ω–∞",
                "–∫–æ–ª–æ–Ω–∏–∑–∞—Ü–∏—è",
                "–∏–Ω–¥—É—Å—Ç—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è",
                "—Ñ–µ–æ–¥–∞–ª–∏–∑–º",
                "–ø—Ä–æ—Å–≤–µ—â–µ–Ω–∏–µ",
                "–¥–µ–∫–ª–∞—Ä–∞—Ü–∏—è",
                "–∫–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è",
                "–¥—Ä–µ–≤–Ω–∏–π –º–∏—Ä",
                "–∞–Ω—Ç–∏—á–Ω–æ—Å—Ç—å",
                "—Å—Ä–µ–¥–Ω–∏–µ –≤–µ–∫–∞",
                "–Ω–æ–≤–æ–µ –≤—Ä–µ–º—è",
                "–¥–∞—Ç–∞",
                "—Å–æ–±—ã—Ç–∏–µ",
                "—ç–ø–æ—Ö–∞",
                "–ø–µ—Ä–∏–æ–¥",
                "–¥–∏–Ω–∞—Å—Ç–∏—è",
                # –ì–µ–æ–≥—Ä–∞—Ñ–∏—è
                "–≥–µ–æ–≥—Ä–∞—Ñ–∏—è",
                "–≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π",
                "–∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç",
                "–º–∞—Ç–µ—Ä–∏–∫",
                "–æ–∫–µ–∞–Ω",
                "–º–æ—Ä–µ",
                "—Ä–µ–∫–∞",
                "–æ–∑–µ—Ä–æ",
                "–≥–æ—Ä–∞",
                "—Ä–∞–≤–Ω–∏–Ω–∞",
                "–∫–ª–∏–º–∞—Ç",
                "—Ä–µ–ª—å–µ—Ñ",
                "—ç–∫–≤–∞—Ç–æ—Ä",
                "–º–µ—Ä–∏–¥–∏–∞–Ω",
                "—à–∏—Ä–æ—Ç–∞",
                "–¥–æ–ª–≥–æ—Ç–∞",
                "–¥–µ–º–æ–≥—Ä–∞—Ñ–∏—è",
                "–≥–ª–æ–±–∞–ª–∏–∑–∞—Ü–∏—è",
                "—Å—Ç—Ä–∞–Ω–∞",
                "—Å—Ç–æ–ª–∏—Ü–∞",
                "–Ω–∞—Å–µ–ª–µ–Ω–∏–µ",
                "–ø—Ä–∏—Ä–æ–¥–∞",
                "—Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
                "–∂–∏–≤–æ—Ç–Ω—ã–π –º–∏—Ä",
                "–ø–æ—á–≤–∞",
                "–ø–æ–ª–µ–∑–Ω—ã–µ –∏—Å–∫–æ–ø–∞–µ–º—ã–µ",
                # –ë–∏–æ–ª–æ–≥–∏—è
                "–±–∏–æ–ª–æ–≥–∏—è",
                "–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π",
                "–∫–ª–µ—Ç–∫–∞",
                "–¥–Ω–∫",
                "–≥–µ–Ω–µ—Ç–∏–∫–∞",
                "—ç–≤–æ–ª—é—Ü–∏—è",
                "—ç–∫–æ–ª–æ–≥–∏—è",
                "—Ñ–∏–∑–∏–æ–ª–æ–≥–∏—è",
                "–∞–Ω–∞—Ç–æ–º–∏—è",
                "–±–∏–æ—Å—Ñ–µ—Ä–∞",
                "–º–∏—Ç–æ–∑",
                "–º–µ–π–æ–∑",
                "—Ä–∞—Å—Ç–µ–Ω–∏–µ",
                "–∂–∏–≤–æ—Ç–Ω–æ–µ",
                "–æ—Ä–≥–∞–Ω–∏–∑–º",
                "–æ—Ä–≥–∞–Ω",
                "—Å–∏—Å—Ç–µ–º–∞ –æ—Ä–≥–∞–Ω–æ–≤",
                "–∫—Ä–æ–≤—å",
                "–Ω–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞",
                "–ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ",
                "–¥—ã—Ö–∞–Ω–∏–µ",
                "–∫—Ä–æ–≤–æ–æ–±—Ä–∞—â–µ–Ω–∏–µ",
                "—Ä–∞–∑–º–Ω–æ–∂–µ–Ω–∏–µ",
                "–Ω–∞—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å",
                "–≤–∏–¥",
                # –§–∏–∑–∏–∫–∞
                "—Ñ–∏–∑–∏–∫–∞",
                "—Ñ–∏–∑–∏—á–µ—Å–∫–∏–π",
                "–º–µ—Ö–∞–Ω–∏–∫–∞",
                "—Ç–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∞",
                "—ç–ª–µ–∫—Ç—Ä–æ–¥–∏–Ω–∞–º–∏–∫–∞",
                "–æ–ø—Ç–∏–∫–∞",
                "–∫–≤–∞–Ω—Ç–æ–≤–∞—è —Ñ–∏–∑–∏–∫–∞",
                "—è–¥–µ—Ä–Ω–∞—è —Ñ–∏–∑–∏–∫–∞",
                "—Å–∏–ª–∞",
                "—ç–Ω–µ—Ä–≥–∏—è",
                "–∏–º–ø—É–ª—å—Å",
                "–≤–æ–ª–Ω–∞",
                "—Å–∫–æ—Ä–æ—Å—Ç—å",
                "—É—Å–∫–æ—Ä–µ–Ω–∏–µ",
                "–º–∞—Å—Å–∞",
                "–¥–∞–≤–ª–µ–Ω–∏–µ",
                "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞",
                "—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ",
                "–º–∞–≥–Ω–µ—Ç–∏–∑–º",
                "—Å–≤–µ—Ç",
                "–∑–≤—É–∫",
                "—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π —Ç–æ–∫",
                "–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ",
                "—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ",
                "–º–æ—â–Ω–æ—Å—Ç—å",
                # –•–∏–º–∏—è
                "—Ö–∏–º–∏—è",
                "—Ö–∏–º–∏—á–µ—Å–∫–∏–π",
                "–º–µ–Ω–¥–µ–ª–µ–µ–≤–∞",
                "–º–µ–Ω–¥–µ–ª–µ–µ–≤",
                "–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è",
                "–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞",
                "—Ç–∞–±–ª–∏—Ü–∞ –º–µ–Ω–¥–µ–ª–µ–µ–≤–∞",
                "—ç–ª–µ–º–µ–Ω—Ç",
                "—ç–ª–µ–º–µ–Ω—Ç—ã",
                "–∞—Ç–æ–º",
                "–∞—Ç–æ–º—ã",
                "–º–æ–ª–µ–∫—É–ª–∞",
                "–º–æ–ª–µ–∫—É–ª—ã",
                "—Ä–µ–∞–∫—Ü–∏—è",
                "—Ä–µ–∞–∫—Ü–∏–∏",
                "–≤–µ—â–µ—Å—Ç–≤–æ",
                "–≤–µ—â–µ—Å—Ç–≤–∞",
                "–∫–∏—Å–ª–æ—Ç–∞",
                "–æ—Å–Ω–æ–≤–∞–Ω–∏–µ",
                "—â–µ–ª–æ—á—å",
                "—Å–æ–ª—å",
                "–æ–∫–∏—Å–ª–µ–Ω–∏–µ",
                "–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ",
                "–∫–∞—Ç–∞–ª–∏–∑–∞—Ç–æ—Ä",
                "–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å",
                "—Ö–∏–º–∏—á–µ—Å–∫–∞—è —Å–≤—è–∑—å",
                "–∏–æ–Ω",
                "—Ä–∞—Å—Ç–≤–æ—Ä",
                "–∫—Ä–∏—Å—Ç–∞–ª–ª",
                "–º–µ—Ç–∞–ª–ª",
                # –ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∏
                "–∞–Ω–≥–ª–∏–π—Å–∫–∏–π",
                "–Ω–µ–º–µ—Ü–∫–∏–π",
                "—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π",
                "–∏—Å–ø–∞–Ω—Å–∫–∏–π",
                "–∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–π",
                "–∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫",
                "–≤—Ç–æ—Ä–æ–π –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π",
                "–≥—Ä–∞–º–º–∞—Ç–∏–∫–∞",
                "–ª–µ–∫—Å–∏–∫–∞",
                "—Ñ–æ–Ω–µ—Ç–∏–∫–∞",
                "—Å–∏–Ω—Ç–∞–∫—Å–∏—Å",
                "–ø–µ—Ä–µ–≤–æ–¥",
                "–∞—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ",
                "—á—Ç–µ–Ω–∏–µ",
                "–ø–∏—Å—å–º–æ",
                "–≥–æ–≤–æ—Ä–µ–Ω–∏–µ",
                "–∏–¥–∏–æ–º–∞",
                "—Å–ª–æ–≤–æ",
                "—Ñ—Ä–∞–∑–∞",
                "–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ",
                "–≤—Ä–µ–º—è",
                "–≥–ª–∞–≥–æ–ª",
                "—Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞",
                # –û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ
                "–æ–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ",
                "–æ–±—â–µ—Å—Ç–≤–æ",
                "—Å–æ—Ü–∏–æ–ª–æ–≥–∏—è",
                "—ç–∫–æ–Ω–æ–º–∏–∫–∞",
                "–ø–æ–ª–∏—Ç–∏–∫–∞",
                "–ø—Ä–∞–≤–æ",
                "–∑–∞–∫–æ–Ω",
                "–∫–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è",
                "–≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ",
                "–≤–ª–∞—Å—Ç—å",
                "–¥–µ–º–æ–∫—Ä–∞—Ç–∏—è",
                "–≥—Ä–∞–∂–¥–∞–Ω–∏–Ω",
                "–≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ",
                "—Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç–∏—Ç—É—Ç—ã",
                "–∫—É–ª—å—Ç—É—Ä–∞",
                "—Ç—Ä–∞–¥–∏—Ü–∏–∏",
                "–æ–±—ã—á–∞–∏",
                "—Å–µ–º—å—è",
                "—à–∫–æ–ª–∞",
                "—Ç—Ä—É–¥",
                "–ø—Ä–æ—Ñ–µ—Å—Å–∏—è",
                # –ú—É–∑—ã–∫–∞
                "–º—É–∑—ã–∫–∞",
                "–º—É–∑—ã–∫–∞–ª—å–Ω—ã–π",
                "–Ω–æ—Ç—ã",
                "–Ω–æ—Ç–∞",
                "—Ä–∏—Ç–º",
                "–º–µ–ª–æ–¥–∏—è",
                "–≥–∞—Ä–º–æ–Ω–∏—è",
                "–∂–∞–Ω—Ä",
                "–∫–æ–º–ø–æ–∑–∏—Ç–æ—Ä",
                "–∫–æ–º–ø–æ–∑–∏—Ü–∏—è",
                "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç",
                "–æ—Ä–∫–µ—Å—Ç—Ä",
                "—Ö–æ—Ä",
                "–ø–µ–Ω–∏–µ",
                "–ø–µ—Å–Ω—è",
                "–º—É–∑—ã–∫–∞–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ",
                # –ò–∑–æ–±—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ (–ò–ó–û)
                "–∏–∑–æ–±—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ",
                "–∏–∑–æ",
                "—Ä–∏—Å–æ–≤–∞–Ω–∏–µ",
                "—Ä–∏—Å—É–Ω–æ–∫",
                "–∂–∏–≤–æ–ø–∏—Å—å",
                "–≥—Ä–∞—Ñ–∏–∫–∞",
                "—Å–∫—É–ª—å–ø—Ç—É—Ä–∞",
                "–∫–æ–º–ø–æ–∑–∏—Ü–∏—è",
                "—Ü–≤–µ—Ç",
                "–∫—Ä–∞—Å–∫–∞",
                "–∫–∏—Å—Ç—å",
                "–∫–∞—Ä–∞–Ω–¥–∞—à",
                "–ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞",
                "–Ω–∞—Ç—é—Ä–º–æ—Ä—Ç",
                "–ø–µ–π–∑–∞–∂",
                "–ø–æ—Ä—Ç—Ä–µ—Ç",
                "—Ö—É–¥–æ–∂–Ω–∏–∫",
                "—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ",
                # –¢—Ä—É–¥ (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è)
                "—Ç—Ä—É–¥",
                "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è",
                "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏",
                "–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
                "–ø—Ä–æ–µ–∫—Ç",
                "–º–∞—Ç–µ—Ä–∏–∞–ª—ã",
                "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã",
                "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç",
                "—á–µ—Ä—á–µ–Ω–∏–µ",
                "—á–µ—Ä—Ç–µ–∂",
                "–∫–æ–Ω—Å—Ç—Ä—É–∏—Ä–æ–≤–∞–Ω–∏–µ",
                "–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ",
                "–∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ",
                "–æ–±—Ä–∞–±–æ—Ç–∫–∞",
                "–¥–µ—Ä–µ–≤–æ",
                "–º–µ—Ç–∞–ª–ª",
                "—Ç–∫–∞–Ω—å",
                "—à–∏—Ç—å–µ",
                "–≤—ã—à–∏–≤–∞–Ω–∏–µ",
                "–≤—è–∑–∞–Ω–∏–µ",
                "—Å—Ç–æ–ª—è—Ä–Ω–æ–µ –¥–µ–ª–æ",
                "—Å–ª–µ—Å–∞—Ä–Ω–æ–µ –¥–µ–ª–æ",
                # –û—Å–Ω–æ–≤—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∑–∞—â–∏—Ç—ã –†–æ–¥–∏–Ω—ã (–û–ë–ñ)
                "–æ–±–∂",
                "–æ—Å–Ω–æ–≤—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏",
                "–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
                "–∑–∞—â–∏—Ç–∞ —Ä–æ–¥–∏–Ω—ã",
                "–ø–µ—Ä–≤–∞—è –ø–æ–º–æ—â—å",
                "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å",
                "—á—Ä–µ–∑–≤—ã—á–∞–π–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏",
                "—á—Å",
                "–≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∞—è –æ–±–æ—Ä–æ–Ω–∞",
                "–≥–æ",
                "–≤–æ–µ–Ω–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞",
                "–≤–æ–µ–Ω–Ω–æ–µ –¥–µ–ª–æ",
                "–∑–∞—â–∏—Ç–∞",
                "—Å–ø–∞—Å–µ–Ω–∏–µ",
                "–ø–æ–∂–∞—Ä",
                "–Ω–∞–≤–æ–¥–Ω–µ–Ω–∏–µ",
                "–∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏–µ",
                "—ç–≤–∞–∫—É–∞—Ü–∏—è",
                "—Å–∏–≥–Ω–∞–ª",
                "—Ç—Ä–µ–≤–æ–≥–∞",
                # –§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞ (—Ñ–∏–∑–∫—É–ª—å—Ç—É—Ä–∞)
                "—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞",
                "—Ñ–∏–∑–∫—É–ª—å—Ç—É—Ä–∞",
                "—Ñ–∏–∑—Ä–∞",
                "—Å–ø–æ—Ä—Ç",
                "—Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π",
                "—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ",
                "—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è",
                "—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞",
                "–∑–∞—Ä—è–¥–∫–∞",
                "—Ä–∞–∑–º–∏–Ω–∫–∞",
                "–∑–¥–æ—Ä–æ–≤—å–µ",
                "—Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ",
                "–Ω–æ—Ä–º–∞—Ç–∏–≤—ã",
                "–Ω–æ—Ä–º–∞—Ç–∏–≤",
                "–±–µ–≥",
                "–ø—Ä—ã–∂–∫–∏",
                "–º–µ—Ç–∞–Ω–∏–µ",
                "–≥–∏–º–Ω–∞—Å—Ç–∏–∫–∞",
                "–ª—ã–∂–∏",
                "–ø–ª–∞–≤–∞–Ω–∏–µ",
                "–≤–æ–ª–µ–π–±–æ–ª",
                "–±–∞—Å–∫–µ—Ç–±–æ–ª",
                "—Ñ—É—Ç–±–æ–ª",
                # –î—É—Ö–æ–≤–Ω–æ-–Ω—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω–∞—è –∫—É–ª—å—Ç—É—Ä–∞ –†–æ—Å—Å–∏–∏
                "–¥—É—Ö–æ–≤–Ω–æ-–Ω—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω–∞—è –∫—É–ª—å—Ç—É—Ä–∞",
                "–¥—É—Ö–æ–≤–Ω–∞—è –∫—É–ª—å—Ç—É—Ä–∞",
                "–Ω—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å",
                "–º–æ—Ä–∞–ª—å",
                "—ç—Ç–∏–∫–∞",
                "—Ç—Ä–∞–¥–∏—Ü–∏–∏",
                "—Ä–µ–ª–∏–≥–∏—è",
                "–ø—Ä–∞–≤–æ—Å–ª–∞–≤–∏–µ",
                "–∫—É–ª—å—Ç—É—Ä–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–∏–µ",
                "–ø–∞—Ç—Ä–∏–æ—Ç–∏–∑–º",
                "—Ä–æ–¥–∏–Ω–∞",
                "–æ—Ç–µ—á–µ—Å—Ç–≤–æ",
                "–≤–µ—Ä–∞",
                "–¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å",
                "–Ω—Ä–∞–≤—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏",
                "–∫—É–ª—å—Ç—É—Ä–∞ —Ä–æ—Å—Å–∏–∏",
                # –†–æ–¥–Ω–æ–π —è–∑—ã–∫ –∏ —Ä–æ–¥–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞
                "—Ä–æ–¥–Ω–æ–π —è–∑—ã–∫",
                "—Ä–æ–¥–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞",
                "—Ä–æ–¥–Ω–æ–π",
                # –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞
                "–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞",
                "–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ",
                "–∞–ª–≥–æ—Ä–∏—Ç–º",
                "–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö",
                "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç",
                "—Å–µ—Ç—å",
                "–∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
                "–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç",
                "–º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ",
                "–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞",
                "–ø—Ä–æ—Ç–æ–∫–æ–ª",
                "–∫–æ–¥",
                "–ø—Ä–æ–≥—Ä–∞–º–º–∞",
                "—è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è",
                "–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è",
                "—Ñ—É–Ω–∫—Ü–∏—è",
                # –û–±—â–∏–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã
                "–∑–∞–¥–∞—á–∞",
                "—Ä–µ—à–∏—Ç—å",
                "—Ä–µ—à–µ–Ω–∏–µ",
                "–ø—Ä–∏–º–µ—Ä",
                "—É—Ä–æ–∫",
                "–¥–æ–º–∞—à–Ω–µ–µ",
                "–∑–∞–¥–∞–Ω–∏–µ",
                "–¥–∑",
                "–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è",
                "—ç–∫–∑–∞–º–µ–Ω",
                "—Ç–µ—Å—Ç",
                "—Ä–∞–±–æ—Ç–∞",
                "–æ–±—ä—è—Å–Ω–∏",
                "–ø–æ–º–æ–≥–∏",
                "–∫–∞–∫ —Ä–µ—à–∏—Ç—å",
                "–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å",
                "—Å–∫–æ–ª—å–∫–æ",
                "–≤—ã—á–∏—Å–ª–∏",
                "–ø–æ—Å—á–∏—Ç–∞–π",
                "–Ω–∞–π–¥–∏",
                "—Ç–∞–±–ª–∏—Ü–∞",
                "–≥—Ä–∞—Ñ–∏–∫",
                "–¥–∏–∞–≥—Ä–∞–º–º–∞",
                "—Å—Ö–µ–º–∞",
                "—Ä–∏—Å—É–Ω–æ–∫",
                "–ø—Ä–∞–≤–∏–ª–æ",
                "—Ñ–æ—Ä–º—É–ª–∞",
                "—Ç–µ–æ—Ä–µ–º–∞",
                "–∞–∫—Å–∏–æ–º–∞",
                "–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ",
            ]
            user_message_lower = user_message.lower()
            is_educational = any(keyword in user_message_lower for keyword in educational_keywords)

            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–µ–¥–º–µ—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
            if is_educational:
                # –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                user.non_educational_questions_count = 0
            else:
                # –ï—Å–ª–∏ –Ω–µ–ø—Ä–µ–¥–º–µ—Ç–Ω—ã–π - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                user.non_educational_questions_count += 1

            # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é, –ø–æ—Ç–æ–º –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            # –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã AI –∑–Ω–∞–ª, —á—Ç–æ –±—É–¥–µ—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è, –∏ –º–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ
            visualization_image = None
            visualization_type = None
            try:
                from bot.services.visualization_service import get_visualization_service

                viz_service = get_visualization_service()
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–µ—Ç–µ–∫—Ü–∏–∏
                visualization_image, visualization_type = viz_service.detect_visualization_request(
                    user_message
                )

                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ AI
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∏–ø –∏–∑ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–Ω–∞—á–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
                if visualization_image and not visualization_type:
                    # –ï—Å–ª–∏ –¥–µ—Ç–µ–∫—Ç–æ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–∏–ø, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
                    user_message_lower = user_message.lower()
                    if "—Ç–∞–±–ª" in user_message_lower and "—É–º–Ω–æ–∂" in user_message_lower:
                        visualization_type = "multiplication_table"
                    elif "–≥—Ä–∞—Ñ–∏–∫" in user_message_lower:
                        visualization_type = "graph"
                    elif "—Ç–∞–±–ª" in user_message_lower:
                        visualization_type = "table"
                    else:
                        visualization_type = "visualization"

            except Exception as e:
                logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Å —É—á—ë—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏ –∫–ª–∞—Å—Å–∞
            # –ï—Å–ª–∏ –µ—Å—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è, –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —ç—Ç–æ–º –≤ –∑–∞–ø—Ä–æ—Å
            enhanced_user_message = user_message
            if visualization_image and visualization_type:
                # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏, —á—Ç–æ–±—ã AI —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ
                if visualization_type == "multiplication_table":
                    enhanced_user_message = (
                        f"{user_message}\n\n"
                        f"[–¢–ê–ë–õ–ò–¶–ê –£–ú–ù–û–ñ–ï–ù–ò–Ø –£–ñ–ï –ü–û–ö–ê–ó–ê–ù–ê. "
                        f"–î–∞–π –ö–û–†–û–¢–ö–û–ï (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –ø–æ—è—Å–Ω–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –ø—Ä–æ —Ç–∞–±–ª–∏—Ü—É —É–º–Ω–æ–∂–µ–Ω–∏—è: "
                        f"–∫–∞–∫ –µ—ë –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –¥–ª—è —á–µ–≥–æ –æ–Ω–∞ –Ω—É–∂–Ω–∞, –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä. "
                        f"–ù–ï —É–ø–æ–º–∏–Ω–∞–π –≥—Ä–∞—Ñ–∏–∫–∏, –ø–∞—Ä–∞–±–æ–ª—ã –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã. "
                        f"–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ —Ç–∞–±–ª–∏—Ü—É —É–º–Ω–æ–∂–µ–Ω–∏—è.]"
                    )
                elif visualization_type == "graph":
                    enhanced_user_message = (
                        f"{user_message}\n\n"
                        f"[–ì–†–ê–§–ò–ö –£–ñ–ï –ü–û–ö–ê–ó–ê–ù. "
                        f"–î–∞–π –ö–û–†–û–¢–ö–û–ï (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –ø–æ—è—Å–Ω–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –ø—Ä–æ —ç—Ç–æ—Ç –≥—Ä–∞—Ñ–∏–∫: "
                        f"—á—Ç–æ –æ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞. "
                        f"–ù–ï —É–ø–æ–º–∏–Ω–∞–π —Ç–∞–±–ª–∏—Ü—ã —É–º–Ω–æ–∂–µ–Ω–∏—è –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã. "
                        f"–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ –≥—Ä–∞—Ñ–∏–∫.]"
                    )
                elif visualization_type in (
                    "bar",
                    "pie",
                    "line",
                    "histogram",
                    "scatter",
                    "box",
                    "bubble",
                    "heatmap",
                ):
                    diagram_names = {
                        "bar": "—Å—Ç–æ–ª–±—á–∞—Ç—É—é –¥–∏–∞–≥—Ä–∞–º–º—É",
                        "pie": "–∫—Ä—É–≥–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É",
                        "line": "–ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫",
                        "histogram": "–≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É",
                        "scatter": "–¥–∏–∞–≥—Ä–∞–º–º—É —Ä–∞—Å—Å–µ—è–Ω–∏—è",
                        "box": "—è—â–∏–∫ —Å —É—Å–∞–º–∏",
                        "bubble": "–ø—É–∑—ã—Ä—å–∫–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É",
                        "heatmap": "—Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É",
                    }
                    diagram_name = diagram_names.get(visualization_type, "–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é")
                    enhanced_user_message = (
                        f"{user_message}\n\n"
                        f"[{diagram_name.upper()} –£–ñ–ï –ü–û–ö–ê–ó–ê–ù–ê. "
                        f"–î–∞–π –ü–û–î–†–û–ë–ù–û–ï –ø–æ—è—Å–Ω–µ–Ω–∏–µ (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π): —á—Ç–æ –æ–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, "
                        f"–∫–∞–∫ –µ—ë —á–∏—Ç–∞—Ç—å –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –æ—Å–Ω–æ–≤–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏. "
                        f"–ù–ï –¥—É–±–ª–∏—Ä—É–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —Ç–µ–∫—Å—Ç–æ–º! "
                        f"–í –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ —Å–ø—Ä–æ—Å–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: '–ü–æ–Ω—è—Ç–Ω–æ? –ú–æ–≥—É –æ–±—ä—è—Å–Ω–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ.', '–û–±—ä—è—Å–Ω–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ?', '–•–æ—á–µ—à—å, –æ–±—ä—è—Å–Ω—é –ø–æ–¥—Ä–æ–±–Ω–µ–µ...', '–ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ—Å–ª–æ–∂–Ω–µ–µ?' –∏–ª–∏ –ø–æ—Ö–æ–∂–µ.]"
                    )
                elif visualization_type == "map":
                    enhanced_user_message = (
                        f"{user_message}\n\n"
                        f"[–ö–ê–†–¢–ê –£–ñ–ï –ü–û–ö–ê–ó–ê–ù–ê. "
                        f"–î–∞–π –ü–û–î–†–û–ë–ù–û–ï –ø–æ—è—Å–Ω–µ–Ω–∏–µ (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π): —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–∞, "
                        f"–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –æ–±—ä–µ–∫—Ç, –æ—Å–Ω–æ–≤–Ω—ã–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏. "
                        f"–ù–ï –¥—É–±–ª–∏—Ä—É–π –∫–∞—Ä—Ç—É —Ç–µ–∫—Å—Ç–æ–º! "
                        f"–í –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ —Å–ø—Ä–æ—Å–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: '–ü–æ–Ω—è—Ç–Ω–æ? –ú–æ–≥—É –æ–±—ä—è—Å–Ω–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ?', '–û–±—ä—è—Å–Ω–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ?', '–•–æ—á–µ—à—å, –æ–±—ä—è—Å–Ω—é –ø–æ–¥—Ä–æ–±–Ω–µ–µ...', '–ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ—Å–ª–æ–∂–Ω–µ–µ?' –∏–ª–∏ –ø–æ—Ö–æ–∂–µ.]"
                    )
                else:
                    enhanced_user_message = (
                        f"{user_message}\n\n"
                        f"[–í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –£–ñ–ï –ü–û–ö–ê–ó–ê–ù–ê. "
                        f"–î–∞–π –ü–û–î–†–û–ë–ù–û–ï –ø–æ—è—Å–Ω–µ–Ω–∏–µ (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π) –¢–û–õ–¨–ö–û –ø–æ —Ç–µ–º–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. "
                        f"–ù–ï —É–ø–æ–º–∏–Ω–∞–π –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ. "
                        f"–í –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ —Å–ø—Ä–æ—Å–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: '–ü–æ–Ω—è—Ç–Ω–æ? –ú–æ–≥—É –æ–±—ä—è—Å–Ω–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ?', '–û–±—ä—è—Å–Ω–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ?', '–•–æ—á–µ—à—å, –æ–±—ä—è—Å–Ω—é –ø–æ–¥—Ä–æ–±–Ω–µ–µ...', '–ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ—Å–ª–æ–∂–Ω–µ–µ?' –∏–ª–∏ –ø–æ—Ö–æ–∂–µ.]"
                    )

            ai_response = await ai_service.generate_response(
                user_message=enhanced_user_message,
                chat_history=history,
                user_age=user.age,
                user_name=user.first_name,
                is_history_cleared=is_history_cleared,
                message_count_since_name=user_message_count,
                skip_name_asking=user.skip_name_asking,
                non_educational_questions_count=user.non_educational_questions_count,
                is_premium=is_premium,
            )

            # –ü—Ä–æ–º–æ–¥–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç AI –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
            ai_response = moderation_service.sanitize_ai_response(ai_response)

            # –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–≤–ª–µ–∫–∞—é—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ—Å–ª–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π
            if visualization_image and visualization_type:
                from bot.services.yandex_ai_response_generator import (
                    add_random_engagement_question,
                )

                ai_response = add_random_engagement_question(ai_response)

            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏—Å—Ç–æ—Ä–∏–∏)
            premium_service.increment_request_count(telegram_id)

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
            history_service.add_message(
                telegram_id=telegram_id, message_text=user_message, message_type="user"
            )

            # –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –±—ã–ª–∞ –æ—á–∏—â–µ–Ω–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–∞–∑–≤–∞–ª –∏–º—è
            if is_history_cleared and not user.first_name and not user.skip_name_asking:
                extracted_name, is_refusal = extract_user_name_from_message(user_message)
                if is_refusal:
                    user.skip_name_asking = True
                    logger.info(
                        "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è –Ω–∞–∑—ã–≤–∞—Ç—å –∏–º—è, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ skip_name_asking"
                    )
                elif extracted_name:
                    user.first_name = extracted_name
                    logger.info(f"‚úÖ –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ: {user.first_name}")

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç AI –≤ –∏—Å—Ç–æ—Ä–∏—é
            history_service.add_message(
                telegram_id=telegram_id, message_text=ai_response, message_type="ai"
            )

            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—é (XP –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è)
            try:
                from bot.services.gamification_service import GamificationService

                gamification_service = GamificationService(db)
                unlocked_achievements = gamification_service.process_message(
                    telegram_id, user_message
                )

                # –ï—Å–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –Ω–æ–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ, —É–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if unlocked_achievements:
                    for achievement_id in unlocked_achievements:
                        # –ù–∞—Ö–æ–¥–∏–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ø–æ ID
                        from bot.services.gamification_service import ALL_ACHIEVEMENTS

                        achievement = next(
                            (a for a in ALL_ACHIEVEMENTS if a.id == achievement_id), None
                        )
                        if achievement:
                            await message.answer(
                                f"üèÜ <b>–ù–æ–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!</b>\n\n"
                                f"{achievement.icon} <b>{achievement.title}</b>\n"
                                f"{achievement.description}\n\n"
                                f"+{achievement.xp_reward} XP üéâ",
                                parse_mode="HTML",
                            )
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏: {e}", exc_info=True)

            logger.info(f"ü§ñ AI –æ—Ç–≤–µ—Ç–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {telegram_id}")

            # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            log_user_activity(telegram_id, "ai_message_sent", True)

            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫—É –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
            try:
                from bot.services.analytics_service import AnalyticsService

                analytics_service = AnalyticsService(db)
                analytics_service.record_education_metric(
                    metric_name="ai_interactions",
                    value=1.0,
                    user_telegram_id=telegram_id,
                )
            except Exception as e:
                logger.debug(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –º–µ—Ç—Ä–∏–∫—É –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è: {e}")

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            message_count = user.message_count

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–±–µ–∑ parse_mode –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        if visualization_image:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–º–µ—Å—Ç–µ —Å —Ç–µ–∫—Å—Ç–æ–º
            from aiogram.types import BufferedInputFile

            photo = BufferedInputFile(visualization_image, filename="visualization.png")
            await message.answer_photo(
                photo=photo,
                caption=ai_response[:1024],  # Telegram –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ caption
            )
            # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω–µ–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            if len(ai_response) > 1024:
                await message.answer(text=ai_response[1024:])
        else:
            await message.answer(
                text=ai_response,
            )

        # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Ñ–æ—Ä–º—É –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ 20-–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        if message_count % 20 == 0 and message_count > 0:
            from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup

            feedback_keyboard = InlineKeyboardMarkup(
                inline_keyboard=[
                    [
                        InlineKeyboardButton(
                            text="üìù –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤",
                            url="https://forms.yandex.ru/cloud/695ba5a6068ff07700f0029a",
                        )
                    ]
                ]
            )

            await message.answer(
                "üéâ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—â–µ–Ω–∏–µ! –ü–æ–¥–µ–ª–∏—Å—å –º–Ω–µ–Ω–∏–µ–º?\n"
                "–¢–≤–æ–π –æ—Ç–∑—ã–≤ –ø–æ–º–æ–∂–µ—Ç —É–ª—É—á—à–∏—Ç—å PandaPal üêº",
                reply_markup=feedback_keyboard,
            )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        log_user_activity(telegram_id, "ai_message_error", False, str(e))

        await message.answer(
            text="–û–π, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –Ω–∞–ø–∏—à–∏ /start"
        )
