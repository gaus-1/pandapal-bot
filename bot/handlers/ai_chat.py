"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±—â–µ–Ω–∏—è —Å AI –¥–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ —á–∞—Ç–∞ PandaPal.

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –±–æ—Ç–∞ - –¥–∏–∞–ª–æ–≥ —Å AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º
PandaPalAI –Ω–∞ –±–∞–∑–µ Yandex Cloud (YandexGPT, SpeechKit, Vision). –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç
–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ —Å –¥–µ—Ç—å–º–∏, –≤–∫–ª—é—á–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.

–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –∏—Ö –∞–Ω–∞–ª–∏–∑
- –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º —Ä–µ—á–∏
- –ê–¥–∞–ø—Ç–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- 5-—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Ç–µ–º
- –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç (6-18 –ª–µ—Ç)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
- –¢–µ–∫—Å—Ç (–æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è)
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∞–Ω–∞–ª–∏–∑ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ)
- –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏)
- –≠–º–æ–¥–∑–∏ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
"""

from aiogram import F, Router
from aiogram.fsm.context import FSMContext
from aiogram.types import Message, PhotoSize
from loguru import logger

from bot.database import get_db
from bot.monitoring import log_user_activity, monitor_performance
from bot.services import ChatHistoryService, ContentModerationService, UserService
from bot.services.ai_service_solid import get_ai_service

# –°–æ–∑–¥–∞—ë–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è AI —á–∞—Ç–∞
router = Router(name="ai_chat")


def _extract_user_name_from_message(user_message: str) -> tuple[str | None, bool]:
    """
    –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è.

    Returns:
        tuple: (–∏–º—è –∏–ª–∏ None, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–∫–∞–∑–æ–º)
    """
    import re

    cleaned_message = user_message.strip().lower()
    cleaned_message = re.sub(r"[.,!?;:]+$", "", cleaned_message)

    refusal_patterns = [
        r"–Ω–µ\s+—Ö–æ—á—É",
        r"–Ω–µ\s+—Å–∫–∞–∂—É",
        r"–Ω–µ\s+–±—É–¥—É",
        r"–Ω–µ\s+–Ω–∞–∑–æ–≤—É",
        r"–Ω–µ\s+—Ö–æ—á—É\s+–Ω–∞–∑—ã–≤–∞—Ç—å",
        r"–Ω–µ\s+–±—É–¥—É\s+–Ω–∞–∑—ã–≤–∞—Ç—å",
        r"–Ω–µ\s+—Ö–æ—á—É\s+–≥–æ–≤–æ—Ä–∏—Ç—å",
        r"–Ω–µ\s+—Å–∫–∞–∂—É\s+–∏–º—è",
        r"–Ω–µ\s+—Ö–æ—á—É\s+—Å–∫–∞–∑–∞—Ç—å",
    ]
    is_refusal = any(re.search(pattern, cleaned_message) for pattern in refusal_patterns)
    if is_refusal:
        return None, True

    common_words = [
        "–¥–∞",
        "–Ω–µ—Ç",
        "–æ–∫",
        "–æ–∫–µ–π",
        "—Ö–æ—Ä–æ—à–æ",
        "—Å–ø–∞—Å–∏–±–æ",
        "–ø—Ä–∏–≤–µ—Ç",
        "–ø–æ–∫–∞",
        "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π",
        "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ",
        "–∫–∞–∫ –¥–µ–ª–∞",
        "—á—Ç–æ",
        "–∫–∞–∫",
        "–ø–æ—á–µ–º—É",
        "–≥–¥–µ",
        "–∫–æ–≥–¥–∞",
        "–∫—Ç–æ",
    ]

    cleaned_for_check = cleaned_message.split()[0] if cleaned_message.split() else cleaned_message

    is_like_name = (
        2 <= len(cleaned_for_check) <= 15
        and re.match(r"^[–∞-—è—ë–ê-–Ø–Åa-zA-Z-]+$", cleaned_for_check)
        and cleaned_for_check not in common_words
        and len(cleaned_message.split()) <= 2
    )

    if is_like_name:
        return cleaned_message.split()[0].capitalize(), False

    return None, False


@router.message(F.text & (F.text == "üí¨ –û–±—â–µ–Ω–∏–µ —Å AI"))
@monitor_performance
async def start_ai_chat(message: Message, state: FSMContext):  # noqa: ARG001
    """
    –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –æ–±—â–µ–Ω–∏—è —Å AI

    Args:
        message: –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        state: FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    """
    await message.answer(
        text="üêº <b>–†–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è —Å AI –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!</b>\n\n"
        "–¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –ø–∏—à–∏ –º–Ω–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî —è –æ—Ç–≤–µ—á—É! üí°",
        parse_mode="HTML",
    )


@router.message(F.text)
@monitor_performance
async def handle_ai_message(message: Message, state: FSMContext):  # noqa: ARG001
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è AI

    –í–ê–ñ–ù–û: –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —è–≤–ª—è–µ—Ç—Å—è —è–¥—Ä–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
    –í–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–Ω—É—é —Ü–µ–ø–æ—á–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ –∏—Å—Ç–æ—Ä–∏–µ–π —á–∞—Ç–∞.
    –ò–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤.

    –ê–ª–≥–æ—Ä–∏—Ç–º:
    1. –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
    2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π (–∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI)
    3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–º–æ–¥–µ—Ä–∞—Ü–∏—è)
    4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ AI —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
    5. –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç
    6. –ü—Ä–æ–º–æ–¥–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç AI
    7. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    8. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

    Args:
        message: –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        state: FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    """
    telegram_id = message.from_user.id
    user_message = message.text

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..."
    await message.bot.send_chat_action(message.chat.id, "typing")

    try:
        # –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
        moderation_service = ContentModerationService()

        # –°–Ω–∞—á–∞–ª–∞ –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        is_safe, reason = moderation_service.is_safe_content(user_message)

        if not is_safe:
            logger.warning(f"üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç {telegram_id}: {reason}")
            moderation_service.log_blocked_content(telegram_id, user_message, reason)
            log_user_activity(telegram_id, "blocked_content", False, reason)

            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–±–∞–∑–æ–≤–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
            try:
                with get_db() as db:
                    user_service = UserService(db)
                    user = user_service.get_user_by_telegram_id(telegram_id)
                    if user and user.user_type == "child":
                        from bot.services.analytics_service import AnalyticsService

                        analytics_service = AnalyticsService(db)
                        analytics_service.record_safety_metric(
                            metric_name="blocked_messages",
                            value=1.0,
                            user_telegram_id=telegram_id,
                            category="basic_moderation",
                        )
            except Exception as e:
                logger.debug(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –º–µ—Ç—Ä–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {e}")

            safe_response = moderation_service.get_safe_response_alternative("blocked_content")
            await message.answer(text=safe_response)
            return

        # –ó–∞—Ç–µ–º –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è
        user_context = {
            "telegram_id": telegram_id,
            "username": message.from_user.username,
            "first_name": message.from_user.first_name,
        }

        try:
            advanced_result = await moderation_service.advanced_moderate_content(
                user_message, user_context
            )

            # –ï—Å–ª–∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –∫–æ–Ω—Ç–µ–Ω—Ç
            if not advanced_result.is_safe:
                logger.warning(
                    f"üö´ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç {telegram_id}: "
                    f"{advanced_result.reason} (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {advanced_result.confidence:.2f})"
                )

                # –õ–æ–≥–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
                log_user_activity(
                    telegram_id,
                    "advanced_blocked_content",
                    False,
                    f"{advanced_result.category.value if advanced_result.category else 'unknown'}: {advanced_result.reason}",
                )

                # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                try:
                    with get_db() as db:
                        from bot.services.analytics_service import AnalyticsService

                        analytics_service = AnalyticsService(db)
                        analytics_service.record_safety_metric(
                            metric_name="blocked_messages",
                            value=1.0,
                            user_telegram_id=telegram_id,
                            category=(
                                advanced_result.category.value
                                if advanced_result.category
                                else "unknown"
                            ),
                        )
                except Exception as e:
                    logger.debug(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –º–µ—Ç—Ä–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {e}")

                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –º–æ–¥–µ—Ä–∞—Ü–∏–∏
                response_text = (
                    advanced_result.alternative_response
                    or moderation_service.get_safe_response_alternative("blocked_content")
                )
                await message.answer(text=response_text)
                return

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π –º–æ–¥–µ—Ä–∞—Ü–∏–∏: {e}")
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –±–∞–∑–æ–≤–æ–π –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏

        # –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
        with get_db() as db:
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã
            user_service = UserService(db)
            history_service = ChatHistoryService(db)

            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user = user_service.get_or_create_user(
                telegram_id=telegram_id,
                username=message.from_user.username,
                first_name=message.from_user.first_name,
                last_name=message.from_user.last_name,
            )

            # –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ Premium –¥–ª—è –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            from bot.services.premium_features_service import PremiumFeaturesService

            premium_service = PremiumFeaturesService(db)
            can_request, limit_reason = premium_service.can_make_ai_request(
                telegram_id, username=message.from_user.username
            )

            if not can_request:
                logger.warning(f"üö´ AI –∑–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥–ª—è user={telegram_id}: {limit_reason}")
                from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup

                keyboard = InlineKeyboardMarkup(
                    inline_keyboard=[
                        [
                            InlineKeyboardButton(
                                text="üíé –£–∑–Ω–∞—Ç—å –æ Premium", callback_data="premium:info"
                            )
                        ]
                    ]
                )

                await message.answer(limit_reason, reply_markup=keyboard, parse_mode="HTML")
                return

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–µ–Ω–∏–≤–æ—Å—Ç–∏ –ø–∞–Ω–¥—ã (–ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞)
            from bot.services.panda_lazy_service import PandaLazyService

            lazy_service = PandaLazyService(db)
            is_lazy, lazy_message = lazy_service.check_and_update_lazy_state(telegram_id)
            if is_lazy and lazy_message:
                logger.info(f"üò¥ –ü–∞–Ω–¥–∞ '–ª–µ–Ω–∏–≤–∞' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                await message.answer(text=lazy_message)
                return

            # –î–ª—è premium - –±–æ–ª—å—à–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            history_limit = 50 if premium_service.is_premium_active(telegram_id) else 10

            # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            history = history_service.get_formatted_history_for_ai(telegram_id, limit=history_limit)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–∏—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞—è)
            is_history_cleared = len(history) == 0

            # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏
            # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ (–∏—â–µ–º –≤ –æ—Ç–≤–µ—Ç–∞—Ö AI)
            user_message_count = 0
            if user.first_name:
                # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ –≤ –æ—Ç–≤–µ—Ç–∞—Ö AI (–∏—â–µ–º –∏–º—è –≤ —Ç–µ–∫—Å—Ç–µ)
                last_name_mention_index = -1
                for i, msg in enumerate(history):
                    if (
                        msg.get("role") == "assistant"
                        and user.first_name.lower() in msg.get("text", "").lower()
                    ):
                        last_name_mention_index = i
                        break

                # –°—á–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ü–û–°–õ–ï –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏
                if last_name_mention_index >= 0:
                    # –ï—Å—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ - —Å—á–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –Ω–µ–≥–æ
                    user_message_count = sum(
                        1
                        for msg in history[last_name_mention_index + 1 :]
                        if msg.get("role") == "user"
                    )
                else:
                    # –ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏ - —Å—á–∏—Ç–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    user_message_count = sum(1 for msg in history if msg.get("role") == "user")
            else:
                # –ù–µ—Ç –∏–º–µ–Ω–∏ - —Å—á–∏—Ç–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                user_message_count = sum(1 for msg in history if msg.get("role") == "user")

            logger.info(
                f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {telegram_id} ({user.first_name}): "
                f"{user_message[:50]}... | –ò—Å—Ç–æ—Ä–∏—è: {len(history)} —Å–æ–æ–±—â–µ–Ω–∏–π | "
                f"–°–æ–æ–±—â–µ–Ω–∏–π —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è: {user_message_count}"
            )

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–ü–∞–Ω–¥–∞ –ø–µ—á–∞—Ç–∞–µ—Ç..."
            await message.bot.send_chat_action(chat_id=message.chat.id, action="typing")

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞ –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –µ—Å–ª–∏ –Ω–µ —Ä—É—Å—Å–∫–∏–π
            from bot.services.translate_service import get_translate_service

            translate_service = get_translate_service()
            detected_lang = await translate_service.detect_language(user_message)

            # –ï—Å–ª–∏ —è–∑—ã–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∏ —ç—Ç–æ –Ω–µ —Ä—É—Å—Å–∫–∏–π, –Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —è–∑—ã–∫
            if (
                detected_lang
                and detected_lang != "ru"
                and detected_lang in translate_service.SUPPORTED_LANGUAGES
            ):
                logger.info(f"üåç –û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫: {detected_lang}")
                # –ü–µ—Ä–µ–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç
                translated_text = await translate_service.translate_text(
                    user_message, target_language="ru", source_language=detected_lang
                )
                if translated_text:
                    lang_name = translate_service.get_language_name(detected_lang)
                    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
                    user_message = (
                        f"üåç –í–∏–∂—É, —á—Ç–æ —Ç—ã –Ω–∞–ø–∏—Å–∞–ª –Ω–∞ {lang_name}!\n\n"
                        f"üìù –û—Ä–∏–≥–∏–Ω–∞–ª: {user_message}\n"
                        f"üá∑üá∫ –ü–µ—Ä–µ–≤–æ–¥: {translated_text}\n\n"
                        f"–û–±—ä—è—Å–Ω–∏ —ç—Ç–æ—Ç –ø–µ—Ä–µ–≤–æ–¥ –∏ –ø–æ–º–æ–≥–∏ –ø–æ–Ω—è—Ç—å –≥—Ä–∞–º–º–∞—Ç–∏–∫—É –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞."
                    )
                    logger.info(f"‚úÖ –¢–µ–∫—Å—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω: {detected_lang} ‚Üí ru")

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º Premium —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            is_premium = premium_service.is_premium_active(telegram_id)

            # –ü–æ–ª—É—á–∞–µ–º AI —Å–µ—Ä–≤–∏—Å (SOLID —Ñ–∞—Å–∞–¥)
            ai_service = get_ai_service()

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–æ–ø—Ä–æ—Å –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º
            educational_keywords = [
                "–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞",
                "–∞–ª–≥–µ–±—Ä–∞",
                "–≥–µ–æ–º–µ—Ç—Ä–∏—è",
                "–∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞",
                "—Ä—É—Å—Å–∫–∏–π",
                "–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞",
                "—Å–æ—á–∏–Ω–µ–Ω–∏–µ",
                "–¥–∏–∫—Ç–∞–Ω—Ç",
                "–∏—Å—Ç–æ—Ä–∏—è",
                "–≥–µ–æ–≥—Ä–∞—Ñ–∏—è",
                "–±–∏–æ–ª–æ–≥–∏—è",
                "—Ñ–∏–∑–∏–∫–∞",
                "—Ö–∏–º–∏—è",
                "–∞–Ω–≥–ª–∏–π—Å–∫–∏–π",
                "–Ω–µ–º–µ—Ü–∫–∏–π",
                "—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π",
                "–∏—Å–ø–∞–Ω—Å–∫–∏–π",
                "–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞",
                "–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ",
                "–∑–∞–¥–∞—á–∞",
                "—Ä–µ—à–∏—Ç—å",
                "—Ä–µ—à–µ–Ω–∏–µ",
                "–ø—Ä–∏–º–µ—Ä",
                "—É—Ä–∞–≤–Ω–µ–Ω–∏–µ",
                "—É—Ä–æ–∫",
                "–¥–æ–º–∞—à–Ω–µ–µ",
                "–∑–∞–¥–∞–Ω–∏–µ",
                "–¥–∑",
                "–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è",
                "–æ–±—ä—è—Å–Ω–∏",
                "–ø–æ–º–æ–≥–∏",
                "–∫–∞–∫ —Ä–µ—à–∏—Ç—å",
                "–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å",
                "—Å–∫–æ–ª—å–∫–æ",
                "–≤—ã—á–∏—Å–ª–∏",
                "–ø–æ—Å—á–∏—Ç–∞–π",
                "–Ω–∞–π–¥–∏",
                "—Ç–∞–±–ª–∏—Ü–∞",
                "—É–º–Ω–æ–∂–µ–Ω–∏–µ",
                "–¥–µ–ª–µ–Ω–∏–µ",
                "—Å–ª–æ–∂–µ–Ω–∏–µ",
                "–≤—ã—á–∏—Ç–∞–Ω–∏–µ",
            ]
            user_message_lower = user_message.lower()
            is_educational = any(keyword in user_message_lower for keyword in educational_keywords)

            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–µ–¥–º–µ—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
            if is_educational:
                # –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                user.non_educational_questions_count = 0
            else:
                # –ï—Å–ª–∏ –Ω–µ–ø—Ä–µ–¥–º–µ—Ç–Ω—ã–π - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                user.non_educational_questions_count += 1

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Å —É—á—ë—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏ –∫–ª–∞—Å—Å–∞
            ai_response = await ai_service.generate_response(
                user_message=user_message,
                chat_history=history,
                user_age=user.age,
                user_name=user.first_name,
                is_history_cleared=is_history_cleared,
                message_count_since_name=user_message_count,
                skip_name_asking=user.skip_name_asking,
                non_educational_questions_count=user.non_educational_questions_count,
                is_premium=is_premium,
            )

            # –ü—Ä–æ–º–æ–¥–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç AI –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
            ai_response = moderation_service.sanitize_ai_response(ai_response)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–∞ –ª–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (—Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è, –≥—Ä–∞—Ñ–∏–∫–∏)
            visualization_image = None
            try:
                from bot.services.visualization_service import get_visualization_service

                viz_service = get_visualization_service()
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–µ—Ç–µ–∫—Ü–∏–∏
                visualization_image = viz_service.detect_visualization_request(user_message)

            except Exception as e:
                logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")

            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏—Å—Ç–æ—Ä–∏–∏)
            premium_service.increment_request_count(telegram_id)

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
            history_service.add_message(
                telegram_id=telegram_id, message_text=user_message, message_type="user"
            )

            # –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –±—ã–ª–∞ –æ—á–∏—â–µ–Ω–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–∞–∑–≤–∞–ª –∏–º—è
            if is_history_cleared and not user.first_name and not user.skip_name_asking:
                extracted_name, is_refusal = _extract_user_name_from_message(user_message)
                if is_refusal:
                    user.skip_name_asking = True
                    logger.info(
                        "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è –Ω–∞–∑—ã–≤–∞—Ç—å –∏–º—è, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ skip_name_asking"
                    )
                elif extracted_name:
                    user.first_name = extracted_name
                    logger.info(f"‚úÖ –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ: {user.first_name}")

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç AI –≤ –∏—Å—Ç–æ—Ä–∏—é
            history_service.add_message(
                telegram_id=telegram_id, message_text=ai_response, message_type="ai"
            )

            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—é (XP –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è)
            try:
                from bot.services.gamification_service import GamificationService

                gamification_service = GamificationService(db)
                unlocked_achievements = gamification_service.process_message(
                    telegram_id, user_message
                )

                # –ï—Å–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –Ω–æ–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ, —É–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if unlocked_achievements:
                    for achievement_id in unlocked_achievements:
                        # –ù–∞—Ö–æ–¥–∏–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ø–æ ID
                        from bot.services.gamification_service import ALL_ACHIEVEMENTS

                        achievement = next(
                            (a for a in ALL_ACHIEVEMENTS if a.id == achievement_id), None
                        )
                        if achievement:
                            await message.answer(
                                f"üèÜ <b>–ù–æ–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!</b>\n\n"
                                f"{achievement.icon} <b>{achievement.title}</b>\n"
                                f"{achievement.description}\n\n"
                                f"+{achievement.xp_reward} XP üéâ",
                                parse_mode="HTML",
                            )
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏: {e}", exc_info=True)

            logger.info(f"ü§ñ AI –æ—Ç–≤–µ—Ç–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {telegram_id}")

            # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            log_user_activity(telegram_id, "ai_message_sent", True)

            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫—É –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
            try:
                from bot.services.analytics_service import AnalyticsService

                analytics_service = AnalyticsService(db)
                analytics_service.record_education_metric(
                    metric_name="ai_interactions",
                    value=1.0,
                    user_telegram_id=telegram_id,
                )
            except Exception as e:
                logger.debug(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –º–µ—Ç—Ä–∏–∫—É –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è: {e}")

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            message_count = user.message_count

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–±–µ–∑ parse_mode –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        if visualization_image:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–º–µ—Å—Ç–µ —Å —Ç–µ–∫—Å—Ç–æ–º
            from aiogram.types import BufferedInputFile

            photo = BufferedInputFile(visualization_image, filename="visualization.png")
            await message.answer_photo(
                photo=photo,
                caption=ai_response[:1024],  # Telegram –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ caption
            )
            # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω–µ–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            if len(ai_response) > 1024:
                await message.answer(text=ai_response[1024:])
        else:
            await message.answer(
                text=ai_response,
            )

        # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Ñ–æ—Ä–º—É –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ 20-–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        if message_count % 20 == 0 and message_count > 0:
            from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup

            feedback_keyboard = InlineKeyboardMarkup(
                inline_keyboard=[
                    [
                        InlineKeyboardButton(
                            text="üìù –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤",
                            url="https://forms.yandex.ru/cloud/695ba5a6068ff07700f0029a",
                        )
                    ]
                ]
            )

            await message.answer(
                "üéâ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—â–µ–Ω–∏–µ! –ü–æ–¥–µ–ª–∏—Å—å –º–Ω–µ–Ω–∏–µ–º?\n"
                "–¢–≤–æ–π –æ—Ç–∑—ã–≤ –ø–æ–º–æ–∂–µ—Ç —É–ª—É—á—à–∏—Ç—å PandaPal üêº",
                reply_markup=feedback_keyboard,
            )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        log_user_activity(telegram_id, "ai_message_error", False, str(e))

        await message.answer(
            text="–û–π, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –Ω–∞–ø–∏—à–∏ /start"
        )


@router.message(F.voice)
async def handle_voice(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

    –í–ê–ñ–ù–û: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yandex SpeechKit –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏.
    –°—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:
    - –§–æ—Ä–º–∞—Ç: OGG Opus (Telegram —Å—Ç–∞–Ω–¥–∞—Ä—Ç)
    - –Ø–∑—ã–∫: ru-RU
    - API: Yandex Cloud SpeechKit STT

    Args:
        message: –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    telegram_id = message.from_user.id

    try:
        logger.info(f"üé§ –ü–æ–ª—É—á–µ–Ω–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {telegram_id}")

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
        processing_msg = await message.answer("üé§ –°–ª—É—à–∞—é —Ç–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏! üêº")

        # –°–∫–∞—á–∏–≤–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        voice_file = await message.bot.get_file(message.voice.file_id)
        voice_bytes = await message.bot.download_file(voice_file.file_path)

        # –ß–∏—Ç–∞–µ–º –±–∞–π—Ç—ã
        audio_data = voice_bytes.read()

        # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
        from bot.services.speech_service import get_speech_service

        speech_service = get_speech_service()

        # –†–∞—Å–ø–æ–∑–Ω–∞–µ–º —Ä–µ—á—å —Å –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —è–∑—ã–∫–∞
        recognized_text = await speech_service.transcribe_voice(
            audio_data,
            language="ru",  # –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
        )

        if not recognized_text:
            await processing_msg.edit_text(
                "üé§ –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å.\n" "–ü–æ–ø—Ä–æ–±—É–π –≥–æ–≤–æ—Ä–∏—Ç—å —á–µ—Ç—á–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º! üìù"
            )
            log_user_activity(telegram_id, "voice_recognition_failed", False, "SpeechKit failed")
            return

        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–ª—É—à–∞—é..."
        await processing_msg.delete()

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞ –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –µ—Å–ª–∏ –Ω–µ —Ä—É—Å—Å–∫–∏–π
        from bot.services.translate_service import get_translate_service

        translate_service = get_translate_service()
        detected_lang = await translate_service.detect_language(recognized_text)

        # –ï—Å–ª–∏ —è–∑—ã–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∏ —ç—Ç–æ –Ω–µ —Ä—É—Å—Å–∫–∏–π, –Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —è–∑—ã–∫
        if (
            detected_lang
            and detected_lang != "ru"
            and detected_lang in translate_service.SUPPORTED_LANGUAGES
        ):
            lang_name = translate_service.get_language_name(detected_lang)
            logger.info(f"üåç –ê—É–¥–∏–æ: –û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫: {detected_lang}")
            # –ü–µ—Ä–µ–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç
            translated_text = await translate_service.translate_text(
                recognized_text, target_language="ru", source_language=detected_lang
            )
            if translated_text:
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±—ã–ª–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –∏ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ
                await message.answer(
                    f'üé§ <i>–Ø —É—Å–ª—ã—à–∞–ª –Ω–∞ {lang_name}:</i> "{recognized_text}"\n'
                    f'üá∑üá∫ <i>–ü–µ—Ä–µ–≤–æ–¥:</i> "{translated_text}"\n\n'
                    f"–°–µ–π—á–∞—Å –æ–±—ä—è—Å–Ω—é –ø–µ—Ä–µ–≤–æ–¥ –∏ –ø–æ–¥—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º... üêº",
                    parse_mode="HTML",
                )
                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
                recognized_text = (
                    f"üåç –í–∏–∂—É, —á—Ç–æ —Ç—ã —Å–∫–∞–∑–∞–ª –Ω–∞ {lang_name}!\n\n"
                    f"üìù –û—Ä–∏–≥–∏–Ω–∞–ª: {recognized_text}\n"
                    f"üá∑üá∫ –ü–µ—Ä–µ–≤–æ–¥: {translated_text}\n\n"
                    f"–û–±—ä—è—Å–Ω–∏ —ç—Ç–æ—Ç –ø–µ—Ä–µ–≤–æ–¥ –∏ –ø–æ–º–æ–≥–∏ –ø–æ–Ω—è—Ç—å –≥—Ä–∞–º–º–∞—Ç–∏–∫—É –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞."
                )
                logger.info(f"‚úÖ –ê—É–¥–∏–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ: {detected_lang} ‚Üí ru")
            else:
                await message.answer(
                    f'üé§ <i>–Ø —É—Å–ª—ã—à–∞–ª:</i> "{recognized_text}"\n\n'
                    f"–°–µ–π—á–∞—Å –ø–æ–¥—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º... üêº",
                    parse_mode="HTML",
                )
        else:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±—ã–ª–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ
            await message.answer(
                f'üé§ <i>–Ø —É—Å–ª—ã—à–∞–ª:</i> "{recognized_text}"\n\n' f"–°–µ–π—á–∞—Å –ø–æ–¥—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º... üêº",
                parse_mode="HTML",
            )

        logger.info(f"‚úÖ –†–µ—á—å —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞: {recognized_text[:100]}")

        # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        log_user_activity(telegram_id, "voice_message_sent", True)

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ø–µ—Ä–µ–¥–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π message —Å bot)
        # –í—Ä–µ–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç –≤ message –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        original_text = message.text
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º __dict__ –¥–ª—è –æ–±—Ö–æ–¥–∞ frozen instance
            object.__setattr__(message, "text", recognized_text)
            await handle_ai_message(message, None)
        finally:
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
            if original_text is not None:
                object.__setattr__(message, "text", original_text)

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        await message.answer(
            "üòî –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.\n"
            "–ü–æ–ø—Ä–æ–±—É–π –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–º! üìù"
        )
        log_user_activity(telegram_id, "voice_processing_error", False, str(e))


@router.message(F.audio)
async def handle_audio(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ (–º—É–∑—ã–∫–∞, —Ç—Ä–µ–∫–∏)

    –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—É –∂–µ –ª–æ–≥–∏–∫—É —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —á—Ç–æ –∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
    Yandex SpeechKit STT —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (voice_file_bytes, language).

    Args:
        message: –ê—É–¥–∏–æ—Ñ–∞–π–ª –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    telegram_id = message.from_user.id

    try:
        logger.info(f"üéµ –ü–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ—Ñ–∞–π–ª –æ—Ç {telegram_id}")

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
        processing_msg = await message.answer("üéµ –°–ª—É—à–∞—é –∞—É–¥–∏–æ—Ñ–∞–π–ª... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏! üêº")

        # –°–∫–∞—á–∏–≤–∞–µ–º –∞—É–¥–∏–æ—Ñ–∞–π–ª
        audio_file = await message.bot.get_file(message.audio.file_id)
        audio_bytes = await message.bot.download_file(audio_file.file_path)

        # –ß–∏—Ç–∞–µ–º –±–∞–π—Ç—ã
        audio_data = audio_bytes.read()

        # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
        from bot.services.speech_service import get_speech_service

        speech_service = get_speech_service()

        # –†–∞—Å–ø–æ–∑–Ω–∞–µ–º —Ä–µ—á—å
        recognized_text = await speech_service.transcribe_voice(
            audio_data,
            language="ru",
        )

        if not recognized_text:
            await processing_msg.edit_text(
                "üéµ –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å –∏–∑ –∞—É–¥–∏–æ.\n"
                "–ü–æ–ø—Ä–æ–±—É–π –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º! üìù"
            )
            log_user_activity(telegram_id, "audio_recognition_failed", False, "SpeechKit failed")
            return

        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–ª—É—à–∞—é..."
        await processing_msg.delete()

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞ –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –µ—Å–ª–∏ –Ω–µ —Ä—É—Å—Å–∫–∏–π
        from bot.services.translate_service import get_translate_service

        translate_service = get_translate_service()
        detected_lang = await translate_service.detect_language(recognized_text)

        # –ï—Å–ª–∏ —è–∑—ã–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∏ —ç—Ç–æ –Ω–µ —Ä—É—Å—Å–∫–∏–π, –Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —è–∑—ã–∫
        if (
            detected_lang
            and detected_lang != "ru"
            and detected_lang in translate_service.SUPPORTED_LANGUAGES
        ):
            lang_name = translate_service.get_language_name(detected_lang)
            logger.info(f"üåç –ê—É–¥–∏–æ: –û–±–Ω–∞—Ä—É–∂–µ–Ω –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫: {detected_lang}")
            # –ü–µ—Ä–µ–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç
            translated_text = await translate_service.translate_text(
                recognized_text, target_language="ru", source_language=detected_lang
            )
            if translated_text:
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±—ã–ª–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –∏ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ
                await message.answer(
                    f'üéµ <i>–Ø —É—Å–ª—ã—à–∞–ª –Ω–∞ {lang_name}:</i> "{recognized_text}"\n'
                    f'üá∑üá∫ <i>–ü–µ—Ä–µ–≤–æ–¥:</i> "{translated_text}"\n\n'
                    f"–°–µ–π—á–∞—Å –æ–±—ä—è—Å–Ω—é –ø–µ—Ä–µ–≤–æ–¥ –∏ –ø–æ–¥—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º... üêº",
                    parse_mode="HTML",
                )
                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
                recognized_text = (
                    f"üåç –í–∏–∂—É, —á—Ç–æ —Ç—ã —Å–∫–∞–∑–∞–ª –Ω–∞ {lang_name}!\n\n"
                    f"üìù –û—Ä–∏–≥–∏–Ω–∞–ª: {recognized_text}\n"
                    f"üá∑üá∫ –ü–µ—Ä–µ–≤–æ–¥: {translated_text}\n\n"
                    f"–û–±—ä—è—Å–Ω–∏ —ç—Ç–æ—Ç –ø–µ—Ä–µ–≤–æ–¥ –∏ –ø–æ–º–æ–≥–∏ –ø–æ–Ω—è—Ç—å –≥—Ä–∞–º–º–∞—Ç–∏–∫—É –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞."
                )
                logger.info(f"‚úÖ –ê—É–¥–∏–æ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ: {detected_lang} ‚Üí ru")
            else:
                await message.answer(
                    f'üéµ <i>–Ø —É—Å–ª—ã—à–∞–ª:</i> "{recognized_text}"\n\n'
                    f"–°–µ–π—á–∞—Å –ø–æ–¥—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º... üêº",
                    parse_mode="HTML",
                )
        else:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±—ã–ª–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ
            await message.answer(
                f'üéµ <i>–Ø —É—Å–ª—ã—à–∞–ª:</i> "{recognized_text}"\n\n' f"–°–µ–π—á–∞—Å –ø–æ–¥—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º... üêº",
                parse_mode="HTML",
            )

        logger.info(f"‚úÖ –†–µ—á—å –∏–∑ –∞—É–¥–∏–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞: {recognized_text[:100]}")

        # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        log_user_activity(telegram_id, "audio_message_sent", True)

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        original_text = message.text
        try:
            object.__setattr__(message, "text", recognized_text)
            await handle_ai_message(message, None)
        finally:
            if original_text is not None:
                object.__setattr__(message, "text", original_text)

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞: {e}")
        await message.answer(
            "üòî –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞.\n" "–ü–æ–ø—Ä–æ–±—É–π –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–º! üìù"
        )
        log_user_activity(telegram_id, "audio_processing_error", False, str(e))


@router.message(F.photo)
@monitor_performance
async def handle_image(message: Message, state: FSMContext):  # noqa: ARG001
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ AI Vision

    –í–ê–ñ–ù–û: –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Yandex Vision OCR –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ.
    –í–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.

    Args:
        message: –°–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
        state: FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        photo: PhotoSize = max(message.photo, key=lambda p: p.file_size)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if photo.file_size > 20 * 1024 * 1024:  # 20MB –ª–∏–º–∏—Ç
            await message.answer(
                "üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ! –ú–∞–∫—Å–∏–º—É–º 20MB. "
                "–ü–æ–ø—Ä–æ–±—É–π —Å–∂–∞—Ç—å —Ñ–æ—Ç–æ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–Ω–æ–≤–∞ üìè"
            )
            return

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        processing_msg = await message.answer("üñºÔ∏è –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏! üêº")

        # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        file = await message.bot.get_file(photo.file_id)
        image_data = await message.bot.download_file(file.file_path)

        # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        image_bytes = image_data.read()

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
        with get_db() as db:
            user_service = UserService(db)
            user = user_service.get_user_by_telegram_id(message.from_user.id)

            if not user:
                await processing_msg.edit_text("‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –∫–æ–º–∞–Ω–¥–æ–π /start")
                return

            # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
            ai_service = get_ai_service()
            history_service = ChatHistoryService(db)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–¥–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            is_safe, reason = await ai_service.moderate_image_content(image_bytes)

            if not is_safe:
                await processing_msg.edit_text(
                    "üö´ –≠—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–µ—Ç–µ–π. "
                    "–ü–æ–ø—Ä–æ–±—É–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ! üêº"
                )
                log_user_activity(message.from_user.id, "image_blocked", False, reason)
                return

            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–ø–∏—Å—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
            caption = message.caption or ""

            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é AI
            ai_response = await ai_service.analyze_image(
                image_data=image_bytes,
                user_message=caption,
                user_age=user.age,
            )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –º–µ—Ç–æ–¥, –±–µ–∑ await)
            history_service.add_message(
                telegram_id=message.from_user.id,
                message_text=f"[–ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï] {caption}" if caption else "[–ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï]",
                message_type="user",
            )

            history_service.add_message(
                telegram_id=message.from_user.id, message_text=ai_response, message_type="ai"
            )

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–∞ –ª–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤ –æ—Ç–≤–µ—Ç–µ AI
            visualization_image = None
            try:
                from bot.services.visualization_service import get_visualization_service

                viz_service = get_visualization_service()
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ AI
                visualization_image = viz_service.detect_visualization_request(ai_response)
            except Exception as e:
                logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ç–æ: {e}")

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π –µ—Å–ª–∏ –µ—Å—Ç—å
            if visualization_image:
                from aiogram.types import BufferedInputFile

                photo = BufferedInputFile(visualization_image, filename="visualization.png")
                await processing_msg.delete()
                await message.answer_photo(
                    photo=photo,
                    caption=ai_response[:1024],  # Telegram –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ caption
                )
                # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω–µ–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                if len(ai_response) > 1024:
                    await message.answer(text=ai_response[1024:])
            else:
                await processing_msg.edit_text(ai_response)

            log_user_activity(
                message.from_user.id, "image_analyzed", True, f"Size: {len(image_bytes)} bytes"
            )

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
        await message.answer(
            "üñºÔ∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. " "–ü–æ–ø—Ä–æ–±—É–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ! üêº"
        )
        log_user_activity(message.from_user.id, "image_error", False, str(e))


@router.message(F.document)
@monitor_performance
async def handle_document(message: Message, state: FSMContext):  # noqa: ARG001
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (PDF, Word –∏ —Ç.–¥.)

    Args:
        message: –°–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º
        state: FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    """
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞
        document = message.document

        # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
        supported_formats = {
            "application/pdf": "PDF",
            "application/msword": "Word",
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document": "Word",
            "text/plain": "–¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª",
        }

        file_type = supported_formats.get(document.mime_type, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 20MB)
        if document.file_size > 20 * 1024 * 1024:
            await message.answer(
                "üìÑ –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 20MB. "
                "–ü–æ–ø—Ä–æ–±—É–π —Å–∂–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –∏–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç üìè"
            )
            return

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
        await message.answer(
            f"üìÑ –ü–æ–ª—É—á–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç: {document.file_name}\n"
            f"–¢–∏–ø: {file_type}\n"
            f"–†–∞–∑–º–µ—Ä: {document.file_size / 1024:.1f} KB\n\n"
            "–î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É. "
            "–ü–æ–∫–∞ –ª—É—á—à–µ —Å–∫–æ–ø–∏—Ä—É–π —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ –∏ –æ—Ç–ø—Ä–∞–≤—å —Ç–µ–∫—Å—Ç–æ–º ‚Äî —è –ø–æ–º–æ–≥—É! üìù"
        )

        # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ø—ã—Ç–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        log_user_activity(
            message.from_user.id,
            "document_upload",
            True,
            f"Type: {file_type}, Size: {document.file_size}",
        )

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {e}")
        await message.answer(
            "üìÑ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞. " "–ü–æ–ø—Ä–æ–±—É–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏! üìù"
        )
        log_user_activity(message.from_user.id, "document_error", False, str(e))
