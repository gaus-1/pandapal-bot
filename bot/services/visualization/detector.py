"""
–î–µ—Ç–µ–∫—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é (SOLID: SRP, OCP).

–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–∞ –ª–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è,
–∑–∞—Ç–µ–º –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
"""

import re

from loguru import logger

try:
    import matplotlib

    matplotlib.use("Agg")
    MATPLOTLIB_AVAILABLE = True
except ImportError:
    MATPLOTLIB_AVAILABLE = False


class VisualizationDetector:
    """
    –î–µ—Ç–µ–∫—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é.

    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–æ–π —Ç–∏–ø –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω—É–∂–µ–Ω.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ —Ç–∞–±–ª–∏—Ü—ã/–≥—Ä–∞—Ñ–∏–∫–∞.
    """

    def __init__(self, viz_service):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞.

        Args:
            viz_service: –≠–∫–∑–µ–º–ø–ª—è—Ä VisualizationService —Å –º–µ—Ç–æ–¥–∞–º–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        """
        self.viz_service = viz_service

    def detect(self, text: str) -> tuple[bytes | None, str | None]:
        """
        –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.

        –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ —è–≤–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ:
        - –ü–û–ö–ê–ñ–ò, –ù–ê–†–ò–°–£–ô, –í–´–í–ï–î–ò, –û–¢–û–ë–†–ê–ó–ò, –ö–ê–ö –í–´–ì–õ–Ø–î–ò–¢ –∏ —Ç.–¥.
        - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –û–ë–™–Ø–°–ù–ò–¢–¨ –∏–ª–∏ –†–ê–°–°–ö–ê–ó–ê–¢–¨ - –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é

        Args:
            text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

        Returns:
            tuple: (–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ None, –¢–∏–ø –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ None)
                   –¢–∏–ø—ã: "table", "graph", "bar", "pie", "line", "histogram", "scatter", "box", "bubble", "heatmap"
        """
        if not MATPLOTLIB_AVAILABLE:
            return None, None

        text_lower = text.lower()

        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —è–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        # –°–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        # –£–õ–£–ß–®–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –ø—Ä–∏–º–µ—Ä–∞ –¥–ª—è –ª—É—á—à–µ–π –¥–µ—Ç–µ–∫—Ü–∏–∏
        visualization_request_words = [
            "–ø–æ–∫–∞–∂–∏",
            "–Ω–∞—Ä–∏—Å—É–π",
            "–≤—ã–≤–µ–¥–∏",
            "–æ—Ç–æ–±—Ä–∞–∑–∏",
            "–ø–æ–∫–∞–∂–∏ –º–Ω–µ",
            "–Ω–∞—Ä–∏—Å—É–π –º–Ω–µ",
            "–≤—ã–≤–µ–¥–∏ –º–Ω–µ",
            "–∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç",
            "–ø–æ–∫–∞–∂–∏ –∫–∞–∫",
            "–Ω–∞—Ä–∏—Å—É–π –∫–∞–∫",
            "–∏–∑–æ–±—Ä–∞–∑–∏",
            "—Å–æ–∑–¥–∞–π",
            "—Å–¥–µ–ª–∞–π",
            "–ø–æ—Å—Ç—Ä–æ–π",
            "–ø–æ—Å—Ç—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫",
            "–ø–æ—Å—Ç—Ä–æ–π —Ç–∞–±–ª–∏—Ü—É",
            "–Ω–∞—á–µ—Ä—Ç–∏",
            "–Ω–∞—á–µ—Ä—Ç–∏ –≥—Ä–∞—Ñ–∏–∫",
            "–ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–π",
            "–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–π",
            "–≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–π",
            "–≤–∏–∑—É–∞–ª–∏–∑",
            "—Å–æ–∑–¥–∞–π –≥—Ä–∞—Ñ–∏–∫",
            "—Å–æ–∑–¥–∞–π –¥–∏–∞–≥—Ä–∞–º–º—É",
            "—Å–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É",
            "–ø–æ—Å—Ç—Ä–æ–π –¥–∏–∞–≥—Ä–∞–º–º—É",
            "–Ω–∞—Ä–∏—Å—É–π –≥—Ä–∞—Ñ–∏–∫",
            "–Ω–∞—Ä–∏—Å—É–π –¥–∏–∞–≥—Ä–∞–º–º—É",
            "–Ω–∞—Ä–∏—Å—É–π —Ç–∞–±–ª–∏—Ü—É",
            "–ø–æ–∫–∞–∂–∏ –≥—Ä–∞—Ñ–∏–∫",
            "–ø–æ–∫–∞–∂–∏ –¥–∏–∞–≥—Ä–∞–º–º—É",
            "–ø–æ–∫–∞–∂–∏ —Ç–∞–±–ª–∏—Ü—É",
            "–≤—ã–≤–µ–¥–∏ –≥—Ä–∞—Ñ–∏–∫",
            "–≤—ã–≤–µ–¥–∏ –¥–∏–∞–≥—Ä–∞–º–º—É",
            "–≤—ã–≤–µ–¥–∏ —Ç–∞–±–ª–∏—Ü—É",
            "–æ—Ç–æ–±—Ä–∞–∑–∏ –≥—Ä–∞—Ñ–∏–∫",
            "–æ—Ç–æ–±—Ä–∞–∑–∏ –¥–∏–∞–≥—Ä–∞–º–º—É",
            "–æ—Ç–æ–±—Ä–∞–∑–∏ —Ç–∞–±–ª–∏—Ü—É",
            "—Å–æ—Å—Ç–∞–≤—å",
            "—Å–æ—Å—Ç–∞–≤—å —Ç–∞–±–ª–∏—Ü—É",
            "—Å–æ—Å—Ç–∞–≤—å –≥—Ä–∞—Ñ–∏–∫",
            "—Å–æ—Å—Ç–∞–≤—å –¥–∏–∞–≥—Ä–∞–º–º—É",
            "–ø–æ—Å—Ç—Ä–æ–π –∫–∞—Ä—Ç—É",
            "–ø–æ–∫–∞–∂–∏ –∫–∞—Ä—Ç—É",
            "–Ω–∞—Ä–∏—Å—É–π –∫–∞—Ä—Ç—É",
            "—Å–æ–∑–¥–∞–π –∫–∞—Ä—Ç—É",
            # –£–õ–£–ß–®–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
            "–≥—Ä–∞—Ñ–∏–∫",
            "–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å",
            "–ø—Ä—è–º–∞—è",
            "–∫—Ä–∏–≤–∞—è",
            "–ø–∞—Ä–∞–±–æ–ª–∞",
            "–≥–∏–ø–µ—Ä–±–æ–ª–∞",
            "—Å–∏–Ω—É—Å–æ–∏–¥–∞",
            "–Ω–∞–∫–ª–æ–Ω–Ω–∞—è",
            "–ª–∏–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞",
            # –£–õ–£–ß–®–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º
            "–¥–∏–∞–≥—Ä–∞–º–º–∞",
            "—Å—Ç–æ–ª–±—á–∞—Ç–∞—è",
            "–∫—Ä—É–≥–æ–≤–∞—è",
            "—Å—Ç–æ–ª–±–∏–∫",
            "—Å–µ–∫—Ç–æ—Ä",
            "–∫–ª–∏–º–∞—Ç–æ–≥—Ä–∞–º–º–∞",
            # –£–õ–£–ß–®–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∫–∞—Ä—Ç
            "—Å—Ö–µ–º–∞ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏",
            "–∫–∞—Ä—Ç–∞ –ø–æ–ª—É—à–∞—Ä–∏–π",
            "—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞",
            "–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞",
            "—Ç–æ–ø–æ–≥—Ä–∞—Ñ",
            # –£–õ–£–ß–®–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Å—Ö–µ–º/—á–µ—Ä—Ç–µ–∂–µ–π
            "—Å—Ö–µ–º–∞",
            "—á–µ—Ä—Ç–µ–∂",
            "—Ä–∏—Å—É–Ω–æ–∫",
            "–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
            "—Å—Ç—Ä–æ–µ–Ω–∏–µ",
            "—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ",
            "–ø–ª–∞–Ω",
            "—Ä–∞–∑—Ä–µ–∑",
            # –£–õ–£–ß–®–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü
            "—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ",
            "—Å–≤–æ–¥–Ω–∞—è",
            "—Ä–µ—à–µ—Ç–æ –ø–µ–Ω–Ω–µ—Ç–∞",
            "–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞",
            # –ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∏
            "show",
            "draw",
            "create",
            "make",
            "build",
            "display",
            "visualize",
            "chart",
            "graph",
            "table",
            "diagram",
            "map",
        ]

        # –°–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å –û–ë–™–Ø–°–ù–ï–ù–ò–Ø (–ù–ï –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏)
        explanation_request_words = [
            "–æ–±—ä—è—Å–Ω–∏",
            "—Ä–∞—Å—Å–∫–∞–∂–∏",
            "—á—Ç–æ —Ç–∞–∫–æ–µ",
            "—á—Ç–æ –∑–Ω–∞—á–∏—Ç",
            "—á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç",
            "–æ–ø–∏—à–∏",
            "—Ä–∞—Å—Ç–æ–ª–∫—É–π",
            "—Ä–∞–∑—ä—è—Å–Ω–∏",
            "–ø–æ–º–æ–≥–∏ –ø–æ–Ω—è—Ç—å",
            "–ø–æ–º–æ–≥–∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è",
            "–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç",
            "–∫–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–æ",
            "–∫–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç",
            "–≤ —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞",
            "—á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è",
        ]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —è–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        has_visualization_request = any(word in text_lower for word in visualization_request_words)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
        has_explanation_request = any(word in text_lower for word in explanation_request_words)

        # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ü–†–ê–í–ò–õ–û:
        # 1. –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ë–ï–ó –∑–∞–ø—Ä–æ—Å–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ - –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
        # 2. –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º (–¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è)
        # 3. –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ —Ç–æ–≥–æ, –Ω–∏ –¥—Ä—É–≥–æ–≥–æ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç (—Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è, –≥—Ä–∞—Ñ–∏–∫ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Ç.–¥.)

        # –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ë–ï–ó –∑–∞–ø—Ä–æ—Å–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ - –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
        if has_explanation_request and not has_visualization_request:
            logger.debug("üîç –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –±–µ–∑ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é")
            return None, None

        # –ö–†–ò–¢–ò–ß–ù–û: –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –¥–∏–∞–≥—Ä–∞–º–º (–µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏)
        # –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –î–û –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–µ–∫—Ü–∏—é
        if has_visualization_request:
            # 39. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –¥–∏–∞–≥—Ä–∞–º–º (—Å—Ç–æ–ª–±—á–∞—Ç–∞—è, –∫—Ä—É–≥–æ–≤–∞—è, –ª–∏–Ω–µ–π–Ω–∞—è, –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞, —Ä–∞—Å—Å–µ—è–Ω–∏—è)
            # –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–∏–ø–∞
            # –£–õ–£–ß–®–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–∏–ø–∞ "–ø–æ–∫–∞–∂–∏ –¥–∏–∞–≥—Ä–∞–º–º—É" –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —Ç–∏–ø–∞
            diagram_type_patterns = {
                "—Å—Ç–æ–ª–±—á–∞—Ç": ("bar", self.viz_service.generate_bar_chart),
                "—Å—Ç–æ–ª–±—á–∞—Ç–∞—è": ("bar", self.viz_service.generate_bar_chart),
                "—Å—Ç–æ–ª–±—á–∞—Ç—É—é": ("bar", self.viz_service.generate_bar_chart),
                "–∫—Ä—É–≥–æ–≤–∞—è": ("pie", self.viz_service.generate_pie_chart),
                "–∫—Ä—É–≥–æ–≤—É—é": ("pie", self.viz_service.generate_pie_chart),
                "–∫—Ä—É–≥–æ–≤": ("pie", self.viz_service.generate_pie_chart),
                "–∫—Ä—É–≥–æ–≤–æ–π": ("pie", self.viz_service.generate_pie_chart),
                "–ª–∏–Ω–µ–π–Ω": ("line", self.viz_service.generate_line_chart),
                "–ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫": ("line", self.viz_service.generate_line_chart),
                "–ª–∏–Ω–µ–π–Ω—É—é": ("line", self.viz_service.generate_line_chart),
                "–ª–∏–Ω–µ–π–Ω–æ–≥–æ": ("line", self.viz_service.generate_line_chart),
                "–≥–∏—Å—Ç–æ–≥—Ä–∞–º–º": ("histogram", self.viz_service.generate_histogram),
                "–≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É": ("histogram", self.viz_service.generate_histogram),
                "–≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã": ("histogram", self.viz_service.generate_histogram),
                "—Ä–∞—Å—Å–µ—è–Ω–∏": ("scatter", self.viz_service.generate_scatter_plot),
                "—Ä–∞—Å—Å–µ—è–Ω–∏—è": ("scatter", self.viz_service.generate_scatter_plot),
                "—Ç–æ—á–µ—á–Ω": ("scatter", self.viz_service.generate_scatter_plot),
                "—Ç–æ—á–µ—á–Ω—É—é": ("scatter", self.viz_service.generate_scatter_plot),
                "—è—â–∏–∫ —Å —É—Å–∞–º–∏": ("box", self.viz_service.generate_box_plot),
                "—è—â–∏–∫": ("box", self.viz_service.generate_box_plot),
                "box plot": ("box", self.viz_service.generate_box_plot),
                "–ø—É–∑—ã—Ä—å–∫–æ–≤": ("bubble", self.viz_service.generate_bubble_chart),
                "–ø—É–∑—ã—Ä—å–∫–æ–≤—É—é": ("bubble", self.viz_service.generate_bubble_chart),
                "—Ç–µ–ø–ª–æ–≤": ("heatmap", self.viz_service.generate_heatmap),
                "—Ç–µ–ø–ª–æ–≤—É—é": ("heatmap", self.viz_service.generate_heatmap),
                "heatmap": ("heatmap", self.viz_service.generate_heatmap),
            }

            # –£–õ–£–ß–®–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –¥–∏–∞–≥—Ä–∞–º–º—É (–±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —Ç–∏–ø–∞)
            # –ù–∞–ø—Ä–∏–º–µ—Ä: "–Ω–∞—Ä–∏—Å—É–π –∑–∞–¥–∞—á—É –∏ –ø–æ–∫–∞–∂–∏ –¥–∏–∞–≥—Ä–∞–º–º—É" - –¥–æ–ª–∂–Ω–∞ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
            general_diagram_patterns = [
                r"–ø–æ–∫–∞–∂–∏\s+–¥–∏–∞–≥—Ä–∞–º–º",
                r"–Ω–∞—Ä–∏—Å—É–π\s+–¥–∏–∞–≥—Ä–∞–º–º",
                r"—Å–æ–∑–¥–∞–π\s+–¥–∏–∞–≥—Ä–∞–º–º",
                r"–ø–æ—Å—Ç—Ä–æ–π\s+–¥–∏–∞–≥—Ä–∞–º–º",
                r"–≤—ã–≤–µ–¥–∏\s+–¥–∏–∞–≥—Ä–∞–º–º",
                r"–æ—Ç–æ–±—Ä–∞–∑–∏\s+–¥–∏–∞–≥—Ä–∞–º–º",
                r"–ø–æ–∫–∞–∂–∏\s+–∫\s+–Ω–µ–π\s+–¥–∏–∞–≥—Ä–∞–º–º",
                r"–ø–æ–∫–∞–∂–∏\s+–∫\s+–Ω–µ–π\s+–∫—Ä—É–≥–æ–≤—É—é",
                r"–ø–æ–∫–∞–∂–∏\s+–∫\s+–∑–∞–¥–∞—á–µ\s+–¥–∏–∞–≥—Ä–∞–º–º",
            ]

            has_general_diagram_request = any(
                re.search(pattern, text_lower) for pattern in general_diagram_patterns
            )

            # –ï—Å–ª–∏ –µ—Å—Ç—å –æ–±—â–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–∏–∞–≥—Ä–∞–º–º—É –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è —Ç–∏–ø–∞ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫—Ä—É–≥–æ–≤—É—é (pie)
            if has_general_diagram_request and not any(
                keyword in text_lower for keyword in diagram_type_patterns
            ):
                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫—Ä—É–≥–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É —Å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                try:
                    demo_data = {
                        "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞": 30,
                        "–†—É—Å—Å–∫–∏–π": 25,
                        "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π": 20,
                        "–§–∏–∑–∏–∫–∞": 15,
                        "–•–∏–º–∏—è": 10,
                    }
                    image = self.viz_service.generate_pie_chart(demo_data, "–î–∏–∞–≥—Ä–∞–º–º–∞")
                    if image:
                        logger.info(
                            "üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –æ–±—â–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–∏–∞–≥—Ä–∞–º–º—É, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∫—Ä—É–≥–æ–≤–∞—è"
                        )
                        return image, "pie"
                except Exception as e:
                    logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã: {e}")

            for keyword, (diagram_type, generator_func) in diagram_type_patterns.items():
                if keyword in text_lower:
                    # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
                    # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º –ø—Ä–∏–º–µ—Ä–Ω—É—é –¥–∏–∞–≥—Ä–∞–º–º—É —Å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                    try:
                        if diagram_type == "bar":
                            # –ü—Ä–∏–º–µ—Ä: —Å—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö
                            demo_data = {
                                "–Ø–±–ª–æ–∫–∏": 25,
                                "–ë–∞–Ω–∞–Ω—ã": 18,
                                "–ê–ø–µ–ª—å—Å–∏–Ω—ã": 22,
                                "–ì—Ä—É—à–∏": 15,
                                "–í–∏–Ω–æ–≥—Ä–∞–¥": 20,
                            }
                            image = generator_func(demo_data, "–ü—Ä–∏–º–µ—Ä —Å—Ç–æ–ª–±—á–∞—Ç–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã")
                        elif diagram_type == "pie":
                            # –ü—Ä–∏–º–µ—Ä: –∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Å –¥–æ–ª—è–º–∏
                            demo_data = {
                                "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞": 30,
                                "–†—É—Å—Å–∫–∏–π": 25,
                                "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π": 20,
                                "–§–∏–∑–∏–∫–∞": 15,
                                "–•–∏–º–∏—è": 10,
                            }
                            image = generator_func(demo_data, "–ü—Ä–∏–º–µ—Ä –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã")
                        elif diagram_type == "line":
                            # –ü—Ä–∏–º–µ—Ä: –ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
                            x_data = list(range(1, 13))  # –ú–µ—Å—è—Ü—ã
                            y_data = [-5, -3, 2, 10, 18, 22, 24, 23, 16, 8, 2, -2]  # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
                            image = generator_func(
                                x_data,
                                y_data,
                                "–ü—Ä–∏–º–µ—Ä –ª–∏–Ω–µ–π–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞",
                                "–ú–µ—Å—è—Ü",
                                "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)",
                            )
                        elif diagram_type == "histogram":
                            # –ü—Ä–∏–º–µ—Ä: –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–æ–∫
                            demo_data = [3, 4, 4, 5, 5, 5, 4, 3, 5, 4, 5, 4, 3, 5, 4, 5, 5, 4, 3, 4]
                            image = generator_func(
                                demo_data, 5, "–ü—Ä–∏–º–µ—Ä –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã", "–û—Ü–µ–Ω–∫–∞", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"
                            )
                        elif diagram_type == "scatter":
                            # –ü—Ä–∏–º–µ—Ä: –¥–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å—Å–µ—è–Ω–∏—è —Ä–æ—Å—Ç–∞ –∏ –≤–µ—Å–∞
                            x_data = [150, 155, 160, 165, 170, 175, 180, 185, 190]
                            y_data = [45, 50, 55, 60, 65, 70, 75, 80, 85]
                            image = generator_func(
                                x_data,
                                y_data,
                                "–ü—Ä–∏–º–µ—Ä –¥–∏–∞–≥—Ä–∞–º–º—ã —Ä–∞—Å—Å–µ—è–Ω–∏—è",
                                "–†–æ—Å—Ç (—Å–º)",
                                "–í–µ—Å (–∫–≥)",
                            )
                        elif diagram_type == "box":
                            # –ü—Ä–∏–º–µ—Ä: —è—â–∏–∫ —Å —É—Å–∞–º–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                            demo_data = {
                                "–ì—Ä—É–ø–ø–∞ A": [65, 70, 72, 75, 78, 80, 82, 85, 88, 90],
                                "–ì—Ä—É–ø–ø–∞ B": [60, 65, 68, 70, 72, 75, 78, 80, 82, 85],
                                "–ì—Ä—É–ø–ø–∞ C": [70, 75, 78, 80, 82, 85, 88, 90, 92, 95],
                            }
                            image = generator_func(demo_data, "–ü—Ä–∏–º–µ—Ä —è—â–∏–∫–∞ —Å —É—Å–∞–º–∏", "–û—Ü–µ–Ω–∫–∞")
                        elif diagram_type == "bubble":
                            # –ü—Ä–∏–º–µ—Ä: –ø—É–∑—ã—Ä—å–∫–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Å—Ç—Ä–∞–Ω (–Ω–∞—Å–µ–ª–µ–Ω–∏–µ, –í–í–ü, –ø–ª–æ—â–∞–¥—å)
                            x_data = [1.4, 1.3, 0.3, 0.2, 0.1]  # –ù–∞—Å–µ–ª–µ–Ω–∏–µ (–º–ª—Ä–¥)
                            y_data = [14, 4, 3, 2, 1]  # –í–í–ü (—Ç—Ä–ª–Ω $)
                            sizes = [9.6, 3.3, 0.9, 0.8, 0.5]  # –ü–ª–æ—â–∞–¥—å (–º–ª–Ω –∫–º¬≤)
                            labels = ["–ö–∏—Ç–∞–π", "–ò–Ω–¥–∏—è", "–°–®–ê", "–ò–Ω–¥–æ–Ω–µ–∑–∏—è", "–ü–∞–∫–∏—Å—Ç–∞–Ω"]
                            image = generator_func(
                                x_data,
                                y_data,
                                sizes,
                                labels,
                                "–ü—Ä–∏–º–µ—Ä –ø—É–∑—ã—Ä—å–∫–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã",
                                "–ù–∞—Å–µ–ª–µ–Ω–∏–µ (–º–ª—Ä–¥)",
                                "–í–í–ü (—Ç—Ä–ª–Ω $)",
                            )
                        elif diagram_type == "heatmap":
                            # –ü—Ä–∏–º–µ—Ä: —Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –ø–æ –¥–Ω—è–º –∏ —á–∞—Å–∞–º
                            demo_data = {
                                "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫": {"9:00": 45, "12:00": 60, "15:00": 50, "18:00": 40},
                                "–í—Ç–æ—Ä–Ω–∏–∫": {"9:00": 50, "12:00": 65, "15:00": 55, "18:00": 45},
                                "–°—Ä–µ–¥–∞": {"9:00": 48, "12:00": 70, "15:00": 58, "18:00": 42},
                                "–ß–µ—Ç–≤–µ—Ä–≥": {"9:00": 52, "12:00": 68, "15:00": 60, "18:00": 48},
                                "–ü—è—Ç–Ω–∏—Ü–∞": {"9:00": 40, "12:00": 55, "15:00": 45, "18:00": 35},
                            }
                            image = generator_func(demo_data, title="–ü—Ä–∏–º–µ—Ä —Ç–µ–ø–ª–æ–≤–æ–π –∫–∞—Ä—Ç—ã")

                        if image:
                            logger.info(f"üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ {diagram_type} –¥–∏–∞–≥—Ä–∞–º–º—É")
                            return image, diagram_type

                    except Exception as e:
                        logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ {diagram_type} –¥–∏–∞–≥—Ä–∞–º–º—ã: {e}")
                        continue

        # –ï—Å–ª–∏ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        # (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤, –≥–¥–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –æ—á–µ–≤–∏–¥–Ω–∞)
        if not has_visualization_request:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –æ—á–µ–Ω—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –≥–¥–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –æ—á–µ–≤–∏–¥–Ω–∞
            # –ù–∞–ø—Ä–∏–º–µ—Ä: "—Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è –Ω–∞ 5" - –æ—á–µ–≤–∏–¥–Ω–æ –Ω—É–∂–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞
            # –ù–æ "—á—Ç–æ —Ç–∞–∫–æ–µ —Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è" - –Ω—É–∂–µ–Ω —Ç–µ–∫—Å—Ç, –Ω–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
            context_visualization_patterns = [
                r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s*—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]\s*–Ω–∞\s*\d+",  # "—Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è –Ω–∞ 5"
                r"–≥—Ä–∞—Ñ–∏–∫\s+—Ñ—É–Ω–∫—Ü–∏[–∏–∏]",  # "–≥—Ä–∞—Ñ–∏–∫ —Ñ—É–Ω–∫—Ü–∏–∏"
                r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=",  # "–≥—Ä–∞—Ñ–∏–∫ y = x"
                r"–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è\s+—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s*–º–µ–Ω–¥–µ–ª–µ–µ–≤–∞",  # "–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ú–µ–Ω–¥–µ–ª–µ–µ–≤–∞"
            ]

            has_context_pattern = any(
                re.search(pattern, text_lower) for pattern in context_visualization_patterns
            )

            # –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ - –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            if not has_context_pattern:
                logger.debug(
                    "üîç –ù–µ—Ç —è–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
                )
                return None, None

        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Å–Ω–∞—á–∞–ª–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –∑–∞—Ç–µ–º –æ–±—â–∏–µ
        # –ü—Ä–∞–≤–∏–ª–æ: –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —Ä–∞–Ω—å—à–µ –æ–±—â–∏—Ö

        # 1. –¢–∞–±–ª–∏—Ü–∞ —Å–æ–ø—Ä—è–∂–µ–Ω–∏—è/—Å–ø—Ä—è–∂–µ–Ω–∏—è –≥–ª–∞–≥–æ–ª–æ–≤ (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å)
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ü–ï–†–í–û–ô, —Ç–∞–∫ –∫–∞–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–ª–æ–≤–∞ "—Å–æ–ø—Ä—è–∂–µ–Ω–∏–µ/—Å–ø—Ä—è–∂–µ–Ω–∏–µ" + "–≥–ª–∞–≥–æ–ª"
        verb_patterns = [
            r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+—Å–æ–ø—Ä—è–∂–µ–Ω–∏[—è–µ]\s+–≥–ª–∞–≥–æ–ª",
            r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+—Å–ø—Ä—è–∂–µ–Ω–∏[—è–µ]\s+–≥–ª–∞–≥–æ–ª",
            r"—Å–æ–ø—Ä—è–∂–µ–Ω–∏[—è–µ]\s+–≥–ª–∞–≥–æ–ª",
            r"—Å–ø—Ä—è–∂–µ–Ω–∏[—è–µ]\s+–≥–ª–∞–≥–æ–ª",
            # –ë–æ–ª–µ–µ –æ–±—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å–ª–æ–≤)
            r"(?<!—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ])(?<!—Å–ª–æ–∂–µ–Ω–∏[—è–µ])(?<!–≤—ã—á–∏—Ç–∞–Ω–∏[—è–µ])(?<!–¥–µ–ª–µ–Ω–∏[—è–µ])—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+—Å–æ–ø—Ä—è–∂–µ–Ω–∏[—è–µ]",
            r"(?<!—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ])(?<!—Å–ª–æ–∂–µ–Ω–∏[—è–µ])(?<!–≤—ã—á–∏—Ç–∞–Ω–∏[—è–µ])(?<!–¥–µ–ª–µ–Ω–∏[—è–µ])—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+—Å–ø—Ä—è–∂–µ–Ω–∏[—è–µ]",
        ]
        for pattern in verb_patterns:
            if re.search(pattern, text_lower):
                image = self.viz_service.generate_russian_verb_conjugation_table()
                if image:
                    logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–ø—Ä—è–∂–µ–Ω–∏—è/—Å–æ–ø—Ä—è–∂–µ–Ω–∏—è –≥–ª–∞–≥–æ–ª–æ–≤")
                    return image, "table"

        # 2. –ê–ª–≥–µ–±—Ä–∞: —Å—Ç–µ–ø–µ–Ω–∏ 2 –∏ 10
        if "—Å—Ç–µ–ø–µ–Ω" in text_lower and (
            "2" in text_lower or "10" in text_lower or "–¥–≤–æ–π–∫" in text_lower or "–¥–≤–∞" in text_lower
        ):
            image = self.viz_service.generate_powers_of_2_and_10_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç–µ–ø–µ–Ω–µ–π —á–∏—Å–µ–ª 2 –∏ 10")
                return image, "table"

        # 3. –ü—Ä–æ—Å—Ç—ã–µ —á–∏—Å–ª–∞
        if (
            ("–ø—Ä–æ—Å—Ç" in text_lower and "—á–∏—Å–ª" in text_lower)
            or "—Ä–µ—à–µ—Ç–æ" in text_lower
            or "—ç—Ä–∞—Ç–æ—Å—Ñ–µ–Ω" in text_lower
        ):
            image = self.viz_service.generate_prime_numbers_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ—Å—Ç—ã—Ö —á–∏—Å–µ–ª")
                return image, "table"

        # 4. –§–æ—Ä–º—É–ª—ã —Å–æ–∫—Ä–∞—â–µ–Ω–Ω–æ–≥–æ —É–º–Ω–æ–∂–µ–Ω–∏—è
        if re.search(
            r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:—Ñ–æ—Ä–º—É–ª[—ã]?\s+—Å–æ–∫—Ä–∞—â–µ–Ω–Ω|—Å–æ–∫—Ä–∞—â–µ–Ω–Ω[–æ–µ]?\s+—É–º–Ω–æ–∂–µ–Ω)",
            text_lower,
        ):
            image = self.viz_service.generate_abbreviated_multiplication_formulas_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Ñ–æ—Ä–º—É–ª —Å–æ–∫—Ä–∞—â–µ–Ω–Ω–æ–≥–æ —É–º–Ω–æ–∂–µ–Ω–∏—è")
                return image, "table"

        # 5. –°–≤–æ–π—Å—Ç–≤–∞ —Å—Ç–µ–ø–µ–Ω–µ–π
        if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:—Å–≤–æ–π—Å—Ç–≤[–∞]?\s+—Å—Ç–µ–ø–µ–Ω)", text_lower):
            image = self.viz_service.generate_power_properties_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–≤–æ–π—Å—Ç–≤ —Å—Ç–µ–ø–µ–Ω–µ–π")
                return image, "table"

        # 6. –°–≤–æ–π—Å—Ç–≤–∞ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –∫–æ—Ä–Ω—è
        if re.search(
            r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:—Å–≤–æ–π—Å—Ç–≤[–∞]?\s+–∫–æ—Ä–Ω|–∫–≤–∞–¥—Ä–∞—Ç–Ω[—ã–π]?\s+–∫–æ—Ä–µ–Ω)", text_lower
        ):
            image = self.viz_service.generate_square_root_properties_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–≤–æ–π—Å—Ç–≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –∫–æ—Ä–Ω—è")
                return image, "table"

        # 7. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥ —á–∏—Å–ª–∞
        if "—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω" in text_lower and "–≤–∏–¥" in text_lower:
            image = self.viz_service.generate_standard_form_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –≤–∏–¥–∞ —á–∏—Å–ª–∞")
                return image, "table"

        # 8. –ö–≤–∞–¥—Ä–∞—Ç—ã –∏ –∫—É–±—ã (–¥–æ —Ç–∞–±–ª–∏—Ü—ã —É–º–Ω–æ–∂–µ–Ω–∏—è)
        if ("–∫–≤–∞–¥—Ä–∞—Ç" in text_lower and "–∫—É–±" in text_lower) and "—É–º–Ω–æ–∂" not in text_lower:
            image = self.viz_service.generate_squares_and_cubes_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ –∏ –∫—É–±–æ–≤")
                return image, "table"

        # 9. –ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è (–±–µ–∑ —á–∏—Å–ª–∞)
        # –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —è–≤–Ω–æ–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ "—É–º–Ω–æ–∂–µ–Ω–∏—è"
        # –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª—É—á–∞–∏ —Å –¥—Ä—É–≥–∏–º–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏ (–≥–ª–∞–≥–æ–ª—ã, –ø–∞–¥–µ–∂–∏ –∏ —Ç.–¥.)
        has_table = "—Ç–∞–±–ª" in text_lower
        has_multiply = "—É–º–Ω–æ–∂" in text_lower
        has_number_pattern = re.search(r"—É–º–Ω–æ–∂[–∞-—è]*\s+–Ω–∞\s+\d+", text_lower)
        # –ò—Å–∫–ª—é—á–∞–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (–≥–ª–∞–≥–æ–ª—ã, –ø–∞–¥–µ–∂–∏, –∞–ª—Ñ–∞–≤–∏—Ç –∏ —Ç.–¥.)
        has_specific_table = re.search(
            r"(?:–≥–ª–∞–≥–æ–ª|–ø–∞–¥–µ–∂|–∞–ª—Ñ–∞–≤–∏—Ç|–±—É–∫–≤|–∑–≤—É–∫|–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ|–ø—É–Ω–∫—Ç—É–∞—Ü|–º–æ—Ä—Ñ–µ–º–Ω|—Å—Ç–∏–ª\s+—Ä–µ—á|"
            r"—Å–æ–ø—Ä—è–∂–µ–Ω–∏[—è–µ]|—Å–ø—Ä—è–∂–µ–Ω–∏[—è–µ]|–≤—Ä–µ–º–µ–Ω[–∞]?\s+–≥–æ–¥|–º–µ—Å—è—Ü|—á–∞—Å–æ–≤[—ã–µ]?\s+–ø–æ—è—Å|"
            r"—Å—Ç—Ä–∞–Ω—ã?|—Ö—Ä–æ–Ω–æ–ª–æ–≥–∏|–≤–µ—Ç–≤[–∏]?\s+–≤–ª–∞—Å—Ç|—Å–∏—Å—Ç–µ–º[—ã]?\s+—Å—á–∏—Å–ª–µ–Ω–∏)",
            text_lower,
        )
        if has_table and has_multiply and not has_number_pattern and not has_specific_table:
            image = self.viz_service.generate_full_multiplication_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è")
                return image, "table"

        # 10. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–ª–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
        full_table_patterns = [
            r"^–ø–æ–∫–∞–∂–∏\s+—Ç–∞–±–ª\w*\s*—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]\s*$",
            r"^–≤—ã–≤–µ–¥–∏\s+—Ç–∞–±–ª\w*\s*—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]\s*$",
            r"—Ç–∞–±–ª\w*\s*—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]\s+–Ω–∞\s+–≤—Å–µ",
            r"–ø–æ–ª–Ω–∞—è\s+—Ç–∞–±–ª\w*\s*—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]",
        ]
        for pattern in full_table_patterns:
            if re.search(pattern, text_lower):
                image = self.viz_service.generate_full_multiplication_table()
                if image:
                    logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è")
                return image, "table"

        # 11. –¢–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —á–∏—Å–ª–æ
        multiplication_patterns = [
            r"—Ç–∞–±–ª\w*\s*—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]\s*–Ω–∞\s*(\d+)",
            r"—Ç–∞–±–ª\w*\s*—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]\s+(\d+)",
            r"—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]\s+–Ω–∞\s*(\d+)",
            r"—É–º–Ω–æ–∂[–∞-—è]*\s+(\d+)",
        ]
        for pattern in multiplication_patterns:
            match = re.search(pattern, text_lower)
            if match:
                try:
                    number = int(match.group(1))
                    if 1 <= number <= 10:
                        image = self.viz_service.generate_multiplication_table_image(number)
                        if image:
                            logger.info(f"üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è –Ω–∞ {number}")
                            return image, "table"
                except (ValueError, IndexError):
                    continue

        # 12. –•–∏–º–∏—è: —Ä–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç—å
        solubility_patterns = [
            r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+—Ä–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç",
            r"—Ä–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç[—å–∏]?\s+–≤–µ—â–µ—Å—Ç–≤",
            r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+—Ä–∞—Å—Ç–≤–æ—Ä",
        ]
        for pattern in solubility_patterns:
            if re.search(pattern, text_lower):
                image = self.viz_service.generate_chemistry_solubility_table()
                if image:
                    logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç–∏")
                return image, "table"

        # 13. –•–∏–º–∏—è: –≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å
        valence_patterns = [
            r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç",
            r"–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç[—å–∏]?\s+—ç–ª–µ–º–µ–Ω—Ç",
            r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+–≤–∞–ª–µ–Ω—Ç",
            r"–ø–æ–∫–∞–∂–∏\s+—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç",
            r"–ø–æ–∫–∞–∂–∏\s+–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç",
            r"–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç[—å–∏]?",
        ]
        for pattern in valence_patterns:
            if re.search(pattern, text_lower):
                image = self.viz_service.generate_chemistry_valence_table()
                if image:
                    logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏")
                return image, "table"

        # 14. –§–∏–∑–∏–∫–∞: –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        constants_patterns = [
            r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+(?:—Ñ–∏–∑–∏—á–µ—Å–∫|–∫–æ–Ω—Å—Ç–∞–Ω—Ç)",
            r"—Ñ–∏–∑–∏—á–µ—Å–∫[–∏–µ]?\s+–∫–æ–Ω—Å—Ç–∞–Ω—Ç[—ã]?",
            r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+–∫–æ–Ω—Å—Ç–∞–Ω—Ç",
        ]
        for pattern in constants_patterns:
            if re.search(pattern, text_lower):
                image = self.viz_service.generate_physics_constants_table()
                if image:
                    logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç")
                return image, "table"

        # 15. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π: –≤—Ä–µ–º–µ–Ω–∞
        english_tenses_patterns = [
            r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+–≤—Ä–µ–º–µ–Ω",
            r"–≤—Ä–µ–º–µ–Ω[–∞]?\s+(?:–∞–Ω–≥–ª–∏–π—Å–∫|–∞–Ω–≥–ª)",
            r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+(?:–∞–Ω–≥–ª–∏–π—Å–∫|–∞–Ω–≥–ª)\s+–≤—Ä–µ–º–µ–Ω",
        ]
        for pattern in english_tenses_patterns:
            if re.search(pattern, text_lower):
                image = self.viz_service.generate_english_tenses_table()
                if image:
                    logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –≤—Ä–µ–º–µ–Ω –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ")
                return image, "table"

        # 16. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã
        if "–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω" in text_lower and "–≥–ª–∞–≥–æ–ª" in text_lower:
            image = self.viz_service.generate_english_irregular_verbs_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≥–ª–∞–≥–æ–ª–æ–≤")
                return image, "table"

        # 17. –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞: —Å–ª–æ–∂–µ–Ω–∏–µ
        if re.search(r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+—Å–ª–æ–∂–µ–Ω–∏[—è–µ]", text_lower):
            image = self.viz_service.generate_addition_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–ª–æ–∂–µ–Ω–∏—è")
                return image, "table"

        # 18. –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞: –≤—ã—á–∏—Ç–∞–Ω–∏–µ
        if re.search(r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+–≤—ã—á–∏—Ç–∞–Ω–∏[—è–µ]", text_lower):
            image = self.viz_service.generate_subtraction_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –≤—ã—á–∏—Ç–∞–Ω–∏—è")
                return image, "table"

        # 19. –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞: –¥–µ–ª–µ–Ω–∏–µ
        if re.search(r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+–¥–µ–ª–µ–Ω–∏[—è–µ]", text_lower):
            image = self.viz_service.generate_division_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –¥–µ–ª–µ–Ω–∏—è")
                return image, "table"

        # 20. –ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
        if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?–µ–¥–∏–Ω–∏—Ü[—ã]?\s+–∏–∑–º–µ—Ä–µ–Ω–∏[—è–µ]", text_lower):
            image = self.viz_service.generate_units_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è")
                return image, "table"

        # 21. –†—É—Å—Å–∫–∏–π: –∞–ª—Ñ–∞–≤–∏—Ç
        if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:–±—É–∫–≤|–∞–ª—Ñ–∞–≤–∏—Ç|–∑–≤—É–∫)", text_lower):
            image = self.viz_service.generate_russian_alphabet_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –±—É–∫–≤ –∏ –∑–≤—É–∫–æ–≤")
                return image, "table"

        # 22. –†—É—Å—Å–∫–∏–π: –ø–∞–¥–µ–∂–∏
        if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:–ø–∞–¥–µ–∂|—Å–∫–ª–æ–Ω–µ–Ω–∏)", text_lower):
            image = self.viz_service.generate_russian_cases_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –ø–∞–¥–µ–∂–µ–π")
                return image, "table"

        # 23. –†—É—Å—Å–∫–∏–π: –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è
        if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ|–ø—Ä–∞–≤–æ–ø–∏—Å–∞–Ω)", text_lower):
            image = self.viz_service.generate_russian_orthography_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏–∏")
                return image, "table"

        # 24. –†—É—Å—Å–∫–∏–π: –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è
        if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:–ø—É–Ω–∫—Ç—É–∞—Ü|–∑–Ω–∞–∫[–∏]?\s+–ø—Ä–µ–ø–∏–Ω–∞–Ω)", text_lower):
            image = self.viz_service.generate_russian_punctuation_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏")
                return image, "table"

        # 25. –†—É—Å—Å–∫–∏–π: –º–æ—Ä—Ñ–µ–º–Ω—ã–π —Ä–∞–∑–±–æ—Ä
        if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:–º–æ—Ä—Ñ–µ–º–Ω|—Ä–∞–∑–±–æ—Ä\s+—Å–ª–æ–≤)", text_lower):
            image = self.viz_service.generate_russian_word_analysis_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –º–æ—Ä—Ñ–µ–º–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞")
                return image, "table"

        # 26. –†—É—Å—Å–∫–∏–π: —Å—Ç–∏–ª–∏ —Ä–µ—á–∏
        if "—Å—Ç–∏–ª" in text_lower and "—Ä–µ—á" in text_lower:
            image = self.viz_service.generate_russian_speech_styles_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç–∏–ª–µ–π —Ä–µ—á–∏")
                return image, "table"

        # 27. –û–∫—Ä—É–∂–∞—é—â–∏–π –º–∏—Ä: –≤—Ä–µ–º–µ–Ω–∞ –≥–æ–¥–∞
        if re.search(
            r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:–≤—Ä–µ–º–µ–Ω[–∞]?\s+–≥–æ–¥|–º–µ—Å—è—Ü|–¥–Ω[–∏—è]?\s+–Ω–µ–¥–µ–ª)", text_lower
        ):
            image = self.viz_service.generate_seasons_months_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –≤—Ä–µ–º–µ–Ω –≥–æ–¥–∞")
                return image, "table"

        # 28. –ì–µ–æ–≥—Ä–∞—Ñ–∏—è: –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ –∑–æ–Ω—ã
        if re.search(r"–ø—Ä–∏—Ä–æ–¥–Ω[—ã–µ]?\s+–∑–æ–Ω", text_lower):
            image = self.viz_service.generate_natural_zones_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–∏—Ä–æ–¥–Ω—ã—Ö –∑–æ–Ω")
                return image, "table"

        # 29. –ì–µ–æ–≥—Ä–∞—Ñ–∏—è: —á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞
        if re.search(r"—á–∞—Å–æ–≤[—ã–µ]?\s+–ø–æ—è—Å", text_lower):
            image = self.viz_service.generate_time_zones_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤")
                return image, "table"

        # 30. –ì–µ–æ–≥—Ä–∞—Ñ–∏—è: —Å—Ç—Ä–∞–Ω—ã
        if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:–∫—Ä—É–ø–Ω–µ–π—à|—Å—Ç—Ä–∞–Ω—ã?\s+–º–∏—Ä)", text_lower):
            image = self.viz_service.generate_countries_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç—Ä–∞–Ω")
                return image, "table"

        # 31. –ì–µ–æ–≥—Ä–∞—Ñ–∏—è: –∫–∞—Ä—Ç—ã —Å—Ç—Ä–∞–Ω —á–µ—Ä–µ–∑ Yandex Maps Static API
        # –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –∫–∞—Ä—Ç—ã: "–ø–æ–∫–∞–∂–∏ –∫–∞—Ä—Ç—É", "–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è", "–∫–∞—Ä—Ç–∞ —Å—Ç—Ä–∞–Ω—ã"
        # –£–õ–£–ß–®–ï–ù–û: —É—á–∏—Ç—ã–≤–∞–µ–º –í–°–ï —Å–ª–æ–≤–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ (–ø–æ–∫–∞–∂–∏/–Ω–∞—Ä–∏—Å—É–π/—Å–æ—Å—Ç–∞–≤—å + –∫–∞—Ä—Ç—É + —Å—Ç—Ä–∞–Ω—É)
        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å –≥–æ—Ä–æ–¥–∞–º–∏ –∏ —Ä–µ–≥–∏–æ–Ω–∞–º–∏
        map_keywords = [
            r"–∫–∞—Ä—Ç[–∞–µ—ã—É]?\s+(?:—Å—Ç—Ä–∞–Ω—ã|–º–∏—Ä–∞|—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|–µ–≤—Ä–æ–ø|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω|–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤)",
            r"(?:–ø–æ–∫–∞–∂–∏|–Ω–∞—Ä–∏—Å—É–π|—Å–æ–∑–¥–∞–π|—Å–æ—Å—Ç–∞–≤—å|–ø–æ—Å—Ç—Ä–æ–π|–≤—ã–≤–µ–¥–∏|–æ—Ç–æ–±—Ä–∞–∑–∏)\s+(?:–∫–∞—Ä—Ç[–∞–µ—ã—É]|–≥–¥–µ\s+–Ω–∞—Ö–æ–¥–∏—Ç—Å—è|–º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏)",
            r"–≥–¥–µ\s+–Ω–∞—Ö–æ–¥–∏—Ç—Å—è\s+(?:—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|—Å—Ç—Ä–∞–Ω–∞|–µ–≤—Ä–æ–ø|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω|–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤)",
            r"–º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏[–µ—è]\s+(?:—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|–µ–≤—Ä–æ–ø|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω|–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤)",
        ]

        for pattern in map_keywords:
            match = re.search(pattern, text_lower)
            if match:
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã/–≥–æ—Ä–æ–¥–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫)
                country_match = re.search(
                    r"(—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|–µ–≤—Ä–æ–ø|—Å—Ç—Ä–∞–Ω–∞|–º–∏—Ä|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω|–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤)",
                    text_lower,
                )
                if country_match:
                    country_name = country_match.group(1)
                    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è
                    if (
                        country_name in ["–ø–∏—Ç–µ—Ä", "–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "—Å–ø–±"]
                        or "—Å–∞–Ω–∫—Ç" in country_name
                        or "–ø–µ—Ç–µ—Ä–±—É—Ä–≥" in country_name
                    ):
                        country_name = "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥"
                    elif "–º–æ—Å–∫–≤" in country_name:
                        country_name = "–º–æ—Å–∫–≤–∞"
                    elif "–µ–≤—Ä–æ–ø" in country_name:
                        country_name = "–µ–≤—Ä–æ–ø–∞"
                    else:
                        # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã –≤ —Ç–µ–∫—Å—Ç–µ
                        full_country_match = re.search(
                            rf"({country_match.group(1)}[–∞-—è]*)", text_lower
                        )
                        if full_country_match:
                            country_name = full_country_match.group(1)

                    image = self.viz_service.generate_country_map(country_name)
                    if image:
                        logger.info(f"üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∫–∞—Ä—Ç–∞ –¥–ª—è: {country_name}")
                        return image, "map"
                else:
                    # –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –Ω–æ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–∞—Ä—Ç—É - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É –º–∏—Ä–∞
                    image = self.viz_service.generate_country_map("–º–∏—Ä")
                    if image:
                        logger.info("üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∫–∞—Ä—Ç–∞ –º–∏—Ä–∞")
                        return image, "map"

        # 31. –ò—Å—Ç–æ—Ä–∏—è: —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è
        if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:—Ö—Ä–æ–Ω–æ–ª–æ–≥–∏|–∏—Å—Ç–æ—Ä–∏[—è–∏]?\s+—Ä–æ—Å—Å–∏)", text_lower):
            image = self.viz_service.generate_history_timeline_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞")
                return image, "table"

        # 32. –û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ: –≤–µ—Ç–≤–∏ –≤–ª–∞—Å—Ç–∏
        if re.search(r"–≤–µ—Ç–≤[–∏]?\s+–≤–ª–∞—Å—Ç", text_lower):
            image = self.viz_service.generate_government_branches_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –≤–µ—Ç–≤–µ–π –≤–ª–∞—Å—Ç–∏")
                return image, "table"

        # 33. –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞: —Å–∏—Å—Ç–µ–º—ã —Å—á–∏—Å–ª–µ–Ω–∏—è
        if re.search(
            r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:—Å–∏—Å—Ç–µ–º[—ã]?\s+—Å—á–∏—Å–ª–µ–Ω–∏|–¥–≤–æ–∏—á–Ω|–≤–æ—Å—å–º–µ—Ä–∏—á–Ω)", text_lower
        ):
            image = self.viz_service.generate_number_systems_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–∏—Å—Ç–µ–º —Å—á–∏—Å–ª–µ–Ω–∏—è")
                return image, "table"

        # 34. –•–∏–º–∏—è: –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ú–µ–Ω–¥–µ–ª–µ–µ–≤–∞
        mendeleev_patterns = [
            r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s*–º–µ–Ω–¥–µ–ª–µ–µ–≤–∞",
            r"–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è\s+—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?",
            r"–º–µ–Ω–¥–µ–ª–µ–µ–≤–∞",
            r"–ø–æ–∫–∞–∂–∏\s+—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s*–º–µ–Ω–¥–µ–ª–µ–µ–≤–∞",
            r"–ø–æ–∫–∞–∂–∏\s+–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é\s+—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?",
        ]
        for pattern in mendeleev_patterns:
            if re.search(pattern, text_lower):
                image = self.viz_service.generate_periodic_table_simple()
                if image:
                    logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ú–µ–Ω–¥–µ–ª–µ–µ–≤–∞")
                return image, "table"

        # 35. –§–∏–∑–∏–∫–∞: –≥—Ä–∞—Ñ–∏–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è
        # –£–õ–£–ß–®–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ –ø—Ä–∏–º–µ—Ä–∞ –¥–ª—è –ª—É—á—à–µ–π –¥–µ—Ç–µ–∫—Ü–∏–∏
        physics_motion_patterns = [
            r"–≥—Ä–∞—Ñ–∏–∫\s+(?:–ø—É—Ç–∏|–ø—É—Ç—å)\s+–æ—Ç\s+–≤—Ä–µ–º–µ–Ω",
            r"–≥—Ä–∞—Ñ–∏–∫\s+—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω[–æ–≥–æ]?\s+–¥–≤–∏–∂–µ–Ω–∏[—è–µ]",
            r"–≥—Ä–∞—Ñ–∏–∫\s+—Ä–∞–≤–Ω–æ—É—Å–∫–æ—Ä–µ–Ω–Ω[–æ–≥–æ]?\s+–¥–≤–∏–∂–µ–Ω–∏[—è–µ]",
            r"–≥—Ä–∞—Ñ–∏–∫\s+–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç[–∏–∏]?\s+–ø—É—Ç–∏\s+–æ—Ç\s+–≤—Ä–µ–º–µ–Ω",
            r"–ø—É—Ç—å\s+–æ—Ç\s+–≤—Ä–µ–º–µ–Ω[–∏]?\s+–≥—Ä–∞—Ñ–∏–∫",
        ]
        for pattern in physics_motion_patterns:
            if re.search(pattern, text_lower):
                if re.search(r"—Ä–∞–≤–Ω–æ—É—Å–∫–æ—Ä–µ–Ω–Ω", text_lower):
                    image = self.viz_service.generate_physics_motion_graph("accelerated")
                else:
                    image = self.viz_service.generate_physics_motion_graph("uniform")
                if image:
                    logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ –ø—É—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏")
                    return image, "graph"

        # 36. –§–∏–∑–∏–∫–∞: –≥—Ä–∞—Ñ–∏–∫ —Å–∫–æ—Ä–æ—Å—Ç–∏
        # –£–õ–£–ß–®–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
        physics_velocity_patterns = [
            r"–≥—Ä–∞—Ñ–∏–∫\s+—Å–∫–æ—Ä–æ—Å—Ç[–∏]?\s+–æ—Ç\s+–≤—Ä–µ–º–µ–Ω",
            r"–≥—Ä–∞—Ñ–∏–∫\s+–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç[–∏–∏]?\s+—Å–∫–æ—Ä–æ—Å—Ç[–∏]?\s+–æ—Ç\s+–≤—Ä–µ–º–µ–Ω",
            r"—Å–∫–æ—Ä–æ—Å—Ç[—å–∏]?\s+–æ—Ç\s+–≤—Ä–µ–º–µ–Ω[–∏]?\s+–≥—Ä–∞—Ñ–∏–∫",
        ]
        for pattern in physics_velocity_patterns:
            if re.search(pattern, text_lower):
                image = self.viz_service.generate_physics_motion_graph("velocity")
                if image:
                    logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏")
                    return image, "graph"

        # 36.5. –ì–µ–æ–º–µ—Ç—Ä–∏—è: –º–µ–¥–∏–∞–Ω–∞ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞
        if re.search(r"–≥—Ä–∞—Ñ–∏–∫\s+–º–µ–¥–∏–∞–Ω", text_lower) or re.search(
            r"–º–µ–¥–∏–∞–Ω[–∞—ã]?\s+—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫", text_lower
        ):
            image = self.viz_service.generate_median_diagram()
            if image:
                logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ö–µ–º–∞ –º–µ–¥–∏–∞–Ω—ã —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞")
                return image, "graph"

        # 36.6. –ë–∏–æ–ª–æ–≥–∏—è: —Å—Ö–µ–º—ã —Å—Ç—Ä–æ–µ–Ω–∏—è (–∫—Ä–æ–≤–æ–æ–±—Ä–∞—â–µ–Ω–∏–µ, –∫–ª–µ—Ç–∫–∞, –æ—Ä–≥–∞–Ω—ã)
        # –£–õ–£–ß–®–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ –ø—Ä–∏–º–µ—Ä–∞ –¥–ª—è –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Å—Ö–µ–º
        # TODO: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Å—Ö–µ–º (generate_biology_cell_structure, generate_biology_circulation)
        # –ü–æ–∫–∞ –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ–º, –Ω–æ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º (–º–µ—Ç–æ–¥—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–∑–∂–µ)
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã: r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+–∫—Ä–æ–≤–æ–æ–±—Ä–∞—â–µ–Ω–∏[—è–µ]", r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+—Å—Ç—Ä–æ–µ–Ω–∏[—è–µ]?\s+–∫–ª–µ—Ç–∫[–∏]", –∏ —Ç.–¥.

        # 36.7. –ì–µ–æ–≥—Ä–∞—Ñ–∏—è: –∫–ª–∏–º–∞—Ç–æ–≥—Ä–∞–º–º—ã
        # –£–õ–£–ß–®–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
        # TODO: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª–∏–º–∞—Ç–æ–≥—Ä–∞–º–º (generate_climatogram)
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã: r"–∫–ª–∏–º–∞—Ç–æ–≥—Ä–∞–º–º[–∞–µ—ã—É]", r"–ø–æ—Å—Ç—Ä–æ–π\s+–∫–ª–∏–º–∞—Ç–æ–≥—Ä–∞–º–º[–∞–µ—ã—É]", –∏ —Ç.–¥.

        # 36.8. –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞: –±–ª–æ–∫-—Å—Ö–µ–º—ã
        # –£–õ–£–ß–®–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
        # TODO: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫-—Å—Ö–µ–º (generate_flowchart)
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã: r"–±–ª–æ–∫[-\s]?—Å—Ö–µ–º[–∞–µ—ã—É]", r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+–∞–ª–≥–æ—Ä–∏—Ç–º[–∞]", –∏ —Ç.–¥.

        # 37. –§–∏–∑–∏–∫–∞: –∑–∞–∫–æ–Ω –û–º–∞ –∏ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–µ —Å—Ö–µ–º—ã
        # –£–õ–£–ß–®–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
        physics_electric_patterns = [
            r"(?:–≥—Ä–∞—Ñ–∏–∫\s+)?(?:–∑–∞–∫–æ–Ω\s+–æ–º–∞|—Å–∏–ª–∞\s+—Ç–æ–∫–∞\s+–æ—Ç\s+–Ω–∞–ø—Ä—è–∂–µ–Ω–∏|–æ–º[–∞]?)",
            r"–≤–æ–ª—å—Ç[-\s]?–∞–º–ø–µ—Ä–Ω[–∞—è]?\s+—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫[–∞–∏]",
            r"–≥—Ä–∞—Ñ–∏–∫\s+—Å–∏–ª[—ã]?\s+—Ç–æ–∫–∞\s+–æ—Ç\s+–Ω–∞–ø—Ä—è–∂–µ–Ω–∏[—è]",
            r"—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫[–∞—è]?\s+—Å—Ö–µ–º[–∞–µ—ã—É]",
            r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+—Å\s+–ª–∞–º–ø[–æ–π–æ–π]",
            r"—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫[–∞—è]?\s+—Ü–µ–ø[—å–∏]",
        ]
        for pattern in physics_electric_patterns:
            if re.search(pattern, text_lower):
                # –î–ª—è —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏—Ö —Å—Ö–µ–º –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä–∞—Ñ–∏–∫ –∑–∞–∫–æ–Ω–∞ –û–º–∞
                # –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å—Ö–µ–º
                if "—Å—Ö–µ–º" in text_lower or "—Ü–µ–ø" in text_lower:
                    # –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞ - –ø–æ–∫–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫ –∑–∞–∫–æ–Ω–∞ –û–º–∞
                    image = self.viz_service.generate_ohms_law_graph()
                    if image:
                        logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞/–≥—Ä–∞—Ñ–∏–∫ –∑–∞–∫–æ–Ω–∞ –û–º–∞")
                        return image, "graph"
                else:
                    # –ì—Ä–∞—Ñ–∏–∫ –∑–∞–∫–æ–Ω–∞ –û–º–∞
                    image = self.viz_service.generate_ohms_law_graph()
                    if image:
                        logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ –∑–∞–∫–æ–Ω–∞ –û–º–∞")
                        return image, "graph"

        # 38. –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞: –≥—Ä–∞—Ñ–∏–∫–∏ —Ñ—É–Ω–∫—Ü–∏–π (–ø–∞—Ä–∞–±–æ–ª–∞, —Å–∏–Ω—É—Å, –∫–æ—Å–∏–Ω—É—Å –∏ —Ç.–¥.)
        # –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –µ—Å—Ç—å —è–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        math_graph_patterns = [
            r"–≥—Ä–∞—Ñ–∏–∫\s+(?:–ø–∞—Ä–∞–±–æ–ª|—Å–∏–Ω—É—Å|–∫–æ—Å–∏–Ω—É—Å|—Ç–∞–Ω–≥–µ–Ω—Å|–ª–æ–≥–∞—Ä–∏—Ñ–º|—ç–∫—Å–ø–æ–Ω–µ–Ω—Ç|—Å—Ç–µ–ø–µ–Ω–Ω)",
            r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=\s*x\^2",  # –ø–∞—Ä–∞–±–æ–ª–∞
            r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=\s*sin",  # —Å–∏–Ω—É—Å
            r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=\s*cos",  # –∫–æ—Å–∏–Ω—É—Å
            r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=\s*tan",  # —Ç–∞–Ω–≥–µ–Ω—Å
            r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=\s*log",  # –ª–æ–≥–∞—Ä–∏—Ñ–º
            r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=\s*exp",  # —ç–∫—Å–ø–æ–Ω–µ–Ω—Ç–∞
            r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=\s*\d+\^x",  # —Å—Ç–µ–ø–µ–Ω–Ω–∞—è
            r"–ø–∞—Ä–∞–±–æ–ª[–∞—ã]",  # –ø–∞—Ä–∞–±–æ–ª–∞
            r"—Å–∏–Ω—É—Å–æ–∏–¥[–∞—ã]",  # —Å–∏–Ω—É—Å–æ–∏–¥–∞
        ]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –µ—Å—Ç—å —è–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        if has_visualization_request or has_context_pattern:
            for pattern in math_graph_patterns:
                if re.search(pattern, text_lower):
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ —Ç–µ–∫—Å—Ç–∞
                    # –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –∏—â–µ–º y = ... –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
                    function_match = re.search(r"y\s*=\s*([^,\n]+)", text_lower)
                    if function_match:
                        function_expr = function_match.group(1).strip()
                        # –û—á–∏—â–∞–µ–º –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
                        function_expr = re.sub(r"[^\w\s\+\-\*\/\^\(\)\.]", "", function_expr)
                        if function_expr:
                            try:
                                image = self.viz_service.generate_function_graph(function_expr)
                                if image:
                                    logger.info(f"üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ —Ñ—É–Ω–∫—Ü–∏–∏: {function_expr}")
                                    return image, "graph"
                            except Exception as e:
                                logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏: {e}")

                    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Ñ—É–Ω–∫—Ü–∏—é, –Ω–æ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ (–ø–∞—Ä–∞–±–æ–ª–∞, —Å–∏–Ω—É—Å –∏ —Ç.–¥.)
                    if "–ø–∞—Ä–∞–±–æ–ª" in text_lower:
                        image = self.viz_service.generate_function_graph("x^2")
                        if image:
                            logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ –ø–∞—Ä–∞–±–æ–ª—ã")
                            return image, "graph"
                    elif "—Å–∏–Ω—É—Å" in text_lower or "—Å–∏–Ω—É—Å–æ–∏–¥" in text_lower:
                        image = self.viz_service.generate_function_graph("sin(x)")
                        if image:
                            logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ —Å–∏–Ω—É—Å–∞")
                            return image, "graph"
                    elif "–∫–æ—Å–∏–Ω—É—Å" in text_lower:
                        image = self.viz_service.generate_function_graph("cos(x)")
                        if image:
                            logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ –∫–æ—Å–∏–Ω—É—Å–∞")
                            return image, "graph"

        return None, None
