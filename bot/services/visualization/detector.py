"""
–î–µ—Ç–µ–∫—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é (SOLID: SRP, OCP).

–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–∞ –ª–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è,
–∑–∞—Ç–µ–º –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

detect() ‚Äî –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä, –¥–µ–ª–µ–≥–∏—Ä—É—é—â–∏–π –ª–æ–≥–∏–∫—É –ø–æ–¥–º–æ–¥—É–ª—è–º –∏–∑ detectors/.
"""

import re

from loguru import logger

from bot.config.response_rules import VISUALIZATION_TRIGGER_WORDS
from bot.services.visualization.detectors import (
    EXPLANATION_REQUEST_WORDS,
    VISUALIZATION_REQUEST_WORDS,
    detect_diagram,
    detect_map,
    detect_math_graph,
    detect_physics,
    detect_scheme,
    detect_subject_tables_and_diagrams,
)

try:
    import matplotlib

    matplotlib.use("Agg")
    MATPLOTLIB_AVAILABLE = True
except ImportError:
    MATPLOTLIB_AVAILABLE = False


class VisualizationDetector:
    """
    –î–µ—Ç–µ–∫—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é.

    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–æ–π —Ç–∏–ø –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω—É–∂–µ–Ω.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ —Ç–∞–±–ª–∏—Ü—ã/–≥—Ä–∞—Ñ–∏–∫–∞.
    """

    def __init__(self, viz_service):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞.

        Args:
            viz_service: –≠–∫–∑–µ–º–ø–ª—è—Ä VisualizationService —Å –º–µ—Ç–æ–¥–∞–º–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        """
        self.viz_service = viz_service

    def detect_geography_question(self, text: str) -> str | None:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–º –≤–æ–ø—Ä–æ—Å–æ–º —Ç–∏–ø–∞ "–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è X".

        –¢–∞–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –ù–ï –¥–æ–ª–∂–Ω—ã —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞—Ä—Ç—É - —Å–Ω–∞—á–∞–ª–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç,
        –∑–∞—Ç–µ–º –∫–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç—É?".

        Args:
            text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

        Returns:
            str | None: –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã/–≥–æ—Ä–æ–¥–∞ –¥–ª—è –∫–∞—Ä—Ç—ã –∏–ª–∏ None –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å
        """
        text_lower = text.lower().strip()

        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ "–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è" (–ë–ï–ó —è–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏)
        if any(kw in text_lower for kw in VISUALIZATION_TRIGGER_WORDS):
            return None  # –≠—Ç–æ –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–∞—Ä—Ç—É

        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º [–∞-—è—ë–ê-–Ø–Åa-zA-Z]+ –≤–º–µ—Å—Ç–æ \w+ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
        geo_patterns = [
            r"–≥–¥–µ\s+–Ω–∞—Ö–æ–¥–∏—Ç—Å—è\s+([–∞-—è—ë–ê-–Ø–Åa-zA-Z]+)",
            r"–≥–¥–µ\s+—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω[–∞–æ—ã]?\s+([–∞-—è—ë–ê-–Ø–Åa-zA-Z]+)",
            r"–≤\s+–∫–∞–∫–æ–π\s+—á–∞—Å—Ç–∏\s+(?:–º–∏—Ä–∞|—Å–≤–µ—Ç–∞)\s+–Ω–∞—Ö–æ–¥–∏—Ç—Å—è\s+([–∞-—è—ë–ê-–Ø–Åa-zA-Z]+)",
            r"–Ω–∞\s+–∫–∞–∫–æ–º\s+(?:–∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–µ|–º–∞—Ç–µ—Ä–∏–∫–µ)\s+–Ω–∞—Ö–æ–¥–∏—Ç—Å—è\s+([–∞-—è—ë–ê-–Ø–Åa-zA-Z]+)",
            r"—Ä–∞—Å—Å–∫–∞–∂–∏\s+(?:–ø—Ä–æ\s+)?(?:–≥–¥–µ\s+)?([–∞-—è—ë–ê-–Ø–Åa-zA-Z]+)\s+(?:–Ω–∞—Ö–æ–¥–∏—Ç—Å—è|—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω)",
            r"—Ä–∞—Å—Å–∫–∞–∂–∏\s+(?:–º–Ω–µ\s+)?–ø—Ä–æ\s+([–∞-—è—ë–ê-–Ø–Åa-zA-Z]+)",  # "—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –ì–µ—Ä–º–∞–Ω–∏—é"
            r"—Ä–∞—Å—Å–∫–∞–∂–∏\s+(?:–º–Ω–µ\s+)?–æ\s+([–∞-—è—ë–ê-–Ø–Åa-zA-Z]+)",  # "—Ä–∞—Å—Å–∫–∞–∂–∏ –æ –ö–∏—Ç–∞–µ"
            r"—á—Ç–æ\s+(?:—Ç—ã\s+)?–∑–Ω–∞–µ—à—å\s+(?:–æ|–ø—Ä–æ)\s+([–∞-—è—ë–ê-–Ø–Åa-zA-Z]+)",  # "—á—Ç–æ –∑–Ω–∞–µ—à—å –æ –ö–∏—Ç–∞–µ"
        ]

        for pattern in geo_patterns:
            match = re.search(pattern, text_lower)
            if match:
                location = match.group(1)
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—Ç—Ä–∞–Ω–∞/–≥–æ—Ä–æ–¥
                # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —É–±–∏—Ä–∞–µ–º –ø–∞–¥–µ–∂–Ω—ã–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                location_normalized = location.lower().strip()

                # –£–±–∏—Ä–∞–µ–º —Ç–∏–ø–∏—á–Ω—ã–µ –ø–∞–¥–µ–∂–Ω—ã–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è (–≤–∏–Ω–∏—Ç–µ–ª—å–Ω—ã–π, —Ä–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π, –ø—Ä–µ–¥–ª–æ–∂–Ω—ã–π)
                for ending in ["–∏—é", "–∏–∏", "–µ–π", "—å—é", "–æ–π", "—ã–π", "–∞—è", "–æ–µ", "–∞—Ö", "—è—Ö"]:
                    if location_normalized.endswith(ending) and len(location_normalized) > 4:
                        location_normalized = location_normalized[: -len(ending)]
                        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø–∏—á–Ω–æ–µ –æ–∫–æ–Ω—á–∞–Ω–∏–µ –∏–º–µ–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∞–¥–µ–∂–∞
                        if ending in ["–∏—é", "–∏–∏"]:
                            location_normalized += "–∏—è"
                        elif ending in ["–µ–π", "—å—é"]:
                            location_normalized += "—å"
                        elif ending == "–æ–π":
                            location_normalized += "–∞"
                        break

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –Ω–∞—à–µ–º —Å–ø–∏—Å–∫–µ —Å—Ç—Ä–∞–Ω –∏ –≥–æ—Ä–æ–¥–æ–≤
                known_locations = [
                    # –°—Ç—Ä–∞–Ω—ã
                    "–∫–∏—Ç–∞–π",
                    "—Ä–æ—Å—Å–∏—è",
                    "—Å—à–∞",
                    "–∞–º–µ—Ä–∏–∫–∞",
                    "—Ñ—Ä–∞–Ω—Ü–∏—è",
                    "–≥–µ—Ä–º–∞–Ω–∏—è",
                    "–∏—Ç–∞–ª–∏—è",
                    "–∏—Å–ø–∞–Ω–∏—è",
                    "—è–ø–æ–Ω–∏—è",
                    "–∫–æ—Ä–µ—è",
                    "–∏–Ω–¥–∏—è",
                    "–±—Ä–∞–∑–∏–ª–∏—è",
                    "–∞–≤—Å—Ç—Ä–∞–ª–∏—è",
                    "–∫–∞–Ω–∞–¥–∞",
                    "–º–µ–∫—Å–∏–∫–∞",
                    "–µ–≥–∏–ø–µ—Ç",
                    "—Ç—É—Ä—Ü–∏—è",
                    "–≥—Ä–µ—Ü–∏—è",
                    "–ø–æ–ª—å—à–∞",
                    "—É–∫—Ä–∞–∏–Ω–∞",
                    "–∞–Ω–≥–ª–∏—è",
                    "–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è",
                    "–Ω–∏–¥–µ—Ä–ª–∞–Ω–¥—ã",
                    "–±–µ–ª—å–≥–∏—è",
                    "—à–≤–µ–π—Ü–∞—Ä–∏—è",
                    "–∞–≤—Å—Ç—Ä–∏—è",
                    "—à–≤–µ—Ü–∏—è",
                    "–Ω–æ—Ä–≤–µ–≥–∏—è",
                    "—Ñ–∏–Ω–ª—è–Ω–¥–∏—è",
                    "–¥–∞–Ω–∏—è",
                    "—á–µ—Ö–∏—è",
                    "–≤–µ–Ω–≥—Ä–∏—è",
                    "—Ä—É–º—ã–Ω–∏—è",
                    "–±–æ–ª–≥–∞—Ä–∏—è",
                    "—Å–µ—Ä–±–∏—è",
                    "—Ö–æ—Ä–≤–∞—Ç–∏—è",
                    "–ø–æ—Ä—Ç—É–≥–∞–ª–∏—è",
                    "–∏—Ä–ª–∞–Ω–¥–∏—è",
                    "–∏—Å–ª–∞–Ω–¥–∏—è",
                    "—Ç–∞–π–ª–∞–Ω–¥",
                    "—Ç–∞–∏–ª–∞–Ω–¥",
                    "–≤—å–µ—Ç–Ω–∞–º",
                    "–∏–Ω–¥–æ–Ω–µ–∑–∏—è",
                    "—Ñ–∏–ª–∏–ø–ø–∏–Ω—ã",
                    "–º–∞–ª–∞–π–∑–∏—è",
                    "—Å–∏–Ω–≥–∞–ø—É—Ä",
                    "–∏—Ä–∞–Ω",
                    "–∏—Ä–∞–∫",
                    "–∏–∑—Ä–∞–∏–ª—å",
                    "—Å–∞—É–¥–æ–≤—Å–∫–∞—è",
                    "–æ–∞—ç",
                    "—ç–º–∏—Ä–∞—Ç—ã",
                    "–∫–∞—Ç–∞—Ä",
                    "–ø–∞–∫–∏—Å—Ç–∞–Ω",
                    "–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω",
                    "–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω",
                    "—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω",
                    "–º–æ–Ω–≥–æ–ª–∏—è",
                    "–≥—Ä—É–∑–∏—è",
                    "–∞—Ä–º–µ–Ω–∏—è",
                    "–∞–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω",
                    "–∞—Ä–≥–µ–Ω—Ç–∏–Ω–∞",
                    "—á–∏–ª–∏",
                    "–ø–µ—Ä—É",
                    "–∫–æ–ª—É–º–±–∏—è",
                    "–≤–µ–Ω–µ—Å—É—ç–ª–∞",
                    "–∫—É–±–∞",
                    "—é–∞—Ä",
                    "–Ω–∏–≥–µ—Ä–∏—è",
                    "–∫–µ–Ω–∏—è",
                    "—ç—Ñ–∏–æ–ø–∏—è",
                    "–º–∞—Ä–æ–∫–∫–æ",
                    "–∞–ª–∂–∏—Ä",
                    # –ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç—ã
                    "–µ–≤—Ä–æ–ø–∞",
                    "–∞–∑–∏—è",
                    "–∞—Ñ—Ä–∏–∫–∞",
                    "–∞–º–µ—Ä–∏–∫–∞",
                    "–∞–≤—Å—Ç—Ä–∞–ª–∏—è",
                    "–∞–Ω—Ç–∞—Ä–∫—Ç–∏–¥–∞",
                    # –ì–æ—Ä–æ–¥–∞ (–≤–∫–ª—é—á–∞—è –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—ã)
                    "–º–æ—Å–∫–≤–∞",
                    "–º—Å–∫",
                    "–ø–µ—Ç–µ—Ä–±—É—Ä–≥",
                    "–ø–∏—Ç–µ—Ä",
                    "—Å–ø–±",
                    "–ª–æ–Ω–¥–æ–Ω",
                    "–ø–∞—Ä–∏–∂",
                    "–±–µ—Ä–ª–∏–Ω",
                    "—Ä–∏–º",
                    "–º–∞–¥—Ä–∏–¥",
                    "—Ç–æ–∫–∏–æ",
                    "–ø–µ–∫–∏–Ω",
                    "—à–∞–Ω—Ö–∞–π",
                    "–Ω—å—é-–π–æ—Ä–∫",
                    "–ª–æ—Å-–∞–Ω–¥–∂–µ–ª–µ—Å",
                    "—Å–∏–¥–Ω–µ–π",
                    "–¥—É–±–∞–π",
                    "—Å—Ç–∞–º–±—É–ª",
                ]

                for loc in known_locations:
                    if loc in location_normalized or location_normalized in loc:
                        logger.info(f"üó∫Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å –æ: {location}")
                        return location

        return None

    def detect(self, text: str) -> tuple[bytes | None, str | None]:
        """
        –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.

        –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä: –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É –ø–æ–¥–º–æ–¥—É–ª—è–º –∏–∑ detectors/.

        Args:
            text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

        Returns:
            tuple: (–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ None, –¢–∏–ø –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ None)
        """
        if not MATPLOTLIB_AVAILABLE:
            return None, None

        text_lower = text.lower()

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞
        has_visualization_request = any(word in text_lower for word in VISUALIZATION_REQUEST_WORDS)
        has_explanation_request = any(word in text_lower for word in EXPLANATION_REQUEST_WORDS)

        # –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ë–ï–ó –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        if has_explanation_request and not has_visualization_request:
            logger.debug("üîç –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –±–µ–∑ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é")
            return None, None

        # 1. –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ö–µ–º—ã (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—ã—à–µ –¥–∏–∞–≥—Ä–∞–º–º)
        if has_visualization_request:
            result = detect_scheme(text_lower, self.viz_service)
            if result[0]:
                return result

            # 2. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã
            result = detect_diagram(text_lower, self.viz_service)
            if result[0]:
                return result

        # 3. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (–±–µ–∑ —è–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏)
        has_context_pattern = False
        if not has_visualization_request:
            context_visualization_patterns = [
                r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s*—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]\s*–Ω–∞\s*\d+",
                r"–≥—Ä–∞—Ñ–∏–∫\s+—Ñ—É–Ω–∫—Ü–∏[–∏–∏]",
                r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=",
                r"–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è\s+—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s*–º–µ–Ω–¥–µ–ª–µ–µ–≤–∞",
            ]
            has_context_pattern = any(
                re.search(p, text_lower) for p in context_visualization_patterns
            )
            if not has_context_pattern:
                logger.debug(
                    "üîç –ù–µ—Ç —è–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
                )
                return None, None

        # 4. –ü—Ä–µ–¥–º–µ—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã, —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–∏, –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞
        result = detect_subject_tables_and_diagrams(text_lower, self.viz_service)
        if result[0]:
            return result

        # 5. –ö–∞—Ä—Ç—ã (—Å –∑–∞—â–∏—Ç–æ–π –æ—Ç ¬´–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è X¬ª)
        if not self.detect_geography_question(text):
            result = detect_map(text_lower, self.viz_service)
            if result[0]:
                return result

        # 6. –§–∏–∑–∏–∫–∞ (–¥–≤–∏–∂–µ–Ω–∏–µ, —Å–∫–æ—Ä–æ—Å—Ç—å, —ç–ª–µ–∫—Ç—Ä–∏–∫–∞, —Ç–µ–ø–ª–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã)
        result = detect_physics(text_lower, text, self.viz_service, has_visualization_request)
        if result[0]:
            return result

        # 7. –ì—Ä–∞—Ñ–∏–∫–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
        if has_visualization_request or has_context_pattern:
            result = detect_math_graph(text_lower, text, self.viz_service)
            if result[0]:
                return result

        return None, None
