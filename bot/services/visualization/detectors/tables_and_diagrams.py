"""
–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü, –¥–∏–∞–≥—Ä–∞–º–º, –∫–∞—Ä—Ç –∏ –ø—Ä–µ–¥–º–µ—Ç–Ω—ã—Ö —Å—Ö–µ–º.

–°—é–¥–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –ª–æ–≥–∏–∫–∏ –∏–∑ VisualizationDetector.detect,
—á—Ç–æ–±—ã –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª detector.py –æ—Å—Ç–∞–≤–∞–ª—Å—è –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ –∏ –ª–µ–≥—á–µ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏.

–ü—É–±–ª–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
    detect_subject_tables_and_diagrams(text_lower, viz_service,
                                       has_visualization_request, has_context_pattern)
"""

from __future__ import annotations

import re

from loguru import logger


def detect_subject_tables_and_diagrams(
    text_lower: str,
    viz_service,
    has_visualization_request: bool,
    has_context_pattern: bool,
) -> tuple[bytes | None, str | None]:
    """
    –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ç–∞–±–ª–∏—Ü—ã, –¥–∏–∞–≥—Ä–∞–º–º—ã, –∫–∞—Ä—Ç—ã –∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.

    Args:
        text_lower: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ.
        viz_service: –≠–∫–∑–µ–º–ø–ª—è—Ä VisualizationService —Å –º–µ—Ç–æ–¥–∞–º–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
        has_visualization_request: –ï—Å—Ç—å –ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —è–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.
        has_context_pattern: –ï—Å—Ç—å –ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.

    Returns:
        (image_bytes, visualization_type) –∏–ª–∏ (None, None), –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
    """

    # 1. –¢–∞–±–ª–∏—Ü–∞ —Å–ø—Ä—è–∂–µ–Ω–∏—è/—Å–æ–ø—Ä—è–∂–µ–Ω–∏—è –≥–ª–∞–≥–æ–ª–æ–≤ (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å)
    verb_patterns = [
        r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+—Å–æ–ø—Ä—è–∂–µ–Ω–∏[—è–µ]\s+–≥–ª–∞–≥–æ–ª",
        r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+—Å–ø—Ä—è–∂–µ–Ω–∏[—è–µ]\s+–≥–ª–∞–≥–æ–ª",
        r"—Å–æ–ø—Ä—è–∂–µ–Ω–∏[—è–µ]\s+–≥–ª–∞–≥–æ–ª",
        r"—Å–ø—Ä—è–∂–µ–Ω–∏[—è–µ]\s+–≥–ª–∞–≥–æ–ª",
        r"(?<!—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ])(?<!—Å–ª–æ–∂–µ–Ω–∏[—è–µ])(?<!–≤—ã—á–∏—Ç–∞–Ω–∏[—è–µ])(?<!–¥–µ–ª–µ–Ω–∏[—è–µ])—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+—Å–æ–ø—Ä—è–∂–µ–Ω–∏[—è–µ]",
        r"(?<!—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ])(?<!—Å–ª–æ–∂–µ–Ω–∏[—è–µ])(?<!–≤—ã—á–∏—Ç–∞–Ω–∏[—è–µ])(?<!–¥–µ–ª–µ–Ω–∏[—è–µ])—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+—Å–ø—Ä—è–∂–µ–Ω–∏[—è–µ]",
    ]
    for pattern in verb_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_russian_verb_conjugation_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–ø—Ä—è–∂–µ–Ω–∏—è/—Å–æ–ø—Ä—è–∂–µ–Ω–∏—è –≥–ª–∞–≥–æ–ª–æ–≤")
                return image, "table"

    # 2. –ê–ª–≥–µ–±—Ä–∞: —Å—Ç–µ–ø–µ–Ω–∏ 2 –∏ 10
    if "—Å—Ç–µ–ø–µ–Ω" in text_lower and (
        "2" in text_lower or "10" in text_lower or "–¥–≤–æ–π–∫" in text_lower or "–¥–≤–∞" in text_lower
    ):
        image = viz_service.generate_powers_of_2_and_10_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç–µ–ø–µ–Ω–µ–π —á–∏—Å–µ–ª 2 –∏ 10")
            return image, "table"

    # 3. –ü—Ä–æ—Å—Ç—ã–µ —á–∏—Å–ª–∞
    if (
        ("–ø—Ä–æ—Å—Ç" in text_lower and "—á–∏—Å–ª" in text_lower)
        or "—Ä–µ—à–µ—Ç–æ" in text_lower
        or "—ç—Ä–∞—Ç–æ—Å—Ñ–µ–Ω" in text_lower
    ):
        image = viz_service.generate_prime_numbers_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ—Å—Ç—ã—Ö —á–∏—Å–µ–ª")
            return image, "table"

    # 4. –§–æ—Ä–º—É–ª—ã —Å–æ–∫—Ä–∞—â–µ–Ω–Ω–æ–≥–æ —É–º–Ω–æ–∂–µ–Ω–∏—è
    if re.search(
        r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:—Ñ–æ—Ä–º—É–ª[—ã]?\s+—Å–æ–∫—Ä–∞—â–µ–Ω–Ω|—Å–æ–∫—Ä–∞—â–µ–Ω–Ω[–æ–µ]?\s+—É–º–Ω–æ–∂–µ–Ω)",
        text_lower,
    ):
        image = viz_service.generate_abbreviated_multiplication_formulas_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Ñ–æ—Ä–º—É–ª —Å–æ–∫—Ä–∞—â–µ–Ω–Ω–æ–≥–æ —É–º–Ω–æ–∂–µ–Ω–∏—è")
            return image, "table"

    # 5. –°–≤–æ–π—Å—Ç–≤–∞ —Å—Ç–µ–ø–µ–Ω–µ–π
    if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:—Å–≤–æ–π—Å—Ç–≤[–∞]?\s+—Å—Ç–µ–ø–µ–Ω)", text_lower):
        image = viz_service.generate_power_properties_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–≤–æ–π—Å—Ç–≤ —Å—Ç–µ–ø–µ–Ω–µ–π")
            return image, "table"

    # 6. –°–≤–æ–π—Å—Ç–≤–∞ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –∫–æ—Ä–Ω—è
    if re.search(
        r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:—Å–≤–æ–π—Å—Ç–≤[–∞]?\s+–∫–æ—Ä–Ω|–∫–≤–∞–¥—Ä–∞—Ç–Ω[—ã–π]?\s+–∫–æ—Ä–µ–Ω)", text_lower
    ):
        image = viz_service.generate_square_root_properties_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–≤–æ–π—Å—Ç–≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –∫–æ—Ä–Ω—è")
            return image, "table"

    # 7. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥ —á–∏—Å–ª–∞
    if "—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω" in text_lower and "–≤–∏–¥" in text_lower:
        image = viz_service.generate_standard_form_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –≤–∏–¥–∞ —á–∏—Å–ª–∞")
            return image, "table"

    # 8. –ö–≤–∞–¥—Ä–∞—Ç—ã –∏ –∫—É–±—ã (–¥–æ —Ç–∞–±–ª–∏—Ü—ã —É–º–Ω–æ–∂–µ–Ω–∏—è)
    if ("–∫–≤–∞–¥—Ä–∞—Ç" in text_lower and "–∫—É–±" in text_lower) and "—É–º–Ω–æ–∂" not in text_lower:
        image = viz_service.generate_squares_and_cubes_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ –∏ –∫—É–±–æ–≤")
            return image, "table"

    # 9. –ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è (–±–µ–∑ —á–∏—Å–ª–∞)
    has_table = "—Ç–∞–±–ª" in text_lower
    has_multiply = "—É–º–Ω–æ–∂" in text_lower
    has_number_pattern = re.search(r"—É–º–Ω–æ–∂[–∞-—è]*\s+–Ω–∞\s+\d+", text_lower)
    has_specific_table = re.search(
        r"(?:–≥–ª–∞–≥–æ–ª|–ø–∞–¥–µ–∂|–∞–ª—Ñ–∞–≤–∏—Ç|–±—É–∫–≤|–∑–≤—É–∫|–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ|–ø—É–Ω–∫—Ç—É–∞—Ü|–º–æ—Ä—Ñ–µ–º–Ω|—Å—Ç–∏–ª\s+—Ä–µ—á|"
        r"—Å–æ–ø—Ä—è–∂–µ–Ω–∏[—è–µ]|—Å–ø—Ä—è–∂–µ–Ω–∏[—è–µ]|–≤—Ä–µ–º–µ–Ω[–∞]?\s+–≥–æ–¥|–º–µ—Å—è—Ü|—á–∞—Å–æ–≤[—ã–µ]?\s+–ø–æ—è—Å|"
        r"—Å—Ç—Ä–∞–Ω—ã?|—Ö—Ä–æ–Ω–æ–ª–æ–≥–∏|–≤–µ—Ç–≤[–∏]?\s+–≤–ª–∞—Å—Ç|—Å–∏—Å—Ç–µ–º[—ã]?\s+—Å—á–∏—Å–ª–µ–Ω–∏)",
        text_lower,
    )
    if has_table and has_multiply and not has_number_pattern and not has_specific_table:
        image = viz_service.generate_full_multiplication_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è")
            return image, "table"

    full_table_patterns = [
        r"^–ø–æ–∫–∞–∂–∏\s+—Ç–∞–±–ª\w*\s*—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]\s*$",
        r"^–≤—ã–≤–µ–¥–∏\s+—Ç–∞–±–ª\w*\s*—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]\s*$",
        r"—Ç–∞–±–ª\w*\s*—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]\s+–Ω–∞\s+–≤—Å–µ",
        r"–ø–æ–ª–Ω–∞—è\s+—Ç–∞–±–ª\w*\s*—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]",
    ]
    for pattern in full_table_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_full_multiplication_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è")
            return image, "table"

    # 11. –¢–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —á–∏—Å–ª–æ
    multiplication_patterns = [
        r"—Ç–∞–±–ª\w*\s*—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]\s*–Ω–∞\s*(\d+)",
        r"—Ç–∞–±–ª\w*\s*—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]\s+(\d+)",
        r"—É–º–Ω–æ–∂–µ–Ω–∏[—è–µ]\s+–Ω–∞\s*(\d+)",
        r"—É–º–Ω–æ–∂[–∞-—è]*\s+(\d+)",
    ]
    for pattern in multiplication_patterns:
        match = re.search(pattern, text_lower)
        if match:
            try:
                number = int(match.group(1))
                if 1 <= number <= 10:
                    image = viz_service.generate_multiplication_table_image(number)
                    if image:
                        logger.info(f"üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è –Ω–∞ {number}")
                        return image, "table"
            except (ValueError, IndexError):
                continue

    # 12. –•–∏–º–∏—è: —Ä–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç—å
    solubility_patterns = [
        r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+—Ä–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç",
        r"—Ä–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç[—å–∏]?\s+–≤–µ—â–µ—Å—Ç–≤",
        r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+—Ä–∞—Å—Ç–≤–æ—Ä",
    ]
    for pattern in solubility_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_chemistry_solubility_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç–∏")
            return image, "table"

    # 13. –•–∏–º–∏—è: –≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å
    valence_patterns = [
        r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç",
        r"–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç[—å–∏]?\s+—ç–ª–µ–º–µ–Ω—Ç",
        r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+–≤–∞–ª–µ–Ω—Ç",
        r"–ø–æ–∫–∞–∂–∏\s+—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç",
        r"–ø–æ–∫–∞–∂–∏\s+–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç",
        r"–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç[—å–∏]?",
    ]
    for pattern in valence_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_chemistry_valence_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏")
            return image, "table"

    # 14. –§–∏–∑–∏–∫–∞: –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    constants_patterns = [
        r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+(?:—Ñ–∏–∑–∏—á–µ—Å–∫|–∫–æ–Ω—Å—Ç–∞–Ω—Ç)",
        r"—Ñ–∏–∑–∏—á–µ—Å–∫[–∏–µ]?\s+–∫–æ–Ω—Å—Ç–∞–Ω—Ç[—ã]?",
        r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+–∫–æ–Ω—Å—Ç–∞–Ω—Ç",
    ]
    for pattern in constants_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_physics_constants_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç")
            return image, "table"

    # 15. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π: –≤—Ä–µ–º–µ–Ω–∞
    english_tenses_patterns = [
        r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+–≤—Ä–µ–º–µ–Ω",
        r"–≤—Ä–µ–º–µ–Ω[–∞]?\s+(?:–∞–Ω–≥–ª–∏–π—Å–∫|–∞–Ω–≥–ª)",
        r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+(?:–∞–Ω–≥–ª–∏–π—Å–∫|–∞–Ω–≥–ª)\s+–≤—Ä–µ–º–µ–Ω",
    ]
    for pattern in english_tenses_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_english_tenses_table()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –≤—Ä–µ–º–µ–Ω –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ")
            return image, "table"

    # 16. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã
    if "–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω" in text_lower and "–≥–ª–∞–≥–æ–ª" in text_lower:
        image = viz_service.generate_english_irregular_verbs_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≥–ª–∞–≥–æ–ª–æ–≤")
            return image, "table"

    # 17‚Äì21. –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
    if re.search(r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+—Å–ª–æ–∂–µ–Ω–∏[—è–µ]", text_lower):
        image = viz_service.generate_addition_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–ª–æ–∂–µ–Ω–∏—è")
            return image, "table"

    if re.search(r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+–≤—ã—á–∏—Ç–∞–Ω–∏[—è–µ]", text_lower):
        image = viz_service.generate_subtraction_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –≤—ã—á–∏—Ç–∞–Ω–∏—è")
            return image, "table"

    if re.search(r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+–¥–µ–ª–µ–Ω–∏[—è–µ]", text_lower):
        image = viz_service.generate_division_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –¥–µ–ª–µ–Ω–∏—è")
            return image, "table"

    if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?–µ–¥–∏–Ω–∏—Ü[—ã]?\s+–∏–∑–º–µ—Ä–µ–Ω–∏[—è–µ]", text_lower):
        image = viz_service.generate_units_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è")
            return image, "table"

    # 21‚Äì26. –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
    if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:–±—É–∫–≤|–∞–ª—Ñ–∞–≤–∏—Ç|–∑–≤—É–∫)", text_lower):
        image = viz_service.generate_russian_alphabet_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –±—É–∫–≤ –∏ –∑–≤—É–∫–æ–≤")
            return image, "table"

    if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:–ø–∞–¥–µ–∂|—Å–∫–ª–æ–Ω–µ–Ω–∏)", text_lower):
        image = viz_service.generate_russian_cases_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –ø–∞–¥–µ–∂–µ–π")
            return image, "table"

    if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ|–ø—Ä–∞–≤–æ–ø–∏—Å–∞–Ω)", text_lower):
        image = viz_service.generate_russian_orthography_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏–∏")
            return image, "table"

    if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:–ø—É–Ω–∫—Ç—É–∞—Ü|–∑–Ω–∞–∫[–∏]?\s+–ø—Ä–µ–ø–∏–Ω–∞–Ω)", text_lower):
        image = viz_service.generate_russian_punctuation_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏")
            return image, "table"

    if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:–º–æ—Ä—Ñ–µ–º–Ω|—Ä–∞–∑–±–æ—Ä\s+—Å–ª–æ–≤)", text_lower):
        image = viz_service.generate_russian_word_analysis_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –º–æ—Ä—Ñ–µ–º–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞")
            return image, "table"

    if "—Å—Ç–∏–ª" in text_lower and "—Ä–µ—á" in text_lower:
        image = viz_service.generate_russian_speech_styles_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç–∏–ª–µ–π —Ä–µ—á–∏")
            return image, "table"

    # 27‚Äì30. –û–∫—Ä—É–∂–∞—é—â–∏–π –º–∏—Ä –∏ –≥–µ–æ–≥—Ä–∞—Ñ–∏—è
    if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:–≤—Ä–µ–º–µ–Ω[–∞]?\s+–≥–æ–¥|–º–µ—Å—è—Ü|–¥–Ω[–∏—è]?\s+–Ω–µ–¥–µ–ª)", text_lower):
        image = viz_service.generate_seasons_months_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –≤—Ä–µ–º–µ–Ω –≥–æ–¥–∞")
            return image, "table"

    if re.search(r"–ø—Ä–∏—Ä–æ–¥–Ω[—ã–µ]?\s+–∑–æ–Ω", text_lower):
        image = viz_service.generate_natural_zones_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–∏—Ä–æ–¥–Ω—ã—Ö –∑–æ–Ω")
            return image, "table"

    if re.search(r"—á–∞—Å–æ–≤[—ã–µ]?\s+–ø–æ—è—Å", text_lower):
        image = viz_service.generate_time_zones_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤")
            return image, "table"

    if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:–∫—Ä—É–ø–Ω–µ–π—à|—Å—Ç—Ä–∞–Ω—ã?\s+–º–∏—Ä)", text_lower):
        image = viz_service.generate_countries_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç—Ä–∞–Ω")
            return image, "table"

    # 31. –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –∏ –∫–∞—Ä—Ç—ã (Yandex Maps Static API)
    map_keywords = [
        r"–∫–∞—Ä—Ç[–∞–µ—ã—É]?\s+(?:—Å—Ç—Ä–∞–Ω—ã|–º–∏—Ä–∞|—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|–µ–≤—Ä–æ–ø|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω|–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤|—Ä–∞–π–æ–Ω)",
        r"(?:–ø–æ–∫–∞–∂–∏|–Ω–∞—Ä–∏—Å—É–π|—Å–æ–∑–¥–∞–π|—Å–æ—Å—Ç–∞–≤—å|–ø–æ—Å—Ç—Ä–æ–π|–≤—ã–≤–µ–¥–∏|–æ—Ç–æ–±—Ä–∞–∑–∏)\s+(?:–∫–∞—Ä—Ç[–∞–µ—ã—É]?\s+)?(?:—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|–µ–≤—Ä–æ–ø|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω|–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤|—Ä–∞–π–æ–Ω)",
        r"(?:–ø–æ–∫–∞–∂–∏|–Ω–∞—Ä–∏—Å—É–π|—Å–æ–∑–¥–∞–π|—Å–æ—Å—Ç–∞–≤—å|–ø–æ—Å—Ç—Ä–æ–π|–≤—ã–≤–µ–¥–∏|–æ—Ç–æ–±—Ä–∞–∑–∏)\s+(?:–∫–∞—Ä—Ç[–∞–µ—ã—É]|–≥–¥–µ\s+–Ω–∞—Ö–æ–¥–∏—Ç—Å—è|–º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏)",
        r"–≥–¥–µ\s+–Ω–∞—Ö–æ–¥–∏—Ç—Å—è\s+(?:—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|—Å—Ç—Ä–∞–Ω–∞|–µ–≤—Ä–æ–ø|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω|–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤)",
        r"–º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏[–µ—è]\s+(?:—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|–µ–≤—Ä–æ–ø|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω|–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤)",
        r"–ø–æ–∫–∞–∂–∏\s+–Ω–∞\s+–∫–∞—Ä—Ç–µ",
        r"—Ñ–∏–∑–∏—á–µ—Å–∫[–∞—è]?\s+–∫–∞—Ä—Ç[–∞–µ—ã—É]?\s+—Ä–æ—Å—Å–∏",
        r"–≥–æ—Ä[—ã]?\s+–∞—Ñ—Ä–∏–∫",
    ]

    for pattern in map_keywords:
        match = re.search(pattern, text_lower)
        if not match:
            continue

        # –†–∞–π–æ–Ω—ã (–°–ü–± / –ú–æ—Å–∫–≤–∞)
        district_match = re.search(
            r"(–º–æ—Å–∫–æ–≤—Å–∫–∏–π|–∞–¥–º–∏—Ä–∞–ª—Ç–µ–π—Å–∫–∏–π|–≤–∞—Å–∏–ª–µ–æ—Å—Ç—Ä–æ–≤—Å–∫–∏–π|–≤—ã–±–æ—Ä–≥—Å–∫–∏–π|–∫–∞–ª–∏–Ω–∏–Ω—Å–∫–∏–π|"
            r"–∫–∏—Ä–æ–≤—Å–∫–∏–π|–∫–æ–ª–ø–∏–Ω—Å–∫–∏–π|–∫—Ä–∞—Å–Ω–æ–≥–≤–∞—Ä–¥–µ–π—Å–∫–∏–π|–∫—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∏–π|–∫—Ä–æ–Ω—à—Ç–∞–¥—Ç—Å–∫–∏–π|"
            r"–∫—É—Ä–æ—Ä—Ç–Ω—ã–π|–Ω–µ–≤—Å–∫–∏–π|–ø–µ—Ç—Ä–æ–≥—Ä–∞–¥—Å–∫–∏–π|–ø–µ—Ç—Ä–æ–¥–≤–æ—Ä—Ü–æ–≤—ã–π|–ø—Ä–∏–º–æ—Ä—Å–∫–∏–π|–ø—É—à–∫–∏–Ω—Å–∫–∏–π|"
            r"—Ñ—Ä—É–Ω–∑–µ–Ω—Å–∫–∏–π|—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π)\s*(?:—Ä–∞–π–æ–Ω)?\s*(?:—Å–ø–±|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|–ø–∏—Ç–µ—Ä|–º–æ—Å–∫–≤)?",
            text_lower,
        )
        if district_match:
            district_name = district_match.group(1)
            if any(word in text_lower for word in ["—Å–ø–±", "–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "–ø–∏—Ç–µ—Ä"]):
                country_name = f"{district_name} —Ä–∞–π–æ–Ω —Å–ø–±"
            elif "–º–æ—Å–∫–≤" in text_lower:
                country_name = f"{district_name} —Ä–∞–π–æ–Ω –º–æ—Å–∫–≤—ã"
            else:
                country_name = f"{district_name} —Ä–∞–π–æ–Ω —Å–ø–±"

            image = viz_service.generate_country_map(country_name)
            if image:
                logger.info(f"üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω —Ä–∞–π–æ–Ω: {country_name}")
                return image, "map"

        # –ì–æ—Ä–æ–¥–∞
        city_match = re.search(
            r"(–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤)",
            text_lower,
        )
        if city_match:
            city_name = city_match.group(1)
            if (
                city_name in ["–ø–∏—Ç–µ—Ä", "–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "—Å–ø–±"]
                or "—Å–∞–Ω–∫—Ç" in city_name
                or "–ø–µ—Ç–µ—Ä–±—É—Ä–≥" in city_name
            ):
                country_name = "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥"
            elif "–º–æ—Å–∫–≤" in city_name:
                country_name = "–º–æ—Å–∫–≤–∞"
            else:
                country_name = city_name

            image = viz_service.generate_country_map(country_name)
            if image:
                logger.info(f"üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥–æ—Ä–æ–¥: {country_name}")
                return image, "map"

        # –°—Ç—Ä–∞–Ω—ã
        country_match = re.search(
            r"(—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|"
            r"–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|–µ–≤—Ä–æ–ø|—Å—Ç—Ä–∞–Ω–∞|–º–∏—Ä|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|"
            r"—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|"
            r"–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|"
            r"–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω)",
            text_lower,
        )
        if country_match:
            country_name = country_match.group(1)
            if "–µ–≤—Ä–æ–ø" in country_name:
                country_name = "–µ–≤—Ä–æ–ø–∞"
            else:
                full_country_match = re.search(rf"({country_match.group(1)}[–∞-—è]*)", text_lower)
                if full_country_match:
                    country_name = full_country_match.group(1)

            image = viz_service.generate_country_map(country_name)
            if image:
                logger.info(f"üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∞: {country_name}")
                return image, "map"

        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏, –Ω–æ –µ—Å—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–∞—Ä—Ç—É - –∫–∞—Ä—Ç–∞ –º–∏—Ä–∞
        if "–∫–∞—Ä—Ç" in text_lower or "–ø–æ–∫–∞–∂–∏" in text_lower:
            image = viz_service.generate_country_map("–º–∏—Ä")
            if image:
                logger.info("üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∫–∞—Ä—Ç–∞ –º–∏—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)")
                return image, "map"

    # 31. –ò—Å—Ç–æ—Ä–∏—è: —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è
    history_patterns = [
        r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:—Ö—Ä–æ–Ω–æ–ª–æ–≥–∏|–∏—Å—Ç–æ—Ä–∏[—è–∏]?\s+—Ä–æ—Å—Å–∏)",
        r"–∫–∞—Ä—Ç[–∞–µ—ã—É]?\s+–≤–æ–π–Ω[—ã]",
        r"–≥–¥–µ\s+–ø—Ä–æ—Ö–æ–¥–∏–ª\s+–∫—Ä–µ—Å—Ç–æ–≤[—ã–π]?\s+–ø–æ—Ö–æ–¥",
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+–±–∏—Ç–≤[—ã]?\s+–ø—Ä–∏\s+–±–æ—Ä–æ–¥–∏–Ω–æ",
        r"–≥–æ–¥[—ã]?\s+–ø—Ä–∞–≤–ª–µ–Ω–∏[—è–µ]",
        r"—Ö—Ä–æ–Ω–æ–ª–æ–≥–∏[—è–∏]",
        r"—Ä–µ—Ñ–æ—Ä–º[—ã]",
        r"–ª–µ–Ω—Ç[–∞–µ—ã—É]?\s+–≤—Ä–µ–º–µ–Ω[–∏]",
    ]
    for pattern in history_patterns:
        if re.search(pattern, text_lower):
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å—Ö–µ–º—É –±–∏—Ç–≤—ã
            if "—Å—Ö–µ–º" in text_lower and "–±–∏—Ç–≤" in text_lower:
                battle = "–±–æ—Ä–æ–¥–∏–Ω–æ"
                battles = ["–±–æ—Ä–æ–¥–∏–Ω–æ", "–∫—É–ª–∏–∫–æ–≤–æ", "–ø–æ–ª—Ç–∞–≤–∞", "—Å—Ç–∞–ª–∏–Ω–≥—Ä–∞–¥", "–ª–µ–¥–æ–≤–æ"]
                for b in battles:
                    if b in text_lower:
                        battle = b
                        break
                image = viz_service.generate_battle_scheme(battle)
                if image:
                    logger.info(f"üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ö–µ–º–∞ –±–∏—Ç–≤—ã: {battle}")
                    return image, "scheme"
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—é –≤–æ–π–Ω—ã
            elif "—Ö—Ä–æ–Ω–æ–ª–æ–≥" in text_lower or "–≤–æ–π–Ω" in text_lower:
                war = "–≤–æ–≤"
                if "1812" in text_lower or "–Ω–∞–ø–æ–ª–µ–æ–Ω" in text_lower:
                    war = "1812"
                elif "—Å–µ–≤–µ—Ä–Ω" in text_lower:
                    war = "—Å–µ–≤–µ—Ä–Ω–∞—è"
                image = viz_service.generate_war_timeline(war)
                if image:
                    logger.info(f"üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è –≤–æ–π–Ω—ã: {war}")
                    return image, "table"
            else:
                image = viz_service.generate_history_timeline_table()
                if image:
                    logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞")
                    return image, "table"

    # 32. –û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ: –≤–µ—Ç–≤–∏ –≤–ª–∞—Å—Ç–∏
    if re.search(r"–≤–µ—Ç–≤[–∏]?\s+–≤–ª–∞—Å—Ç", text_lower):
        image = viz_service.generate_government_branches_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –≤–µ—Ç–≤–µ–π –≤–ª–∞—Å—Ç–∏")
            return image, "table"

    # 33. –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞: —Å–∏—Å—Ç–µ–º—ã —Å—á–∏—Å–ª–µ–Ω–∏—è
    if re.search(r"(?:—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s+)?(?:—Å–∏—Å—Ç–µ–º[—ã]?\s+—Å—á–∏—Å–ª–µ–Ω–∏|–¥–≤–æ–∏—á–Ω|–≤–æ—Å—å–º–µ—Ä–∏—á–Ω)", text_lower):
        image = viz_service.generate_number_systems_table()
        if image:
            logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å–∏—Å—Ç–µ–º —Å—á–∏—Å–ª–µ–Ω–∏—è")
            return image, "table"

    # 34. –•–∏–º–∏—è: –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ú–µ–Ω–¥–µ–ª–µ–µ–≤–∞
    mendeleev_patterns = [
        r"—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s*–º–µ–Ω–¥–µ–ª–µ–µ–≤–∞",
        r"–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è\s+—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?",
        r"–º–µ–Ω–¥–µ–ª–µ–µ–≤–∞",
        r"–ø–æ–∫–∞–∂–∏\s+—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?\s*–º–µ–Ω–¥–µ–ª–µ–µ–≤–∞",
        r"–ø–æ–∫–∞–∂–∏\s+–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é\s+—Ç–∞–±–ª[–∏—ã]—Ü[–∞–µ—ã]?",
    ]
    for pattern in mendeleev_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_periodic_table_simple()
            if image:
                logger.info("üìä –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ú–µ–Ω–¥–µ–ª–µ–µ–≤–∞")
            return image, "table"

    # 35‚Äì38. –§–∏–∑–∏–∫–∞ –∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞—Ñ–∏–∫–∏
    physics_motion_patterns = [
        r"–≥—Ä–∞—Ñ–∏–∫\s+(?:–ø—É—Ç–∏|–ø—É—Ç—å)\s+–æ—Ç\s+–≤—Ä–µ–º–µ–Ω",
        r"–≥—Ä–∞—Ñ–∏–∫\s+—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω[–æ–≥–æ]?\s+–¥–≤–∏–∂–µ–Ω–∏[—è–µ]",
        r"–≥—Ä–∞—Ñ–∏–∫\s+—Ä–∞–≤–Ω–æ—É—Å–∫–æ—Ä–µ–Ω–Ω[–æ–≥–æ]?\s+–¥–≤–∏–∂–µ–Ω–∏[—è–µ]",
        r"–≥—Ä–∞—Ñ–∏–∫\s+–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç[–∏–∏]?\s+–ø—É—Ç–∏\s+–æ—Ç\s+–≤—Ä–µ–º–µ–Ω",
        r"–ø—É—Ç—å\s+–æ—Ç\s+–≤—Ä–µ–º–µ–Ω[–∏]?\s+–≥—Ä–∞—Ñ–∏–∫",
        r"–Ω–∞—Ä–∏—Å—É–π[,\s]+–∫–∞–∫\s+–µ–¥–µ—Ç\s+–º–∞—à–∏–Ω",
        r"–≥—Ä–∞—Ñ–∏–∫\s+–ø—É—Ç–∏",
        r"—Ä–∞–≤–Ω–æ—É—Å–∫–æ—Ä–µ–Ω–Ω–æ–µ\s+–¥–≤–∏–∂–µ–Ω–∏–µ\s+–≥—Ä–∞—Ñ–∏–∫",
        r"–≥—Ä–∞—Ñ–∏–∫\s+—Å–∫–æ—Ä–æ—Å—Ç[–∏]?\s+v\s*\(?\s*t\s*\)?",
        r"—Ç–æ—Ä–º–æ–∂–µ–Ω–∏[–µ—è]",
    ]
    for pattern in physics_motion_patterns:
        if re.search(pattern, text_lower):
            if re.search(r"—Ä–∞–≤–Ω–æ—É—Å–∫–æ—Ä–µ–Ω–Ω", text_lower):
                image = viz_service.generate_physics_motion_graph("accelerated")
            else:
                image = viz_service.generate_physics_motion_graph("uniform")
            if image:
                logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ –ø—É—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏")
                return image, "graph"

    physics_velocity_patterns = [
        r"–≥—Ä–∞—Ñ–∏–∫\s+—Å–∫–æ—Ä–æ—Å—Ç[–∏]?\s+–æ—Ç\s+–≤—Ä–µ–º–µ–Ω",
        r"–≥—Ä–∞—Ñ–∏–∫\s+–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç[–∏–∏]?\s+—Å–∫–æ—Ä–æ—Å—Ç[–∏]?\s+–æ—Ç\s+–≤—Ä–µ–º–µ–Ω",
        r"—Å–∫–æ—Ä–æ—Å—Ç[—å–∏]?\s+–æ—Ç\s+–≤—Ä–µ–º–µ–Ω[–∏]?\s+–≥—Ä–∞—Ñ–∏–∫",
    ]
    for pattern in physics_velocity_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_physics_motion_graph("velocity")
            if image:
                logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏")
            return image, "graph"

    if re.search(r"–≥—Ä–∞—Ñ–∏–∫\s+–º–µ–¥–∏–∞–Ω", text_lower) or re.search(
        r"–º–µ–¥–∏–∞–Ω[–∞—ã]?\s+—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫", text_lower
    ):
        image = viz_service.generate_median_diagram()
        if image:
            logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ö–µ–º–∞ –º–µ–¥–∏–∞–Ω—ã —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞")
            return image, "graph"

    physics_electric_patterns = [
        r"(?:–≥—Ä–∞—Ñ–∏–∫\s+)?–∑–∞–∫–æ–Ω\s+–æ–º[–∞]?",
        r"—Å–∏–ª–∞\s+—Ç–æ–∫–∞\s+–æ—Ç\s+–Ω–∞–ø—Ä—è–∂–µ–Ω–∏[—è]",
        r"–≤–æ–ª—å—Ç[-\s]?–∞–º–ø–µ—Ä–Ω[–∞—è]?\s+—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫[–∞–∏]",
        r"–≥—Ä–∞—Ñ–∏–∫\s+—Å–∏–ª[—ã]?\s+—Ç–æ–∫–∞\s+–æ—Ç\s+–Ω–∞–ø—Ä—è–∂–µ–Ω–∏[—è]",
        r"–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ\s+–∏\s+—Ç–æ–∫",
    ]
    electric_scheme_patterns = [
        r"—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫[–∞—è]?\s+—Å—Ö–µ–º[–∞–µ—ã—É]",
        r"—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫[–∞—è]?\s+—Ü–µ–ø[—å–∏]",
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫[–æ–≥–æ]?\s+—Ü–µ–ø[–∏]",
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+—Å\s+–ª–∞–º–ø[–æ–π–æ–π]",
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+—Ü–µ–ø[–∏]",
        r"–Ω–∞—Ä–∏—Å—É–π\s+–ª–∞–º–ø–æ—á–∫[—É]?\s+–∏\s+—Ä–µ–∑–∏—Å—Ç–æ—Ä",
        r"–∫–∞–∫\s+—Å–æ–µ–¥–∏–Ω–∏—Ç—å\s+–ø—Ä–æ–≤–æ–¥–Ω–∏–∫",
    ]
    physics_thermal_patterns = [
        r"–≥—Ä–∞—Ñ–∏–∫\s+–Ω–∞–≥—Ä–µ–≤–∞–Ω–∏[—è]?\s+–≤–æ–¥[—ã]",
        r"–∫–æ–≥–¥–∞\s+–ª–µ–¥\s+—Ç–∞–µ—Ç",
        r"–≥—Ä–∞—Ñ–∏–∫\s+–ø–ª–∞–≤–ª–µ–Ω–∏[—è]",
        r"–∫—Ä–∏–≤[–∞—è]?\s+–Ω–∞–≥—Ä–µ–≤–∞",
    ]

    if has_visualization_request:
        for pattern in electric_scheme_patterns:
            if re.search(pattern, text_lower):
                image = viz_service.generate_electric_circuit_scheme()
                if image:
                    logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞ —Ü–µ–ø–∏")
                    return image, "scheme"
                image = viz_service.generate_ohms_law_graph()
                if image:
                    logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞/–≥—Ä–∞—Ñ–∏–∫ –∑–∞–∫–æ–Ω–∞ –û–º–∞")
                    return image, "graph"

        for pattern in physics_electric_patterns:
            if re.search(pattern, text_lower):
                image = viz_service.generate_ohms_law_graph()
                if image:
                    logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ –∑–∞–∫–æ–Ω–∞ –û–º–∞")
                    return image, "graph"

        for pattern in physics_thermal_patterns:
            if re.search(pattern, text_lower):
                substance = "–ª–µ–¥"
                for s in ["—Å–≤–∏–Ω–µ—Ü", "–æ–ª–æ–≤–æ", "–∞–ª—é–º–∏–Ω–∏–π"]:
                    if s in text_lower:
                        substance = s
                        break
                if re.search(r"–æ—Ö–ª–∞–∂–¥–µ–Ω–∏|–æ—Å—Ç—ã–≤–∞–Ω–∏", text_lower):
                    image = viz_service.generate_heating_cooling_graph("cooling")
                elif re.search(r"–ø–ª–∞–≤–ª–µ–Ω–∏|—Ç–∞–µ—Ç", text_lower):
                    image = viz_service.generate_melting_graph(substance)
                else:
                    image = viz_service.generate_heating_cooling_graph("heating")
                if image:
                    logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ —Ç–µ–ø–ª–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞")
                    return image, "graph"

    math_graph_patterns = [
        r"–≥—Ä–∞—Ñ–∏–∫\s+(?:–ø–∞—Ä–∞–±–æ–ª|—Å–∏–Ω—É—Å|–∫–æ—Å–∏–Ω—É—Å|—Ç–∞–Ω–≥–µ–Ω—Å|–ª–æ–≥–∞—Ä–∏—Ñ–º|—ç–∫—Å–ø–æ–Ω–µ–Ω—Ç|—Å—Ç–µ–ø–µ–Ω–Ω)",
        r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=\s*x\^2",
        r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=\s*sin",
        r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=\s*cos",
        r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=\s*tan",
        r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=\s*log",
        r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=\s*exp",
        r"–≥—Ä–∞—Ñ–∏–∫\s+y\s*=\s*\d+\^x",
        r"–ø–∞—Ä–∞–±–æ–ª[–∞—ã]",
        r"—Å–∏–Ω—É—Å–æ–∏–¥[–∞—ã]",
    ]

    if has_visualization_request or has_context_pattern:
        for pattern in math_graph_patterns:
            if not re.search(pattern, text_lower):
                continue

            function_match = re.search(r"y\s*=\s*([^,\n]+)", text_lower)
            if function_match:
                function_expr = function_match.group(1).strip()
                function_expr = re.sub(r"[^\w\s\+\-\*\/\^\(\)\.]", "", function_expr)
                if function_expr:
                    try:
                        image = viz_service.generate_function_graph(function_expr)
                        if image:
                            logger.info(f"üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ —Ñ—É–Ω–∫—Ü–∏–∏: {function_expr}")
                            return image, "graph"
                    except Exception as e:
                        logger.debug(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏: {e}")

            if "–ø–∞—Ä–∞–±–æ–ª" in text_lower:
                image = viz_service.generate_function_graph("x^2")
                if image:
                    logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ –ø–∞—Ä–∞–±–æ–ª—ã")
                    return image, "graph"
            if "—Å–∏–Ω—É—Å" in text_lower or "—Å–∏–Ω—É—Å–æ–∏–¥" in text_lower:
                image = viz_service.generate_function_graph("sin(x)")
                if image:
                    logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ —Å–∏–Ω—É—Å–∞")
                    return image, "graph"
            if "–∫–æ—Å–∏–Ω—É—Å" in text_lower:
                image = viz_service.generate_function_graph("cos(x)")
                if image:
                    logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ –∫–æ—Å–∏–Ω—É—Å–∞")
                    return image, "graph"

    return None, None
