"""–î–µ—Ç–µ–∫—Ü–∏—è –∫–∞—Ä—Ç (–≥–æ—Ä–æ–¥–∞, —Å—Ç—Ä–∞–Ω—ã, —Ä–∞–π–æ–Ω—ã)."""

from __future__ import annotations

import re

from loguru import logger


def detect_map(text_lower: str, viz_service) -> tuple[bytes | None, str | None]:
    """
    –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–∞—Ä—Ç —á–µ—Ä–µ–∑ Yandex Maps Static API.

    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ detect_geography_question.
    –ó–∞–ø—Ä–æ—Å—ã ¬´–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è X¬ª –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π, –Ω–µ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π.

    Args:
        text_lower: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ.
        viz_service: –≠–∫–∑–µ–º–ø–ª—è—Ä VisualizationService —Å –º–µ—Ç–æ–¥–∞–º–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

    Returns:
        (image_bytes, visualization_type) –∏–ª–∏ (None, None).
    """
    map_keywords = [
        r"–∫–∞—Ä—Ç[–∞–µ—ã—É]?\s+(?:—Å—Ç—Ä–∞–Ω—ã|–º–∏—Ä–∞|—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|–µ–≤—Ä–æ–ø|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω|–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤|–º—Å–∫|—Ä–∞–π–æ–Ω)",
        r"(?:–ø–æ–∫–∞–∂–∏|–Ω–∞—Ä–∏—Å—É–π|—Å–æ–∑–¥–∞–π|—Å–æ—Å—Ç–∞–≤—å|–ø–æ—Å—Ç—Ä–æ–π|–≤—ã–≤–µ–¥–∏|–æ—Ç–æ–±—Ä–∞–∑–∏)\s+(?:–∫–∞—Ä—Ç[–∞–µ—ã—É]?\s+)?(?:—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|–µ–≤—Ä–æ–ø|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω|–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤|–º—Å–∫|—Ä–∞–π–æ–Ω)",
        r"(?:–ø–æ–∫–∞–∂–∏|–Ω–∞—Ä–∏—Å—É–π|—Å–æ–∑–¥–∞–π|—Å–æ—Å—Ç–∞–≤—å|–ø–æ—Å—Ç—Ä–æ–π|–≤—ã–≤–µ–¥–∏|–æ—Ç–æ–±—Ä–∞–∑–∏)\s+(?:–∫–∞—Ä—Ç[–∞–µ—ã—É]|–º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏)",
        r"–ø–æ–∫–∞–∂–∏\s+–Ω–∞\s+–∫–∞—Ä—Ç–µ",
        r"—Ñ–∏–∑–∏—á–µ—Å–∫[–∞—è]?\s+–∫–∞—Ä—Ç[–∞–µ—ã—É]?\s+—Ä–æ—Å—Å–∏",
        r"–≥–æ—Ä[—ã]?\s+–∞—Ñ—Ä–∏–∫",
    ]

    for pattern in map_keywords:
        match = re.search(pattern, text_lower)
        if not match:
            continue

        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –æ–∫—Ä—É–≥ > —Ä–∞–π–æ–Ω > –≥–æ—Ä–æ–¥ > —Å—Ç—Ä–∞–Ω–∞

        # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –æ–∫—Ä—É–≥–∞ –ú–æ—Å–∫–≤—ã
        result = _detect_moscow_okrug(text_lower, viz_service)
        if result[0]:
            return result

        # –†–∞–π–æ–Ω—ã –°–ü–± –∏ –ú–æ—Å–∫–≤—ã
        result = _detect_district(text_lower, viz_service)
        if result[0]:
            return result

        # –ì–æ—Ä–æ–¥–∞ (–≤–∫–ª—é—á–∞—è –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—ã)
        result = _detect_city(text_lower, viz_service)
        if result[0]:
            return result

        # –°—Ç—Ä–∞–Ω—ã
        result = _detect_country(text_lower, viz_service)
        if result[0]:
            return result

        # Fallback ‚Äî –∫–∞—Ä—Ç–∞ –º–∏—Ä–∞
        if "–∫–∞—Ä—Ç" in text_lower or "–ø–æ–∫–∞–∂–∏" in text_lower:
            image = viz_service.generate_country_map("–º–∏—Ä")
            if image:
                logger.info("üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∫–∞—Ä—Ç–∞ –º–∏—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)")
                return image, "map"

    return None, None


# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏


def _detect_moscow_okrug(text_lower: str, viz_service) -> tuple[bytes | None, str | None]:
    """–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –æ–∫—Ä—É–≥–∞ –ú–æ—Å–∫–≤—ã."""
    okrug_match = re.search(
        r"(—Ü–∞–æ|—Å–∞–æ|—Å–≤–∞–æ|–≤–∞–æ|—é–≤–∞–æ|—é–∞–æ|—é–∑–∞–æ|–∑–∞–æ|—Å–∑–∞–æ|—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|—Å–µ–≤–µ—Ä–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|—Å–µ–≤–µ—Ä–æ[-\s]?–≤–æ—Å—Ç–æ—á–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|–≤–æ—Å—Ç–æ—á–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|—é–≥–æ[-\s]?–≤–æ—Å—Ç–æ—á–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|—é–∂–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|—é–≥–æ[-\s]?–∑–∞–ø–∞–¥–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|–∑–∞–ø–∞–¥–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|—Å–µ–≤–µ—Ä–æ[-\s]?–∑–∞–ø–∞–¥–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥)",
        text_lower,
    )
    if not okrug_match or "–º–æ—Å–∫–≤" not in text_lower:
        return None, None

    okrug_name = okrug_match.group(1).strip()
    okrug_map = {
        "—Ü–∞–æ": "—Ü–∞–æ",
        "—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω": "—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π",
        "—Å–∞–æ": "—Å–∞–æ",
        "—Å–µ–≤–µ—Ä–Ω": "—Å–µ–≤–µ—Ä–Ω—ã–π",
        "—Å–≤–∞–æ": "—Å–≤–∞–æ",
        "—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ—á–Ω": "—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π",
        "–≤–∞–æ": "–≤–∞–æ",
        "–≤–æ—Å—Ç–æ—á–Ω": "–≤–æ—Å—Ç–æ—á–Ω—ã–π",
        "—é–≤–∞–æ": "—é–≤–∞–æ",
        "—é–≥–æ-–≤–æ—Å—Ç–æ—á–Ω": "—é–≥–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π",
        "—é–∞–æ": "—é–∞–æ",
        "—é–∂–Ω": "—é–∂–Ω—ã–π",
        "—é–∑–∞–æ": "—é–∑–∞–æ",
        "—é–≥–æ-–∑–∞–ø–∞–¥–Ω": "—é–≥–æ-–∑–∞–ø–∞–¥–Ω—ã–π",
        "–∑–∞–æ": "–∑–∞–æ",
        "–∑–∞–ø–∞–¥–Ω": "–∑–∞–ø–∞–¥–Ω—ã–π",
        "—Å–∑–∞–æ": "—Å–∑–∞–æ",
        "—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥–Ω": "—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥–Ω—ã–π",
    }
    for key, val in okrug_map.items():
        if key in okrug_name:
            okrug_name = val
            break
    image = viz_service.generate_country_map(okrug_name)
    if image:
        logger.info(f"üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –æ–∫—Ä—É–≥ –ú–æ—Å–∫–≤—ã: {okrug_name}")
        return image, "map"
    return None, None


def _detect_district(text_lower: str, viz_service) -> tuple[bytes | None, str | None]:
    """–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç —Ä–∞–π–æ–Ω—ã –°–ü–± –∏ –ú–æ—Å–∫–≤—ã."""
    district_match = re.search(
        r"(–º–æ—Å–∫–æ–≤—Å–∫–∏–π|–∞–¥–º–∏—Ä–∞–ª—Ç–µ–π—Å–∫–∏–π|–≤–∞—Å–∏–ª–µ–æ—Å—Ç—Ä–æ–≤—Å–∫–∏–π|–≤—ã–±–æ—Ä–≥—Å–∫–∏–π|–∫–∞–ª–∏–Ω–∏–Ω—Å–∫–∏–π|–∫–∏—Ä–æ–≤—Å–∫–∏–π|–∫–æ–ª–ø–∏–Ω—Å–∫–∏–π|–∫—Ä–∞—Å–Ω–æ–≥–≤–∞—Ä–¥–µ–π—Å–∫–∏–π|–∫—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∏–π|–∫—Ä–æ–Ω—à—Ç–∞–¥—Ç—Å–∫–∏–π|–∫—É—Ä–æ—Ä—Ç–Ω—ã–π|–Ω–µ–≤—Å–∫–∏–π|–ø–µ—Ç—Ä–æ–≥—Ä–∞–¥—Å–∫–∏–π|–ø–µ—Ç—Ä–æ–¥–≤–æ—Ä—Ü–æ–≤—ã–π|–ø—Ä–∏–º–æ—Ä—Å–∫–∏–π|–ø—É—à–∫–∏–Ω—Å–∫–∏–π|—Ñ—Ä—É–Ω–∑–µ–Ω—Å–∫–∏–π|—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π|–∞—Ä–±–∞—Ç|—Ç–≤–µ—Ä—Å–∫–æ–π|—Ö–∞–º–æ–≤–Ω–∏–∫–∏|–∑–∞–º–æ—Å–∫–≤–æ—Ä–µ—á—å–µ|–∫–∏—Ç–∞–π[-\s]?–≥–æ—Ä–æ–¥|–±–∞—Å–º–∞–Ω–Ω—ã–π|—Ç–∞–≥–∞–Ω—Å–∫–∏–π|–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫–∏–π|–º–µ—â–∞–Ω—Å–∫–∏–π)\s*(?:—Ä–∞–π–æ–Ω)?\s*(?:—Å–ø–±|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|–ø–∏—Ç–µ—Ä|–º–æ—Å–∫–≤)?",
        text_lower,
    )
    if not district_match:
        return None, None

    district_name = district_match.group(1)
    if any(word in text_lower for word in ["—Å–ø–±", "–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "–ø–∏—Ç–µ—Ä"]):
        country_name = f"{district_name} —Ä–∞–π–æ–Ω —Å–ø–±"
    elif "–º–æ—Å–∫–≤" in text_lower or district_name in [
        "–∞—Ä–±–∞—Ç",
        "—Ç–≤–µ—Ä—Å–∫–æ–π",
        "—Ö–∞–º–æ–≤–Ω–∏–∫–∏",
        "–∑–∞–º–æ—Å–∫–≤–æ—Ä–µ—á—å–µ",
        "–∫–∏—Ç–∞–π-–≥–æ—Ä–æ–¥",
        "–±–∞—Å–º–∞–Ω–Ω—ã–π",
        "—Ç–∞–≥–∞–Ω—Å–∫–∏–π",
        "–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫–∏–π",
        "–º–µ—â–∞–Ω—Å–∫–∏–π",
    ]:
        country_name = district_name
    else:
        country_name = f"{district_name} —Ä–∞–π–æ–Ω —Å–ø–±"
    image = viz_service.generate_country_map(country_name)
    if image:
        logger.info(f"üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω —Ä–∞–π–æ–Ω: {country_name}")
        return image, "map"
    return None, None


def _detect_city(text_lower: str, viz_service) -> tuple[bytes | None, str | None]:
    """–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –≥–æ—Ä–æ–¥–∞ (–≤–∫–ª—é—á–∞—è –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—ã –º—Å–∫, —Å–ø–±)."""
    city_match = re.search(
        r"\b(–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤[–∞—É–µ—ã]?|–º—Å–∫)\b",
        text_lower,
    )
    if not city_match:
        return None, None

    city_name = city_match.group(1)
    if city_name in ["–ø–∏—Ç–µ—Ä", "–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "—Å–ø–±"] or "—Å–∞–Ω–∫—Ç" in city_name:
        country_name = "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥"
    elif "–º–æ—Å–∫–≤" in city_name or city_name == "–º—Å–∫":
        country_name = "–º–æ—Å–∫–≤–∞"
    else:
        country_name = city_name
    image = viz_service.generate_country_map(country_name)
    if image:
        logger.info(f"üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥–æ—Ä–æ–¥: {country_name}")
        return image, "map"
    return None, None


def _detect_country(text_lower: str, viz_service) -> tuple[bytes | None, str | None]:
    """–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä–∞–Ω—ã."""
    country_match = re.search(
        r"(—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|–µ–≤—Ä–æ–ø|—Å—Ç—Ä–∞–Ω–∞|–º–∏—Ä|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω)",
        text_lower,
    )
    if not country_match:
        return None, None

    country_name = country_match.group(1)
    if "–µ–≤—Ä–æ–ø" in country_name:
        country_name = "–µ–≤—Ä–æ–ø–∞"
    else:
        full_country_match = re.search(rf"({country_match.group(1)}[–∞-—è]*)", text_lower)
        if full_country_match:
            country_name = full_country_match.group(1)
    image = viz_service.generate_country_map(country_name)
    if image:
        logger.info(f"üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∞: {country_name}")
        return image, "map"
    return None, None
