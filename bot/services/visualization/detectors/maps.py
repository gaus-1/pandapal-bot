"""–î–µ—Ç–µ–∫—Ü–∏—è –∫–∞—Ä—Ç (–≥–æ—Ä–æ–¥–∞, —Å—Ç—Ä–∞–Ω—ã, —Ä–∞–π–æ–Ω—ã, –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã)."""

from __future__ import annotations

import re

from loguru import logger

# Regex-–≥—Ä—É–ø–ø–∞ –¥–ª—è —Ç–∏–ø–æ–≤ –ø—Ä–∏—Ä–æ–¥–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (–≤—Å–µ –ø–∞–¥–µ–∂–∏)
_GEO_TYPES_RE = (
    r"—Ä–µ–∫[–∞–µ—É–∏–æ–π]\w*|–≥–æ—Ä[–∞–µ—É—ã–æ–π—Ö—å]\w*|–æ–∑–µ—Ä[–∞–æ–µ—É—ë—å]\w*|–æ–∑—ë—Ä\w*|"
    r"–º–æ—Ä[–µ—è—é—å–µ–π]\w*|–æ–∫–µ–∞–Ω\w*|–ø—É—Å—Ç—ã–Ω[—è–∏—é–µ–π—å—ã]\w*|"
    r"–æ—Å—Ç—Ä–æ–≤\w*|–ø–æ–ª—É–æ—Å—Ç—Ä–æ–≤\w*|–≤—É–ª–∫–∞–Ω\w*|–≤–æ–¥–æ–ø–∞–¥\w*|"
    r"–ø—Ä–æ–ª–∏–≤\w*|–∑–∞–ª–∏–≤\w*|–º—ã—Å\w*|–∫–∞–Ω–∞–ª\w*|"
    r"—Ä–∞–≤–Ω–∏–Ω\w*|–Ω–∏–∑–º–µ–Ω–Ω–æ—Å—Ç\w*|–ø–ª–æ—Å–∫–æ–≥–æ—Ä—å\w*|–≤–ø–∞–¥–∏–Ω\w*|—Ä–∏—Ñ\w*"
)


def detect_map(text_lower: str, viz_service) -> tuple[bytes | None, str | None]:
    """
    –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–∞—Ä—Ç —á–µ—Ä–µ–∑ Yandex Maps Static API.

    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ detect_geography_question.
    –ó–∞–ø—Ä–æ—Å—ã ¬´–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è X¬ª –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π, –Ω–µ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π.

    Args:
        text_lower: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ.
        viz_service: –≠–∫–∑–µ–º–ø–ª—è—Ä VisualizationService —Å –º–µ—Ç–æ–¥–∞–º–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

    Returns:
        (image_bytes, visualization_type) –∏–ª–∏ (None, None).
    """
    map_keywords = [
        # –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫–∞—Ä—Ç —Å—Ç—Ä–∞–Ω/–≥–æ—Ä–æ–¥–æ–≤
        r"–∫–∞—Ä—Ç[–∞–µ—ã—É]?\s+(?:—Å—Ç—Ä–∞–Ω—ã|–º–∏—Ä–∞|—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|–µ–≤—Ä–æ–ø|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω|–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤|–º—Å–∫|—Ä–∞–π–æ–Ω)",
        r"(?:–ø–æ–∫–∞–∂–∏|–Ω–∞—Ä–∏—Å—É–π|—Å–æ–∑–¥–∞–π|—Å–æ—Å—Ç–∞–≤—å|–ø–æ—Å—Ç—Ä–æ–π|–≤—ã–≤–µ–¥–∏|–æ—Ç–æ–±—Ä–∞–∑–∏)\s+(?:–∫–∞—Ä—Ç[–∞–µ—ã—É]?\s+)?(?:—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|–µ–≤—Ä–æ–ø|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω|–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤|–º—Å–∫|—Ä–∞–π–æ–Ω)",
        r"(?:–ø–æ–∫–∞–∂–∏|–Ω–∞—Ä–∏—Å—É–π|—Å–æ–∑–¥–∞–π|—Å–æ—Å—Ç–∞–≤—å|–ø–æ—Å—Ç—Ä–æ–π|–≤—ã–≤–µ–¥–∏|–æ—Ç–æ–±—Ä–∞–∑–∏)\s+(?:–∫–∞—Ä—Ç[–∞–µ—ã—É]|–º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏)",
        r"–ø–æ–∫–∞–∂–∏\s+–Ω–∞\s+–∫–∞—Ä—Ç–µ",
        r"—Ñ–∏–∑–∏—á–µ—Å–∫[–∞—è]?\s+–∫–∞—Ä—Ç[–∞–µ—ã—É]?\s+—Ä–æ—Å—Å–∏",
        r"–≥–æ—Ä[—ã]?\s+–∞—Ñ—Ä–∏–∫",
        # –ü—Ä–∏—Ä–æ–¥–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã —Å –≥–ª–∞–≥–æ–ª–æ–º –¥–µ–π—Å—Ç–≤–∏—è
        rf"(?:–ø–æ–∫–∞–∂–∏|–Ω–∞—Ä–∏—Å—É–π|—Å–æ–∑–¥–∞–π|–≤—ã–≤–µ–¥–∏|–æ—Ç–æ–±—Ä–∞–∑–∏)\s+(?:{_GEO_TYPES_RE})\s+\w+",
        # "–∫–∞—Ä—Ç–∞ —Ä–µ–∫–∏/–≥–æ—Ä—ã/–æ–∑–µ—Ä–∞ X"
        rf"–∫–∞—Ä—Ç[–∞–µ—ã—É]?\s+(?:{_GEO_TYPES_RE})\s+",
        # "—Ä–µ–∫–∞ X –Ω–∞ –∫–∞—Ä—Ç–µ" / "–≥–æ—Ä–∞ X –Ω–∞ –∫–∞—Ä—Ç–µ"
        rf"(?:{_GEO_TYPES_RE})\s+[\w\-]+(?:\s+[\w\-]+){{0,2}}\s+–Ω–∞\s+–∫–∞—Ä—Ç–µ",
        # "–ø–æ–∫–∞–∂–∏ X –Ω–∞ –∫–∞—Ä—Ç–µ" (generic)
        r"–ø–æ–∫–∞–∂–∏\s+.{2,50}?\s+–Ω–∞\s+–∫–∞—Ä—Ç–µ",
        # Standalone natural object names with "–≥–¥–µ" (map context)
        rf"–≥–¥–µ\s+(?:–Ω–∞—Ö–æ–¥–∏—Ç—Å—è|—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω[–∞–æ—ã]?|—Ç–µ—á—ë—Ç|—Ç–µ—á–µ—Ç|–ø—Ä–æ—Ç–µ–∫–∞–µ—Ç)\s+(?:{_GEO_TYPES_RE})?\s*\w+",
        # "–ø–æ–∫–∞–∂–∏ <adj> <geo_type>" (e.g., "–ø–æ–∫–∞–∂–∏ —Ç–∏—Ö–∏–π –æ–∫–µ–∞–Ω", "–ø–æ–∫–∞–∂–∏ —á—ë—Ä–Ω–æ–µ –º–æ—Ä–µ")
        r"(?:–ø–æ–∫–∞–∂–∏|–Ω–∞—Ä–∏—Å—É–π|–≤—ã–≤–µ–¥–∏|–æ—Ç–æ–±—Ä–∞–∑–∏)\s+\w+\s+(?:–æ–∫–µ–∞–Ω|–º–æ—Ä–µ|–≥–æ—Ä[—É—ã–∞]|—Ä–µ–∫[—É–∞–∏]|–æ–∑–µ—Ä–æ|–ø—É—Å—Ç—ã–Ω[—é—è–∏]|–æ—Å—Ç—Ä–æ–≤|–≤—É–ª–∫–∞–Ω|–≤–æ–¥–æ–ø–∞–¥|–ø—Ä–æ–ª–∏–≤|–∑–∞–ª–∏–≤|–ø–æ–ª—É–æ—Å—Ç—Ä–æ–≤)",
        # "–∫–∞—Ä—Ç–∞ <adj> <geo_type>" (e.g., "–∫–∞—Ä—Ç–∞ —Å—Ä–µ–¥–∏–∑–µ–º–Ω–æ–≥–æ –º–æ—Ä—è", "–∫–∞—Ä—Ç–∞ –∫–∞–≤–∫–∞–∑—Å–∫–∏—Ö –≥–æ—Ä")
        r"–∫–∞—Ä—Ç[–∞–µ—ã—É]?\s+\w+\s+(?:–º–æ—Ä—è|–º–æ—Ä–µ–π|–≥–æ—Ä|—Ä–µ–∫–∏|—Ä–µ–∫|–æ–∑–µ—Ä–∞|–æ–∑—ë—Ä|–æ–∫–µ–∞–Ω–∞|–ø—É—Å—Ç—ã–Ω–∏|–æ—Å—Ç—Ä–æ–≤–∞|–æ—Å—Ç—Ä–æ–≤–æ–≤|–≤—É–ª–∫–∞–Ω–∞|–≤–æ–¥–æ–ø–∞–¥–∞|–ø—Ä–æ–ª–∏–≤–∞|–∑–∞–ª–∏–≤–∞|–ø–æ–ª—É–æ—Å—Ç—Ä–æ–≤–∞)",
        # Generic "–∫–∞—Ä—Ç–∞ X" for any location (last resort trigger)
        r"–∫–∞—Ä—Ç[–∞–µ—ã—É]\s+\w{3,}",
    ]

    for pattern in map_keywords:
        match = re.search(pattern, text_lower)
        if not match:
            continue

        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –æ–∫—Ä—É–≥ > —Ä–∞–π–æ–Ω > –≥–æ—Ä–æ–¥ > —Å—Ç—Ä–∞–Ω–∞ > –ø—Ä–∏—Ä–æ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç > generic

        # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –æ–∫—Ä—É–≥–∞ –ú–æ—Å–∫–≤—ã
        result = _detect_moscow_okrug(text_lower, viz_service)
        if result[0]:
            return result

        # –†–∞–π–æ–Ω—ã –°–ü–± –∏ –ú–æ—Å–∫–≤—ã
        result = _detect_district(text_lower, viz_service)
        if result[0]:
            return result

        # –ì–æ—Ä–æ–¥–∞ (–≤–∫–ª—é—á–∞—è –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—ã)
        result = _detect_city(text_lower, viz_service)
        if result[0]:
            return result

        # –°—Ç—Ä–∞–Ω—ã
        result = _detect_country(text_lower, viz_service)
        if result[0]:
            return result

        # –ü—Ä–∏—Ä–æ–¥–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (—Ä–µ–∫–∏, –≥–æ—Ä—ã, –º–æ—Ä—è, –æ–∑—ë—Ä–∞ –∏ —Ç.–¥.)
        result = _detect_natural_object(text_lower, viz_service)
        if result[0]:
            return result

        # Generic ‚Äî –∏–∑–≤–ª–µ–∫–∞–µ–º —á—Ç–æ —É–≥–æ–¥–Ω–æ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∫–∞—Ä—Ç—ã (geocoder fallback)
        result = _detect_generic_location(text_lower, viz_service)
        if result[0]:
            return result

    return None, None


# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏


def _detect_moscow_okrug(text_lower: str, viz_service) -> tuple[bytes | None, str | None]:
    """–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –æ–∫—Ä—É–≥–∞ –ú–æ—Å–∫–≤—ã."""
    okrug_match = re.search(
        r"(—Ü–∞–æ|—Å–∞–æ|—Å–≤–∞–æ|–≤–∞–æ|—é–≤–∞–æ|—é–∞–æ|—é–∑–∞–æ|–∑–∞–æ|—Å–∑–∞–æ|—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|—Å–µ–≤–µ—Ä–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|—Å–µ–≤–µ—Ä–æ[-\s]?–≤–æ—Å—Ç–æ—á–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|–≤–æ—Å—Ç–æ—á–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|—é–≥–æ[-\s]?–≤–æ—Å—Ç–æ—á–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|—é–∂–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|—é–≥–æ[-\s]?–∑–∞–ø–∞–¥–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|–∑–∞–ø–∞–¥–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥|—Å–µ–≤–µ—Ä–æ[-\s]?–∑–∞–ø–∞–¥–Ω\w*\s*(?:–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω\w*)?\s*–æ–∫—Ä—É–≥)",
        text_lower,
    )
    if not okrug_match or "–º–æ—Å–∫–≤" not in text_lower:
        return None, None

    okrug_name = okrug_match.group(1).strip()
    okrug_map = {
        "—Ü–∞–æ": "—Ü–∞–æ",
        "—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω": "—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π",
        "—Å–∞–æ": "—Å–∞–æ",
        "—Å–µ–≤–µ—Ä–Ω": "—Å–µ–≤–µ—Ä–Ω—ã–π",
        "—Å–≤–∞–æ": "—Å–≤–∞–æ",
        "—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ—á–Ω": "—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π",
        "–≤–∞–æ": "–≤–∞–æ",
        "–≤–æ—Å—Ç–æ—á–Ω": "–≤–æ—Å—Ç–æ—á–Ω—ã–π",
        "—é–≤–∞–æ": "—é–≤–∞–æ",
        "—é–≥–æ-–≤–æ—Å—Ç–æ—á–Ω": "—é–≥–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π",
        "—é–∞–æ": "—é–∞–æ",
        "—é–∂–Ω": "—é–∂–Ω—ã–π",
        "—é–∑–∞–æ": "—é–∑–∞–æ",
        "—é–≥–æ-–∑–∞–ø–∞–¥–Ω": "—é–≥–æ-–∑–∞–ø–∞–¥–Ω—ã–π",
        "–∑–∞–æ": "–∑–∞–æ",
        "–∑–∞–ø–∞–¥–Ω": "–∑–∞–ø–∞–¥–Ω—ã–π",
        "—Å–∑–∞–æ": "—Å–∑–∞–æ",
        "—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥–Ω": "—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥–Ω—ã–π",
    }
    for key, val in okrug_map.items():
        if key in okrug_name:
            okrug_name = val
            break
    image = viz_service.generate_country_map(okrug_name)
    if image:
        logger.info(f"üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –æ–∫—Ä—É–≥ –ú–æ—Å–∫–≤—ã: {okrug_name}")
        return image, "map"
    return None, None


def _detect_district(text_lower: str, viz_service) -> tuple[bytes | None, str | None]:
    """–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç —Ä–∞–π–æ–Ω—ã –°–ü–± –∏ –ú–æ—Å–∫–≤—ã."""
    district_match = re.search(
        r"(–º–æ—Å–∫–æ–≤—Å–∫–∏–π|–∞–¥–º–∏—Ä–∞–ª—Ç–µ–π—Å–∫–∏–π|–≤–∞—Å–∏–ª–µ–æ—Å—Ç—Ä–æ–≤—Å–∫–∏–π|–≤—ã–±–æ—Ä–≥—Å–∫–∏–π|–∫–∞–ª–∏–Ω–∏–Ω—Å–∫–∏–π|–∫–∏—Ä–æ–≤—Å–∫–∏–π|–∫–æ–ª–ø–∏–Ω—Å–∫–∏–π|–∫—Ä–∞—Å–Ω–æ–≥–≤–∞—Ä–¥–µ–π—Å–∫–∏–π|–∫—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∏–π|–∫—Ä–æ–Ω—à—Ç–∞–¥—Ç—Å–∫–∏–π|–∫—É—Ä–æ—Ä—Ç–Ω—ã–π|–Ω–µ–≤—Å–∫–∏–π|–ø–µ—Ç—Ä–æ–≥—Ä–∞–¥—Å–∫–∏–π|–ø–µ—Ç—Ä–æ–¥–≤–æ—Ä—Ü–æ–≤—ã–π|–ø—Ä–∏–º–æ—Ä—Å–∫–∏–π|–ø—É—à–∫–∏–Ω—Å–∫–∏–π|—Ñ—Ä—É–Ω–∑–µ–Ω—Å–∫–∏–π|—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π|–∞—Ä–±–∞—Ç|—Ç–≤–µ—Ä—Å–∫–æ–π|—Ö–∞–º–æ–≤–Ω–∏–∫–∏|–∑–∞–º–æ—Å–∫–≤–æ—Ä–µ—á—å–µ|–∫–∏—Ç–∞–π[-\s]?–≥–æ—Ä–æ–¥|–±–∞—Å–º–∞–Ω–Ω—ã–π|—Ç–∞–≥–∞–Ω—Å–∫–∏–π|–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫–∏–π|–º–µ—â–∞–Ω—Å–∫–∏–π)\s*(?:—Ä–∞–π–æ–Ω)?\s*(?:—Å–ø–±|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|–ø–∏—Ç–µ—Ä|–º–æ—Å–∫–≤)?",
        text_lower,
    )
    if not district_match:
        return None, None

    district_name = district_match.group(1)
    if any(word in text_lower for word in ["—Å–ø–±", "–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "–ø–∏—Ç–µ—Ä"]):
        country_name = f"{district_name} —Ä–∞–π–æ–Ω —Å–ø–±"
    elif "–º–æ—Å–∫–≤" in text_lower or district_name in [
        "–∞—Ä–±–∞—Ç",
        "—Ç–≤–µ—Ä—Å–∫–æ–π",
        "—Ö–∞–º–æ–≤–Ω–∏–∫–∏",
        "–∑–∞–º–æ—Å–∫–≤–æ—Ä–µ—á—å–µ",
        "–∫–∏—Ç–∞–π-–≥–æ—Ä–æ–¥",
        "–±–∞—Å–º–∞–Ω–Ω—ã–π",
        "—Ç–∞–≥–∞–Ω—Å–∫–∏–π",
        "–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫–∏–π",
        "–º–µ—â–∞–Ω—Å–∫–∏–π",
    ]:
        country_name = district_name
    else:
        country_name = f"{district_name} —Ä–∞–π–æ–Ω —Å–ø–±"
    image = viz_service.generate_country_map(country_name)
    if image:
        logger.info(f"üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω —Ä–∞–π–æ–Ω: {country_name}")
        return image, "map"
    return None, None


def _detect_city(text_lower: str, viz_service) -> tuple[bytes | None, str | None]:
    """–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –≥–æ—Ä–æ–¥–∞ (–≤–∫–ª—é—á–∞—è –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—ã –º—Å–∫, —Å–ø–±)."""
    city_match = re.search(
        r"\b(–ø–∏—Ç–µ—Ä|–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–∞–Ω–∫—Ç[-\s]?–ø–µ—Ç–µ—Ä–±—É—Ä–≥|—Å–ø–±|–º–æ—Å–∫–≤[–∞—É–µ—ã]?|–º—Å–∫)\b",
        text_lower,
    )
    if not city_match:
        return None, None

    city_name = city_match.group(1)
    if city_name in ["–ø–∏—Ç–µ—Ä", "–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "—Å–ø–±"] or "—Å–∞–Ω–∫—Ç" in city_name:
        country_name = "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥"
    elif "–º–æ—Å–∫–≤" in city_name or city_name == "–º—Å–∫":
        country_name = "–º–æ—Å–∫–≤–∞"
    else:
        country_name = city_name
    image = viz_service.generate_country_map(country_name)
    if image:
        logger.info(f"üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥–æ—Ä–æ–¥: {country_name}")
        return image, "map"
    return None, None


def _detect_country(text_lower: str, viz_service) -> tuple[bytes | None, str | None]:
    """–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä–∞–Ω—ã –∏ –∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç—ã."""
    country_match = re.search(
        r"(—è–ø–æ–Ω–∏|—Ä–æ—Å—Å–∏|–∫–∏—Ç–∞|—Å—à–∞|—Ñ—Ä–∞–Ω—Ü–∏|–≥–µ—Ä–º–∞–Ω–∏|–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏|–∏–Ω–¥–∏|–±—Ä–∞–∑–∏–ª–∏|–∞–≤—Å—Ç—Ä–∞–ª–∏|–∫–∞–Ω–∞–¥|–∏—Ç–∞–ª–∏|–∏—Å–ø–∞–Ω–∏|–µ–≥–∏–ø—Ç|–º–µ–∫—Å–∏–∫|–µ–≤—Ä–æ–ø|—Å—Ç—Ä–∞–Ω–∞|–º–∏—Ä\b|–∑–µ–º–ª\b|—Ç—É—Ä—Ü–∏|–ø–æ–ª—å—à|—É–∫—Ä–∞–∏–Ω|–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω|—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω|–º–æ–Ω–≥–æ–ª–∏|—Ç–∞–∏–ª–∞–Ω–¥|–≤—å–µ—Ç–Ω–∞–º|–∏–Ω–¥–æ–Ω–µ–∑–∏|—Ñ–∏–ª–∏–ø–ø–∏–Ω|–º–∞–ª–∞–π–∑–∏|—Å–∏–Ω–≥–∞–ø—É—Ä|—Å–∞—É–¥–æ–≤—Å–∫|–∏–∑—Ä–∞–∏–ª|–∏—Ä–∞–Ω|–∏—Ä–∞–∫|–ø–∞–∫–∏—Å—Ç–∞–Ω|–±–∞–Ω–≥–ª–∞–¥–µ—à|–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω|–∞—Ä–≥–µ–Ω—Ç–∏–Ω|—á–∏–ª–∏|–ø–µ—Ä—É|–∫–æ–ª—É–º–±–∏|–≤–µ–Ω–µ—Å—É—ç–ª|–∫—É–±|—é–∂–Ω[–∞—è]?\s+–∞—Ñ—Ä–∏–∫|–Ω–∏–≥–µ—Ä–∏|–∫–µ–Ω–∏|—ç—Ñ–∏–æ–ø–∏|–º–∞—Ä–æ–∫–∫|–∞–ª–∂–∏—Ä|—Ç—É–Ω–∏—Å|–ª–∏–≤–∏|—Å—É–¥–∞–Ω|—Å–∏–±–∏—Ä|–¥–∞–ª—å–Ω\w*\s+–≤–æ—Å—Ç–æ–∫|–∞—Ä–∫—Ç–∏–∫|–∞–Ω—Ç–∞—Ä–∫—Ç–∏–¥)",
        text_lower,
    )
    if not country_match:
        return None, None

    country_name = country_match.group(1)
    if "–µ–≤—Ä–æ–ø" in country_name:
        country_name = "–µ–≤—Ä–æ–ø–∞"
    elif country_name.startswith("–º–∏—Ä"):
        country_name = "–º–∏—Ä"
    elif country_name.startswith("–∑–µ–º–ª"):
        country_name = "–∑–µ–º–ª—è"
    else:
        full_country_match = re.search(rf"({country_match.group(1)}[–∞-—è—ë]*)", text_lower)
        if full_country_match:
            country_name = full_country_match.group(1)
    image = viz_service.generate_country_map(country_name)
    if image:
        logger.info(f"üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∞: {country_name}")
        return image, "map"
    return None, None


def _detect_natural_object(text_lower: str, viz_service) -> tuple[bytes | None, str | None]:
    """–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (—Ä–µ–∫–∏, –≥–æ—Ä—ã, –º–æ—Ä—è, –æ–∑—ë—Ä–∞ –∏ —Ç.–¥.)."""
    match = re.search(
        rf"({_GEO_TYPES_RE})\s+([\w\-]+(?:[\-\s][\w\-]+){{0,3}})",
        text_lower,
    )
    if not match:
        return None, None

    type_word = match.group(1)
    object_name = match.group(2).strip()

    # –£–±–∏—Ä–∞–µ–º —à—É–º–æ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ –∫–æ–Ω—Ü–µ –∏ –ø–æ—Å–ª–µ –Ω–∏—Ö
    object_name = re.sub(
        r"\s+(?:–Ω–∞\s+–∫–∞—Ä—Ç–µ|–Ω–∞\s+–∫–∞—Ä—Ç—É|–≤\s+\w+|–ø–æ\s+\w+|–¥–ª—è\s+\w+|–≥–¥–µ|—ç—Ç–æ|—á—Ç–æ|–∫–∞–∫|–ø–æ–∫–∞–∂–∏|–Ω–∞—Ä–∏—Å—É–π|–∫–∞—Ä—Ç\w*|–ø–æ–∂–∞–ª—É–π—Å—Ç–∞|–ø–ª–∏–∑).*$",
        "",
        object_name,
    )
    # –£–±–∏—Ä–∞–µ–º –æ–¥–∏–Ω–æ—á–Ω–æ–µ "–Ω–∞" –≤ –∫–æ–Ω—Ü–µ
    object_name = re.sub(r"\s+–Ω–∞$", "", object_name)

    if not object_name or len(object_name) < 2:
        return None, None

    # –ü—Ä–æ–±—É–µ–º: "—Ç–∏–ø –æ–±—ä–µ–∫—Ç", –∑–∞—Ç–µ–º –ø—Ä–æ—Å—Ç–æ "–æ–±—ä–µ–∫—Ç"
    full_query = f"{type_word} {object_name}"
    for query in [full_query, object_name]:
        image = viz_service.generate_country_map(query)
        if image:
            logger.info(f"üó∫Ô∏è –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏—Ä–æ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç: {full_query}")
            return image, "map"

    return None, None


def _detect_generic_location(text_lower: str, viz_service) -> tuple[bytes | None, str | None]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –∫–∞—Ä—Ç–æ—á–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (geocoder fallback)."""
    patterns = [
        r"–ø–æ–∫–∞–∂–∏\s+–Ω–∞\s+–∫–∞—Ä—Ç–µ\s+(.+?)(?:\s*$)",
        r"(?:–ø–æ–∫–∞–∂–∏|–Ω–∞—Ä–∏—Å—É–π|–≤—ã–≤–µ–¥–∏|–æ—Ç–æ–±—Ä–∞–∑–∏)\s+(.+?)\s+–Ω–∞\s+–∫–∞—Ä—Ç–µ",
        r"–∫–∞—Ä—Ç[–∞–µ—ã—É]\s+(.+?)(?:\s*$)",
        r"(?:–ø–æ–∫–∞–∂–∏|–Ω–∞—Ä–∏—Å—É–π|–≤—ã–≤–µ–¥–∏|–æ—Ç–æ–±—Ä–∞–∑–∏)\s+–∫–∞—Ä—Ç[–∞–µ—ã—É]\s+(.+?)(?:\s*$)",
        r"–≥–¥–µ\s+(?:–Ω–∞—Ö–æ–¥–∏—Ç—Å—è|—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω[–∞–æ—ã]?|—Ç–µ—á—ë—Ç|—Ç–µ—á–µ—Ç|–ø—Ä–æ—Ç–µ–∫–∞–µ—Ç)\s+(.+?)(?:\s*$)",
    ]

    # –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å –≥–µ–æ-—Ç–∏–ø, –¥–æ–±–∞–≤–ª—è–µ–º "–ø–æ–∫–∞–∂–∏ X" –∫–∞–∫ –ø–∞—Ç—Ç–µ—Ä–Ω
    if re.search(
        r"(?:–æ–∫–µ–∞–Ω|–º–æ—Ä–µ|–º–æ—Ä[—è—é–µ–π]|–≥–æ—Ä[–∞–µ—É—ã–æ–π—Ö]|—Ä–µ–∫[–∞–µ—É–∏–æ–π]|–æ–∑–µ—Ä[–∞–æ–µ—É]|"
        r"–ø—É—Å—Ç—ã–Ω|–æ—Å—Ç—Ä–æ–≤|–≤—É–ª–∫–∞–Ω|–≤–æ–¥–æ–ø–∞–¥|–ø—Ä–æ–ª–∏–≤|–∑–∞–ª–∏–≤|–ø–æ–ª—É–æ—Å—Ç—Ä–æ–≤)",
        text_lower,
    ):
        patterns.append(r"(?:–ø–æ–∫–∞–∂–∏|–Ω–∞—Ä–∏—Å—É–π|–≤—ã–≤–µ–¥–∏|–æ—Ç–æ–±—Ä–∞–∑–∏)\s+(.+?)(?:\s*$)")

    for pattern in patterns:
        match = re.search(pattern, text_lower)
        if not match:
            continue

        location = match.group(1).strip()
        # –£–±–∏—Ä–∞–µ–º —à—É–º
        location = re.sub(r"\s*(?:–ø–æ–∂–∞–ª—É–π—Å—Ç–∞|–ø–ª–∏–∑|–ø–ª–∑|–ø–æ–∂)\s*$", "", location).strip()
        location = re.sub(r"\s+–Ω–∞\s+–∫–∞—Ä—Ç–µ\s*$", "", location).strip()

        if len(location) < 2 or len(location) > 100:
            continue

        image = viz_service.generate_country_map(location)
        if image:
            logger.info(f"üó∫Ô∏è Generic location: {location}")
            return image, "map"

    return None, None
