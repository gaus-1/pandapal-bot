"""–î–µ—Ç–µ–∫—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ö–µ–º (–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—è, –±–∏–æ–ª–æ–≥–∏—è, –∞–ª–≥–æ—Ä–∏—Ç–º—ã –∏ –¥—Ä.)."""

from __future__ import annotations

import re

from loguru import logger


def detect_scheme(text_lower: str, viz_service) -> tuple[bytes | None, str | None]:
    """
    –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ö–µ–º—ã.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —è–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.
    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—ã—à–µ, —á–µ–º —É —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º.

    Args:
        text_lower: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ.
        viz_service: –≠–∫–∑–µ–º–ø–ª—è—Ä VisualizationService —Å –º–µ—Ç–æ–¥–∞–º–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

    Returns:
        (image_bytes, visualization_type) –∏–ª–∏ (None, None).
    """
    # –ü–†–ò–û–†–ò–¢–ï–¢: –≥—Ä–∞—Ñ–∏–∫ –ø–∞—Ä–∞–±–æ–ª—ã ‚Äî —É—á–∏—Ç—ã–≤–∞–µ–º –í–°–ï —Å–ª–æ–≤–∞ –∑–∞–ø—Ä–æ—Å–∞
    if re.search(r"–≥—Ä–∞—Ñ–∏–∫\s+–ø–∞—Ä–∞–±–æ–ª|–≥—Ä–∞—Ñ–∏–∫\s+–ø–æ—Ä–∞–±–æ–ª|–ø–∞—Ä–∞–±–æ–ª[–∞—ã]|–ø–æ—Ä–∞–±–æ–ª[–∞—ã]", text_lower):
        image = viz_service.generate_function_graph("x**2")
        if image:
            logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≥—Ä–∞—Ñ–∏–∫ –ø–∞—Ä–∞–±–æ–ª—ã (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)")
            return image, "graph"

    # –°—Ö–µ–º–∞ –°–æ–ª–Ω–µ—á–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
    astronomy_scheme_patterns = [
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+–ø–ª–∞–Ω–µ—Ç",
        r"–ø–æ–∫–∞–∂–∏\s+—Å—Ö–µ–º[—É]?\s+–ø–ª–∞–Ω–µ—Ç",
        r"–Ω–∞—Ä–∏—Å—É–π\s+—Å—Ö–µ–º[—É]?\s+–ø–ª–∞–Ω–µ—Ç",
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+—Å–æ–ª–Ω–µ—á–Ω[–∞—è]?\s+—Å–∏—Å—Ç–µ–º[—ã]",
        r"–ø–ª–∞–Ω–µ—Ç[—ã]?\s+–≤\s+–ø–æ—Ä—è–¥–∫[–µ]",
        r"–∫–∞–∫–∏–µ\s+–ø–ª–∞–Ω–µ—Ç[—ã]?\s+–µ—Å—Ç—å",
    ]
    for pattern in astronomy_scheme_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_solar_system_scheme()
            if image:
                logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ö–µ–º–∞ –ø–ª–∞–Ω–µ—Ç/–°–æ–ª–Ω–µ—á–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã")
                return image, "scheme"

    # –°—Ö–µ–º–∞ —Å—Ç—Ä–æ–µ–Ω–∏—è —Ç–µ–ª–∞ —á–µ–ª–æ–≤–µ–∫–∞
    biology_scheme_patterns = [
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+—Å—Ç—Ä–æ–µ–Ω–∏[—è–µ]?\s+—Ç–µ–ª[–∞–∞]?\s+—á–µ–ª–æ–≤–µ–∫[–∞]",
        r"—Å—Ç—Ä–æ–µ–Ω–∏[–µ]?\s+—Ç–µ–ª[–∞–∞]?\s+—á–µ–ª–æ–≤–µ–∫[–∞]",
        r"–≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç[–∏]?\s+—á–µ–ª–æ–≤–µ–∫[–∞]",
        r"–ø–æ–∫–∞–∂–∏\s+—Å—Ö–µ–º[—É]?\s+—Ç–µ–ª[–∞–∞]?\s+—á–µ–ª–æ–≤–µ–∫[–∞]",
        r"–Ω–∞—Ä–∏—Å—É–π\s+—Å—Ö–µ–º[—É]?\s+—Ç–µ–ª[–∞–∞]?\s+—á–µ–ª–æ–≤–µ–∫[–∞]",
        r"–∞–Ω–∞—Ç–æ–º–∏[—è]?\—Å+—á–µ–ª–æ–≤–µ–∫[–∞]",
        r"–æ—Ä–≥–∞–Ω[—ã]?\s+—á–µ–ª–æ–≤–µ–∫[–∞]",
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+–∫—Ä–æ–≤–æ–æ–±—Ä–∞—â–µ–Ω–∏[—è–µ]",
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+—Å—Ç—Ä–æ–µ–Ω–∏[—è–µ]?\s+–∫–ª–µ—Ç–∫[–∏]",
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+–¥—ã—Ö–∞–Ω–∏[—è–µ]",
    ]
    for pattern in biology_scheme_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_human_body_structure_scheme()
            if image:
                logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ö–µ–º–∞ —Å—Ç—Ä–æ–µ–Ω–∏—è —Ç–µ–ª–∞ —á–µ–ª–æ–≤–µ–∫–∞")
                return image, "scheme"

    # –ö—Ä—É–≥–æ–≤–æ—Ä–æ—Ç –≤–æ–¥—ã
    water_cycle_patterns = [
        r"–∫—Ä—É–≥–æ–≤–æ—Ä–æ—Ç[–∞]?\s+–≤–æ–¥[—ã]",
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+–∫—Ä—É–≥–æ–≤–æ—Ä–æ—Ç[–∞]?\s+–≤–æ–¥[—ã]",
        r"–∫–∞–∫\s+–¥–≤–∏–∂–µ—Ç—Å—è\s+–≤–æ–¥[–∞]",
        r"–∏—Å–ø–∞—Ä–µ–Ω–∏[–µ]?\s+–≤–æ–¥[—ã]",
        r"–∫—Ä—É–≥–æ–≤–æ—Ä–æ—Ç[–∞]?\s+–≤–æ–¥[—ã]?\s+–≤\s+–ø—Ä–∏—Ä–æ–¥[–µ]",
    ]
    for pattern in water_cycle_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_water_cycle_scheme()
            if image:
                logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –∫—Ä—É–≥–æ–≤–æ—Ä–æ—Ç –≤–æ–¥—ã")
                return image, "scheme"

    # –°—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª–µ—Ç–∫–∏
    cell_patterns = [
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+—Å—Ç—Ä–æ–µ–Ω–∏[—è–µ]?\s+–∫–ª–µ—Ç–∫[–∏]",
        r"—Å—Ç—Ä–æ–µ–Ω–∏[–µ]?\s+–∫–ª–µ—Ç–∫[–∏]",
        r"–∫–ª–µ—Ç–æ—á–Ω[–∞—è]?\s+–º–µ–º–±—Ä–∞–Ω[–∞]",
        r"—è–¥—Ä[–æ]?\s+–∫–ª–µ—Ç–∫[–∏]",
        r"–æ—Ä–≥–∞–Ω–µ–ª–ª[—ã]?\s+–∫–ª–µ—Ç–∫[–∏]",
    ]
    for pattern in cell_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_cell_structure_scheme()
            if image:
                logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ö–µ–º–∞ —Å—Ç—Ä–æ–µ–Ω–∏—è –∫–ª–µ—Ç–∫–∏")
                return image, "scheme"

    # –°—Ç—Ä–æ–µ–Ω–∏–µ –î–ù–ö
    dna_patterns = [
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+—Å—Ç—Ä–æ–µ–Ω–∏[—è–µ]?\s+–¥–Ω–∫",
        r"—Å—Ç—Ä–æ–µ–Ω–∏[–µ]?\s+–¥–Ω–∫",
        r"–¥–≤–æ–π–Ω[–∞—è]?\s+—Å–ø–∏—Ä–∞–ª—å",
        r"–º–æ–ª–µ–∫—É–ª[–∞]?\s+–¥–Ω–∫",
        r"—Å—Ç—Ä—É–∫—Ç—É—Ä[–∞]?\s+–¥–Ω–∫",
    ]
    for pattern in dna_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_dna_structure_scheme()
            if image:
                logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ö–µ–º–∞ —Å—Ç—Ä–æ–µ–Ω–∏—è –î–ù–ö")
                return image, "scheme"

    # –ë–ª–æ–∫-—Å—Ö–µ–º–∞ –∞–ª–≥–æ—Ä–∏—Ç–º–∞
    flowchart_patterns = [
        r"–±–ª–æ–∫[-\s]?—Å—Ö–µ–º[–∞–µ—ã—É]",
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+–∞–ª–≥–æ—Ä–∏—Ç–º[–∞]",
        r"–±–ª–æ–∫[-\s]?—Å—Ö–µ–º[–∞–µ—ã—É]?\s+–∞–ª–≥–æ—Ä–∏—Ç–º[–∞]",
        r"–∞–ª–≥–æ—Ä–∏—Ç–º\s+–≤\s+–≤–∏–¥–µ\s+—Å—Ö–µ–º[—ã]",
        r"–≥—Ä–∞—Ñ–∏—á–µ—Å–∫[–æ–µ]?\s+–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏[–µ]?\s+–∞–ª–≥–æ—Ä–∏—Ç–º[–∞]",
    ]
    for pattern in flowchart_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_algorithm_flowchart_scheme()
            if image:
                logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –±–ª–æ–∫-—Å—Ö–µ–º–∞ –∞–ª–≥–æ—Ä–∏—Ç–º–∞")
                return image, "scheme"

    # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞
    state_patterns = [
        r"—Å—Ö–µ–º[–∞–µ—ã—É]?\s+—Å—Ç—Ä—É–∫—Ç—É—Ä[—ã]?\s+–≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤[–∞]",
        r"—Å—Ç—Ä—É–∫—Ç—É—Ä[–∞]?\s+–≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤[–∞]",
        r"–≤–µ—Ç–≤[–∏]?\s+–≤–ª–∞—Å—Ç[–∏]",
        r"—Ä–∞–∑–¥–µ–ª–µ–Ω–∏[–µ]?\s+–≤–ª–∞—Å—Ç[–µ–π]",
        r"–∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å–Ω[–∞—è]?\s+–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω[–∞—è]?\s+—Å—É–¥–µ–±–Ω[–∞—è]?\s+–≤–ª–∞—Å—Ç[—å]",
    ]
    for pattern in state_patterns:
        if re.search(pattern, text_lower):
            image = viz_service.generate_state_structure_scheme()
            if image:
                logger.info("üìà –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ö–µ–º–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞")
                return image, "scheme"

    return None, None
