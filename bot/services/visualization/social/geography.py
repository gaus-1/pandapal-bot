"""–ú–æ–¥—É–ª—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏."""

from loguru import logger

from bot.config.settings import Settings
from bot.services.visualization.base import BaseVisualizationService

try:
    import requests

    REQUESTS_AVAILABLE = True
except ImportError:
    REQUESTS_AVAILABLE = False


class GeographyVisualization(BaseVisualizationService):
    """–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏: —á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞, —Å—Ç—Ä–∞–Ω—ã, –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ –∑–æ–Ω—ã, –∫–∞—Ä—Ç—ã."""

    def generate_time_zones_table(self) -> bytes | None:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤ –†–æ—Å—Å–∏–∏."""
        headers = ["–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å", "–°–º–µ—â–µ–Ω–∏–µ (UTC)", "–ì–æ—Ä–æ–¥–∞"]
        rows = [
            ["–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥", "UTC+2", "–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥"],
            ["–ú–æ—Å–∫–≤–∞", "UTC+3", "–ú–æ—Å–∫–≤–∞, –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥"],
            ["–°–∞–º–∞—Ä–∞", "UTC+4", "–°–∞–º–∞—Ä–∞, –ò–∂–µ–≤—Å–∫"],
            ["–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "UTC+5", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –ü–µ—Ä–º—å"],
            ["–û–º—Å–∫", "UTC+6", "–û–º—Å–∫"],
            ["–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫", "UTC+7", "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫, –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫"],
            ["–ò—Ä–∫—É—Ç—Å–∫", "UTC+8", "–ò—Ä–∫—É—Ç—Å–∫, –£–ª–∞–Ω-–£–¥—ç"],
            ["–Ø–∫—É—Ç—Å–∫", "UTC+9", "–Ø–∫—É—Ç—Å–∫, –ß–∏—Ç–∞"],
            ["–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫", "UTC+10", "–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫, –•–∞–±–∞—Ä–æ–≤—Å–∫"],
            ["–ú–∞–≥–∞–¥–∞–Ω", "UTC+11", "–ú–∞–≥–∞–¥–∞–Ω"],
            ["–ö–∞–º—á–∞—Ç–∫–∞", "UTC+12", "–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫-–ö–∞–º—á–∞—Ç—Å–∫–∏–π"],
        ]
        return self.generate_table(headers, rows, "–ß–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞ –†–æ—Å—Å–∏–∏")

    def generate_countries_table(self) -> bytes | None:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É –∫—Ä—É–ø–Ω–µ–π—à–∏—Ö —Å—Ç—Ä–∞–Ω –ø–æ –ø–ª–æ—â–∞–¥–∏ –∏ –Ω–∞—Å–µ–ª–µ–Ω–∏—é."""
        headers = ["–°—Ç—Ä–∞–Ω–∞", "–ü–ª–æ—â–∞–¥—å (–º–ª–Ω –∫–º¬≤)", "–ù–∞—Å–µ–ª–µ–Ω–∏–µ (–º–ª–Ω —á–µ–ª.)", "–°—Ç–æ–ª–∏—Ü–∞"]
        rows = [
            ["–†–æ—Å—Å–∏—è", "17.1", "146", "–ú–æ—Å–∫–≤–∞"],
            ["–ö–∞–Ω–∞–¥–∞", "10.0", "38", "–û—Ç—Ç–∞–≤–∞"],
            ["–ö–∏—Ç–∞–π", "9.6", "1400", "–ü–µ–∫–∏–Ω"],
            ["–°–®–ê", "9.5", "330", "–í–∞—à–∏–Ω–≥—Ç–æ–Ω"],
            ["–ë—Ä–∞–∑–∏–ª–∏—è", "8.5", "215", "–ë—Ä–∞–∑–∏–ª–∏–∞"],
            ["–ê–≤—Å—Ç—Ä–∞–ª–∏—è", "7.7", "26", "–ö–∞–Ω–±–µ—Ä—Ä–∞"],
            ["–ò–Ω–¥–∏—è", "3.3", "1380", "–ù—å—é-–î–µ–ª–∏"],
            ["–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞", "2.8", "45", "–ë—É—ç–Ω–æ—Å-–ê–π—Ä–µ—Å"],
        ]
        return self.generate_table(headers, rows, "–ö—Ä—É–ø–Ω–µ–π—à–∏–µ —Å—Ç—Ä–∞–Ω—ã –º–∏—Ä–∞")

    def generate_natural_zones_table(self) -> bytes | None:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É –ø—Ä–∏—Ä–æ–¥–Ω—ã—Ö –∑–æ–Ω."""
        headers = ["–ü—Ä–∏—Ä–æ–¥–Ω–∞—è –∑–æ–Ω–∞", "–ö–ª–∏–º–∞—Ç", "–†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", "–ñ–∏–≤–æ—Ç–Ω—ã–µ"]
        rows = [
            ["–ê—Ä–∫—Ç–∏–∫–∞", "—Ö–æ–ª–æ–¥–Ω—ã–π", "–ª–∏—à–∞–π–Ω–∏–∫–∏, –º—Ö–∏", "–±–µ–ª—ã–π –º–µ–¥–≤–µ–¥—å, —Ç—é–ª–µ–Ω—å"],
            ["–¢—É–Ω–¥—Ä–∞", "—Ö–æ–ª–æ–¥–Ω—ã–π", "–º—Ö–∏, –∫–∞—Ä–ª–∏–∫–æ–≤—ã–µ –¥–µ—Ä–µ–≤—å—è", "–æ–ª–µ–Ω—å, –ø–µ—Å–µ—Ü"],
            ["–¢–∞–π–≥–∞", "—É–º–µ—Ä–µ–Ω–Ω—ã–π", "—Ö–≤–æ–π–Ω—ã–µ –ª–µ—Å–∞", "–º–µ–¥–≤–µ–¥—å, –≤–æ–ª–∫, –ª–æ—Å—å"],
            ["–°–º–µ—à–∞–Ω–Ω—ã–π –ª–µ—Å", "—É–º–µ—Ä–µ–Ω–Ω—ã–π", "—Ö–≤–æ–π–Ω—ã–µ –∏ –ª–∏—Å—Ç–≤–µ–Ω–Ω—ã–µ", "–±–µ–ª–∫–∞, –∑–∞—è—Ü"],
            ["–°—Ç–µ–ø—å", "—Å—É—Ö–æ–π", "—Ç—Ä–∞–≤—ã", "—Å—É—Å–ª–∏–∫, –¥—Ä–æ—Ñ–∞"],
            ["–ü—É—Å—Ç—ã–Ω—è", "–∂–∞—Ä–∫–∏–π, —Å—É—Ö–æ–π", "–∫–∞–∫—Ç—É—Å—ã, –≤–µ—Ä–±–ª—é–∂—å—è –∫–æ–ª—é—á–∫–∞", "–≤–µ—Ä–±–ª—é–¥, —Å–∫–æ—Ä–ø–∏–æ–Ω"],
        ]
        return self.generate_table(headers, rows, "–ü—Ä–∏—Ä–æ–¥–Ω—ã–µ –∑–æ–Ω—ã –†–æ—Å—Å–∏–∏")

    def generate_country_map(self, country_name: str) -> bytes | None:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç—É —Å—Ç—Ä–∞–Ω—ã, –≥–æ—Ä–æ–¥–∞ –∏–ª–∏ —Ä–∞–π–æ–Ω–∞ —á–µ—Ä–µ–∑ Yandex Maps Static API.

        –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—ä–µ–∫—Ç –¶–ï–õ–ò–ö–û–ú —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏:
        - –°—Ç—Ä–∞–Ω—ã: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –í–°–Ø —Å—Ç—Ä–∞–Ω–∞ —Ü–µ–ª–∏–∫–æ–º —Å –µ—ë –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ (zoom=3-7 –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞)
        - –ì–æ—Ä–æ–¥–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –í–ï–°–¨ –≥–æ—Ä–æ–¥ —Ü–µ–ª–∏–∫–æ–º —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ —Ä–∞–π–æ–Ω–æ–≤ (zoom=10)
          –ü—Ä–∏–º–µ—Ä—ã: "–ø–æ–∫–∞–∂–∏ —Å–ø–±", "–ø–æ–∫–∞–∂–∏ –º–æ—Å–∫–≤—É" ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤–µ—Å—å –≥–æ—Ä–æ–¥ —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
        - –†–∞–π–æ–Ω—ã: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä–∞–π–æ–Ω —Å –µ–≥–æ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ (zoom=12-13)
          –ü—Ä–∏–º–µ—Ä—ã: "–ø–æ–∫–∞–∂–∏ –º–æ—Å–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω —Å–ø–±" ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä–∞–π–æ–Ω —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏

        –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Yandex Maps API:
        - –¢–∏–ø –∫–∞—Ä—Ç—ã: "map" (–≤—Å–µ–≥–¥–∞) - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã
        - Zoom: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–∏—Ä–∞–µ—Ç—Å—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ–±—ä–µ–∫—Ç–∞ —Ü–µ–ª–∏–∫–æ–º
        - –ú–µ—Ç–∫–∞: –∫—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ –æ–±—ä–µ–∫—Ç–∞

        –ï—Å–ª–∏ API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None (–∫–∞—Ä—Ç—ã –Ω–µ –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è).
        """
        settings = Settings()

        # –ï—Å–ª–∏ API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω - –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—ã
        if not settings.yandex_maps_api_key:
            logger.debug("üó∫Ô∏è Yandex Maps API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω - –∫–∞—Ä—Ç—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã")
            return None

        # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ä–∞–π–æ–Ω–æ–≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞ (–¥–ª—è –ø–æ–∫–∞–∑–∞ –≥—Ä–∞–Ω–∏—Ü —Ä–∞–π–æ–Ω–æ–≤)
        # Zoom=12-13 –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ –≥—Ä–∞–Ω–∏—Ü —Ä–∞–π–æ–Ω–∞
        spb_districts = {
            "–º–æ—Å–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω": (59.85, 30.32, "–ú–æ—Å–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 12),
            "–º–æ—Å–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω —Å–ø–±": (59.85, 30.32, "–ú–æ—Å–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 12),
            "–º–æ—Å–∫–æ–≤—Å–∫–∏–π": (59.85, 30.32, "–ú–æ—Å–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 12),
            "–∞–¥–º–∏—Ä–∞–ª—Ç–µ–π—Å–∫–∏–π": (59.93, 30.30, "–ê–¥–º–∏—Ä–∞–ª—Ç–µ–π—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 12),
            "–≤–∞—Å–∏–ª–µ–æ—Å—Ç—Ä–æ–≤—Å–∫–∏–π": (59.94, 30.27, "–í–∞—Å–∏–ª–µ–æ—Å—Ç—Ä–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 12),
            "–≤—ã–±–æ—Ä–≥—Å–∫–∏–π": (60.05, 30.35, "–í—ã–±–æ—Ä–≥—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 12),
            "–∫–∞–ª–∏–Ω–∏–Ω—Å–∫–∏–π": (59.97, 30.39, "–ö–∞–ª–∏–Ω–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 12),
            "–∫–∏—Ä–æ–≤—Å–∫–∏–π": (59.88, 30.26, "–ö–∏—Ä–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 12),
            "–∫–æ–ª–ø–∏–Ω—Å–∫–∏–π": (59.75, 30.60, "–ö–æ–ª–ø–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 11),
            "–∫—Ä–∞—Å–Ω–æ–≥–≤–∞—Ä–¥–µ–π—Å–∫–∏–π": (59.97, 30.44, "–ö—Ä–∞—Å–Ω–æ–≥–≤–∞—Ä–¥–µ–π—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 12),
            "–∫—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∏–π": (59.82, 30.15, "–ö—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 11),
            "–∫—Ä–æ–Ω—à—Ç–∞–¥—Ç—Å–∫–∏–π": (60.00, 29.77, "–ö—Ä–æ–Ω—à—Ç–∞–¥—Ç—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 13),
            "–∫—É—Ä–æ—Ä—Ç–Ω—ã–π": (60.15, 29.90, "–ö—É—Ä–æ—Ä—Ç–Ω—ã–π —Ä–∞–π–æ–Ω –°–ü–±", 11),
            "–Ω–µ–≤—Å–∫–∏–π": (59.90, 30.50, "–ù–µ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 11),
            "–ø–µ—Ç—Ä–æ–≥—Ä–∞–¥—Å–∫–∏–π": (59.96, 30.31, "–ü–µ—Ç—Ä–æ–≥—Ä–∞–¥—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 12),
            "–ø–µ—Ç—Ä–æ–¥–≤–æ—Ä—Ü–æ–≤—ã–π": (59.88, 29.90, "–ü–µ—Ç—Ä–æ–¥–≤–æ—Ä—Ü–æ–≤—ã–π —Ä–∞–π–æ–Ω –°–ü–±", 11),
            "–ø—Ä–∏–º–æ—Ä—Å–∫–∏–π": (60.00, 30.15, "–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 11),
            "–ø—É—à–∫–∏–Ω—Å–∫–∏–π": (59.72, 30.40, "–ü—É—à–∫–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 12),
            "—Ñ—Ä—É–Ω–∑–µ–Ω—Å–∫–∏–π": (59.90, 30.38, "–§—Ä—É–Ω–∑–µ–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω –°–ü–±", 12),
            "—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π": (59.93, 30.35, "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω –°–ü–±", 12),
        }

        # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ä–∞–π–æ–Ω–æ–≤ –ú–æ—Å–∫–≤—ã
        msk_districts = {
            "–º–æ—Å–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω –º–æ—Å–∫–≤—ã": (55.75, 37.62, "–ú–æ—Å–∫–æ–≤—Å–∫–∏–π —Ä–∞–π–æ–Ω –ú–æ—Å–∫–≤—ã", 12),
            "—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥": (55.75, 37.62, "–¶–ê–û –ú–æ—Å–∫–≤—ã", 11),
            "—Å–µ–≤–µ—Ä–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥": (55.80, 37.55, "–°–ê–û –ú–æ—Å–∫–≤—ã", 11),
            "—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥": (55.82, 37.65, "–°–í–ê–û –ú–æ—Å–∫–≤—ã", 11),
            "–≤–æ—Å—Ç–æ—á–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥": (55.75, 37.70, "–í–ê–û –ú–æ—Å–∫–≤—ã", 11),
            "—é–≥–æ-–≤–æ—Å—Ç–æ—á–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥": (55.70, 37.75, "–Æ–í–ê–û –ú–æ—Å–∫–≤—ã", 11),
            "—é–∂–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥": (55.65, 37.70, "–Æ–ê–û –ú–æ—Å–∫–≤—ã", 11),
            "—é–≥–æ-–∑–∞–ø–∞–¥–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥": (55.65, 37.55, "–Æ–ó–ê–û –ú–æ—Å–∫–≤—ã", 11),
            "–∑–∞–ø–∞–¥–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥": (55.75, 37.50, "–ó–ê–û –ú–æ—Å–∫–≤—ã", 11),
            "—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–∫—Ä—É–≥": (55.80, 37.45, "–°–ó–ê–û –ú–æ—Å–∫–≤—ã", 11),
        }

        # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å—Ç—Ä–∞–Ω –∏ —Ä–µ–≥–∏–æ–Ω–æ–≤ (—à–∏—Ä–æ—Ç–∞, –¥–æ–ª–≥–æ—Ç–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ, zoom)
        # Zoom: 2-3 –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å—Ç—Ä–∞–Ω/–∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–æ–≤ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—é —Å—Ç—Ä–∞–Ω—É —Ü–µ–ª–∏–∫–æ–º —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏)
        # 4-5 –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö —Å—Ç—Ä–∞–Ω, 6-7 –¥–ª—è –º–∞–ª—ã—Ö —Å—Ç—Ä–∞–Ω
        # –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω—É —Ü–µ–ª–∏–∫–æ–º —Å –µ—ë –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
        countries_coords = {
            # –ö—Ä—É–ø–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã (zoom=3 –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω—ã —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏)
            "—Ä–æ—Å—Å–∏—è": (55.7558, 37.6173, "–†–æ—Å—Å–∏—è", 3),  # –¶–µ–Ω—Ç—Ä - –ú–æ—Å–∫–≤–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—é —Å—Ç—Ä–∞–Ω—É
            "–∫–∏—Ç–∞–π": (39.9042, 116.4074, "–ö–∏—Ç–∞–π", 4),  # –¶–µ–Ω—Ç—Ä - –ü–µ–∫–∏–Ω
            "—Å—à–∞": (39.8283, -98.5795, "–°–®–ê", 4),  # –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä
            "–∫–∞–Ω–∞–¥–∞": (56.1304, -106.3468, "–ö–∞–Ω–∞–¥–∞", 3),
            "–±—Ä–∞–∑–∏–ª–∏—è": (-14.2350, -51.9253, "–ë—Ä–∞–∑–∏–ª–∏—è", 4),
            "–∞–≤—Å—Ç—Ä–∞–ª–∏—è": (-25.2744, 133.7751, "–ê–≤—Å—Ç—Ä–∞–ª–∏—è", 4),
            "–∏–Ω–¥–∏—è": (28.6139, 77.2090, "–ò–Ω–¥–∏—è", 5),  # –¶–µ–Ω—Ç—Ä - –î–µ–ª–∏
            # –ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω—ã
            "—Ñ—Ä–∞–Ω—Ü–∏—è": (46.2276, 2.2137, "–§—Ä–∞–Ω—Ü–∏—è", 6),
            "–≥–µ—Ä–º–∞–Ω–∏—è": (51.1657, 10.4515, "–ì–µ—Ä–º–∞–Ω–∏—è", 6),
            "–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è": (55.3781, -3.4360, "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è", 6),
            "–∏—Ç–∞–ª–∏—è": (41.8719, 12.5674, "–ò—Ç–∞–ª–∏—è", 6),
            "–∏—Å–ø–∞–Ω–∏—è": (40.4637, -3.7492, "–ò—Å–ø–∞–Ω–∏—è", 6),
            "–ø–æ–ª—å—à–∞": (52.2297, 21.0122, "–ü–æ–ª—å—à–∞", 6),
            "—É–∫—Ä–∞–∏–Ω–∞": (50.4501, 30.5234, "–£–∫—Ä–∞–∏–Ω–∞", 6),
            "—Ç—É—Ä—Ü–∏—è": (39.9334, 32.8597, "–¢—É—Ä—Ü–∏—è", 6),
            "–≥—Ä–µ—Ü–∏—è": (37.9838, 23.7275, "–ì—Ä–µ—Ü–∏—è", 7),
            "–Ω–∏–¥–µ—Ä–ª–∞–Ω–¥—ã": (52.1326, 5.2913, "–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã", 7),
            "–±–µ–ª—å–≥–∏—è": (50.5039, 4.4699, "–ë–µ–ª—å–≥–∏—è", 7),
            "—à–≤–µ–π—Ü–∞—Ä–∏—è": (46.8182, 8.2275, "–®–≤–µ–π—Ü–∞—Ä–∏—è", 7),
            "–∞–≤—Å—Ç—Ä–∏—è": (48.2082, 16.3738, "–ê–≤—Å—Ç—Ä–∏—è", 7),
            "—à–≤–µ—Ü–∏—è": (59.3293, 18.0686, "–®–≤–µ—Ü–∏—è", 5),
            "–Ω–æ—Ä–≤–µ–≥–∏—è": (59.9139, 10.7522, "–ù–æ—Ä–≤–µ–≥–∏—è", 5),
            "—Ñ–∏–Ω–ª—è–Ω–¥–∏—è": (60.1699, 24.9384, "–§–∏–Ω–ª—è–Ω–¥–∏—è", 5),
            "–¥–∞–Ω–∏—è": (55.6761, 12.5683, "–î–∞–Ω–∏—è", 7),
            # –ê–∑–∏–∞—Ç—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω—ã
            "—è–ø–æ–Ω–∏—è": (36.2048, 138.2529, "–Ø–ø–æ–Ω–∏—è", 6),
            "–∫–æ—Ä–µ—è": (37.5665, 126.9780, "–ö–æ—Ä–µ—è", 6),
            "—é–∂–Ω–∞—è –∫–æ—Ä–µ—è": (37.5665, 126.9780, "–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è", 6),
            "—Å–µ–≤–µ—Ä–Ω–∞—è –∫–æ—Ä–µ—è": (39.0392, 125.7625, "–°–µ–≤–µ—Ä–Ω–∞—è –ö–æ—Ä–µ—è", 6),
            "—Ç–∞–π–ª–∞–Ω–¥": (13.7563, 100.5018, "–¢–∞–∏–ª–∞–Ω–¥", 6),
            "–≤—å–µ—Ç–Ω–∞–º": (21.0285, 105.8542, "–í—å–µ—Ç–Ω–∞–º", 6),
            "–∏–Ω–¥–æ–Ω–µ–∑–∏—è": (-6.2088, 106.8456, "–ò–Ω–¥–æ–Ω–µ–∑–∏—è", 5),
            "—Ñ–∏–ª–∏–ø–ø–∏–Ω—ã": (14.5995, 120.9842, "–§–∏–ª–∏–ø–ø–∏–Ω—ã", 6),
            "–º–∞–ª–∞–π–∑–∏—è": (3.1390, 101.6869, "–ú–∞–ª–∞–π–∑–∏—è", 6),
            "—Å–∏–Ω–≥–∞–ø—É—Ä": (1.3521, 103.8198, "–°–∏–Ω–≥–∞–ø—É—Ä", 7),
            "—Å–∞—É–¥–æ–≤—Å–∫–∞—è –∞—Ä–∞–≤–∏—è": (24.7136, 46.6753, "–°–∞—É–¥–æ–≤—Å–∫–∞—è –ê—Ä–∞–≤–∏—è", 5),
            "–∏–∑—Ä–∞–∏–ª—å": (31.7683, 35.2137, "–ò–∑—Ä–∞–∏–ª—å", 7),
            "–∏—Ä–∞–Ω": (35.6892, 51.3890, "–ò—Ä–∞–Ω", 5),
            "–∏—Ä–∞–∫": (33.3152, 44.3661, "–ò—Ä–∞–∫", 6),
            "–ø–∞–∫–∏—Å—Ç–∞–Ω": (30.3753, 69.3451, "–ü–∞–∫–∏—Å—Ç–∞–Ω", 5),
            "–±–∞–Ω–≥–ª–∞–¥–µ—à": (23.8103, 90.4125, "–ë–∞–Ω–≥–ª–∞–¥–µ—à", 6),
            "–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω": (34.5553, 69.2075, "–ê—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω", 5),
            "–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω": (51.1694, 71.4491, "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω", 5),
            "—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω": (41.2995, 69.2401, "–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω", 6),
            "–º–æ–Ω–≥–æ–ª–∏—è": (47.8864, 106.9057, "–ú–æ–Ω–≥–æ–ª–∏—è", 5),
            # –ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω—ã
            "–º–µ–∫—Å–∏–∫–∞": (19.4326, -99.1332, "–ú–µ–∫—Å–∏–∫–∞", 5),
            "–∞—Ä–≥–µ–Ω—Ç–∏–Ω–∞": (-34.6037, -58.3816, "–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞", 5),
            "—á–∏–ª–∏": (-33.4489, -70.6693, "–ß–∏–ª–∏", 5),
            "–ø–µ—Ä—É": (-12.0464, -77.0428, "–ü–µ—Ä—É", 5),
            "–∫–æ–ª—É–º–±–∏—è": (4.7110, -74.0721, "–ö–æ–ª—É–º–±–∏—è", 5),
            "–≤–µ–Ω–µ—Å—É—ç–ª–∞": (10.4806, -66.9036, "–í–µ–Ω–µ—Å—É—ç–ª–∞", 5),
            "–∫—É–±–∞": (23.1136, -82.3666, "–ö—É–±–∞", 7),
            # –ê—Ñ—Ä–∏–∫–∞–Ω—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω—ã
            "–µ–≥–∏–ø–µ—Ç": (30.0444, 31.2357, "–ï–≥–∏–ø–µ—Ç", 6),
            "—é–∂–Ω–∞—è –∞—Ñ—Ä–∏–∫–∞": (-25.7461, 28.1881, "–Æ–∂–Ω–∞—è –ê—Ñ—Ä–∏–∫–∞", 5),
            "–Ω–∏–≥–µ—Ä–∏—è": (6.5244, 3.3792, "–ù–∏–≥–µ—Ä–∏—è", 5),
            "–∫–µ–Ω–∏—è": (-1.2921, 36.8219, "–ö–µ–Ω–∏—è", 6),
            "—ç—Ñ–∏–æ–ø–∏—è": (9.1450, 38.7667, "–≠—Ñ–∏–æ–ø–∏—è", 5),
            "–º–∞—Ä–æ–∫–∫–æ": (33.9716, -6.8498, "–ú–∞—Ä–æ–∫–∫–æ", 6),
            "–∞–ª–∂–∏—Ä": (36.7538, 3.0588, "–ê–ª–∂–∏—Ä", 5),
            "—Ç—É–Ω–∏—Å": (36.8065, 10.1815, "–¢—É–Ω–∏—Å", 7),
            "–ª–∏–≤–∏—è": (32.8872, 13.1913, "–õ–∏–≤–∏—è", 5),
            "—Å—É–¥–∞–Ω": (15.5007, 32.5599, "–°—É–¥–∞–Ω", 5),
            # –ì–æ—Ä–æ–¥–∞ –†–æ—Å—Å–∏–∏ (zoom=10 –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ–≥–æ –≥–æ—Ä–æ–¥–∞ —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏)
            # –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –≥–æ—Ä–æ–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Å—å –≥–æ—Ä–æ–¥ —Ü–µ–ª–∏–∫–æ–º —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
            "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥": (59.9343, 30.3351, "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", 10),
            "–ø–∏—Ç–µ—Ä": (59.9343, 30.3351, "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", 10),
            "–ø–µ—Ç–µ—Ä–±—É—Ä–≥": (59.9343, 30.3351, "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", 10),
            "—Å–ø–±": (59.9343, 30.3351, "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", 10),
            "–º–æ—Å–∫–≤–∞": (55.7558, 37.6173, "–ú–æ—Å–∫–≤–∞", 10),
            # –†–µ–≥–∏–æ–Ω—ã
            "–µ–≤—Ä–æ–ø–∞": (54.5260, 15.2551, "–ï–≤—Ä–æ–ø–∞", 4),
            "–∞–∑–∏—è": (34.0479, 100.6197, "–ê–∑–∏—è", 3),
            "–∞—Ñ—Ä–∏–∫–∞": (8.7832, 34.5085, "–ê—Ñ—Ä–∏–∫–∞", 3),
            "–∞–º–µ—Ä–∏–∫–∞": (19.4326, -99.1332, "–ê–º–µ—Ä–∏–∫–∞", 3),
            "—Å–µ–≤–µ—Ä–Ω–∞—è –∞–º–µ—Ä–∏–∫–∞": (39.8283, -98.5795, "–°–µ–≤–µ—Ä–Ω–∞—è –ê–º–µ—Ä–∏–∫–∞", 3),
            "—é–∂–Ω–∞—è –∞–º–µ—Ä–∏–∫–∞": (-14.2350, -51.9253, "–Æ–∂–Ω–∞—è –ê–º–µ—Ä–∏–∫–∞", 3),
            "–º–∏—Ä": (20.0, 0.0, "–ú–∏—Ä", 2),
        }

        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã/—Ä–∞–π–æ–Ω–∞ (—É–±–∏—Ä–∞–µ–º –æ–ø–µ—á–∞—Ç–∫–∏ –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã)
        country_lower = country_name.lower().strip()

        # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —á–∞—Å—Ç—ã–µ –æ–ø–µ—á–∞—Ç–∫–∏
        country_lower = country_lower.replace("—Ä–æ—Å–∏–∏–∏", "—Ä–æ—Å—Å–∏–∏")
        country_lower = country_lower.replace("—Ä–æ—Å–∏–∏", "—Ä–æ—Å—Å–∏–∏")
        country_lower = country_lower.replace("—Ä–æ—Å–∏—è", "—Ä–æ—Å—Å–∏—è")

        # –£–õ–£–ß–®–ï–ù–û: –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–∏—Å–∫–∞ —Ä–∞–π–æ–Ω–æ–≤
        # –£–±–∏—Ä–∞–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–æ–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∞–¥–µ–∂–∞ –∏ –¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–∏
        country_normalized = country_lower
        # –ó–∞–º–µ–Ω—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–∞ –±–∞–∑–æ–≤—É—é —Ñ–æ—Ä–º—É
        country_normalized = country_normalized.replace("—Ä–∞–π–æ–Ω–∞", "—Ä–∞–π–æ–Ω")
        country_normalized = country_normalized.replace("—Ä–∞–π–æ–Ω–µ", "—Ä–∞–π–æ–Ω")
        country_normalized = country_normalized.replace("—Ä–∞–π–æ–Ω—ã", "—Ä–∞–π–æ–Ω")
        country_normalized = country_normalized.replace("–º–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ", "–º–æ—Å–∫–æ–≤—Å–∫–∏–π")
        country_normalized = country_normalized.replace("–º–æ—Å–∫–æ–≤—Å–∫–∞—è", "–º–æ—Å–∫–æ–≤—Å–∫–∏–π")
        country_normalized = country_normalized.replace("–º–æ—Å–∫–æ–≤—Å–∫–æ–µ", "–º–æ—Å–∫–æ–≤—Å–∫–∏–π")
        country_normalized = country_normalized.replace("–º–æ—Å–∫–æ–≤—Å–∫–∏–º", "–º–æ—Å–∫–æ–≤—Å–∫–∏–π")
        country_normalized = country_normalized.replace("–º–æ—Å–∫–æ–≤—Å–∫–∏–º", "–º–æ—Å–∫–æ–≤—Å–∫–∏–π")
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥—Ä—É–≥–∏–µ —Ä–∞–π–æ–Ω—ã
        for suffix in ["–æ–≥–æ", "–æ–º—É", "—ã–º", "–æ–º", "–æ–π", "—É—é", "–∞—è", "–æ–µ", "—ã–µ", "—ã—Ö"]:
            # –£–±–∏—Ä–∞–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã—Ö
            if country_normalized.endswith(suffix):
                # –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑–æ–≤—É—é —Ñ–æ—Ä–º—É
                base = country_normalized[: -len(suffix)]
                if base.endswith("—Å–∫"):
                    country_normalized = base + "–∏–π"
                elif base.endswith("–Ω"):
                    country_normalized = base + "—ã–π"
                break

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–∞–π–æ–Ω–æ–≤
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–ª–æ–≤ "—Ä–∞–π–æ–Ω", "—Å–ø–±", "–º–æ—Å–∫–≤–∞" –∏ –Ω–∞–∑–≤–∞–Ω–∏–π —Ä–∞–π–æ–Ω–æ–≤
        has_district_keywords = any(
            word in country_normalized
            for word in ["—Ä–∞–π–æ–Ω", "—Å–ø–±", "–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "–ø–∏—Ç–µ—Ä", "–º–æ—Å–∫–≤–∞", "–º–æ—Å–∫–æ–≤—Å–∫–∏–π"]
        )

        country_data = None

        # –£–õ–£–ß–®–ï–ù–û: –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–π–æ–Ω—ã –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å "—Å–ø–±", "–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "–ø–∏—Ç–µ—Ä")
        if has_district_keywords and any(
            word in country_normalized for word in ["—Å–ø–±", "–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "–ø–∏—Ç–µ—Ä"]
        ):
            for key in spb_districts:
                # –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                if (
                    key == country_normalized
                    or key in country_normalized
                    or country_normalized in key
                ):
                    country_data = spb_districts[key]
                    logger.info(f"üó∫Ô∏è –ù–∞–π–¥–µ–Ω —Ä–∞–π–æ–Ω –°–ü–±: {key} (–∑–∞–ø—Ä–æ—Å: '{country_name}')")
                    break
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
                key_words = set(key.split())
                query_words = set(country_normalized.split())
                # –ï—Å–ª–∏ –µ—Å—Ç—å –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (–∏—Å–∫–ª—é—á–∞—è –æ–±—â–∏–µ —Å–ª–æ–≤–∞)
                common_words = key_words & query_words
                if common_words and len(common_words) >= 1:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–µ —Å–ª–æ–≤–æ —Ä–∞–π–æ–Ω–∞
                    district_words = {
                        "–º–æ—Å–∫–æ–≤—Å–∫–∏–π",
                        "–∞–¥–º–∏—Ä–∞–ª—Ç–µ–π—Å–∫–∏–π",
                        "–≤–∞—Å–∏–ª–µ–æ—Å—Ç—Ä–æ–≤—Å–∫–∏–π",
                        "–≤—ã–±–æ—Ä–≥—Å–∫–∏–π",
                        "–∫–∞–ª–∏–Ω–∏–Ω—Å–∫–∏–π",
                        "–∫–∏—Ä–æ–≤—Å–∫–∏–π",
                        "–∫–æ–ª–ø–∏–Ω—Å–∫–∏–π",
                        "–∫—Ä–∞—Å–Ω–æ–≥–≤–∞—Ä–¥–µ–π—Å–∫–∏–π",
                        "–∫—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∏–π",
                        "–∫—Ä–æ–Ω—à—Ç–∞–¥—Ç—Å–∫–∏–π",
                        "–∫—É—Ä–æ—Ä—Ç–Ω—ã–π",
                        "–Ω–µ–≤—Å–∫–∏–π",
                        "–ø–µ—Ç—Ä–æ–≥—Ä–∞–¥—Å–∫–∏–π",
                        "–ø–µ—Ç—Ä–æ–¥–≤–æ—Ä—Ü–æ–≤—ã–π",
                        "–ø—Ä–∏–º–æ—Ä—Å–∫–∏–π",
                        "–ø—É—à–∫–∏–Ω—Å–∫–∏–π",
                        "—Ñ—Ä—É–Ω–∑–µ–Ω—Å–∫–∏–π",
                        "—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π",
                    }
                    if common_words & district_words:
                        country_data = spb_districts[key]
                        logger.info(
                            f"üó∫Ô∏è –ù–∞–π–¥–µ–Ω —Ä–∞–π–æ–Ω –°–ü–± –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º: {key} (–∑–∞–ø—Ä–æ—Å: '{country_name}')"
                        )
                        break

        # –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–π–æ–Ω—ã –ú–æ—Å–∫–≤—ã
        if not country_data and has_district_keywords and "–º–æ—Å–∫–≤–∞" in country_normalized:
            for key in msk_districts:
                if (
                    key == country_normalized
                    or key in country_normalized
                    or country_normalized in key
                ):
                    country_data = msk_districts[key]
                    logger.info(f"üó∫Ô∏è –ù–∞–π–¥–µ–Ω —Ä–∞–π–æ–Ω –ú–æ—Å–∫–≤—ã: {key} (–∑–∞–ø—Ä–æ—Å: '{country_name}')")
                    break
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
                key_words = set(key.split())
                query_words = set(country_normalized.split())
                common_words = key_words & query_words
                if common_words and len(common_words) >= 1:
                    country_data = msk_districts[key]
                    logger.info(
                        f"üó∫Ô∏è –ù–∞–π–¥–µ–Ω —Ä–∞–π–æ–Ω –ú–æ—Å–∫–≤—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º: {key} (–∑–∞–ø—Ä–æ—Å: '{country_name}')"
                    )
                    break

        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Ä–∞–π–æ–Ω, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é (–≤—Å–µ —Ä–∞–π–æ–Ω—ã)
        if not country_data and has_district_keywords:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Ä–∞–π–æ–Ω—ã –°–ü–±
            for key in spb_districts:
                key_words = set(key.split())
                query_words = set(country_normalized.split())
                common_words = key_words & query_words
                if common_words and len(common_words) >= 1:
                    country_data = spb_districts[key]
                    logger.info(
                        f"üó∫Ô∏è –ù–∞–π–¥–µ–Ω —Ä–∞–π–æ–Ω –°–ü–± –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é: {key} (–∑–∞–ø—Ä–æ—Å: '{country_name}')"
                    )
                    break

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Ä–∞–π–æ–Ω—ã –ú–æ—Å–∫–≤—ã
            if not country_data:
                for key in msk_districts:
                    key_words = set(key.split())
                    query_words = set(country_normalized.split())
                    common_words = key_words & query_words
                    if common_words and len(common_words) >= 1:
                        country_data = msk_districts[key]
                        logger.info(
                            f"üó∫Ô∏è –ù–∞–π–¥–µ–Ω —Ä–∞–π–æ–Ω –ú–æ—Å–∫–≤—ã –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é: {key} (–∑–∞–ø—Ä–æ—Å: '{country_name}')"
                        )
                        break

        # –ó–∞—Ç–µ–º –∏—â–µ–º —Å—Ç—Ä–∞–Ω—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Ä–∞–π–æ–Ω)
        if not country_data:
            for key in countries_coords:
                if key == country_lower or key in country_lower or country_lower in key:
                    country_data = countries_coords[key]
                    break

        if not country_data:
            logger.warning(
                f"üó∫Ô∏è –°—Ç—Ä–∞–Ω–∞/—Ä–∞–π–æ–Ω '{country_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ. "
                f"–î–æ—Å—Ç—É–ø–Ω—ã–µ: {', '.join(sorted(list(countries_coords.keys())[:5] + list(spb_districts.keys())[:5]))}..."
            )
            return None

        lat, lon, name, zoom = country_data

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É —á–µ—Ä–µ–∑ Yandex Maps Static API
        # –£–õ–£–ß–®–ï–ù–û: –î–ª—è —Ä–∞–π–æ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª—å—à–∏–π zoom –¥–ª—è –ø–æ–∫–∞–∑–∞ –≥—Ä–∞–Ω–∏—Ü
        try:
            return self._get_yandex_map(lat, lon, zoom, name)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã —á–µ—Ä–µ–∑ Yandex Maps: {e}")
            return None

    def _get_yandex_map(self, lat: float, lon: float, zoom: int, label: str) -> bytes | None:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—á–Ω—É—é –∫–∞—Ä—Ç—É —á–µ—Ä–µ–∑ Yandex Maps Static API.

        Args:
            lat: –®–∏—Ä–æ—Ç–∞ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã
            lon: –î–æ–ª–≥–æ—Ç–∞ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã
            zoom: –£—Ä–æ–≤–µ–Ω—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è (1-17)
            label: –ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ

        Returns:
            bytes: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        if not REQUESTS_AVAILABLE:
            logger.warning("‚ö†Ô∏è requests –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –∫–∞—Ä—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")
            return None

        settings = Settings()
        if not settings.yandex_maps_api_key:
            return None

        # URL –¥–ª—è Yandex Maps Static API (–æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ v1 —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ 2026)
        base_url = "https://static-maps.yandex.ru/v1"

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è Yandex Maps Static API
        # –°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: https://yandex.ru/maps-api/docs/static-api/request.html
        # –£–õ–£–ß–®–ï–ù–û: –î–ª—è —Ä–∞–π–æ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª—å—à–∏–π zoom –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ –≥—Ä–∞–Ω–∏—Ü
        params = {
            "apikey": settings.yandex_maps_api_key,  # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
            "ll": f"{lon},{lat}",  # –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã: –¥–æ–ª–≥–æ—Ç–∞, —à–∏—Ä–æ—Ç–∞
            "z": str(zoom),  # –£—Ä–æ–≤–µ–Ω—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è (0-21, –¥–ª—è —Ä–∞–π–æ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º 11-13)
            "size": "650,450",  # –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∞–∫—Å–∏–º—É–º: 650x450)
            "lang": "ru_RU",  # –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è: —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
            "pt": f"{lon},{lat},pm2rdm",  # –ú–µ—Ç–∫–∞: –∫—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        }

        # –£–õ–£–ß–®–ï–ù–û: –î–ª—è –≥–æ—Ä–æ–¥–æ–≤, —Ä–∞–π–æ–Ω–æ–≤ –∏ —Å—Ç—Ä–∞–Ω –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
        # –í API v1 –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä maptype=admin –¥–ª—è –ø–æ–∫–∞–∑–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –≥—Ä–∞–Ω–∏—Ü
        # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã —Å—Ç—Ä–∞–Ω, —Ä–µ–≥–∏–æ–Ω–æ–≤, –≥–æ—Ä–æ–¥–æ–≤, —Ä–∞–π–æ–Ω–æ–≤
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º maptype=admin –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã —Å —á–µ—Ç–∫–∏–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
        params["maptype"] = "admin"  # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
        # –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º style –ø–∞—Ä–∞–º–µ—Ç—Ä—ã - –æ–Ω–∏ –≤—ã–∑—ã–≤–∞—é—Ç –æ—à–∏–±–∫—É –ø—Ä–∏ maptype=admin
        # API –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ maptype=admin

        try:
            # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å API
            headers = {
                "User-Agent": "PandaPal-Bot/1.0 (Educational Telegram Bot)",
                "Accept": "image/png,image/*,*/*",
            }

            response = requests.get(
                base_url, params=params, headers=headers, timeout=15, stream=True
            )

            if response.status_code == 200:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                content_type = response.headers.get("Content-Type", "")
                if "image" not in content_type:
                    logger.warning(
                        f"‚ö†Ô∏è Yandex Maps –≤–µ—Ä–Ω—É–ª –Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (Content-Type: {content_type})"
                    )
                    return None

                image_bytes = response.content

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤)
                if len(image_bytes) < 1000:
                    logger.warning(
                        f"‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω–æ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ({len(image_bytes)} –±–∞–π—Ç)"
                    )
                    return None

                logger.info(
                    f"‚úÖ –ü–æ–ª—É—á–µ–Ω–∞ –∫–∞—Ä—Ç–∞ —á–µ—Ä–µ–∑ Yandex Maps Static API: {label} "
                    f"({len(image_bytes)} –±–∞–π—Ç, zoom={zoom})"
                )
                return image_bytes

            elif response.status_code == 403:
                logger.error(
                    "‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω –∫ Yandex Maps Static API. "
                    "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ –ª–∏–º–∏—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è."
                )
                return None
            elif response.status_code == 400:
                error_text = response.text[:500]
                logger.error(
                    f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –∫ Yandex Maps Static API: {error_text}"
                )
                return None
            else:
                error_text = response.text[:500] if response.text else "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –æ—à–∏–±–∫–∏"
                logger.error(
                    f"‚ùå –û—à–∏–±–∫–∞ Yandex Maps Static API (status {response.status_code}): {error_text}"
                )
                return None

        except requests.Timeout:
            logger.error("‚ùå –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Yandex Maps Static API (15 —Å–µ–∫)")
            return None
        except requests.ConnectionError as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Yandex Maps Static API: {e}")
            return None
        except Exception as e:
            logger.error(
                f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Yandex Maps Static API: {e}", exc_info=True
            )
            return None
