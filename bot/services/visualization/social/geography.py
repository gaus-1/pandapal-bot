"""–ú–æ–¥—É–ª—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏."""

from loguru import logger

from bot.config.settings import Settings
from bot.services.visualization.base import BaseVisualizationService

try:
    import matplotlib.pyplot as plt
    import requests

    MATPLOTLIB_AVAILABLE = True
    REQUESTS_AVAILABLE = True
except ImportError:
    MATPLOTLIB_AVAILABLE = False
    REQUESTS_AVAILABLE = False


class GeographyVisualization(BaseVisualizationService):
    """–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏: —á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞, —Å—Ç—Ä–∞–Ω—ã, –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ –∑–æ–Ω—ã, –∫–∞—Ä—Ç—ã."""

    def generate_time_zones_table(self) -> bytes | None:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤ –†–æ—Å—Å–∏–∏."""
        headers = ["–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å", "–°–º–µ—â–µ–Ω–∏–µ (UTC)", "–ì–æ—Ä–æ–¥–∞"]
        rows = [
            ["–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥", "UTC+2", "–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥"],
            ["–ú–æ—Å–∫–≤–∞", "UTC+3", "–ú–æ—Å–∫–≤–∞, –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥"],
            ["–°–∞–º–∞—Ä–∞", "UTC+4", "–°–∞–º–∞—Ä–∞, –ò–∂–µ–≤—Å–∫"],
            ["–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "UTC+5", "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, –ü–µ—Ä–º—å"],
            ["–û–º—Å–∫", "UTC+6", "–û–º—Å–∫"],
            ["–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫", "UTC+7", "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫, –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫"],
            ["–ò—Ä–∫—É—Ç—Å–∫", "UTC+8", "–ò—Ä–∫—É—Ç—Å–∫, –£–ª–∞–Ω-–£–¥—ç"],
            ["–Ø–∫—É—Ç—Å–∫", "UTC+9", "–Ø–∫—É—Ç—Å–∫, –ß–∏—Ç–∞"],
            ["–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫", "UTC+10", "–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫, –•–∞–±–∞—Ä–æ–≤—Å–∫"],
            ["–ú–∞–≥–∞–¥–∞–Ω", "UTC+11", "–ú–∞–≥–∞–¥–∞–Ω"],
            ["–ö–∞–º—á–∞—Ç–∫–∞", "UTC+12", "–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫-–ö–∞–º—á–∞—Ç—Å–∫–∏–π"],
        ]
        return self.generate_table(headers, rows, "–ß–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞ –†–æ—Å—Å–∏–∏")

    def generate_countries_table(self) -> bytes | None:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É –∫—Ä—É–ø–Ω–µ–π—à–∏—Ö —Å—Ç—Ä–∞–Ω –ø–æ –ø–ª–æ—â–∞–¥–∏ –∏ –Ω–∞—Å–µ–ª–µ–Ω–∏—é."""
        headers = ["–°—Ç—Ä–∞–Ω–∞", "–ü–ª–æ—â–∞–¥—å (–º–ª–Ω –∫–º¬≤)", "–ù–∞—Å–µ–ª–µ–Ω–∏–µ (–º–ª–Ω —á–µ–ª.)", "–°—Ç–æ–ª–∏—Ü–∞"]
        rows = [
            ["–†–æ—Å—Å–∏—è", "17.1", "146", "–ú–æ—Å–∫–≤–∞"],
            ["–ö–∞–Ω–∞–¥–∞", "10.0", "38", "–û—Ç—Ç–∞–≤–∞"],
            ["–ö–∏—Ç–∞–π", "9.6", "1400", "–ü–µ–∫–∏–Ω"],
            ["–°–®–ê", "9.5", "330", "–í–∞—à–∏–Ω–≥—Ç–æ–Ω"],
            ["–ë—Ä–∞–∑–∏–ª–∏—è", "8.5", "215", "–ë—Ä–∞–∑–∏–ª–∏–∞"],
            ["–ê–≤—Å—Ç—Ä–∞–ª–∏—è", "7.7", "26", "–ö–∞–Ω–±–µ—Ä—Ä–∞"],
            ["–ò–Ω–¥–∏—è", "3.3", "1380", "–ù—å—é-–î–µ–ª–∏"],
            ["–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞", "2.8", "45", "–ë—É—ç–Ω–æ—Å-–ê–π—Ä–µ—Å"],
        ]
        return self.generate_table(headers, rows, "–ö—Ä—É–ø–Ω–µ–π—à–∏–µ —Å—Ç—Ä–∞–Ω—ã –º–∏—Ä–∞")

    def generate_natural_zones_table(self) -> bytes | None:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É –ø—Ä–∏—Ä–æ–¥–Ω—ã—Ö –∑–æ–Ω."""
        headers = ["–ü—Ä–∏—Ä–æ–¥–Ω–∞—è –∑–æ–Ω–∞", "–ö–ª–∏–º–∞—Ç", "–†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", "–ñ–∏–≤–æ—Ç–Ω—ã–µ"]
        rows = [
            ["–ê—Ä–∫—Ç–∏–∫–∞", "—Ö–æ–ª–æ–¥–Ω—ã–π", "–ª–∏—à–∞–π–Ω–∏–∫–∏, –º—Ö–∏", "–±–µ–ª—ã–π –º–µ–¥–≤–µ–¥—å, —Ç—é–ª–µ–Ω—å"],
            ["–¢—É–Ω–¥—Ä–∞", "—Ö–æ–ª–æ–¥–Ω—ã–π", "–º—Ö–∏, –∫–∞—Ä–ª–∏–∫–æ–≤—ã–µ –¥–µ—Ä–µ–≤—å—è", "–æ–ª–µ–Ω—å, –ø–µ—Å–µ—Ü"],
            ["–¢–∞–π–≥–∞", "—É–º–µ—Ä–µ–Ω–Ω—ã–π", "—Ö–≤–æ–π–Ω—ã–µ –ª–µ—Å–∞", "–º–µ–¥–≤–µ–¥—å, –≤–æ–ª–∫, –ª–æ—Å—å"],
            ["–°–º–µ—à–∞–Ω–Ω—ã–π –ª–µ—Å", "—É–º–µ—Ä–µ–Ω–Ω—ã–π", "—Ö–≤–æ–π–Ω—ã–µ –∏ –ª–∏—Å—Ç–≤–µ–Ω–Ω—ã–µ", "–±–µ–ª–∫–∞, –∑–∞—è—Ü"],
            ["–°—Ç–µ–ø—å", "—Å—É—Ö–æ–π", "—Ç—Ä–∞–≤—ã", "—Å—É—Å–ª–∏–∫, –¥—Ä–æ—Ñ–∞"],
            ["–ü—É—Å—Ç—ã–Ω—è", "–∂–∞—Ä–∫–∏–π, —Å—É—Ö–æ–π", "–∫–∞–∫—Ç—É—Å—ã, –≤–µ—Ä–±–ª—é–∂—å—è –∫–æ–ª—é—á–∫–∞", "–≤–µ—Ä–±–ª—é–¥, —Å–∫–æ—Ä–ø–∏–æ–Ω"],
        ]
        return self.generate_table(headers, rows, "–ü—Ä–∏—Ä–æ–¥–Ω—ã–µ –∑–æ–Ω—ã –†–æ—Å—Å–∏–∏")

    def generate_country_map(self, country_name: str) -> bytes | None:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç—É —Å—Ç—Ä–∞–Ω—ã —á–µ—Ä–µ–∑ Yandex Maps Static API.

        –ï—Å–ª–∏ API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None (–∫–∞—Ä—Ç—ã –Ω–µ –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è).
        """
        settings = Settings()

        # –ï—Å–ª–∏ API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω - –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—ã
        if not settings.yandex_maps_api_key:
            logger.debug("üó∫Ô∏è Yandex Maps API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω - –∫–∞—Ä—Ç—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã")
            return None

        # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å—Ç—Ä–∞–Ω –∏ —Ä–µ–≥–∏–æ–Ω–æ–≤ (—à–∏—Ä–æ—Ç–∞, –¥–æ–ª–≥–æ—Ç–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ, zoom)
        # Zoom: 2-3 –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å—Ç—Ä–∞–Ω/–∫–æ–Ω—Ç–∏–Ω–µ–Ω—Ç–æ–≤, 4-5 –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö, 6-7 –¥–ª—è –º–∞–ª—ã—Ö
        countries_coords = {
            # –ö—Ä—É–ø–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã
            "—Ä–æ—Å—Å–∏—è": (55.7558, 37.6173, "–†–æ—Å—Å–∏—è", 3),  # –¶–µ–Ω—Ç—Ä - –ú–æ—Å–∫–≤–∞
            "–∫–∏—Ç–∞–π": (39.9042, 116.4074, "–ö–∏—Ç–∞–π", 4),  # –¶–µ–Ω—Ç—Ä - –ü–µ–∫–∏–Ω
            "—Å—à–∞": (39.8283, -98.5795, "–°–®–ê", 4),  # –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä
            "–∫–∞–Ω–∞–¥–∞": (56.1304, -106.3468, "–ö–∞–Ω–∞–¥–∞", 3),
            "–±—Ä–∞–∑–∏–ª–∏—è": (-14.2350, -51.9253, "–ë—Ä–∞–∑–∏–ª–∏—è", 4),
            "–∞–≤—Å—Ç—Ä–∞–ª–∏—è": (-25.2744, 133.7751, "–ê–≤—Å—Ç—Ä–∞–ª–∏—è", 4),
            "–∏–Ω–¥–∏—è": (28.6139, 77.2090, "–ò–Ω–¥–∏—è", 5),  # –¶–µ–Ω—Ç—Ä - –î–µ–ª–∏
            # –ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω—ã
            "—Ñ—Ä–∞–Ω—Ü–∏—è": (46.2276, 2.2137, "–§—Ä–∞–Ω—Ü–∏—è", 6),
            "–≥–µ—Ä–º–∞–Ω–∏—è": (51.1657, 10.4515, "–ì–µ—Ä–º–∞–Ω–∏—è", 6),
            "–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è": (55.3781, -3.4360, "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è", 6),
            "–∏—Ç–∞–ª–∏—è": (41.8719, 12.5674, "–ò—Ç–∞–ª–∏—è", 6),
            "–∏—Å–ø–∞–Ω–∏—è": (40.4637, -3.7492, "–ò—Å–ø–∞–Ω–∏—è", 6),
            "–ø–æ–ª—å—à–∞": (52.2297, 21.0122, "–ü–æ–ª—å—à–∞", 6),
            "—É–∫—Ä–∞–∏–Ω–∞": (50.4501, 30.5234, "–£–∫—Ä–∞–∏–Ω–∞", 6),
            "—Ç—É—Ä—Ü–∏—è": (39.9334, 32.8597, "–¢—É—Ä—Ü–∏—è", 6),
            "–≥—Ä–µ—Ü–∏—è": (37.9838, 23.7275, "–ì—Ä–µ—Ü–∏—è", 7),
            "–Ω–∏–¥–µ—Ä–ª–∞–Ω–¥—ã": (52.1326, 5.2913, "–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã", 7),
            "–±–µ–ª—å–≥–∏—è": (50.5039, 4.4699, "–ë–µ–ª—å–≥–∏—è", 7),
            "—à–≤–µ–π—Ü–∞—Ä–∏—è": (46.8182, 8.2275, "–®–≤–µ–π—Ü–∞—Ä–∏—è", 7),
            "–∞–≤—Å—Ç—Ä–∏—è": (48.2082, 16.3738, "–ê–≤—Å—Ç—Ä–∏—è", 7),
            "—à–≤–µ—Ü–∏—è": (59.3293, 18.0686, "–®–≤–µ—Ü–∏—è", 5),
            "–Ω–æ—Ä–≤–µ–≥–∏—è": (59.9139, 10.7522, "–ù–æ—Ä–≤–µ–≥–∏—è", 5),
            "—Ñ–∏–Ω–ª—è–Ω–¥–∏—è": (60.1699, 24.9384, "–§–∏–Ω–ª—è–Ω–¥–∏—è", 5),
            "–¥–∞–Ω–∏—è": (55.6761, 12.5683, "–î–∞–Ω–∏—è", 7),
            # –ê–∑–∏–∞—Ç—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω—ã
            "—è–ø–æ–Ω–∏—è": (36.2048, 138.2529, "–Ø–ø–æ–Ω–∏—è", 6),
            "–∫–æ—Ä–µ—è": (37.5665, 126.9780, "–ö–æ—Ä–µ—è", 6),
            "—é–∂–Ω–∞—è –∫–æ—Ä–µ—è": (37.5665, 126.9780, "–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è", 6),
            "—Å–µ–≤–µ—Ä–Ω–∞—è –∫–æ—Ä–µ—è": (39.0392, 125.7625, "–°–µ–≤–µ—Ä–Ω–∞—è –ö–æ—Ä–µ—è", 6),
            "—Ç–∞–π–ª–∞–Ω–¥": (13.7563, 100.5018, "–¢–∞–∏–ª–∞–Ω–¥", 6),
            "–≤—å–µ—Ç–Ω–∞–º": (21.0285, 105.8542, "–í—å–µ—Ç–Ω–∞–º", 6),
            "–∏–Ω–¥–æ–Ω–µ–∑–∏—è": (-6.2088, 106.8456, "–ò–Ω–¥–æ–Ω–µ–∑–∏—è", 5),
            "—Ñ–∏–ª–∏–ø–ø–∏–Ω—ã": (14.5995, 120.9842, "–§–∏–ª–∏–ø–ø–∏–Ω—ã", 6),
            "–º–∞–ª–∞–π–∑–∏—è": (3.1390, 101.6869, "–ú–∞–ª–∞–π–∑–∏—è", 6),
            "—Å–∏–Ω–≥–∞–ø—É—Ä": (1.3521, 103.8198, "–°–∏–Ω–≥–∞–ø—É—Ä", 7),
            "—Å–∞—É–¥–æ–≤—Å–∫–∞—è –∞—Ä–∞–≤–∏—è": (24.7136, 46.6753, "–°–∞—É–¥–æ–≤—Å–∫–∞—è –ê—Ä–∞–≤–∏—è", 5),
            "–∏–∑—Ä–∞–∏–ª—å": (31.7683, 35.2137, "–ò–∑—Ä–∞–∏–ª—å", 7),
            "–∏—Ä–∞–Ω": (35.6892, 51.3890, "–ò—Ä–∞–Ω", 5),
            "–∏—Ä–∞–∫": (33.3152, 44.3661, "–ò—Ä–∞–∫", 6),
            "–ø–∞–∫–∏—Å—Ç–∞–Ω": (30.3753, 69.3451, "–ü–∞–∫–∏—Å—Ç–∞–Ω", 5),
            "–±–∞–Ω–≥–ª–∞–¥–µ—à": (23.8103, 90.4125, "–ë–∞–Ω–≥–ª–∞–¥–µ—à", 6),
            "–∞—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω": (34.5553, 69.2075, "–ê—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω", 5),
            "–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω": (51.1694, 71.4491, "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω", 5),
            "—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω": (41.2995, 69.2401, "–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω", 6),
            "–º–æ–Ω–≥–æ–ª–∏—è": (47.8864, 106.9057, "–ú–æ–Ω–≥–æ–ª–∏—è", 5),
            # –ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω—ã
            "–º–µ–∫—Å–∏–∫–∞": (19.4326, -99.1332, "–ú–µ–∫—Å–∏–∫–∞", 5),
            "–∞—Ä–≥–µ–Ω—Ç–∏–Ω–∞": (-34.6037, -58.3816, "–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞", 5),
            "—á–∏–ª–∏": (-33.4489, -70.6693, "–ß–∏–ª–∏", 5),
            "–ø–µ—Ä—É": (-12.0464, -77.0428, "–ü–µ—Ä—É", 5),
            "–∫–æ–ª—É–º–±–∏—è": (4.7110, -74.0721, "–ö–æ–ª—É–º–±–∏—è", 5),
            "–≤–µ–Ω–µ—Å—É—ç–ª–∞": (10.4806, -66.9036, "–í–µ–Ω–µ—Å—É—ç–ª–∞", 5),
            "–∫—É–±–∞": (23.1136, -82.3666, "–ö—É–±–∞", 7),
            # –ê—Ñ—Ä–∏–∫–∞–Ω—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω—ã
            "–µ–≥–∏–ø–µ—Ç": (30.0444, 31.2357, "–ï–≥–∏–ø–µ—Ç", 6),
            "—é–∂–Ω–∞—è –∞—Ñ—Ä–∏–∫–∞": (-25.7461, 28.1881, "–Æ–∂–Ω–∞—è –ê—Ñ—Ä–∏–∫–∞", 5),
            "–Ω–∏–≥–µ—Ä–∏—è": (6.5244, 3.3792, "–ù–∏–≥–µ—Ä–∏—è", 5),
            "–∫–µ–Ω–∏—è": (-1.2921, 36.8219, "–ö–µ–Ω–∏—è", 6),
            "—ç—Ñ–∏–æ–ø–∏—è": (9.1450, 38.7667, "–≠—Ñ–∏–æ–ø–∏—è", 5),
            "–º–∞—Ä–æ–∫–∫–æ": (33.9716, -6.8498, "–ú–∞—Ä–æ–∫–∫–æ", 6),
            "–∞–ª–∂–∏—Ä": (36.7538, 3.0588, "–ê–ª–∂–∏—Ä", 5),
            "—Ç—É–Ω–∏—Å": (36.8065, 10.1815, "–¢—É–Ω–∏—Å", 7),
            "–ª–∏–≤–∏—è": (32.8872, 13.1913, "–õ–∏–≤–∏—è", 5),
            "—Å—É–¥–∞–Ω": (15.5007, 32.5599, "–°—É–¥–∞–Ω", 5),
            # –ì–æ—Ä–æ–¥–∞ –†–æ—Å—Å–∏–∏
            "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥": (59.9343, 30.3351, "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", 10),
            "–ø–∏—Ç–µ—Ä": (59.9343, 30.3351, "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", 10),
            "–ø–µ—Ç–µ—Ä–±—É—Ä–≥": (59.9343, 30.3351, "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", 10),
            "—Å–ø–±": (59.9343, 30.3351, "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", 10),
            "–º–æ—Å–∫–≤–∞": (55.7558, 37.6173, "–ú–æ—Å–∫–≤–∞", 10),
            # –†–µ–≥–∏–æ–Ω—ã
            "–µ–≤—Ä–æ–ø–∞": (54.5260, 15.2551, "–ï–≤—Ä–æ–ø–∞", 4),
            "–∞–∑–∏—è": (34.0479, 100.6197, "–ê–∑–∏—è", 3),
            "–∞—Ñ—Ä–∏–∫–∞": (8.7832, 34.5085, "–ê—Ñ—Ä–∏–∫–∞", 3),
            "–∞–º–µ—Ä–∏–∫–∞": (19.4326, -99.1332, "–ê–º–µ—Ä–∏–∫–∞", 3),
            "—Å–µ–≤–µ—Ä–Ω–∞—è –∞–º–µ—Ä–∏–∫–∞": (39.8283, -98.5795, "–°–µ–≤–µ—Ä–Ω–∞—è –ê–º–µ—Ä–∏–∫–∞", 3),
            "—é–∂–Ω–∞—è –∞–º–µ—Ä–∏–∫–∞": (-14.2350, -51.9253, "–Æ–∂–Ω–∞—è –ê–º–µ—Ä–∏–∫–∞", 3),
            "–º–∏—Ä": (20.0, 0.0, "–ú–∏—Ä", 2),
        }

        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã (—É–±–∏—Ä–∞–µ–º –æ–ø–µ—á–∞—Ç–∫–∏ –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã)
        country_lower = country_name.lower().strip()

        # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —á–∞—Å—Ç—ã–µ –æ–ø–µ—á–∞—Ç–∫–∏
        country_lower = country_lower.replace("—Ä–æ—Å–∏–∏–∏", "—Ä–æ—Å—Å–∏–∏")
        country_lower = country_lower.replace("—Ä–æ—Å–∏–∏", "—Ä–æ—Å—Å–∏–∏")
        country_lower = country_lower.replace("—Ä–æ—Å–∏—è", "—Ä–æ—Å—Å–∏—è")

        country_data = None

        # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–ª–∏ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ
        for key in countries_coords:
            if key == country_lower or key in country_lower or country_lower in key:
                country_data = countries_coords[key]
                break

        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
        if not country_data:
            for key in countries_coords:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –∫–ª—é—á –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã –æ–±—â–∏–µ —Å–ª–æ–≤–∞
                key_words = set(key.split())
                country_words = set(country_lower.split())
                if key_words & country_words:  # –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤
                    country_data = countries_coords[key]
                    break

        if not country_data:
            logger.warning(
                f"üó∫Ô∏è –°—Ç—Ä–∞–Ω–∞ '{country_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ. "
                f"–î–æ—Å—Ç—É–ø–Ω—ã–µ: {', '.join(sorted(countries_coords.keys())[:10])}..."
            )
            return None

        lat, lon, name, zoom = country_data

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É —á–µ—Ä–µ–∑ Yandex Maps Static API
        try:
            return self._get_yandex_map(lat, lon, zoom, name)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã —á–µ—Ä–µ–∑ Yandex Maps: {e}")
            return None

    def _get_yandex_map(self, lat: float, lon: float, zoom: int, label: str) -> bytes | None:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—á–Ω—É—é –∫–∞—Ä—Ç—É —á–µ—Ä–µ–∑ Yandex Maps Static API.

        Args:
            lat: –®–∏—Ä–æ—Ç–∞ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã
            lon: –î–æ–ª–≥–æ—Ç–∞ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞—Ä—Ç—ã
            zoom: –£—Ä–æ–≤–µ–Ω—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è (1-17)
            label: –ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ

        Returns:
            bytes: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        """
        if not REQUESTS_AVAILABLE:
            logger.warning("‚ö†Ô∏è requests –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –∫–∞—Ä—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")
            return None

        settings = Settings()
        if not settings.yandex_maps_api_key:
            return None

        # URL –¥–ª—è Yandex Maps Static API (–æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ v1 —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ 2026)
        base_url = "https://static-maps.yandex.ru/v1"

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è Yandex Maps Static API
        # –°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: https://yandex.ru/maps-api/docs/static-api/request.html
        params = {
            "apikey": settings.yandex_maps_api_key,  # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
            "ll": f"{lon},{lat}",  # –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã: –¥–æ–ª–≥–æ—Ç–∞, —à–∏—Ä–æ—Ç–∞
            "z": str(zoom),  # –£—Ä–æ–≤–µ–Ω—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è (0-21)
            "size": "650,450",  # –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∞–∫—Å–∏–º—É–º: 650x450)
            "lang": "ru_RU",  # –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è: —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
            "pt": f"{lon},{lat},pm2rdm",  # –ú–µ—Ç–∫–∞: –∫—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        }

        try:
            # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å API
            headers = {
                "User-Agent": "PandaPal-Bot/1.0 (Educational Telegram Bot)",
                "Accept": "image/png,image/*,*/*",
            }

            response = requests.get(
                base_url, params=params, headers=headers, timeout=15, stream=True
            )

            if response.status_code == 200:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                content_type = response.headers.get("Content-Type", "")
                if "image" not in content_type:
                    logger.warning(
                        f"‚ö†Ô∏è Yandex Maps –≤–µ—Ä–Ω—É–ª –Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (Content-Type: {content_type})"
                    )
                    return None

                image_bytes = response.content

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤)
                if len(image_bytes) < 1000:
                    logger.warning(
                        f"‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω–æ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ({len(image_bytes)} –±–∞–π—Ç)"
                    )
                    return None

                logger.info(
                    f"‚úÖ –ü–æ–ª—É—á–µ–Ω–∞ –∫–∞—Ä—Ç–∞ —á–µ—Ä–µ–∑ Yandex Maps Static API: {label} "
                    f"({len(image_bytes)} –±–∞–π—Ç, zoom={zoom})"
                )
                return image_bytes

            elif response.status_code == 403:
                logger.error(
                    "‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω –∫ Yandex Maps Static API. "
                    "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ –ª–∏–º–∏—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è."
                )
                return None
            elif response.status_code == 400:
                error_text = response.text[:500]
                logger.error(
                    f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –∫ Yandex Maps Static API: {error_text}"
                )
                return None
            else:
                error_text = response.text[:500] if response.text else "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –æ—à–∏–±–∫–∏"
                logger.error(
                    f"‚ùå –û—à–∏–±–∫–∞ Yandex Maps Static API (status {response.status_code}): {error_text}"
                )
                return None

        except requests.Timeout:
            logger.error("‚ùå –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Yandex Maps Static API (15 —Å–µ–∫)")
            return None
        except requests.ConnectionError as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Yandex Maps Static API: {e}")
            return None
        except Exception as e:
            logger.error(
                f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Yandex Maps Static API: {e}", exc_info=True
            )
            return None

        # –°—Ç–∞—Ä—ã–π –∫–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ö–µ–º–∞—Ç–∏—á–Ω—ã—Ö –∫–∞—Ä—Ç –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
        # (–∑–∞–º–µ–Ω–µ–Ω –Ω–∞ Yandex Maps Static API)
        # –û—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
        return None

    def _generate_world_map(self, country_name: str) -> bytes | None:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–±—â—É—é –∫–∞—Ä—Ç—É –º–∏—Ä–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ä–µ–≥–∏–æ–Ω–∞ —Å—Ç—Ä–∞–Ω—ã."""
        if not MATPLOTLIB_AVAILABLE:
            return None

        try:
            import io

            fig, ax = plt.subplots(figsize=(14, 8))
            fig.patch.set_facecolor("white")

            # –†–∏—Å—É–µ–º —Å—Ö–µ–º–∞—Ç–∏—á–Ω—É—é –∫–∞—Ä—Ç—É –º–∏—Ä–∞
            ax.set_xlim(-180, 180)
            ax.set_ylim(-90, 90)
            ax.set_aspect("equal")
            ax.axis("off")

            # –ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç—ã
            continents = [
                ("–ê–∑–∏—è", (60, 10), (140, 50), "#E8F5E9", "#4CAF50"),
                ("–ï–≤—Ä–æ–ø–∞", (-10, 35), (40, 70), "#E3F2FD", "#2196F3"),
                ("–°–µ–≤. –ê–º–µ—Ä–∏–∫–∞", (-130, 25), (-50, 70), "#FFF3E0", "#FF9800"),
                ("–Æ–∂. –ê–º–µ—Ä–∏–∫–∞", (-80, -55), (-35, 12), "#F3E5F5", "#9C27B0"),
                ("–ê—Ñ—Ä–∏–∫–∞", (-20, -35), (50, 35), "#FFF9C4", "#FBC02D"),
                ("–ê–≤—Å—Ç—Ä–∞–ª–∏—è", (110, -45), (155, -10), "#E1BEE7", "#7B1FA2"),
            ]

            for name, (x1, y1), (x2, y2), facecolor, edgecolor in continents:
                rect = plt.Rectangle(
                    (x1, y1),
                    (x2 - x1),
                    (y2 - y1),
                    facecolor=facecolor,
                    edgecolor=edgecolor,
                    linewidth=2,
                )
                ax.add_patch(rect)
                ax.text(
                    (x1 + x2) / 2,
                    (y1 + y2) / 2,
                    name,
                    ha="center",
                    va="center",
                    fontsize=11,
                    bbox={"boxstyle": "round,pad=0.3", "facecolor": "white", "alpha": 0.7},
                )

            # –ó–∞–≥–æ–ª–æ–≤–æ–∫
            ax.text(
                0.5,
                0.95,
                f"–ö–∞—Ä—Ç–∞ –º–∏—Ä–∞: {country_name}",
                transform=ax.transAxes,
                ha="center",
                fontsize=16,
                fontweight="bold",
            )

            ax.text(
                0.5,
                0.05,
                "–°—Ö–µ–º–∞—Ç–∏—á–Ω–∞—è –∫–∞—Ä—Ç–∞ –º–∏—Ä–∞",
                transform=ax.transAxes,
                ha="center",
                fontsize=12,
                style="italic",
                color="gray",
            )

            plt.tight_layout()

            buf = io.BytesIO()
            plt.savefig(buf, format="png", dpi=100, bbox_inches="tight", facecolor="white")
            buf.seek(0)
            plt.close(fig)

            return buf.read()

        except Exception as e:
            from loguru import logger

            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã –º–∏—Ä–∞: {e}")
            return None
