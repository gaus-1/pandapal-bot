"""
–°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ —ç–º–æ–¥–∑–∏ –≤ –æ—Ç–≤–µ—Ç–∞—Ö –ü–∞–Ω–¥—ã.

–û–¥–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: –ø–∞—Ä—Å–∏–Ω–≥ —Ñ—Ä–∞–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞
—Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞. –ù–µ –Ω–∞—Ä—É—à–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–æ–≤ ‚Äî —ç–º–æ–¥–∑–∏ —Ç–æ–ª—å–∫–æ —É–∫—Ä–∞—à–µ–Ω–∏–µ.
"""

from typing import Literal

# –§—Ä–∞–∑—ã ¬´–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏¬ª (—Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏)
NO_EMOJI_PHRASES = (
    "–Ω–µ —Å—Ç–∞–≤—å —ç–º–æ–¥–∑–∏",
    "–Ω–µ —Å—Ç–∞–≤—å —Å–º–∞–π–ª–∏–∫–∏",
    "–±–µ–∑ —ç–º–æ–¥–∑–∏",
    "–±–µ–∑ —Å–º–∞–π–ª–∏–∫–æ–≤",
    "–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏",
    "–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏",
    "–Ω–µ –Ω–∞–¥–æ —ç–º–æ–¥–∑–∏",
    "–Ω–µ –Ω—É–∂–Ω—ã —ç–º–æ–¥–∑–∏",
    "–Ω–µ –ø–∏—à–∏ —ç–º–æ–¥–∑–∏",
    "–±–µ–∑ —ç–º–æ–¥–∂–∏",
    "–Ω–µ —ç–º–æ–¥–∑–∏",
)

# –§—Ä–∞–∑—ã ¬´–¥–æ–±–∞–≤–ª—è—Ç—å —ç–º–æ–¥–∑–∏¬ª
YES_EMOJI_PHRASES = (
    "–¥–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∑–∏",
    "—Å—Ç–∞–≤—å —ç–º–æ–¥–∑–∏",
    "—Å —ç–º–æ–¥–∑–∏",
    "–º–æ–∂–Ω–æ —ç–º–æ–¥–∑–∏",
    "—Ö–æ—á—É —ç–º–æ–¥–∑–∏",
    "—Å–æ —Å–º–∞–π–ª–∏–∫–∞–º–∏",
    "–¥–æ–±–∞–≤–ª—è–π —Å–º–∞–π–ª–∏–∫–∏",
    "—Å —ç–º–æ–¥–∂–∏",
    "–∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏",
)


def parse_emoji_preference_from_message(message: str) -> Literal[False, True] | None:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –ø–æ —ç–º–æ–¥–∑–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    Returns:
        False ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏.
        True ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏.
        None ‚Äî –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω–µ—Ç —è–≤–Ω–æ–π –ø—Ä–æ—Å—å–±—ã (–ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –Ω–µ –º–µ–Ω—è—Ç—å).
    """
    if not message or not isinstance(message, str):
        return None
    lower = message.lower().strip()
    for phrase in NO_EMOJI_PHRASES:
        if phrase in lower:
            return False
    for phrase in YES_EMOJI_PHRASES:
        if phrase in lower:
            return True
    return None


def compute_allow_emoji_this_turn(chat_history: list[dict]) -> bool:
    """
    –†–µ—à–∞–µ—Ç, —Ä–∞–∑—Ä–µ—à–∞—Ç—å –ª–∏ —ç–º–æ–¥–∑–∏ –≤ —Ç–µ–∫—É—â–µ–º –æ—Ç–≤–µ—Ç–µ –ø—Ä–∏ —Ä–µ–∂–∏–º–µ ¬´–∏–Ω–æ–≥–¥–∞¬ª (1‚Äì2 –∏–∑ 5‚Äì7).

    –°—á–∏—Ç–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –∏ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç —ç–º–æ–¥–∑–∏ –≤ 2 –∏–∑ –∫–∞–∂–¥—ã—Ö 7 –æ—Ç–≤–µ—Ç–æ–≤.
    """
    if not chat_history:
        return True  # –ø–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç ‚Äî –º–æ–∂–Ω–æ
    count = sum(1 for m in chat_history if m.get("role") == "assistant")
    return (count % 7) in (2, 5)


def get_emoji_prompt_snippet(
    emoji_in_chat: bool | None,
    allow_emoji_this_turn: bool,
) -> str | None:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –ø—Ä–æ —ç–º–æ–¥–∑–∏.

    –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–∞–±–∑–∞—Ü—ã, —Å–ø–∏—Å–∫–∏, –≤—ã–¥–µ–ª–µ–Ω–∏—è) –æ—Å—Ç–∞—ë—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π;
    —ç–º–æ–¥–∑–∏ —Ç–æ–ª—å–∫–æ —É–∫—Ä–∞—à–µ–Ω–∏–µ, –Ω–µ –Ω–∞—Ä—É—à–∞—é—Ç —Ä–∞–∑–±–∏–≤–∫—É –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é.

    Args:
        emoji_in_chat: None = –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∏–Ω–æ–≥–¥–∞), False = –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, True = –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.
        allow_emoji_this_turn: –ø—Ä–∏ emoji_in_chat=None ‚Äî —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤ —ç—Ç–æ–º –æ—Ç–≤–µ—Ç–µ –∏–ª–∏ –Ω–µ—Ç.

    Returns:
        –°—Ç—Ä–æ–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–ª–∏ None.
    """
    if emoji_in_chat is False:
        return (
            "–≠–º–æ–¥–∑–∏ –≤ –æ—Ç–≤–µ—Ç–∞—Ö –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π. "
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–∞–±–∑–∞—Ü—ã, —Å–ø–∏—Å–∫–∏, –≤—ã–¥–µ–ª–µ–Ω–∏—è, –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞) —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ."
        )
    if emoji_in_chat is True:
        return (
            "–ú–æ–∂–µ—à—å –¥–æ–±–∞–≤–ª—è—Ç—å 1‚Äì2 —É–º–µ—Å—Ç–Ω—ã—Ö —ç–º–æ–¥–∑–∏ –ø–æ —Ç–µ–º–µ –æ—Ç–≤–µ—Ç–∞ –∫–∞–∫ —É–∫—Ä–∞—à–µ–Ω–∏–µ. "
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–∞–±–∑–∞—Ü—ã, —Å–ø–∏—Å–∫–∏, –≤—ã–¥–µ–ª–µ–Ω–∏—è, –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞) —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ; "
            "—ç–º–æ–¥–∑–∏ —Ç–æ–ª—å–∫–æ –¥–æ–ø–æ–ª–Ω—è—é—Ç, –Ω–µ –∑–∞–º–µ–Ω—è—é—Ç –∏ –Ω–µ –Ω–∞—Ä—É—à–∞—é—Ç —Ä–∞–∑–±–∏–≤–∫—É –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é."
        )
    # emoji_in_chat is None ‚Äî —Ä–µ–∂–∏–º ¬´–∏–Ω–æ–≥–¥–∞¬ª
    if allow_emoji_this_turn:
        return (
            "–í —ç—Ç–æ–º –æ—Ç–≤–µ—Ç–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å 1‚Äì2 —É–º–µ—Å—Ç–Ω—ã—Ö —ç–º–æ–¥–∑–∏ –ø–æ —Ç–µ–º–µ "
            "(–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ üßÆ, –∫–Ω–∏–≥–∞ üìñ, –ø—Ä–∏—Ä–æ–¥–∞ üåø –∏ —Ç.–ø.) –∫–∞–∫ —É–∫—Ä–∞—à–µ–Ω–∏–µ. "
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ; —ç–º–æ–¥–∑–∏ –Ω–µ –Ω–∞—Ä—É—à–∞—é—Ç –∞–±–∑–∞—Ü—ã, —Å–ø–∏—Å–∫–∏ –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é."
        )
    return (
        "–í —ç—Ç–æ–º –æ—Ç–≤–µ—Ç–µ —ç–º–æ–¥–∑–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π. "
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–∞–±–∑–∞—Ü—ã, —Å–ø–∏—Å–∫–∏, –≤—ã–¥–µ–ª–µ–Ω–∏—è) —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ."
    )
