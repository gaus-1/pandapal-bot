"""
Нормализация типичных опечаток в запросах детей.

Используется для маршрутизации (визуализация/график/арт) и для промпта,
чтобы модель понимала «приперы» как «примеры», «темпереатуры» как «температуры» и т.д.
"""

import re

# Словарь: опечатка (нижний регистр) -> правильное слово. По всем предметам.
_COMMON_TYPOS: dict[str, str] = {
    # помощь, просьбы
    "памаги": "помоги",
    "памоги": "помоги",
    "скинь": "покажи",
    "скиньте": "покажите",
    # примеры, подробнее, расскажи, объясни
    "приперы": "примеры",
    "приеры": "примеры",
    "примееры": "примеры",
    "подрабонее": "подробнее",
    "подробне": "подробнее",
    "подробнеее": "подробнее",
    "подробней": "подробнее",
    "расскожи": "расскажи",
    "раскажи": "расскажи",
    "расскажы": "расскажи",
    "обясни": "объясни",
    "обьясни": "объясни",
    "обьяснением": "объяснением",
    "обяснение": "объяснение",
    # что
    "чё": "что",
    "чо": "что",
    "што": "что",
    # математика
    "каратнаво": "квадратного",
    "пишеться": "пишется",
    "дискременанта": "дискриминанта",
    "умноженяи": "умножения",
    "задачю": "задачу",
    "решат": "решать",
    # геометрия
    "трапецыи": "трапеции",
    "пифагора": "Пифагора",
    "обьем": "объём",
    # физика
    "ньютона": "Ньютона",
    "ньютон": "Ньютон",
    "архимеда": "Архимеда",
    "архимед": "Архимед",
    # химия
    "менделеева": "Менделеева",
    # температура, график, диаграмма
    "темпереатуры": "температуры",
    "темпереатура": "температура",
    "напишы": "напиши",
    "граффик": "график",
    "диагрмма": "диаграмма",
    "диаграма": "диаграмма",
    # география, история (капитализация / частые опечатки)
    "москвы": "Москвы",
    "рюриковичей": "Рюриковичей",
    # русский
    "падежы": "падежи",
    # иностранные языки
    "времен": "времён",
}


def normalize_common_typos(text: str) -> str:
    """
    Исправляет типичные опечатки в тексте для маршрутизации и промпта.

    По всем предметам: «подробнее», «примеры», «расскажи», «объясни»
    и т.п. с типичными ошибками приводятся к одному варианту.
    """
    if not text or not text.strip():
        return text
    result = text.strip()
    lower = result.lower()
    # Сортируем по длине ключа (длинные первыми), чтобы «темпереатуры» заменилось до «температуры»
    for typo, correct in sorted(_COMMON_TYPOS.items(), key=lambda x: -len(x[0])):
        if typo in lower:
            pattern = re.compile(re.escape(typo), re.IGNORECASE)
            replacement = correct

            def repl(m: re.Match, rep: str = replacement) -> str:
                w = m.group(0)
                if w[0].isupper():
                    return rep.capitalize() if len(rep) > 0 else rep
                return rep

            result = pattern.sub(repl, result)
            lower = result.lower()
    return result
