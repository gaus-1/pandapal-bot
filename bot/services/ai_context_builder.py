"""
–ü–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ AI.

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ª–æ–≥–∏–∫—É –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ AI –º–æ–¥–µ–ª—å,
–≤–∫–ª—é—á–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—é –ø–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞.
–°–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø—É Single Responsibility - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞: –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
"""

from typing import Dict, List, Optional

from bot.services.yandex_ai_response_generator import IContextBuilder


class ContextBuilder(IContextBuilder):
    """
    –ü–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è AI —Å –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π –ø–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å: —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ AI –º–æ–¥–µ–ª—å
    —Å —É—á–µ—Ç–æ–º –≤–æ–∑—Ä–∞—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
    """

    def build(
        self,
        user_message: str,
        chat_history: List[Dict] = None,
        user_age: Optional[int] = None,
        user_grade: Optional[int] = None,
    ) -> str:
        """
        –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ AI.

        –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, –≤–∫–ª—é—á–∞—é—â–∏–π –∞–¥–∞–ø—Ç–∞—Ü–∏—é –ø–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç
        –∏ –∫–ª–∞—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∞ —Ç–∞–∫–∂–µ –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞.

        Args:
            user_message (str): –¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            chat_history (List[Dict], optional): –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
            user_age (Optional[int]): –í–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞.
            user_grade (Optional[int]): –ö–ª–∞—Å—Å –æ–±—É—á–µ–Ω–∏—è (1-9) –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–∏.

        Returns:
            str: –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ AI –º–æ–¥–µ–ª—å.
        """
        context_parts = []

        # –í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è (—Å —É—á–µ—Ç–æ–º –∫–ª–∞—Å—Å–∞ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
        if user_age or user_grade:
            age_context = self._get_age_context(user_age or 10, user_grade)
            context_parts.append(age_context)

        # –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞
        if chat_history:
            history_context = self._prepare_history_context(chat_history)
            context_parts.append(history_context)

        # –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        context_parts.append(f"–¢–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å: {user_message}")

        return "\n\n".join(context_parts)

    def _get_age_context(self, user_age: int, user_grade: Optional[int] = None) -> str:
        """
        –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –ø–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç –∏ –∫–ª–∞—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

        Args:
            user_age (int): –í–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            user_grade (Optional[int]): –ö–ª–∞—Å—Å –æ–±—É—á–µ–Ω–∏—è (1-9).

        Returns:
            str: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è AI –ø–æ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –ø–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç –∏ –∫–ª–∞—Å—Å.
        """
        # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –∫–ª–∞—Å—Å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–∏
        if user_grade:
            return self._get_grade_context(user_grade)

        # –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–æ–∑—Ä–∞—Å—Ç
        if user_age <= 7:
            return (
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Ä–µ–±–µ–Ω–æ–∫ 6-7 –ª–µ—Ç (1-2 –∫–ª–∞—Å—Å). "
                "–ò—Å–ø–æ–ª—å–∑—É–π –û–ß–ï–ù–¨ –ø—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞, –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–¥–æ 10 —Å–ª–æ–≤). "
                "–ú–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏ –∏ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏–∑ –∂–∏–∑–Ω–∏ (–∏–≥—Ä—É—à–∫–∏, –∂–∏–≤–æ—Ç–Ω—ã–µ, –µ–¥–∞). "
                "–ò–∑–±–µ–≥–∞–π —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤. –û–±—ä—è—Å–Ω—è–π –∫–∞–∫ –¥–ª—è –º–∞–ª—ã—à–∞."
            )
        elif user_age <= 9:
            return (
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Ä–µ–±–µ–Ω–æ–∫ 8-9 –ª–µ—Ç (3-4 –∫–ª–∞—Å—Å). "
                "–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞, –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–¥–æ 15 —Å–ª–æ–≤). "
                "–ü–æ–Ω—è—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏. "
                "–ù–∞—á–∏–Ω–∞–π –≤–≤–æ–¥–∏—Ç—å —É—á–µ–±–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã, –Ω–æ —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏. "
                "–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ."
            )
        elif user_age <= 11:
            return (
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Ä–µ–±–µ–Ω–æ–∫ 10-11 –ª–µ—Ç (5-6 –∫–ª–∞—Å—Å). "
                "–ò—Å–ø–æ–ª—å–∑—É–π –±–æ–ª–µ–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º —è–∑—ã–∫–æ–º. "
                "–£—á–µ–±–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏. "
                "–°–ª–æ–∂–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã, –Ω–æ –ø–æ–Ω—è—Ç–Ω–æ. "
                "–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã."
            )
        elif user_age <= 13:
            return (
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ø–æ–¥—Ä–æ—Å—Ç–æ–∫ 12-13 –ª–µ—Ç (7-8 –∫–ª–∞—Å—Å). "
                "–ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å –Ω–∞—É—á–Ω—ã–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏. "
                "–£–≥–ª—É–±–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è, –Ω–æ –ø–æ–Ω—è—Ç–Ω–æ. "
                "–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –ø—Ä–∏–º–µ—Ä—ã."
            )
        else:
            return (
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ø–æ–¥—Ä–æ—Å—Ç–æ–∫ 14-15 –ª–µ—Ç (9 –∫–ª–∞—Å—Å). "
                "–ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ –Ω–∞—É—á–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è. "
                "–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏. "
                "–ì–ª—É–±–æ–∫–∏–µ –∑–Ω–∞–Ω–∏—è, –Ω–æ –≤—Å–µ –µ—â–µ –¥–æ—Å—Ç—É–ø–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ."
            )

    def _get_grade_context(self, grade: int) -> str:
        """
        –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –ø–æ –∫–ª–∞—Å—Å—É –æ–±—É—á–µ–Ω–∏—è.

        Args:
            grade (int): –ö–ª–∞—Å—Å –æ–±—É—á–µ–Ω–∏—è (1-9).

        Returns:
            str: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è AI –ø–æ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –ø–æ–¥ –∫–ª–∞—Å—Å.
        """
        grade_contexts = {
            1: (
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - 1 –∫–ª–∞—Å—Å (6-7 –ª–µ—Ç). "
                "–ò—Å–ø–æ–ª—å–∑—É–π –û–ß–ï–ù–¨ –ø—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞ (3-4 –±—É–∫–≤—ã), –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (5-8 —Å–ª–æ–≤). "
                "–ú–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏ üéàüê∂üçé, –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –∂–∏–∑–Ω–∏ (–∏–≥—Ä—É—à–∫–∏, —Å–µ–º—å—è, –∏–≥—Ä—ã). "
                "–ò–∑–±–µ–≥–∞–π —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ —Å –º–∞–ª—ã—à–æ–º, –Ω–æ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ."
            ),
            2: (
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - 2 –∫–ª–∞—Å—Å (7-8 –ª–µ—Ç). "
                "–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞, –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (8-12 —Å–ª–æ–≤). "
                "–ú–Ω–æ–≥–æ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏–∑ –∂–∏–∑–Ω–∏, —ç–º–æ–¥–∑–∏ üé®üöóüçï. "
                "–ù–∞—á–∏–Ω–∞–π –≤–≤–æ–¥–∏—Ç—å –ø—Ä–æ—Å—Ç—ã–µ —É—á–µ–±–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏."
            ),
            3: (
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - 3 –∫–ª–∞—Å—Å (8-9 –ª–µ—Ç). "
                "–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–æ 15 —Å–ª–æ–≤. "
                "–ü–æ–Ω—è—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏. "
                "–£—á–µ–±–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏. –≠–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ."
            ),
            4: (
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - 4 –∫–ª–∞—Å—Å (9-10 –ª–µ—Ç). "
                "–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–æ 18 —Å–ª–æ–≤. "
                "–ü–æ–Ω—è—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã. –£—á–µ–±–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏. "
                "–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ —Ç–∞–±–ª–∏—Ü—ã."
            ),
            5: (
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - 5 –∫–ª–∞—Å—Å (10-11 –ª–µ—Ç). "
                "–ò—Å–ø–æ–ª—å–∑—É–π –±–æ–ª–µ–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º —è–∑—ã–∫–æ–º. "
                "–£—á–µ–±–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏. "
                "–°–ª–æ–∂–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã, –Ω–æ –ø–æ–Ω—è—Ç–Ω–æ. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã."
            ),
            6: (
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - 6 –∫–ª–∞—Å—Å (11-12 –ª–µ—Ç). "
                "–ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã —Å —É—á–µ–±–Ω—ã–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏. "
                "–°–ª–æ–∂–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ. "
                "–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∏ —Ç–∞–±–ª–∏—Ü—ã."
            ),
            7: (
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - 7 –∫–ª–∞—Å—Å (12-13 –ª–µ—Ç). "
                "–ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å –Ω–∞—É—á–Ω—ã–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏. "
                "–£–≥–ª—É–±–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è, –Ω–æ –ø–æ–Ω—è—Ç–Ω–æ. "
                "–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –ø—Ä–∏–º–µ—Ä—ã."
            ),
            8: (
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - 8 –∫–ª–∞—Å—Å (13-14 –ª–µ—Ç). "
                "–ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ –Ω–∞—É—á–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è. "
                "–°–ª–æ–∂–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏. "
                "–ì–ª—É–±–æ–∫–∏–µ –∑–Ω–∞–Ω–∏—è, –Ω–æ –≤—Å–µ –µ—â–µ –¥–æ—Å—Ç—É–ø–Ω–æ."
            ),
            9: (
                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - 9 –∫–ª–∞—Å—Å (14-15 –ª–µ—Ç). "
                "–ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ –Ω–∞—É—á–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è. "
                "–°–ª–æ–∂–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏. "
                "–ì–ª—É–±–æ–∫–∏–µ –∑–Ω–∞–Ω–∏—è, –Ω–æ –æ–±—ä—è—Å–Ω—è–π –ø–æ–Ω—è—Ç–Ω–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ."
            ),
        }

        return grade_contexts.get(grade, grade_contexts[5])  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –∫–ª–∞—Å—Å

    def _prepare_history_context(self, chat_history: List[Dict]) -> str:
        """
        –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞.

        –§–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è
        –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π (content/parts).

        Args:
            chat_history (List[Dict]): –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞.

        Returns:
            str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
        """
        history_text = "–ü—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:\n"
        for msg in chat_history[-5:]:  # –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π
            # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞: 'content' –∏ 'parts'
            content = msg.get("content", "")
            if not content and "parts" in msg:
                content = msg["parts"][0] if isinstance(msg["parts"], list) and msg["parts"] else ""

            role = msg.get("role", "user")
            role_text = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" if role == "user" else "AI"
            history_text += f"{role_text}: {content}\n"
        return history_text
