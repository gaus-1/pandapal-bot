"""
–°–µ—Ä–≤–∏—Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—É–ª –¥–ª—è –¥–µ—Ç–µ–π —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è–º–∏.

–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å–ª–æ–∂–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã –≤ –ø–æ–Ω—è—Ç–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏,
–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è.
"""

import re
from typing import Any

from loguru import logger

from bot.services.visualization_service import VisualizationService


class FormulaExplainer:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—É–ª –¥–µ—Ç—è–º.

    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ, —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ, —Ö–∏–º–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª—ã
    –≤ –ø–æ–Ω—è—Ç–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è–º–∏.
    """

    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞."""
        self.viz_service = VisualizationService()

        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Ñ–æ—Ä–º—É–ª
        self.formula_patterns = {
            # –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞
            "quadratic": r"[a-z]x¬≤\s*[+\-]\s*[a-z]x\s*[+\-]\s*[a-z]\s*=\s*0",
            "pythagorean": r"a¬≤\s*\+\s*b¬≤\s*=\s*c¬≤",
            "area_circle": r"S\s*=\s*œÄr¬≤|A\s*=\s*œÄr¬≤",
            "volume_sphere": r"V\s*=\s*4/3œÄr¬≥|V\s*=\s*\(4/3\)œÄr¬≥",
            "power": r"a\^n|a\*\*n|a‚Åø",
            "fraction": r"\d+/\d+",
            "sqrt": r"‚àö\d+|sqrt\(\d+\)",
            # –§–∏–∑–∏–∫–∞
            "newton_2": r"F\s*=\s*ma",
            "energy": r"E\s*=\s*mc¬≤",
            "speed": r"v\s*=\s*s/t",
            "density": r"œÅ\s*=\s*m/V",
            "pressure": r"p\s*=\s*F/S",
            "work": r"A\s*=\s*Fs",
            "power_physics": r"N\s*=\s*A/t",
            "ohm_law": r"I\s*=\s*U/R",
            # –•–∏–º–∏—è
            "chemical_equation": r"[A-Z][a-z]?\d*\s*[\+\-‚Üí]\s*[A-Z][a-z]?\d*",
            "molarity": r"C\s*=\s*n/V",
            "mass_fraction": r"w\s*=\s*m‚ÇÅ/m‚ÇÇ",
        }

        # –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —Ñ–æ—Ä–º—É–ª —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏
        self.formula_explanations = self._init_formula_base()

    def _init_formula_base(self) -> dict[str, dict[str, Any]]:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π —Ñ–æ—Ä–º—É–ª."""
        return {
            # –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞
            "quadratic": {
                "name": "–ö–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ",
                "formula": "ax¬≤ + bx + c = 0",
                "simple": "–£—Ä–∞–≤–Ω–µ–Ω–∏–µ, –≥–¥–µ x —É–º–Ω–æ–∂–∞–µ—Ç—Å—è —Å–∞–º –Ω–∞ —Å–µ–±—è",
                "parts": {
                    "a": "–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø—Ä–∏ x¬≤ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä–æ —Ä–∞—Å—Ç–µ—Ç)",
                    "b": "–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø—Ä–∏ x (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–∫–ª–æ–Ω)",
                    "c": "—Å–≤–æ–±–æ–¥–Ω—ã–π —á–ª–µ–Ω (—Ç–æ—á–∫–∞ –Ω–∞—á–∞–ª–∞)",
                },
                "example": "x¬≤ + 5x + 6 = 0\n–ó–¥–µ—Å—å a=1, b=5, c=6\n–†–µ—à–µ–Ω–∏–µ: x=-2 –∏–ª–∏ x=-3",
                "life_example": "–ö–∞–∫ –±—Ä–æ—à–µ–Ω–Ω—ã–π –º—è—á –ª–µ—Ç–∏—Ç –ø–æ –¥—É–≥–µ –≤–≤–µ—Ä—Ö –∏ –≤–Ω–∏–∑",
                "visualization": "quadratic_graph",
            },
            "pythagorean": {
                "name": "–¢–µ–æ—Ä–µ–º–∞ –ü–∏—Ñ–∞–≥–æ—Ä–∞",
                "formula": "a¬≤ + b¬≤ = c¬≤",
                "simple": "–í –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–æ–º —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–µ: –∫–≤–∞–¥—Ä–∞—Ç –≥–∏–ø–æ—Ç–µ–Ω—É–∑—ã = —Å—É–º–º–µ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ –∫–∞—Ç–µ—Ç–æ–≤",
                "parts": {
                    "a": "–ø–µ—Ä–≤—ã–π –∫–∞—Ç–µ—Ç (–∫–æ—Ä–æ—Ç–∫–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)",
                    "b": "–≤—Ç–æ—Ä–æ–π –∫–∞—Ç–µ—Ç (–∫–æ—Ä–æ—Ç–∫–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)",
                    "c": "–≥–∏–ø–æ—Ç–µ–Ω—É–∑–∞ (—Å–∞–º–∞—è –¥–ª–∏–Ω–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞, –Ω–∞–ø—Ä–æ—Ç–∏–≤ –ø—Ä—è–º–æ–≥–æ —É–≥–ª–∞)",
                },
                "example": "–ï—Å–ª–∏ a=3 –∏ b=4, —Ç–æ c¬≤=9+16=25, –∑–Ω–∞—á–∏—Ç c=5",
                "life_example": "–ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –¥–ª–∏–Ω—É –ª–µ—Å—Ç–Ω–∏—Ü—ã –∫ —Å—Ç–µ–Ω–µ: –≤—ã—Å–æ—Ç–∞¬≤ + —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ¬≤ = –¥–ª–∏–Ω–∞ –ª–µ—Å—Ç–Ω–∏—Ü—ã¬≤",
                "visualization": "right_triangle",
            },
            "area_circle": {
                "name": "–ü–ª–æ—â–∞–¥—å –∫—Ä—É–≥–∞",
                "formula": "S = œÄr¬≤",
                "simple": "–ü–ª–æ—â–∞–¥—å –∫—Ä—É–≥–∞ = –ø–∏ —É–º–Ω–æ–∂–∏—Ç—å –Ω–∞ —Ä–∞–¥–∏—É—Å –≤ –∫–≤–∞–¥—Ä–∞—Ç–µ",
                "parts": {
                    "œÄ": "—á–∏—Å–ª–æ –ø–∏ ‚âà 3.14 (–ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –≤–µ–ª–∏—á–∏–Ω–∞)",
                    "r": "—Ä–∞–¥–∏—É—Å (—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –¥–æ –∫—Ä–∞—è –∫—Ä—É–≥–∞)",
                    "r¬≤": "—Ä–∞–¥–∏—É—Å —É–º–Ω–æ–∂–∏—Ç—å –Ω–∞ —Å–µ–±—è",
                },
                "example": "–ï—Å–ª–∏ —Ä–∞–¥–∏—É—Å = 5 —Å–º, —Ç–æ S = 3.14 √ó 5¬≤ = 3.14 √ó 25 = 78.5 —Å–º¬≤",
                "life_example": "–ü–ª–æ—â–∞–¥—å –ø–∏—Ü—Ü—ã –¥–∏–∞–º–µ—Ç—Ä–æ–º 30 —Å–º (—Ä–∞–¥–∏—É—Å 15 —Å–º) ‚âà 707 —Å–º¬≤",
                "visualization": "circle_area",
            },
            # –§–∏–∑–∏–∫–∞
            "newton_2": {
                "name": "–í—Ç–æ—Ä–æ–π –∑–∞–∫–æ–Ω –ù—å—é—Ç–æ–Ω–∞",
                "formula": "F = ma",
                "simple": "–°–∏–ª–∞ = –º–∞—Å—Å–∞ √ó —É—Å–∫–æ—Ä–µ–Ω–∏–µ",
                "parts": {
                    "F": "—Å–∏–ª–∞ (–≤ –ù—å—é—Ç–æ–Ω–∞—Ö, –ù) - –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ —Ç–æ–ª–∫–∞–µ–º",
                    "m": "–º–∞—Å—Å–∞ (–≤ –∫–∏–ª–æ–≥—Ä–∞–º–º–∞—Ö, –∫–≥) - –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç—è–∂–µ–ª—ã–π –ø—Ä–µ–¥–º–µ—Ç",
                    "a": "—É—Å–∫–æ—Ä–µ–Ω–∏–µ (–≤ –º/—Å¬≤) - –Ω–∞—Å–∫–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä–æ —Ä–∞–∑–≥–æ–Ω—è–µ—Ç—Å—è",
                },
                "example": "–¢–µ–ª–µ–∂–∫–∞ –º–∞—Å—Å–æ–π 2 –∫–≥ —Ä–∞–∑–≥–æ–Ω—è–µ—Ç—Å—è —Å —É—Å–∫–æ—Ä–µ–Ω–∏–µ–º 3 –º/—Å¬≤\nF = 2 √ó 3 = 6 –ù",
                "life_example": "–ß—Ç–æ–±—ã —Ä–∞–∑–æ–≥–Ω–∞—Ç—å —Ç—è–∂–µ–ª—É—é –∫–æ—Ä–æ–±–∫—É, –Ω—É–∂–Ω–æ –ø—Ä–∏–ª–æ–∂–∏—Ç—å –±–æ–ª—å—à–µ —Å–∏–ª—ã, —á–µ–º –¥–ª—è –ª–µ–≥–∫–æ–π",
                "visualization": "force_diagram",
            },
            "speed": {
                "name": "–°–∫–æ—Ä–æ—Å—Ç—å",
                "formula": "v = s/t",
                "simple": "–°–∫–æ—Ä–æ—Å—Ç—å = —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ √∑ –≤—Ä–µ–º—è",
                "parts": {
                    "v": "—Å–∫–æ—Ä–æ—Å—Ç—å (–≤ –º/—Å –∏–ª–∏ –∫–º/—á) - –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –¥–≤–∏–∂–µ–º—Å—è",
                    "s": "—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–≤ –º–µ—Ç—Ä–∞—Ö –∏–ª–∏ –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö) - —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—à–ª–∏",
                    "t": "–≤—Ä–µ–º—è (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö –∏–ª–∏ —á–∞—Å–∞—Ö) - —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏",
                },
                "example": "–ü—Ä–æ–µ—Ö–∞–ª–∏ 100 –∫–º –∑–∞ 2 —á–∞—Å–∞\nv = 100 √∑ 2 = 50 –∫–º/—á",
                "life_example": "–ï—Å–ª–∏ –±–µ–∂–∏—à—å 400 –º–µ—Ç—Ä–æ–≤ –∑–∞ 80 —Å–µ–∫—É–Ω–¥, —Ç–≤–æ—è —Å–∫–æ—Ä–æ—Å—Ç—å = 5 –º/—Å",
                "visualization": "speed_graph",
            },
            "density": {
                "name": "–ü–ª–æ—Ç–Ω–æ—Å—Ç—å",
                "formula": "œÅ = m/V",
                "simple": "–ü–ª–æ—Ç–Ω–æ—Å—Ç—å = –º–∞—Å—Å–∞ √∑ –æ–±—ä–µ–º (–Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç—è–∂–µ–ª—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª)",
                "parts": {
                    "œÅ": "–ø–ª–æ—Ç–Ω–æ—Å—Ç—å (–≤ –∫–≥/–º¬≥ –∏–ª–∏ –≥/—Å–º¬≥) - –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –≤–µ—â–µ—Å—Ç–≤–∞",
                    "m": "–º–∞—Å—Å–∞ (–≤ –∫–≥ –∏–ª–∏ –≥) - —Å–∫–æ–ª—å–∫–æ –≤–µ—Å–∏—Ç",
                    "V": "–æ–±—ä–µ–º (–≤ –º¬≥ –∏–ª–∏ —Å–º¬≥) - —Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç–∞ –∑–∞–Ω–∏–º–∞–µ—Ç",
                },
                "example": "–ö—É–±–∏–∫ –∂–µ–ª–µ–∑–∞ 1 —Å–º¬≥ –≤–µ—Å–∏—Ç 7.8 –≥\nœÅ = 7.8 √∑ 1 = 7.8 –≥/—Å–º¬≥",
                "life_example": "–ñ–µ–ª–µ–∑–æ —Ç–æ–Ω–µ—Ç (–ø–ª–æ—Ç–Ω–æ—Å—Ç—å 7.8), –∞ –¥–µ—Ä–µ–≤–æ –ø–ª–∞–≤–∞–µ—Ç (–ø–ª–æ—Ç–Ω–æ—Å—Ç—å 0.5) - –≤–æ–¥–∞ –∏–º–µ–µ—Ç –ø–ª–æ—Ç–Ω–æ—Å—Ç—å 1",
                "visualization": "density_comparison",
            },
            # –•–∏–º–∏—è
            "molarity": {
                "name": "–ú–æ–ª—è—Ä–Ω–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è",
                "formula": "C = n/V",
                "simple": "–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ—â–µ—Å—Ç–≤–∞ √∑ –æ–±—ä–µ–º —Ä–∞—Å—Ç–≤–æ—Ä–∞",
                "parts": {
                    "C": "–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è (–≤ –º–æ–ª—å/–ª) - –Ω–∞—Å–∫–æ–ª—å–∫–æ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π —Ä–∞—Å—Ç–≤–æ—Ä",
                    "n": "–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ—â–µ—Å—Ç–≤–∞ (–≤ –º–æ–ª—è—Ö) - —Å–∫–æ–ª—å–∫–æ –º–æ–ª–µ–∫—É–ª",
                    "V": "–æ–±—ä–µ–º —Ä–∞—Å—Ç–≤–æ—Ä–∞ (–≤ –ª–∏—Ç—Ä–∞—Ö) - —Å–∫–æ–ª—å–∫–æ –∂–∏–¥–∫–æ—Å—Ç–∏",
                },
                "example": "–†–∞—Å—Ç–≤–æ—Ä–∏–ª–∏ 2 –º–æ–ª—è —Å–æ–ª–∏ –≤ 1 –ª–∏—Ç—Ä–µ –≤–æ–¥—ã\nC = 2 √∑ 1 = 2 –º–æ–ª—å/–ª",
                "life_example": "–ö–∞–∫ —Å–∞—Ö–∞—Ä –≤ —á–∞–µ: —á–µ–º –±–æ–ª—å—à–µ –ª–æ–∂–µ–∫ –Ω–∞ —Å—Ç–∞–∫–∞–Ω, —Ç–µ–º —Å–ª–∞—â–µ (–≤—ã—à–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è)",
                "visualization": "concentration_diagram",
            },
        }

    def detect_formulas(self, text: str) -> list[str]:
        """
        –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º—É–ª—ã –≤ —Ç–µ–∫—Å—Ç–µ.

        Args:
            text: –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

        Returns:
            –°–ø–∏—Å–æ–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ñ–æ—Ä–º—É–ª
        """
        detected = []
        text_lower = text.lower()

        for formula_type, pattern in self.formula_patterns.items():
            if re.search(pattern, text, re.IGNORECASE):
                detected.append(formula_type)
                logger.debug(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞: {formula_type}")

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        keywords = {
            "quadratic": ["–∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ", "–¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞–Ω—Ç", "–ø–∞—Ä–∞–±–æ–ª–∞"],
            "pythagorean": ["—Ç–µ–æ—Ä–µ–º–∞ –ø–∏—Ñ–∞–≥–æ—Ä–∞", "–ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫", "–≥–∏–ø–æ—Ç–µ–Ω—É–∑–∞"],
            "area_circle": ["–ø–ª–æ—â–∞–¥—å –∫—Ä—É–≥–∞", "–ø–ª–æ—â–∞–¥—å –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–∏"],
            "newton_2": ["–≤—Ç–æ—Ä–æ–π –∑–∞–∫–æ–Ω –Ω—å—é—Ç–æ–Ω–∞", "—Å–∏–ª–∞ –∏ —É—Å–∫–æ—Ä–µ–Ω–∏–µ"],
            "speed": ["—Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è", "–ø—É—Ç—å –∏ –≤—Ä–µ–º—è"],
            "density": ["–ø–ª–æ—Ç–Ω–æ—Å—Ç—å –≤–µ—â–µ—Å—Ç–≤–∞", "–º–∞—Å—Å–∞ –∏ –æ–±—ä–µ–º"],
        }

        for formula_type, words in keywords.items():
            if any(word in text_lower for word in words) and formula_type not in detected:
                detected.append(formula_type)
                logger.debug(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º: {formula_type}")

        return detected

    def explain_formula(self, formula_type: str, user_age: int = 12) -> str:  # noqa: ARG002
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª—ã.

        Args:
            formula_type: –¢–∏–ø —Ñ–æ—Ä–º—É–ª—ã
            user_age: –í–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

        Returns:
            –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª—ã
        """
        if formula_type not in self.formula_explanations:
            return ""

        data = self.formula_explanations[formula_type]

        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
        explanation = f"üìê {data['name']}\n\n"
        explanation += f"–§–æ—Ä–º—É–ª–∞: {data['formula']}\n\n"
        explanation += f"–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏: {data['simple']}\n\n"

        # –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —á–∞—Å—Ç–µ–π —Ñ–æ—Ä–º—É–ª—ã
        explanation += "–ß—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç –±—É–∫–≤—ã:\n"
        for symbol, meaning in data["parts"].items():
            explanation += f"‚Ä¢ {symbol} ‚Äî {meaning}\n"

        explanation += f"\n–ü—Ä–∏–º–µ—Ä:\n{data['example']}\n\n"
        explanation += f"–ì–¥–µ —ç—Ç–æ –≤ –∂–∏–∑–Ω–∏:\n{data['life_example']}"

        return explanation

    def enhance_prompt_with_formula_context(self, user_message: str, user_age: int = 12) -> str:
        """
        –£–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –æ —Ñ–æ—Ä–º—É–ª–∞—Ö –¥–ª—è AI.

        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_age: –í–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Returns:
            –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI –ø—Ä–æ–º–ø—Ç–∞
        """
        detected_formulas = self.detect_formulas(user_message)

        if not detected_formulas:
            return ""

        context = "\n\nüîç –û–ë–ù–ê–†–£–ñ–ï–ù–´ –§–û–†–ú–£–õ–´ –í –í–û–ü–†–û–°–ï:\n"
        context += "–ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞:\n\n"

        for formula_type in detected_formulas:
            explanation = self.explain_formula(formula_type, user_age)
            if explanation:
                context += f"{explanation}\n\n{'='*50}\n\n"

        context += "\n‚úÖ –í–ê–ñ–ù–û –î–õ–Ø –û–¢–í–ï–¢–ê:\n"
        context += "1. –û–±—ä—è—Å–Ω–∏ —Ñ–æ—Ä–º—É–ª—É –ü–†–û–°–¢–´–ú–ò –°–õ–û–í–ê–ú–ò –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞\n"
        context += "2. –ü–æ–∫–∞–∂–∏ —Ñ–æ—Ä–º—É–ª—É —á–µ—Ç–∫–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ\n"
        context += "3. –†–∞–∑–±–µ—Ä–∏ –∫–∞–∂–¥—É—é –±—É–∫–≤—É –≤ —Ñ–æ—Ä–º—É–ª–µ - —á—Ç–æ –æ–Ω–∞ –æ–∑–Ω–∞—á–∞–µ—Ç\n"
        context += "4. –ü—Ä–∏–≤–µ–¥–∏ –ö–û–ù–ö–†–ï–¢–ù–´–ô –ß–ò–°–õ–û–í–û–ô –ü–†–ò–ú–ï–† —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º —Ä–µ—à–µ–Ω–∏–µ–º\n"
        context += "5. –ü–æ–∫–∞–∂–∏, –≥–¥–µ —ç—Ç–∞ —Ñ–æ—Ä–º—É–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –í –†–ï–ê–õ–¨–ù–û–ô –ñ–ò–ó–ù–ò\n"
        context += "6. –ï—Å–ª–∏ —Ñ–æ—Ä–º—É–ª–∞ —Å–ª–æ–∂–Ω–∞—è - —É–ø—Ä–æ—Å—Ç–∏ –µ–µ –∏–ª–∏ —Ä–∞–∑–±–µ–π –Ω–∞ —á–∞—Å—Ç–∏\n"
        context += "7. –ò—Å–ø–æ–ª—å–∑—É–π –∞–Ω–∞–ª–æ–≥–∏–∏ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –ø–æ–Ω—è—Ç–Ω—ã–µ —Ä–µ–±–µ–Ω–∫—É\n\n"

        return context

    def should_generate_visualization(self, formula_type: str) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–∞ –ª–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º—É–ª—ã.

        Args:
            formula_type: –¢–∏–ø —Ñ–æ—Ä–º—É–ª—ã

        Returns:
            True –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
        """
        if formula_type not in self.formula_explanations:
            return False

        viz_type = self.formula_explanations[formula_type].get("visualization")
        return viz_type is not None

    def generate_formula_visualization(self, formula_type: str) -> bytes | None:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è —Ñ–æ—Ä–º—É–ª—ã.

        Args:
            formula_type: –¢–∏–ø —Ñ–æ—Ä–º—É–ª—ã

        Returns:
            PNG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ None
        """
        if formula_type not in self.formula_explanations:
            return None

        data = self.formula_explanations[formula_type]
        viz_type = data.get("visualization")

        if not viz_type:
            return None

        try:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–µ—Ä–≤–∏—Å
            if viz_type == "right_triangle":
                # –î–ª—è —Ç–µ–æ—Ä–µ–º—ã –ü–∏—Ñ–∞–≥–æ—Ä–∞ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—é
                return self.viz_service.generate_geometry_visualization(
                    "right_triangle", {"a": 3, "b": 4, "c": 5}
                )
            elif viz_type == "circle_area":
                return self.viz_service.generate_geometry_visualization("circle", {"radius": 5})
            # –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã

            logger.info(f"–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è {formula_type} –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞")
            return None

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è {formula_type}: {e}")
            return None


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
formula_explainer = FormulaExplainer()
