"""
Модуль для формирования системных промптов для YandexGPT.

Добавляет динамический контекст (имя, статус приветствия, редирект на учебу)
к базовому системному промпту.
"""

from bot.config.prompts import AI_SYSTEM_PROMPT


class PromptBuilder:
    """Построитель промптов для YandexGPT."""

    def __init__(self):
        self.base_prompt = AI_SYSTEM_PROMPT

    def build_system_prompt(
        self,
        user_message: str = "",
        user_name: str | None = None,
        chat_history: list[dict] | None = None,
        is_history_cleared: bool = False,
        message_count_since_name: int = 0,  # noqa: ARG002
        non_educational_questions_count: int = 0,  # noqa: ARG002
        user_age: int | None = None,  # noqa: ARG002
        user_grade: int | None = None,
        is_auto_greeting_sent: bool = False,
    ) -> str:
        """
        Построить системный промпт: базовые правила + опциональный контекст приветствия/прощания.
        """
        greeting = self._get_greeting_context(
            chat_history or [],
            is_history_cleared,
            user_message,
            is_auto_greeting_sent,
            user_name,
            user_grade,
        )
        if greeting:
            return f"{self.base_prompt}\n\n{greeting}"
        return self.base_prompt

    # ========== ЗАКОММЕНТИРОВАНО: Структурные инструкции ==========
    # Даем модели полную свободу в форматировании ответов, как в Алисе
    # YandexGPT Pro 5.1 уже обучена на хороших ответах

    def _get_strict_structure_instruction(self, user_message: str = "") -> str:  # noqa: ARG002
        """
        Возвращает жесткую инструкцию по структуре ответа.
        ЗАКОММЕНТИРОВАНО - не используется, даем модели свободу.
        """
        return ""
        # # Определяем тип вопроса
        # message_lower = user_message.lower()
        #
        # # Запрос визуализации
        # is_visual_request = any(
        #     kw in message_lower
        #     for kw in [
        #         "покажи",
        #         "нарисуй",
        #         "построй",
        #         "график",
        #         "таблиц",
        #         "карт",
        #         "схем",
        #         "диаграмм",
        #     ]
        # )
        #
        # # Точные науки (пошаговый шаблон)
        # is_exact_science = any(
        #     kw in message_lower
        #     for kw in [
        #         "реши",
        #         "вычисли",
        #         "посчитай",
        #         "найди",
        #         "уравнени",
        #         "задач",
        #         "пример",
        #         "формул",
        #         "правил",
        #         "грамматик",
        #         "орфограф",
        #     ]
        # )
        #
        # # Объяснение явлений (объясняющий шаблон)
        # is_explanation = any(
        #     kw in message_lower
        #     for kw in [
        #         "объясни",
        #         "расскажи",
        #         "что такое",
        #         "почему",
        #         "как работает",
        #         "зачем",
        #         "для чего",
        #     ]
        # )
        #
        # # Формируем инструкцию по структуре
        # structure_instruction = ""
        #
        # if is_visual_request:
        #     structure_instruction = """
        # СТРУКТУРА ДЛЯ ВИЗУАЛИЗАЦИИ (БЕЗ явных заголовков):
        # Изображение уже прикреплено к твоему ответу. НЕ упоминай это! Дай ПОДРОБНОЕ пояснение.
        #
        # Начни с краткого описания что это (1-2 предложения). Выдели ключевое понятие жирным.
        #
        # Объясни как читать/использовать:
        # - Конкретный пример 1
        # - Конкретный пример 2
        # - Конкретный пример 3
        #
        # Если применимо, перечисли основные свойства списком:
        # - Свойство 1
        # - Свойство 2
        #
        # Покажи где применяется (1-2 предложения).
        #
        # ЗАПРЕЩЕНО: говорить "визуализация показана", "график/таблица/карта будет добавлена", "система сгенерирует".
        # Для таблиц умножения: НЕ перечисляй значения! Объясни КАК пользоваться.
        # Для графиков: укажи точки, возрастание/убывание, примеры. Выдели ключевые числа жирным.
        # Для карт: положение, соседи, водные объекты, факты.
        # Используй ** только для выделения ключевых слов и чисел (НЕ для заголовков).
        # НИКОГДА не используй заголовки "Что это:", "Как читать:", "Основные свойства:", "Где применяется:".
        # """
        # elif is_exact_science:
        #     structure_instruction = """
        # СТРУКТУРА ДЛЯ ЗАДАЧ И ПРАВИЛ (БЕЗ явных заголовков):
        # Начни с главного правила (1-2 предложения). Выдели ключевое понятие жирным.
        #
        # Затем дай пошаговую инструкцию (3-5 шагов):
        # 1. Первый шаг
        # 2. Второй шаг
        # 3. И так далее
        #
        # Приведи пример задачи с решением по этим шагам. Выдели ключевые числа и ответ жирным.
        #
        # Заверши кратким резюме для запоминания.
        #
        # НИКОГДА не используй заголовки "ГЛАВНОЕ ПРАВИЛО:", "ПОШАГОВАЯ ИНСТРУКЦИЯ:", "ПРИМЕР:", "ИТОГ:".
        # """
        # elif is_explanation:
        #     structure_instruction = """
        # СТРУКТУРА ДЛЯ ОБЪЯСНЕНИЙ (объясняющий шаблон):
        # 1. ЯРКАЯ АНАЛОГИЯ (1-2 предложения): сравнение из жизни ребенка
        # 2. СВЯЗНЫЙ РАССКАЗ (2-3 абзаца): главные факты, причины, механизм
        # 3. КОНКРЕТНЫЙ ПРИМЕР (1 абзац): как это работает в реальности
        # 4. ВЫВОД + ФИШКА ДЛЯ ПАМЯТИ (1-2 предложения): резюме и ассоциация
        #
        # Объясняй "почему" и "как", а не только "что".
        # Связывай факты между собой.
        # """
        # else:
        #     structure_instruction = """
        # ОБЩАЯ СТРУКТУРА ОТВЕТА (БЕЗ явных заголовков):
        # Начни с прямого ответа на вопрос (1-2 предложения). Выдели ключевые слова жирным.
        #
        # Затем разверни объяснение (2-4 абзаца), разбирая каждый аспект.
        #
        # Приведи примеры (1-3 примера) из жизни.
        #
        # Заверши кратким резюме (1 предложение).
        #
        # НИКОГДА не используй заголовки "СУТЬ:", "РАЗВЕРНУТОЕ ОБЪЯСНЕНИЕ:", "ПРИМЕРЫ:", "ИТОГ:".
        # """
        #
        # # Общие правила
        # general_rules = """
        # ОБЯЗАТЕЛЬНЫЕ ПРАВИЛА:
        # - Начни СРАЗУ с ответа. Без "Привет", "Конечно", "Рад помочь", "Суть:".
        # - НЕ повторяй слова в начале ответа.
        # - НИКОГДА не используй явные заголовки типа "Определение:", "Суть:", "Ключевые свойства:" и т.д.
        # - Разбивай текст на абзацы (пустые строки между блоками).
        # - Используй жирное выделение для ключевых слов, понятий, чисел, ответов.
        # - Учитывай ВСЕ слова в вопросе пользователя.
        # - Давай ГЛУБОКИЙ, РАЗВЕРНУТЫЙ ответ с примерами.
        # - НЕ пиши "полотном текста" - используй структуру.
        # """
        #
        # return f"\n{structure_instruction}\n{general_rules}"

    def _get_greeting_context(
        self,
        chat_history: list[dict] | None,
        is_history_cleared: bool,
        user_message: str,
        is_auto_greeting_sent: bool,
        user_name: str | None = None,
        user_grade: int | None = None,
    ) -> str | None:
        """Определяет нужно ли приветствоваться или прощаться."""
        if not chat_history:
            chat_history = []

        user_message_lower = user_message.lower().strip()

        # Проверка, здоровалась ли панда
        ai_greeted = False
        if is_auto_greeting_sent:
            ai_greeted = True
        else:
            for msg in chat_history:
                if msg.get("role") == "assistant":
                    txt = msg.get("text", "").lower()
                    if (
                        "привет" in txt
                        or "чем могу помочь" in txt
                        or "начнем" in txt
                        or "пандапал" in txt
                    ):
                        ai_greeted = True
                        break

        # Пользователь прощается - ТОЛЬКО если это явное прощание, не вопрос
        farewell_keywords = [
            "пока",
            "до свидания",
            "до свиданья",
            "прощай",
            "прощайте",
            "bye",
            "goodbye",
            "see you",
            "увидимся",
        ]
        # Проверяем, что это именно прощание, а не вопрос с этими словами
        is_farewell = any(fw in user_message_lower for fw in farewell_keywords)
        # Если есть вопросительные слова - это не прощание
        has_question_words = any(
            qw in user_message_lower for qw in ["что", "как", "где", "когда", "почему", "кто", "?"]
        )
        if is_farewell and not has_question_words:
            return (
                "Пользователь попрощался. Попрощайся в ответ коротко и вежливо. "
                "Только «ты», никогда «Здравствуйте»."
            )

        # КРИТИЧЕСКИ ВАЖНО: После очистки истории приветствие должно быть ТОЛЬКО ОДИН РАЗ
        # Если история очищена И приветствие уже отправлено - НЕ здороваться снова
        if is_history_cleared and ai_greeted:
            return (
                "ВНИМАНИЕ: История очищена, ты уже поздоровалась. "
                "НЕ повторяй приветствие. Никогда не пиши «Здравствуйте». Сразу начинай с решения или объяснения."
            )

        # Пользователь здоровается - ТОЛЬКО если это явное приветствие
        greeting_keywords = [
            "привет",
            "здравствуй",
            "здравствуйте",
            "добрый день",
            "доброе утро",
            "добрый вечер",
            "здравова",
            "хай",
            "hi",
            "hello",
        ]
        user_greeted = any(gw in user_message_lower for gw in greeting_keywords)

        # ОСОБЫЙ СЛУЧАЙ: После очистки корзины, если панда уже поздоровалась и пользователь тоже поздоровался
        # НЕ повторять привет, а спросить имя или что будем изучать
        if is_history_cleared and ai_greeted and user_greeted:
            return (
                "ВНИМАНИЕ: Ты уже поздоровалась, пользователь тоже. НЕ пиши «Привет» снова. "
                "Спроси: «Как тебя зовут?» или «Что будем изучать сегодня?» — сразу с вопроса, без повторного приветствия. "
                "Только «ты», никогда «Здравствуйте»."
            )

        # КРИТИЧЕСКИ ВАЖНО: Если у пользователя нет имени ИЛИ класса - спроси оба при первом заходе
        # Проверяем это через user_name и user_grade, которые передаются в build_system_prompt
        # Если (user_name=None ИЛИ user_grade=None) И (история пуста ИЛИ история очищена И пользователь не прощается)
        needs_name = user_name is None
        needs_grade = user_grade is None
        is_first_visit = (not chat_history or is_history_cleared) and not is_farewell

        if (needs_name or needs_grade) and is_first_visit:
            # Если пользователь явно поздоровался - спроси имя и класс в приветствии
            if user_greeted:
                if needs_name and needs_grade:
                    return (
                        "Поприветствуй один раз: «Привет! Как тебя зовут и в каком ты классе?» (или «Давай знакомиться — как тебя зовут и в каком ты классе?»). "
                        "Только «ты», никогда «Здравствуйте»."
                    )
                elif needs_name:
                    return (
                        "Поприветствуй один раз: «Привет! Как тебя зовут?» (или «Давай знакомиться — как тебя зовут?»). "
                        "Только «ты», никогда «Здравствуйте»."
                    )
                elif needs_grade:
                    return (
                        "Поприветствуй один раз: «Привет! В каком ты классе?» (или «Расскажи, в каком ты классе?»). "
                        "Только «ты», никогда «Здравствуйте»."
                    )
            # Если это первое сообщение (история пустая) - можно спросить имя и класс
            elif not chat_history:
                if needs_name and needs_grade:
                    return (
                        "Первое сообщение, не знаешь имени и класса. Спроси: «Привет! Как тебя зовут и в каком ты классе?». "
                        "Только «ты», никогда «Здравствуйте»."
                    )
                elif needs_name:
                    return (
                        "Первое сообщение, не знаешь имени. Спроси: «Привет! Как тебя зовут?». "
                        "Только «ты», никогда «Здравствуйте»."
                    )
                elif needs_grade:
                    return (
                        "Первое сообщение, не знаешь класса. Спроси: «Привет! В каком ты классе?». "
                        "Только «ты», никогда «Здравствуйте»."
                    )

        # Приветствуем ТОЛЬКО если:
        # 1. Пользователь явно поздоровался И
        # 2. Панда еще НЕ здоровалась И
        # 3. (История пуста ИЛИ история очищена)
        # 4. У пользователя ЕСТЬ имя (чтобы не дублировать запрос имени выше)
        if (
            user_greeted
            and not ai_greeted
            and (not chat_history or is_history_cleared)
            and user_name
        ):
            return (
                "Поприветствуй один раз: «Привет! Я PandaPal. Чем могу помочь сегодня?» (без имени). "
                "Только «ты», никогда «Здравствуйте»."
            )

        # Панда уже здоровалась - НЕ здороваться снова
        if ai_greeted:
            # Но если нужно спросить имя/класс - спроси без приветствия
            needs_name = user_name is None
            needs_grade = user_grade is None
            if needs_name and needs_grade:
                return (
                    "Ты уже поздоровалась. НЕ повторяй «Привет». Спроси: «Как тебя зовут и в каком ты классе?». "
                    "Никогда «Здравствуйте»."
                )
            elif needs_name:
                return (
                    "Ты уже поздоровалась. НЕ повторяй «Привет». Спроси: «Как тебя зовут?». "
                    "Никогда «Здравствуйте»."
                )
            elif needs_grade:
                return (
                    "Ты уже поздоровалась. НЕ повторяй «Привет». Спроси: «В каком ты классе?». "
                    "Никогда «Здравствуйте»."
                )
            return (
                "Ты уже поздоровалась. НЕ повторяй приветствие. Никогда не пиши «Здравствуйте». "
                "Сразу начинай с решения или объяснения."
            )

        return None


# Глобальный экземпляр
_prompt_builder = None


def get_prompt_builder() -> PromptBuilder:
    """Получить глобальный экземпляр PromptBuilder."""
    global _prompt_builder
    if _prompt_builder is None:
        _prompt_builder = PromptBuilder()
    return _prompt_builder
