"""Query expansion для улучшения RAG поиска."""

import re


class QueryExpander:
    """Расширение поисковых запросов синонимами и связанными терминами."""

    def __init__(self):
        # Расширенный словарь синонимов (200+ терминов по всем предметам)
        self.synonyms = {
            # МАТЕМАТИКА (арифметика)
            "умножение": ["произведение", "умножить", "перемножение", "таблица умножения"],
            "деление": ["частное", "разделить", "делимое", "делитель"],
            "сложение": ["сумма", "прибавить", "слагаемое", "плюс"],
            "вычитание": ["разность", "отнять", "уменьшаемое", "минус"],
            "дробь": ["числитель", "знаменатель", "дробное число"],
            "процент": ["процентное соотношение", "доля", "часть от целого"],
            "остаток": ["деление с остатком", "остаточное"],
            # МАТЕМАТИКА (алгебра)
            "уравнение": ["равенство", "решить", "найти x", "корень уравнения"],
            "неравенство": ["больше меньше", "сравнение"],
            "функция": ["зависимость", "график функции", "аргумент"],
            "график": ["диаграмма", "кривая", "координатная плоскость"],
            "парабола": ["квадратичная функция", "y=x²"],
            "гипербола": ["обратная пропорциональность", "y=k/x"],
            "линейная функция": ["y=kx+b", "прямая линия"],
            "степень": ["возведение в степень", "показатель степени"],
            "корень": ["квадратный корень", "извлечение корня", "радикал"],
            "логарифм": ["показательная функция", "основание логарифма"],
            "многочлен": ["полином", "одночлен", "коэффициент"],
            "формула": ["выражение", "тождество"],
            # МАТЕМАТИКА (геометрия)
            "треугольник": ["три стороны", "углы треугольника", "периметр"],
            "прямоугольник": ["четырехугольник", "стороны", "диагональ"],
            "квадрат": ["равные стороны", "прямые углы"],
            "окружность": ["круг", "радиус", "диаметр", "центр"],
            "площадь": ["квадратные единицы", "поверхность"],
            "периметр": ["длина границы", "сумма сторон"],
            "объем": ["кубические единицы", "вместимость"],
            "угол": ["градус", "острый", "тупой", "прямой угол"],
            "теорема пифагора": ["катет", "гипотенуза", "прямоугольный треугольник"],
            "синус": ["тригонометрия", "sin", "противолежащий катет"],
            "косинус": ["тригонометрия", "cos", "прилежащий катет"],
            "тангенс": ["тригонометрия", "tan", "отношение сторон"],
            # РУССКИЙ ЯЗЫК (части речи)
            "глагол": ["действие", "что делать", "спряжение", "время глагола"],
            "существительное": ["предмет", "кто что", "склонение", "род"],
            "прилагательное": ["признак", "какой", "согласование", "степень сравнения"],
            "наречие": ["как", "где", "когда", "признак действия"],
            "местоимение": ["замена существительного", "личное местоимение"],
            "числительное": ["количество", "порядок", "сколько"],
            "предлог": ["служебная часть речи", "падеж"],
            "союз": ["связь", "соединение", "сочинительный", "подчинительный"],
            "частица": ["оттенок значения", "не", "ни", "бы"],
            "причастие": ["признак по действию", "действительное", "страдательное"],
            "деепричастие": ["добавочное действие", "суффикс"],
            # РУССКИЙ ЯЗЫК (орфография)
            "орфография": ["правописание", "правило", "буквы"],
            "безударная гласная": ["проверочное слово", "корень"],
            "парная согласная": ["проверка", "звонкая", "глухая"],
            "непроизносимая согласная": ["стечение согласных"],
            "приставка": ["начало слова", "пре", "при"],
            "суффикс": ["часть слова", "словообразование"],
            "окончание": ["изменяемая часть", "склонение"],
            "корень слова": ["однокоренные слова", "главная часть", "морфема"],
            # РУССКИЙ ЯЗЫК (пунктуация)
            "пунктуация": ["знаки препинания", "запятая", "точка"],
            "запятая": ["перечисление", "обращение", "вводное слово"],
            "тире": ["пояснение", "подлежащее сказуемое"],
            "двоеточие": ["перечисление", "пояснение"],
            "прямая речь": ["слова автора", "диалог"],
            # РУССКИЙ ЯЗЫК (синтаксис)
            "предложение": ["подлежащее", "сказуемое", "члены предложения"],
            "подлежащее": ["главный член", "кто что"],
            "сказуемое": ["главный член", "что делает"],
            "дополнение": ["второстепенный член", "падежный вопрос"],
            "определение": ["второстепенный член", "какой"],
            "обстоятельство": ["второстепенный член", "как где когда"],
            # ЛИТЕРАТУРА
            "автор": ["писатель", "поэт", "создатель"],
            "произведение": ["книга", "текст", "литература"],
            "герой": ["персонаж", "главный герой", "действующее лицо"],
            "сюжет": ["фабула", "развитие действия", "завязка"],
            "тема": ["идея", "главная мысль", "проблема"],
            "жанр": ["вид литературы", "рассказ", "повесть", "роман"],
            "стихотворение": ["поэзия", "стих", "рифма", "строфа"],
            "басня": ["мораль", "аллегория", "крылов"],
            "сказка": ["вымысел", "волшебство", "народная"],
            "метафора": ["переносное значение", "сравнение"],
            "эпитет": ["художественное определение", "образ"],
            # ИСТОРИЯ (общие термины)
            "война": ["битва", "сражение", "конфликт", "военные действия"],
            "реформа": ["изменение", "преобразование", "перемены"],
            "революция": ["переворот", "восстание", "смена власти"],
            "государство": ["страна", "держава", "власть"],
            "правитель": ["царь", "император", "князь", "король"],
            "народ": ["население", "нация", "этнос"],
            "культура": ["искусство", "традиции", "обычаи"],
            "экономика": ["хозяйство", "торговля", "производство"],
            # ИСТОРИЯ (периоды)
            "древний мир": ["античность", "древняя греция", "древний рим"],
            "средние века": ["средневековье", "феодализм", "рыцари"],
            "новое время": ["буржуазия", "капитализм", "промышленность"],
            "древняя русь": ["киевская русь", "варяги", "славяне"],
            # ГЕОГРАФИЯ (физическая)
            "океан": ["море", "водное пространство", "акватория"],
            "материк": ["континент", "суша", "часть света"],
            "река": ["водоток", "исток", "устье", "приток"],
            "озеро": ["водоем", "пресная вода"],
            "гора": ["вершина", "хребет", "возвышенность"],
            "равнина": ["низменность", "плато", "плоскогорье"],
            "климат": ["погода", "температура", "осадки"],
            "природная зона": ["тундра", "тайга", "степь", "пустыня"],
            # ГЕОГРАФИЯ (экономическая)
            "население": ["жители", "демография", "плотность"],
            "страна": ["государство", "территория", "столица"],
            "город": ["населенный пункт", "мегаполис"],
            "промышленность": ["производство", "завод", "фабрика"],
            "сельское хозяйство": ["земледелие", "животноводство"],
            # БИОЛОГИЯ (ботаника)
            "растение": ["флора", "цветок", "дерево", "трава"],
            "фотосинтез": ["хлорофилл", "углекислый газ", "кислород"],
            "клетка": ["ядро", "цитоплазма", "мембрана", "органоид"],
            "корень растения": ["поглощение воды", "укрепление", "ботаника"],
            "стебель": ["проводящая система", "ствол"],
            "лист": ["фотосинтез", "дыхание", "испарение"],
            "цветок": ["опыление", "пестик", "тычинка"],
            "плод": ["семя", "размножение"],
            # БИОЛОГИЯ (зоология)
            "животное": ["фауна", "организм", "вид"],
            "млекопитающее": ["теплокровное", "шерсть", "молоко"],
            "птица": ["перья", "клюв", "полет", "яйцо"],
            "рыба": ["жабры", "плавники", "чешуя"],
            "насекомое": ["членистоногое", "шесть ног", "крылья"],
            "земноводное": ["амфибия", "лягушка", "метаморфоз"],
            "пресмыкающееся": ["рептилия", "чешуя", "холоднокровное"],
            # БИОЛОГИЯ (анатомия человека)
            "организм": ["тело", "система органов"],
            "сердце": ["кровообращение", "пульс", "сосуды"],
            "легкие": ["дыхание", "кислород", "газообмен"],
            "желудок": ["пищеварение", "переваривание"],
            "мозг": ["нервная система", "мышление", "рефлекс"],
            "скелет": ["кости", "позвоночник", "опора"],
            "мышцы": ["движение", "сокращение"],
            # ФИЗИКА
            "сила": ["ньютон", "воздействие", "притяжение"],
            "энергия": ["работа", "джоуль", "мощность"],
            "скорость": ["движение", "метр в секунду", "ускорение"],
            "масса": ["килограмм", "вес", "инерция"],
            "температура": ["градус", "теплота", "термометр"],
            "давление": ["паскаль", "атмосфера", "жидкость"],
            "электричество": ["ток", "напряжение", "сопротивление"],
            "магнит": ["притяжение", "полюс", "поле"],
            "свет": ["луч", "отражение", "преломление", "линза"],
            "звук": ["колебание", "волна", "частота", "громкость"],
            "механика": ["движение", "равновесие", "рычаг"],
            "теплота": ["теплопередача", "конвекция", "излучение"],
            # ХИМИЯ
            "атом": ["ядро", "электрон", "протон", "нейтрон"],
            "молекула": ["связь", "вещество", "формула"],
            "элемент": ["таблица менделеева", "химический знак"],
            "реакция": ["химическое превращение", "продукт", "реагент"],
            "кислота": ["водород", "ph", "кислый"],
            "щелочь": ["основание", "гидроксид", "щелочной"],
            "соль": ["ионы", "кристалл", "растворимость"],
            "оксид": ["кислород", "окисление"],
            "металл": ["проводник", "блеск", "пластичность"],
            "неметалл": ["изолятор", "хрупкость"],
            "валентность": ["связь", "степень окисления"],
            "раствор": ["растворитель", "растворенное вещество", "концентрация"],
            # ИНФОРМАТИКА
            "программа": ["код", "алгоритм", "инструкция"],
            "алгоритм": ["последовательность", "шаги", "блок-схема"],
            "переменная": ["данные", "значение", "тип"],
            "цикл": ["повторение", "for", "while"],
            "условие": ["if", "ветвление", "логика"],
            "массив": ["список", "элемент", "индекс"],
            "функция программы": ["подпрограмма", "параметр", "возврат", "код"],
            "система счисления": ["двоичная", "десятичная", "бит"],
            "файл": ["данные", "папка", "расширение"],
            "интернет": ["сеть", "браузер", "сайт"],
            # АНГЛИЙСКИЙ ЯЗЫК
            "английская грамматика": ["правило", "структура", "english grammar"],
            "времена в английском": ["present", "past", "future", "tense"],
            "артикль": ["a", "an", "the", "определенный"],
            "verb": ["глагол английский", "действие", "irregular verb"],
            "noun": ["существительное английское", "предмет", "plural"],
            "adjective": ["прилагательное английское", "описание", "comparison"],
            "preposition": ["предлог английский", "место", "время"],
            "pronoun": ["местоимение английское", "замена", "personal"],
            # ОБЩЕСТВОЗНАНИЕ
            "общество": ["социум", "люди", "группа"],
            "государство и власть": ["страна", "закон", "конституция", "правительство"],
            "право": ["закон", "норма", "обязанность"],
            "экономика общества": ["хозяйство", "деньги", "рынок", "торговля"],
            "политика": ["власть", "партия", "выборы"],
            "семья": ["родители", "дети", "брак"],
            "образование": ["школа", "учеба", "знания"],
            "труд": ["работа", "профессия", "зарплата"],
            # МУЗЫКА
            "нота": ["звук", "высота", "длительность"],
            "ритм": ["такт", "темп", "размер"],
            "мелодия": ["музыкальная тема", "напев"],
            "гамма": ["звукоряд", "тональность", "лад"],
            "аккорд": ["созвучие", "трезвучие"],
            "композитор": ["автор музыки", "музыкант"],
            # ИЗО
            "рисунок": ["изображение", "набросок", "эскиз"],
            "живопись": ["картина", "краски", "холст"],
            "цвет": ["оттенок", "палитра", "спектр"],
            "композиция": ["расположение", "построение"],
            "перспектива": ["глубина", "объем", "точка схода"],
        }

        # Расширенный словарь связанных тем
        self.related_terms = {
            # Математика
            "таблица умножения": ["арифметика", "математика", "счет", "примеры"],
            "синус": ["тригонометрия", "угол", "треугольник", "косинус"],
            "дробь": ["числитель", "знаменатель", "сокращение"],
            "уравнение": ["алгебра", "корень", "решение"],
            "площадь": ["геометрия", "фигура", "формула"],
            "теорема": ["доказательство", "геометрия", "утверждение"],
            # Русский язык
            "падежи": ["русский язык", "склонение", "грамматика", "окончание"],
            "спряжение": ["глагол", "окончание", "лицо", "число"],
            "орфограмма": ["правописание", "буква", "правило"],
            "синтаксис": ["предложение", "пунктуация", "разбор"],
            # Биология
            "фотосинтез": ["биология", "растения", "хлорофилл", "кислород"],
            "клетка": ["биология", "организм", "ядро", "мембрана"],
            "эволюция": ["дарвин", "отбор", "вид", "происхождение"],
            "генетика": ["наследственность", "ген", "хромосома"],
            # Физика
            "ньютон": ["сила", "законы", "механика", "движение"],
            "электричество": ["ток", "напряжение", "цепь", "сопротивление"],
            "оптика": ["свет", "линза", "зеркало", "преломление"],
            # Химия
            "таблица менделеева": ["элементы", "периоды", "группы", "химия"],
            "реакция": ["вещества", "превращение", "уравнение"],
            "кислота": ["основание", "ph", "индикатор", "нейтрализация"],
            # История
            "петр первый": ["реформы", "россия", "империя", "флот"],
            "великая отечественная": ["война", "победа", "фашизм", "1941"],
            "революция 1917": ["октябрь", "большевики", "советская власть"],
            # География
            "россия": ["страна", "территория", "население", "москва"],
            "климат": ["погода", "температура", "осадки", "зона"],
            "рельеф": ["горы", "равнины", "возвышенности"],
        }

    def expand(self, query: str, max_additions: int = 3) -> str:
        """
        Расширить запрос синонимами и связанными терминами.

        Args:
            query: Исходный запрос
            max_additions: Максимум дополнительных терминов

        Returns:
            Расширенный запрос
        """
        query_lower = query.lower()
        additions = []

        # Добавляем синонимы
        for term, syns in self.synonyms.items():
            if term in query_lower and len(additions) < max_additions:
                additions.append(syns[0])  # Добавляем первый синоним

        # Добавляем связанные термины
        for term, related in self.related_terms.items():
            if term in query_lower and len(additions) < max_additions:
                additions.extend(related[: max_additions - len(additions)])

        if additions:
            return f"{query} {' '.join(additions[:max_additions])}"
        return query

    def generate_variations(self, query: str) -> list[str]:
        """
        Генерировать вариации запроса для multi-query RAG.

        Args:
            query: Исходный запрос

        Returns:
            Список вариаций запроса
        """
        variations = [query]

        # Вариация 1: Расширенный запрос
        expanded = self.expand(query)
        if expanded != query:
            variations.append(expanded)

        # Вариация 2: Извлечь ключевые слова
        keywords = self._extract_keywords(query)
        if keywords and keywords != query:
            variations.append(" ".join(keywords))

        # Вариация 3: Формализованный вопрос
        formal = self._formalize_question(query)
        if formal and formal != query:
            variations.append(formal)

        return variations[:3]  # Максимум 3 вариации

    def _extract_keywords(self, query: str) -> list[str]:
        """Извлечь ключевые слова из запроса."""
        # Удаляем стоп-слова
        stop_words = {
            "что",
            "как",
            "где",
            "когда",
            "почему",
            "зачем",
            "это",
            "такое",
            "мне",
            "нужно",
            "помоги",
            "расскажи",
            "объясни",
        }

        words = query.lower().split()
        keywords = [w for w in words if w not in stop_words and len(w) > 3]
        return keywords

    def _formalize_question(self, query: str) -> str:
        """Преобразовать в формальный вопрос."""
        query_lower = query.lower()

        # Паттерны формализации
        patterns = [
            (r"что такое (.+)", r"\1 определение"),
            (r"как решить (.+)", r"\1 решение"),
            (r"расскажи про (.+)", r"\1 информация"),
            (r"объясни (.+)", r"\1 объяснение"),
        ]

        for pattern, replacement in patterns:
            match = re.search(pattern, query_lower)
            if match:
                return re.sub(pattern, replacement, query_lower)

        return query
