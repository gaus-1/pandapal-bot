# Политика безопасности

## Поддерживаемые версии

Мы активно поддерживаем следующие версии PandaPal:

| Версия | Поддержка         |
| ------ | ----------------- |
| 2.x    | ✅ Активная       |
| 1.x    | ⚠️ Критические баги только |
| < 1.0  | ❌ Не поддерживается |

## Сообщить об уязвимости

Мы серьезно относимся к безопасности PandaPal. Если вы обнаружили уязвимость, пожалуйста, сообщите нам об этом ответственно.

### Как сообщить

**НЕ создавайте публичный Issue для уязвимостей безопасности.**

Вместо этого:

1. **GitHub Security Advisories** (рекомендуется):
   - Перейдите на вкладку [Security](https://github.com/gaus-1/pandapal-bot/security)
   - Нажмите "Report a vulnerability"
   - Заполните форму с деталями

2. **Email** (альтернатива):
   - Отправьте email на: [создайте приватный Issue с меткой "security"]
   - Тема: `[SECURITY] Краткое описание`
   - Укажите детали уязвимости

### Что включить в отчет

Пожалуйста, предоставьте следующую информацию:

- **Тип уязвимости** (например, SQL injection, XSS, CSRF)
- **Затронутые компоненты** (файлы, endpoints, функции)
- **Шаги для воспроизведения**
- **Потенциальное влияние**
- **Предлагаемое исправление** (если есть)
- **Ваши контактные данные** для дальнейшей связи

### Процесс обработки

1. **Подтверждение** — в течение 48 часов
2. **Оценка** — в течение 7 дней
3. **Исправление** — в зависимости от серьезности:
   - Критические: 1-3 дня
   - Высокие: 7-14 дней
   - Средние: 30 дней
   - Низкие: следующий релиз
4. **Публикация** — после выпуска патча

### Программа вознаграждений

В настоящее время у нас нет официальной bug bounty программы, но мы:

- Публично признаем ваш вклад (если вы согласны)
- Добавим вас в [SECURITY_CONTRIBUTORS.md](SECURITY_CONTRIBUTORS.md)
- Предоставим бесплатный Premium доступ на год

### Меры безопасности проекта

PandaPal реализует следующие меры безопасности:

#### OWASP Top 10 Protection

**A01: Broken Access Control** ✅
- Централизованная проверка владельца ресурса через `verify_resource_owner()` и `require_owner()` в `bot/api/validators.py`
- Все endpoints с `telegram_id` в URL защищены от несанкционированного доступа
- Frontend отправляет `X-Telegram-Init-Data` заголовок во всех API запросах
- Backend валидирует HMAC-SHA256 подпись через Telegram Bot Token
- При попытке доступа к чужим данным возвращается 403 Forbidden
- Защищено 16+ endpoints: профиль, прогресс, достижения, дашборд, история чата, игры, домашние задания, Premium функции

**A10: SSRF Protection** ✅
- Все внешние HTTP запросы проходят через `SSRFProtection.validate_external_request()`
- Whitelist разрешенных доменов (nsportal.ru, school203.ru)
- Блокировка запросов к localhost, внутренним IP (10.x, 172.16-31.x, 192.168.x)
- Валидация схемы URL (только http/https)
- Реализовано в `bot/services/web_scraper.py` через метод `_safe_get()`

#### Защита данных
- ✅ Шифрование данных в transit (HTTPS/TLS через Cloudflare Full Strict)
- ✅ Секреты только в переменных окружения, никогда в коде
- ✅ Telegram initData валидация через HMAC-SHA256

#### Защита приложения
- ✅ Валидация входных данных (Pydantic V2)
- ✅ Защита от SQL injection (SQLAlchemy ORM, параметризованные запросы)
- ✅ Защита от XSS (Content Security Policy headers в frontend)
- ✅ Защита от CSRF (токены, CORS настройки)
- ✅ Rate limiting (60 req/min API, 30 req/min AI)
- ✅ Модерация контента (150+ паттернов, 4 языка)
- ✅ Owner verification для всех защищенных ресурсов

#### Инфраструктура
- ✅ Регулярные обновления зависимостей
- ✅ Автоматическое сканирование уязвимостей (Dependabot)
- ✅ Pre-commit hooks (ruff, pylint, bandit, safety)
- ✅ CI/CD с проверками безопасности
- ✅ Redis FSM storage для горизонтального масштабирования

#### Мониторинг
- ✅ Логирование всех критических операций (loguru)
- ✅ Prometheus metrics для мониторинга производительности
- ✅ Аудит логирование попыток несанкционированного доступа
- ✅ Мониторинг подозрительной активности

### Известные ограничения

Текущие известные ограничения безопасности:

1. **Rate limiting** — базируется на IP (можно обойти через VPN)
2. **Модерация контента** — паттерн-based (может пропустить новые обходы)
3. **File uploads** — ограничение 20MB (можно улучшить валидацию типов)

Мы активно работаем над улучшением этих аспектов.

### Ресурсы безопасности

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [CWE Top 25](https://cwe.mitre.org/top25/)
- [Python Security Best Practices](https://python.readthedocs.io/en/latest/library/security_warnings.html)

### Scope

**В scope:**
- ✅ Backend API (bot/, web_server.py)
- ✅ Frontend (frontend/)
- ✅ Database queries
- ✅ Authentication/Authorization
- ✅ Payment processing
- ✅ Content moderation bypass

**Вне scope:**
- ❌ Социальная инженерия
- ❌ DoS/DDoS атаки
- ❌ Физический доступ
- ❌ Уязвимости в сторонних сервисах (Yandex Cloud, Railway)
- ❌ Проблемы с устаревшими версиями браузеров

### Контакты

Для вопросов по безопасности:
- GitHub Security: https://github.com/gaus-1/pandapal-bot/security
- Email: [создайте приватный security issue]

---

Спасибо за помощь в обеспечении безопасности PandaPal.
