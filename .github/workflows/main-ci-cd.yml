# PandaPal CI/CD Pipeline
# Backend: Python 3.13 + PostgreSQL 17
# Frontend: React 18 + TypeScript + Vite
# Auto-deploy: Railway

name: ğŸ¼ PandaPal CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.13'
  NODE_VERSION: '20'
  POSTGRES_VERSION: '17'

jobs:
  # Backend: Python + PostgreSQL
  backend:
    name: ğŸ Backend (Python 3.13)
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
      attestations: write

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pandapal_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

      - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Lint - flake8 (critical errors only)
        run: |
          pip install flake8
          flake8 bot --count --select=E9,F63,F7,F82 --show-source --statistics || true
        continue-on-error: true

      - name: ğŸ¨ Format check - black
        run: |
          pip install black
          black --check bot
        continue-on-error: true

      - name: ğŸ“š Import sorting - isort
        run: |
          pip install isort
          isort --check-only bot
        continue-on-error: true

      - name: ğŸ§ª Run tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/pandapal_test
          TELEGRAM_BOT_TOKEN: 123456789:TEST_TOKEN_FOR_CI
          YANDEX_CLOUD_API_KEY: AQVTEST_KEY_FOR_CI
          YANDEX_CLOUD_FOLDER_ID: b1gTEST_FOLDER_ID_FOR_CI
          YANDEX_GPT_MODEL: yandexgpt-lite
          SECRET_KEY: test_secret_key_32_chars_minimum
          DEBUG: 'True'
        run: |
          pytest tests/ -v --cov=bot --cov-report=xml --cov-report=term-missing --maxfail=1
        continue-on-error: true

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          flags: backend
          name: backend-coverage
        continue-on-error: true

      - name: ğŸ³ Build Docker image (backend)
        id: build-backend
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: pandapal-backend:${{ github.sha }}
        continue-on-error: true

      - name: ğŸ” Extract image digest (backend)
        id: digest-backend
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.build-backend.outcome == 'success'
        run: |
          image_id=$(docker image inspect pandapal-backend:${{ github.sha }} --format='{{.Id}}' | cut -d':' -f2)
          digest="sha256:$image_id"
          echo "digest=$digest" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ” Generate build attestation (backend)
        uses: actions/attest-build-provenance@v3
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.digest-backend.outcome == 'success' && steps.digest-backend.outputs.digest != ''
        continue-on-error: true
        with:
          subject-name: 'pandapal-backend'
          subject-digest: '${{ steps.digest-backend.outputs.digest }}'
          push-to-registry: false

  # Frontend: React + TypeScript + Vite
  frontend:
    name: âš›ï¸ Frontend (React 18)
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
      attestations: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ” Lint - ESLint
        working-directory: ./frontend
        run: npm run lint
        continue-on-error: true

      - name: ğŸ—ï¸ Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: ğŸ“¦ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 7

      - name: ğŸ³ Set up Docker Buildx (frontend)
        uses: docker/setup-buildx-action@v3
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

      - name: ğŸ³ Build Docker image (frontend)
        id: build-frontend
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: pandapal-frontend:${{ github.sha }}

      - name: ğŸ” Extract image digest (frontend)
        id: digest-frontend
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.build-frontend.outcome == 'success'
        run: |
          image_id=$(docker image inspect pandapal-frontend:${{ github.sha }} --format='{{.Id}}' | cut -d':' -f2)
          digest="sha256:$image_id"
          echo "digest=$digest" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ” Generate build attestation (frontend)
        uses: actions/attest-build-provenance@v3
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.digest-frontend.outcome == 'success' && steps.digest-frontend.outputs.digest != ''
        continue-on-error: true
        with:
          subject-name: 'pandapal-frontend'
          subject-digest: '${{ steps.digest-frontend.outputs.digest }}'
          push-to-registry: false

  # Security: Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ Ğ¸ ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
  security:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: ğŸ”’ Check dependencies (safety)
        run: |
          safety check --json --output safety-report.json || true
        continue-on-error: true

      - name: ğŸ›¡ï¸ Security linting (bandit)
        run: |
          bandit -r bot/ -f json -o bandit-report.json -ll --skip B101,B601 || true
        continue-on-error: true

      - name: ğŸ“‹ Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            safety-report.json
            bandit-report.json
          retention-days: 30

  # ============================================================================
  # DEPLOY: Auto-deploy to Railway (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ main Ğ²ĞµÑ‚ĞºĞ¸)
  # ============================================================================
  deploy:
    name: ğŸš€ Deploy to Railway
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy notification
        run: |
          echo "ğŸš€ Deploying PandaPal Bot to Railway..."
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ“ Message: ${{ github.event.head_commit.message }}"

      - name: âœ… Deploy complete
        run: |
          echo "âœ… Railway Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ñ‚ Ğ¸Ğ· GitHub"
          echo "ğŸŒ URL: https://pandapal.ru"
          echo "ğŸ“Š Health: https://pandapal.ru/health"

  # Summary: Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚
  summary:
    name: ğŸ“Š Build Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: always()

    steps:
      - name: ğŸ“Š Print summary
        run: |
          echo "ğŸ¼ PandaPal Bot - CI/CD Summary"
          echo "Backend: ${{ needs.backend.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"
          echo "âœ… Pipeline completed"
