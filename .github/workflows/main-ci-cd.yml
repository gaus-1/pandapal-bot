# PandaPal CI/CD Pipeline
# Backend: Python 3.13 + PostgreSQL 17
# Frontend: React 18 + TypeScript + Vite
# Auto-deploy: Railway
#
# Actions pinned to full SHA (reproducible, secure). IDE may still show "version not found" if it can't reach GitHub.

name: üêº PandaPal CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.13'
  NODE_VERSION: '20'
  POSTGRES_VERSION: '17'

jobs:
  # Backend: Python + PostgreSQL
  backend:
    name: üêç Backend (Python 3.13)
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
      attestations: write

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pandapal_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

      - name: üêç Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üîç Lint - flake8 (critical errors only)
        run: |
          pip install flake8
          flake8 bot --count --select=E9,F63,F7,F82 --show-source --statistics || true
        continue-on-error: true

      - name: üé® Format check - black
        run: |
          pip install black
          black --check bot
        continue-on-error: true

      - name: üìö Import sorting - isort
        run: |
          pip install isort
          isort --check-only bot
        continue-on-error: true

      - name: üß™ Run tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/pandapal_test
          TELEGRAM_BOT_TOKEN: 123456789:TEST_TOKEN_FOR_CI
          YANDEX_CLOUD_API_KEY: AQVTEST_KEY_FOR_CI
          YANDEX_CLOUD_FOLDER_ID: b1gTEST_FOLDER_ID_FOR_CI
          YANDEX_GPT_MODEL: yandexgpt-lite
          SECRET_KEY: test_secret_key_32_chars_minimum
          DEBUG: 'True'
        run: |
          pytest tests/ -v --cov=bot --cov-report=xml --cov-report=term-missing --maxfail=1
        continue-on-error: true

      - name: üìä Upload coverage to Codecov
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4
        with:
          files: ./coverage.xml
          flags: backend
          name: backend-coverage
        continue-on-error: true

      - name: üê≥ Build Docker image (backend)
        id: build-backend
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5
        with:
          context: .
          load: true
          tags: pandapal-backend:${{ github.sha }}
        continue-on-error: true

      - name: üîç Extract image digest (backend)
        id: digest-backend
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.build-backend.outcome == 'success'
        run: |
          image_id=$(docker image inspect pandapal-backend:${{ github.sha }} --format='{{.Id}}' | cut -d':' -f2)
          digest="sha256:$image_id"
          echo "digest=$digest" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: üîê Generate build attestation (backend)
        uses: actions/attest-build-provenance@43d14bc2b83dec42d39ecae14e916627a18bb661 # v3
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.digest-backend.outcome == 'success' && steps.digest-backend.outputs.digest != ''
        continue-on-error: true
        with:
          subject-name: 'pandapal-backend'
          subject-digest: '${{ steps.digest-backend.outputs.digest }}'
          push-to-registry: false

  # Frontend: React + TypeScript + Vite
  frontend:
    name: ‚öõÔ∏è Frontend (React 18)
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
      attestations: write

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: üü¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: üì¶ Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: üîç Lint - ESLint
        working-directory: ./frontend
        run: npm run lint
        continue-on-error: true

      - name: üèóÔ∏è Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: üì¶ Upload build artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 7

      - name: üê≥ Set up Docker Buildx (frontend)
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

      - name: üê≥ Build Docker image (frontend)
        id: build-frontend
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5
        with:
          context: .
          load: true
          tags: pandapal-frontend:${{ github.sha }}

      - name: üîç Extract image digest (frontend)
        id: digest-frontend
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.build-frontend.outcome == 'success'
        run: |
          image_id=$(docker image inspect pandapal-frontend:${{ github.sha }} --format='{{.Id}}' | cut -d':' -f2)
          digest="sha256:$image_id"
          echo "digest=$digest" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: üîê Generate build attestation (frontend)
        uses: actions/attest-build-provenance@43d14bc2b83dec42d39ecae14e916627a18bb661 # v3
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.digest-frontend.outcome == 'success' && steps.digest-frontend.outputs.digest != ''
        continue-on-error: true
        with:
          subject-name: 'pandapal-frontend'
          subject-digest: '${{ steps.digest-frontend.outputs.digest }}'
          push-to-registry: false

  # Security: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
  security:
    name: üõ°Ô∏è Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: üêç Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: üîí Check dependencies (safety)
        run: |
          safety check --json --output safety-report.json || true
        continue-on-error: true

      - name: üõ°Ô∏è Security linting (bandit)
        run: |
          bandit -r bot/ -f json -o bandit-report.json -ll --skip B101,B601 || true
        continue-on-error: true

      - name: üìã Upload security reports
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: security-reports
          path: |
            safety-report.json
            bandit-report.json
          retention-days: 30

  # ============================================================================
  # DEPLOY: Railway –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç push –≤ main –∏ –¥–µ–ø–ª–æ–∏—Ç —Å–∞–º (GitHub integration).
  # –í–∞–∂–Ω–æ: –¥–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏ push –≤ –≤–µ—Ç–∫—É main. Push –≤ develop ‚Üí CI –µ—Å—Ç—å, –¥–µ–ø–ª–æ—è –Ω–µ—Ç.
  # –≠—Ç–æ—Ç job —Ç–æ–ª—å–∫–æ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –≤ –ª–æ–≥–∞—Ö, —á—Ç–æ –ø–∞–π–ø–ª–∞–π–Ω –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é.
  # ============================================================================
  deploy:
    name: üöÄ Deploy to Railway
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Deploy (Railway GitHub integration)
        env:
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_AUTHOR: ${{ github.actor }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          echo "::group::Deploy info"
          echo "Deploy: Railway auto-deploys on push to main (GitHub integration)"
          echo "Commit: $COMMIT_SHA"
          echo "Author: $COMMIT_AUTHOR"
          echo "Message: ${COMMIT_MSG:-n/a}"
          echo "::endgroup::"

      - name: ‚úÖ Deploy ready
        run: |
          echo "::notice title=Deploy::Railway will deploy from this push. App URL: https://pandapal.ru"
          echo "Health: https://pandapal.ru/health"

  # Summary: –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
  summary:
    name: üìä Build Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: always()

    steps:
      - name: üìä Print summary
        run: |
          echo "üêº PandaPal Bot - CI/CD Summary"
          echo "Backend: ${{ needs.backend.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"
          echo "‚úÖ Pipeline completed"
