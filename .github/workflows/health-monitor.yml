# Health check monitor
# Pings /health/detailed every 5 minutes, sends Telegram alert on failure
#
# Required secrets:
#   TELEGRAM_BOT_TOKEN  - bot token for sending alerts
#   ADMIN_TELEGRAM_ID   - Telegram user ID of the main admin
#   HEALTH_CHECK_URL    - full URL to health endpoint

name: Health Monitor

on:
  schedule:
    # Every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch: # manual trigger

jobs:
  health-check:
    name: Check Service Health
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Check health endpoint
        id: health
        env:
          HEALTH_URL: ${{ secrets.HEALTH_CHECK_URL }}
        run: |
          URL="${HEALTH_URL:-https://web-production-725aa.up.railway.app/health/detailed}"

          echo "Checking: $URL"

          HTTP_CODE=$(curl -s -o /tmp/health_response.json -w "%{http_code}" \
            --max-time 15 \
            --retry 2 \
            --retry-delay 3 \
            "$URL" 2>/dev/null || echo "000")

          echo "HTTP status: $HTTP_CODE"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            cat /tmp/health_response.json | python3 -m json.tool 2>/dev/null || true
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "::warning::Health check failed with HTTP $HTTP_CODE"
            cat /tmp/health_response.json 2>/dev/null || echo "No response body"
          fi

      - name: Send alert on failure
        if: steps.health.outputs.status == 'unhealthy'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.ADMIN_TELEGRAM_ID }}
        run: |
          RESPONSE=$(cat /tmp/health_response.json 2>/dev/null | head -c 200 || echo "No response")
          MESSAGE="üö® <b>PandaPal DOWN</b>

‚è∞ $(date -u +%Y-%m-%d\ %H:%M\ UTC)
üì° Health check failed

<code>${RESPONSE}</code>

üîó <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View logs</a>"

          if [ -n "$BOT_TOKEN" ] && [ -n "$CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="$CHAT_ID" \
              -d text="$MESSAGE" \
              -d parse_mode="HTML" \
              -d disable_web_page_preview="true"
          else
            echo "::error::Missing TELEGRAM_BOT_TOKEN or ADMIN_TELEGRAM_ID secrets"
          fi

      - name: Send recovery notification
        if: steps.health.outputs.status == 'healthy'
        run: |
          echo "Service is healthy"
